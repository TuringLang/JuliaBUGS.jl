name: Benchmark

on:
  pull_request:
    branches:
      - main
    paths:
      - 'JuliaBUGS/**'
      - '.github/workflows/Benchmark.yml'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  benchmark:
    name: Benchmark
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - uses: julia-actions/setup-julia@v2
      with:
        version: '1.11'

    - uses: actions/cache@v4
      with:
        path: |
          ~/.julia
          ~/.julia/artifacts
        key: ${{ runner.os }}-julia-benchmark-${{ hashFiles('JuliaBUGS/**/Project.toml', 'JuliaBUGS/**/Manifest.toml') }}
        restore-keys: |
          ${{ runner.os }}-julia-benchmark-

    - name: Run benchmarks
      working-directory: ./JuliaBUGS
      env:
        BENCHMARK_OUTPUT: benchmark_results.md
      run: |
        julia --project=benchmark -e 'using Pkg; Pkg.instantiate()'
        julia --project=benchmark benchmark/run_benchmarks.jl

    - name: Post results to PR
      uses: marocchino/sticky-pull-request-comment@v2
      if: github.event_name == 'pull_request'
      with:
        path: JuliaBUGS/benchmark_results.md
        recreate: true
