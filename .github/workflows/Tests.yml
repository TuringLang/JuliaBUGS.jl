name: Tests

on:
  push:
    branches:
      - main
    paths:
      - 'JuliaBUGS/**'
      - '.github/workflows/Tests.yml'
  pull_request:
    paths:
      - 'JuliaBUGS/**'
      - '.github/workflows/Tests.yml'
  workflow_dispatch:

jobs:
  # Basic tests run in parallel  
  test-basic:
    name: ${{ matrix.test_group }} - Julia ${{ matrix.version }} (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    continue-on-error: ${{ matrix.version == 'pre' }}
    strategy:
      fail-fast: false
      matrix:
        version:
          - '1.11'
          - '1'
          # - 'min'
          # - 'pre'
        os:
          - ubuntu-latest
          # - windows-latest
        arch:
          - x64
        test_group:
          - "elementary"
          - "frontend" 
          - "graphs"
          - "compilation"
          - "log_density"
          - "model_operations"
          - "experimental"

    steps:
      - uses: actions/checkout@v4

      - uses: julia-actions/setup-julia@v2
        with:
          version: ${{ matrix.version }}
          arch: ${{ matrix.arch }}
      
      - uses: actions/cache@v4
        with:
          path: |
            ~/.julia
            ~/.julia/artifacts
          key: ${{ runner.os }}-julia-${{ matrix.version }}-${{ matrix.arch }}-${{ hashFiles('JuliaBUGS/**/Project.toml', 'JuliaBUGS/**/Manifest.toml') }}
          restore-keys: |
            ${{ runner.os }}-julia-${{ matrix.version }}-${{ matrix.arch }}-
            ${{ runner.os }}-julia-${{ matrix.version }}-
      
      - uses: julia-actions/julia-buildpkg@v1
        with:
          project: JuliaBUGS

      - name: Running ${{ matrix.test_group }} tests
        uses: julia-actions/julia-runtest@v1
        with:
          project: JuliaBUGS
        env:
          TEST_GROUP: ${{ matrix.test_group }}

  # Slow inference tests with retry logic
  test-inference:
    name: ${{ matrix.test_group }} - Julia ${{ matrix.version }} (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    continue-on-error: false
    strategy:
      fail-fast: false
      matrix:
        version:
          - '1.11'
          - '1'
        os:
          - ubuntu-latest
        arch:
          - x64
        test_group:
          - "inference_hmc"
          - "inference_chains"
          - "inference_mh"
          - "gibbs"

    steps:
      - uses: actions/checkout@v4

      - uses: julia-actions/setup-julia@v2
        with:
          version: ${{ matrix.version }}
          arch: ${{ matrix.arch }}
      
      - uses: actions/cache@v4
        with:
          path: |
            ~/.julia
            ~/.julia/artifacts
          key: ${{ runner.os }}-julia-${{ matrix.version }}-${{ matrix.arch }}-${{ hashFiles('JuliaBUGS/**/Project.toml', 'JuliaBUGS/**/Manifest.toml') }}
          restore-keys: |
            ${{ runner.os }}-julia-${{ matrix.version }}-${{ matrix.arch }}-
            ${{ runner.os }}-julia-${{ matrix.version }}-
      
      - uses: julia-actions/julia-buildpkg@v1
        with:
          project: JuliaBUGS

      - name: Running ${{ matrix.test_group }} tests
        uses: julia-actions/julia-runtest@v1
        with:
          project: JuliaBUGS
        env:
          TEST_GROUP: ${{ matrix.test_group }}

  # Parallel sampling tests with multiple threads
  test-parallel:
    name: Parallel Sampling - Julia ${{ matrix.version }} (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    continue-on-error: false
    strategy:
      fail-fast: false
      matrix:
        version:
          - '1.11'
          - '1'
        os:
          - ubuntu-latest
        arch:
          - x64

    steps:
      - uses: actions/checkout@v4

      - uses: julia-actions/setup-julia@v2
        with:
          version: ${{ matrix.version }}
          arch: ${{ matrix.arch }}
      
      - uses: actions/cache@v4
        with:
          path: |
            ~/.julia
            ~/.julia/artifacts
          key: ${{ runner.os }}-julia-${{ matrix.version }}-${{ matrix.arch }}-${{ hashFiles('JuliaBUGS/**/Project.toml', 'JuliaBUGS/**/Manifest.toml') }}
          restore-keys: |
            ${{ runner.os }}-julia-${{ matrix.version }}-${{ matrix.arch }}-
            ${{ runner.os }}-julia-${{ matrix.version }}-
      
      - uses: julia-actions/julia-buildpkg@v1
        with:
          project: JuliaBUGS

      - name: Set thread count
        id: threads
        run: echo "count=$(nproc)" >> $GITHUB_OUTPUT

      - name: Running parallel_sampling tests
        uses: julia-actions/julia-runtest@v1
        with:
          project: JuliaBUGS
        env:
          TEST_GROUP: parallel_sampling
          JULIA_NUM_THREADS: ${{ steps.threads.outputs.count }}