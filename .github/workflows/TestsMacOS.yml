name: Tests

on:
  # push:
  #   branches:
  #     - main
  # pull_request:

  workflow_dispatch:

jobs:
  # Basic tests run in parallel on macOS 
  test-basic:
    name: ${{ matrix.test_group }} - Julia ${{ matrix.version }} (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    continue-on-error: ${{ matrix.version == 'pre' }}
    strategy:
      fail-fast: false
      matrix:
        version: 
          - '1'
          # - 'min'
          # - 'pre'
        os: [macOS-latest]
        arch: [aarch64]
        test_group:
          - "elementary"
          - "frontend"
          - "graphs" 
          - "compilation"
          - "log_density"
          - "model_operations"
          - "experimental"

    steps:
      - uses: actions/checkout@v4

      - uses: julia-actions/setup-julia@v2
        with:
          version: ${{ matrix.version }}
          arch: ${{ matrix.arch }}
      
      - uses: actions/cache@v4
        with:
          path: |
            ~/.julia
            ~/.julia/artifacts
          key: ${{ runner.os }}-julia-${{ matrix.version }}-${{ matrix.arch }}-${{ hashFiles('**/Project.toml', '**/Manifest.toml') }}
          restore-keys: |
            ${{ runner.os }}-julia-${{ matrix.version }}-${{ matrix.arch }}-
            ${{ runner.os }}-julia-${{ matrix.version }}-
      
      - uses: julia-actions/julia-buildpkg@v1

      - name: Running ${{ matrix.test_group }} tests
        uses: julia-actions/julia-runtest@v1
        env:
          TEST_GROUP: ${{ matrix.test_group }}

  # Slow inference tests with retry logic on macOS
  test-inference:
    name: ${{ matrix.test_group }} - Julia ${{ matrix.version }} (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    continue-on-error: false
    strategy:
      fail-fast: false
      matrix:
        version:
          - '1'
        os: [macOS-latest]
        arch: [aarch64]
        test_group:
          - "inference_hmc"
          - "inference_chains"

    steps:
      - uses: actions/checkout@v4

      - uses: julia-actions/setup-julia@v2
        with:
          version: ${{ matrix.version }}
          arch: ${{ matrix.arch }}
      
      - uses: actions/cache@v4
        with:
          path: |
            ~/.julia
            ~/.julia/artifacts
          key: ${{ runner.os }}-julia-${{ matrix.version }}-${{ matrix.arch }}-${{ hashFiles('**/Project.toml', '**/Manifest.toml') }}
          restore-keys: |
            ${{ runner.os }}-julia-${{ matrix.version }}-${{ matrix.arch }}-
            ${{ runner.os }}-julia-${{ matrix.version }}-
      
      - uses: julia-actions/julia-buildpkg@v1

      - name: Running ${{ matrix.test_group }} tests
        uses: julia-actions/julia-runtest@v1
        env:
          TEST_GROUP: ${{ matrix.test_group }}
