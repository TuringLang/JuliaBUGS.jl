Directory structure:
‚îî‚îÄ‚îÄ DoodleBUGS/
    ‚îú‚îÄ‚îÄ README.md
    ‚îú‚îÄ‚îÄ env.d.ts
    ‚îú‚îÄ‚îÄ eslint.config.ts
    ‚îú‚îÄ‚îÄ index.html
    ‚îú‚îÄ‚îÄ package.json
    ‚îú‚îÄ‚îÄ tsconfig.app.json
    ‚îú‚îÄ‚îÄ tsconfig.json
    ‚îú‚îÄ‚îÄ tsconfig.node.json
    ‚îú‚îÄ‚îÄ vite.config.ts
    ‚îú‚îÄ‚îÄ vite.lib.config.ts
    ‚îú‚îÄ‚îÄ .editorconfig
    ‚îú‚îÄ‚îÄ .prettierignore
    ‚îú‚îÄ‚îÄ .prettierrc
    ‚îú‚îÄ‚îÄ experiments/
    ‚îÇ   ‚îî‚îÄ‚îÄ DoodleWidget/
    ‚îÇ       ‚îú‚îÄ‚îÄ dashboard.html
    ‚îÇ       ‚îú‚îÄ‚îÄ demo.html
    ‚îÇ       ‚îú‚îÄ‚îÄ embedded-article.html
    ‚îÇ       ‚îú‚îÄ‚îÄ examples.html
    ‚îÇ       ‚îú‚îÄ‚îÄ index.html
    ‚îÇ       ‚îî‚îÄ‚îÄ index.qmd
    ‚îú‚îÄ‚îÄ public/
    ‚îÇ   ‚îî‚îÄ‚îÄ examples/
    ‚îÇ       ‚îî‚îÄ‚îÄ rats/
    ‚îÇ           ‚îî‚îÄ‚îÄ model.json
    ‚îî‚îÄ‚îÄ src/
        ‚îú‚îÄ‚îÄ App.vue
        ‚îú‚îÄ‚îÄ DoodleWidget.vue
        ‚îú‚îÄ‚îÄ main.ce.ts
        ‚îú‚îÄ‚îÄ main.ts
        ‚îú‚îÄ‚îÄ assets/
        ‚îÇ   ‚îî‚îÄ‚îÄ styles/
        ‚îÇ       ‚îî‚îÄ‚îÄ global.css
        ‚îú‚îÄ‚îÄ components/
        ‚îÇ   ‚îú‚îÄ‚îÄ canvas/
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FloatingBottomToolbar.vue
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ GraphCanvas.vue
        ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ GraphEditor.vue
        ‚îÇ   ‚îú‚îÄ‚îÄ common/
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ BaseModal.vue
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DebugPanel.vue
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DropdownMenu.vue
        ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ FloatingPanel.vue
        ‚îÇ   ‚îú‚îÄ‚îÄ layouts/
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AboutModal.vue
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ExportModal.vue
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ FaqModal.vue
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ GraphStyleModal.vue
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LeftSidebar.vue
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ MainLayout.vue
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RightSidebar.vue
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ShareModal.vue
        ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ValidationIssuesModal.vue
        ‚îÇ   ‚îú‚îÄ‚îÄ left-sidebar/
        ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ProjectManager.vue
        ‚îÇ   ‚îú‚îÄ‚îÄ panels/
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CodePreviewPanel.vue
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ DataInputPanel.vue
        ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ScriptSettingsPanel.vue
        ‚îÇ   ‚îú‚îÄ‚îÄ right-sidebar/
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ JsonEditorPanel.vue
        ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LocalScriptPanel.vue
        ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ NodePropertiesPanel.vue
        ‚îÇ   ‚îî‚îÄ‚îÄ ui/
        ‚îÇ       ‚îú‚îÄ‚îÄ BaseButton.vue
        ‚îÇ       ‚îú‚îÄ‚îÄ BaseInput.vue
        ‚îÇ       ‚îî‚îÄ‚îÄ BaseSelect.vue
        ‚îú‚îÄ‚îÄ composables/
        ‚îÇ   ‚îú‚îÄ‚îÄ useBugsCodeGenerator.ts
        ‚îÇ   ‚îú‚îÄ‚îÄ useCompoundDragDrop.ts
        ‚îÇ   ‚îú‚îÄ‚îÄ useGraphElements.ts
        ‚îÇ   ‚îú‚îÄ‚îÄ useGraphInstance.ts
        ‚îÇ   ‚îú‚îÄ‚îÄ useGraphLayout.ts
        ‚îÇ   ‚îú‚îÄ‚îÄ useGraphValidator.ts
        ‚îÇ   ‚îú‚îÄ‚îÄ useGridSnapping.ts
        ‚îÇ   ‚îú‚îÄ‚îÄ useImportExport.ts
        ‚îÇ   ‚îú‚îÄ‚îÄ usePersistence.ts
        ‚îÇ   ‚îî‚îÄ‚îÄ useShareExport.ts
        ‚îú‚îÄ‚îÄ config/
        ‚îÇ   ‚îú‚îÄ‚îÄ examples.ts
        ‚îÇ   ‚îî‚îÄ‚îÄ nodeDefinitions.ts
        ‚îú‚îÄ‚îÄ stores/
        ‚îÇ   ‚îú‚îÄ‚îÄ dataStore.ts
        ‚îÇ   ‚îú‚îÄ‚îÄ graphStore.ts
        ‚îÇ   ‚îú‚îÄ‚îÄ projectStore.ts
        ‚îÇ   ‚îú‚îÄ‚îÄ scriptStore.ts
        ‚îÇ   ‚îî‚îÄ‚îÄ uiStore.ts
        ‚îî‚îÄ‚îÄ types/
            ‚îú‚îÄ‚îÄ cytoscape-extensions.d.ts
            ‚îî‚îÄ‚îÄ index.ts

================================================
FILE: README.md
================================================
# DoodleBUGS: Browser-Based Graphical Interface for JuliaBUGS

A web-based graphical editor for creating Bayesian models, inspired by DoodleBUGS and designed to work with JuliaBUGS. This project aims to provide a visual interface for building, understanding, and sharing probabilistic models.

Try DoodleBUGS at [`https://turinglang.org/JuliaBUGS.jl/DoodleBUGS/`](https://turinglang.org/JuliaBUGS.jl/DoodleBUGS/).

# Project Status

This project is in active development. You can track the development progress and view active work in the [Issues with `DoodleBUGS` label](https://github.com/TuringLang/JuliaBUGS.jl/issues?q=is%3Aissue%20state%3Aopen%20label%3ADoodleBUGS).

> [!NOTE]
> This project supports touch screen devices (iPad/Tablets), however, we recommend using a Desktop environment for the best model building experience.

We welcome contributions! Feel free to explore the code, report [issues](https://github.com/TuringLang/JuliaBUGS.jl/issues/new?template=doodlebugs.md), or suggest new features. Your involvement is highly encouraged and valued.

## Project Setup

```sh
npm install
```

### Compile and Hot-Reload for Development

```sh
npm run dev
```

### Type-Check, Compile and Minify for Production

```sh
npm run build
```

### Preview Production Build

```sh
npm run preview
```

### Linting and Formatting

````sh
# Run ESLint check
npm run lint
``

```sh
# Run ESLint with auto-fix
npm run lint:fix
````

```sh
# Format all files with Prettier
npm run format
```

```sh
# Check formatting (without modifying)
npm run format:check
```

```sh
# Run type checking
npm run type-check
```

For more information, questions, or to get involved, please contact [@shravanngoswamii](https://github.com/shravanngoswamii) (Ping me on [Julia Slack](https://julialang.slack.com/archives/CCYDC34A0)).

> [!TIP]
> You can generate a standalone Julia script for local run directly from the web app using the "Scripts" option in the right sidebar where you can configure parameters, copy, or download it.

## Acknowledgements & GSoC 2025

This project was initiated as part of the Google Summer of Code 2025 program.

- GSoC Project: [https://summerofcode.withgoogle.com/archive/2025/projects/4ecMbDwU](https://summerofcode.withgoogle.com/archive/2025/projects/4ecMbDwU)
- GSoC Report: [https://turinglang.org/GSoC-2025-Report-DoodleBUGS](https://turinglang.org/GSoC-2025-Report-DoodleBUGS)

**Contributor**: Shravan Goswami (Github: [@shravanngoswamii](https://github.com/shravanngoswamii))

**Mentors**: Xianda Sun (Github: [@sunxd3](https://github.com/sunxd3)) & Hong Ge (Github: [@yebai](https://github.com/yebai))

Special thanks to the [TuringLang](https://github.com/TuringLang) and [JuliaBUGS](https://github.com/TuringLang/JuliaBUGS.jl) community and contributors.



================================================
FILE: env.d.ts
================================================
/// <reference types="vite/client" />



================================================
FILE: eslint.config.ts
================================================
import { globalIgnores } from 'eslint/config'
import { defineConfigWithVueTs, vueTsConfigs } from '@vue/eslint-config-typescript'
import pluginVue from 'eslint-plugin-vue'
import skipFormatting from '@vue/eslint-config-prettier/skip-formatting'

// To allow more languages other than `ts` in `.vue` files, uncomment the following lines:
// import { configureVueProject } from '@vue/eslint-config-typescript'
// configureVueProject({ scriptLangs: ['ts', 'tsx'] })
// More info at https://github.com/vuejs/eslint-config-typescript/#advanced-setup

export default defineConfigWithVueTs(
  {
    name: 'app/files-to-lint',
    files: ['**/*.{ts,mts,tsx,vue}'],
  },

  globalIgnores(['**/dist/**', '**/dist-lib/**', '**/dist-ssr/**', '**/coverage/**']),

  pluginVue.configs['flat/essential'],
  vueTsConfigs.recommended,
  skipFormatting
)



================================================
FILE: index.html
================================================
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" href="https://turinglang.org/assets/favicon.ico" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="mobile-web-app-capable" content="yes" />
  <title>DoodleBUGS</title>
</head>

<body>
  <div id="app"></div>
  <script type="module" src="/src/main.ts"></script>
</body>

</html>


================================================
FILE: package.json
================================================
{
  "name": "doodlebugs",
  "version": "0.0.0",
  "private": true,
  "type": "module",
  "scripts": {
    "dev": "vite --host",
    "build": "run-p type-check \"build-only {@}\" --",
    "preview": "vite preview --host",
    "build-only": "vite build",
    "build:lib": "run-p type-check \"build-lib-only {@}\" --",
    "build-lib-only": "vite build --config vite.lib.config.ts",
    "build:all": "npm run build:lib && npm run build",
    "type-check": "vue-tsc --build --force",
    "lint": "eslint . --ext .vue,.ts,.mts,.tsx",
    "lint:fix": "eslint . --ext .vue,.ts,.mts,.tsx --fix",
    "format": "prettier --write \"**/*.{ts,mts,tsx,vue,json,md}\"",
    "format:check": "prettier --check \"**/*.{ts,mts,tsx,vue,json,md}\""
  },
  "dependencies": {
    "@primevue/themes": "^4.4.1",
    "@types/cytoscape": "^3.21.9",
    "codemirror": "^5.65.19",
    "cytoscape": "^3.32.0",
    "cytoscape-cola": "^2.5.1",
    "cytoscape-dagre": "^2.5.0",
    "cytoscape-fcose": "^2.2.0",
    "cytoscape-klay": "^3.1.4",
    "cytoscape-svg": "^0.4.0",
    "cytoscape-undo-redo": "^1.3.3",
    "pinia": "^3.0.2",
    "primeicons": "^7.0.0",
    "primevue": "^4.4.1",
    "vue": "^3.5.13"
  },
  "devDependencies": {
    "@tsconfig/node22": "^22.0.1",
    "@types/codemirror": "^5.60.16",
    "@types/node": "^22.14.0",
    "@vitejs/plugin-vue": "^5.2.3",
    "@vue/eslint-config-prettier": "^10.2.0",
    "@vue/eslint-config-typescript": "^14.5.0",
    "@vue/tsconfig": "^0.7.0",
    "eslint": "^9.22.0",
    "eslint-plugin-vue": "~10.0.0",
    "jiti": "^2.4.2",
    "npm-run-all2": "^7.0.2",
    "prettier": "^3.5.2",
    "typescript": "~5.8.0",
    "vite": "^6.3.6",
    "vite-plugin-vue-devtools": "^7.7.2",
    "vue-tsc": "^2.2.8"
  }
}



================================================
FILE: tsconfig.app.json
================================================
{
  "extends": "@vue/tsconfig/tsconfig.dom.json",
  "include": ["env.d.ts", "src/**/*", "src/**/*.vue"],
  "exclude": ["src/**/__tests__/*"],
  "compilerOptions": {
    "composite": true,
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.app.tsbuildinfo",
    "paths": {
      "@/*": ["./src/*"]
    },
    "types": ["vite/client"]
  }
}



================================================
FILE: tsconfig.json
================================================
{
  "files": [],
  "references": [
    {
      "path": "./tsconfig.node.json"
    },
    {
      "path": "./tsconfig.app.json"
    }
  ]
}



================================================
FILE: tsconfig.node.json
================================================
{
  "extends": "@tsconfig/node22/tsconfig.json",
  "include": [
    "vite.config.*",
    "vitest.config.*",
    "cypress.config.*",
    "nightwatch.conf.*",
    "playwright.config.*",
    "eslint.config.*"
  ],
  "compilerOptions": {
    "noEmit": true,
    "tsBuildInfoFile": "./node_modules/.tmp/tsconfig.node.tsbuildinfo",

    "module": "ESNext",
    "moduleResolution": "Bundler",
    "types": ["node"]
  }
}



================================================
FILE: vite.config.ts
================================================
import { fileURLToPath, URL } from 'node:url'
import { defineConfig, loadEnv } from 'vite'
import vue from '@vitejs/plugin-vue'
import vueDevTools from 'vite-plugin-vue-devtools'
import { resolve } from 'node:path'
import { copyFileSync, mkdirSync, existsSync, readFileSync, writeFileSync } from 'node:fs'

function copyWidgetDemo() {
  return {
    name: 'copy-widget-demo',
    closeBundle() {
      const distDir = resolve(__dirname, 'dist')
      const widgetDir = resolve(distDir, 'widget')
      const libDir = resolve(distDir, 'lib')

      if (!existsSync(widgetDir)) mkdirSync(widgetDir, { recursive: true })
      if (!existsSync(libDir)) mkdirSync(libDir, { recursive: true })

      const libFiles = ['doodlebugs.js', 'doodlebugs.css', 'doodlebugs.umd.cjs']
      libFiles.forEach((file) => {
        const src = resolve(__dirname, 'dist-lib', file)
        if (existsSync(src)) copyFileSync(src, resolve(libDir, file))
      })

      const demoSrc = resolve(__dirname, 'experiments/DoodleWidget/demo.html')
      let demoContent = readFileSync(demoSrc, 'utf-8')
      demoContent = demoContent
        .replace('../../dist-lib/doodlebugs.css', '../lib/doodlebugs.css')
        .replace('../../dist-lib/doodlebugs.js', '../lib/doodlebugs.js')
      writeFileSync(resolve(widgetDir, 'index.html'), demoContent)
    },
  }
}

export default defineConfig(({ mode }) => {
  const env = loadEnv(mode, process.cwd(), '')
  const baseUrl = env.VITE_APP_BASE_URL || '/'

  return {
    base: baseUrl,
    plugins: [vue(), vueDevTools(), copyWidgetDemo()],
    resolve: {
      alias: {
        '@': fileURLToPath(new URL('./src', import.meta.url)),
      },
    },
    build: {
      outDir: 'dist',
      emptyOutDir: true,
    },
  }
})



================================================
FILE: vite.lib.config.ts
================================================
import { fileURLToPath, URL } from 'node:url'
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'

export default defineConfig({
  base: './',
  plugins: [
    vue({
      template: {
        compilerOptions: {
          isCustomElement: (tag) => tag === 'doodle-bugs',
        },
      },
    }),
  ],
  resolve: {
    alias: {
      '@': fileURLToPath(new URL('./src', import.meta.url)),
    },
  },
  build: {
    outDir: 'dist-lib',
    lib: {
      entry: './src/main.ce.ts',
      name: 'DoodleBugs',
      fileName: 'doodlebugs',
    },
    rollupOptions: {
      output: {
        globals: {
          vue: 'Vue',
        },
        assetFileNames: (assetInfo) => {
          if (assetInfo.name === 'style.css') return 'doodlebugs.css'
          return assetInfo.name || ''
        },
      },
    },
    emptyOutDir: true,
    copyPublicDir: false,
  },
  define: {
    'process.env': {},
  },
})



================================================
FILE: .editorconfig
================================================
[*.{js,jsx,mjs,cjs,ts,tsx,mts,cts,vue,css,scss,sass,less,styl}]
charset = utf-8
indent_size = 2
indent_style = space
insert_final_newline = true
trim_trailing_whitespace = true

end_of_line = lf
max_line_length = 100



================================================
FILE: .prettierignore
================================================
node_modules
dist
dist-ssr
coverage
*.local
.vite
.DS_Store
package-lock.json
pnpm-lock.yaml
yarn.lock



================================================
FILE: .prettierrc
================================================
{
  "semi": false,
  "singleQuote": true,
  "tabWidth": 2,
  "trailingComma": "es5",
  "printWidth": 100,
  "arrowParens": "always",
  "endOfLine": "lf",
  "vueIndentScriptAndStyle": false
}



================================================
FILE: experiments/DoodleWidget/dashboard.html
================================================
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DoodleBUGS Widget - Dashboard Example</title>
    <link rel="stylesheet" href="../../dist-lib/doodlebugs.css">
    <script type="module" src="../../dist-lib/doodlebugs.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }

        .dashboard-header {
            padding: 20px 30px;
            background: rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dashboard-header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dashboard-header h1::before {
            content: "üìä";
        }

        .stats {
            display: flex;
            gap: 30px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #10b981;
        }

        .stat-label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .dashboard-content {
            padding: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
        }

        .widget-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .widget-card-header {
            padding: 16px 20px;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .widget-card-title {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .widget-card-badge {
            background: #10b981;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .widget-card-body {
            height: 450px;
        }

        .wide-card {
            grid-column: 1 / -1;
        }

        .wide-card .widget-card-body {
            height: 500px;
        }

        footer {
            text-align: center;
            padding: 40px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.85rem;
        }

        footer a {
            color: #10b981;
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .dashboard-content {
                grid-template-columns: 1fr;
            }

            .dashboard-header {
                flex-direction: column;
                gap: 20px;
            }

            .stats {
                width: 100%;
                justify-content: space-around;
            }
        }
    </style>
</head>

<body>
    <header class="dashboard-header">
        <h1>Model Dashboard</h1>
        <div class="stats">
            <div class="stat">
                <div class="stat-value">3</div>
                <div class="stat-label">Models</div>
            </div>
            <div class="stat">
                <div class="stat-value">12</div>
                <div class="stat-label">Nodes</div>
            </div>
            <div class="stat">
                <div class="stat-value">8</div>
                <div class="stat-label">Edges</div>
            </div>
        </div>
    </header>

    <main class="dashboard-content">
        <div class="widget-card">
            <div class="widget-card-header">
                <span class="widget-card-title">üêÄ Rats Model</span>
                <span class="widget-card-badge">Hierarchical</span>
            </div>
            <div class="widget-card-body">
                <doodle-bugs id="widget-1"></doodle-bugs>
            </div>
        </div>

        <div class="widget-card">
            <div class="widget-card-header">
                <span class="widget-card-title">üìà Regression Model</span>
                <span class="widget-card-badge">Linear</span>
            </div>
            <div class="widget-card-body">
                <doodle-bugs id="widget-2"></doodle-bugs>
            </div>
        </div>

        <div class="widget-card wide-card">
            <div class="widget-card-header">
                <span class="widget-card-title">üî¨ Full Project Workspace</span>
                <span class="widget-card-badge">Development</span>
            </div>
            <div class="widget-card-body">
                <doodle-bugs id="widget-3"></doodle-bugs>
            </div>
        </div>
    </main>

    <footer>
        <p>DoodleBUGS Dashboard ¬∑ Part of <a href="https://github.com/TuringLang/JuliaBUGS.jl">JuliaBUGS</a></p>
    </footer>
</body>

</html>


================================================
FILE: experiments/DoodleWidget/demo.html
================================================
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DoodleBUGS Widget Demo</title>
    <link rel="stylesheet" href="../../dist-lib/doodlebugs.css">
    <script type="module" src="../../dist-lib/doodlebugs.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            display: grid;
            grid-template-columns: 200px 1fr 200px;
            grid-template-rows: 50px 1fr;
        }

        .header {
            grid-column: 1 / -1;
            background: #9e9e9e;
        }

        .left-placeholder {
            background: #bdbdbd;
        }

        .right-placeholder {
            background: #bdbdbd;
        }

        .main-content {
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        #widget-container {
            width: 100%;
            height: 100%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="header"></div>
    <div class="left-placeholder"></div>
    <div class="main-content">
        <div id="widget-container">
            <doodle-bugs></doodle-bugs>
        </div>
    </div>
    <div class="right-placeholder"></div>
</body>
</html>



================================================
FILE: experiments/DoodleWidget/embedded-article.html
================================================
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DoodleBUGS Widget - Embedded Article Example</title>
    <link rel="stylesheet" href="../../dist-lib/doodlebugs.css">
    <script type="module" src="../../dist-lib/doodlebugs.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', 'Times New Roman', serif;
            line-height: 1.8;
            color: #333;
            background: #fafafa;
        }

        .article-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        header {
            text-align: center;
            padding: 60px 0 40px;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 40px;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 400;
            margin-bottom: 20px;
            color: #1a1a1a;
        }

        .meta {
            color: #666;
            font-size: 0.9rem;
        }

        h2 {
            font-size: 1.6rem;
            font-weight: 600;
            margin: 40px 0 20px;
            color: #1a1a1a;
        }

        p {
            margin-bottom: 20px;
            font-size: 1.1rem;
            text-align: justify;
        }

        .widget-section {
            margin: 60px 0;
            padding: 30px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .widget-section h3 {
            font-size: 1.2rem;
            color: #10b981;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .widget-container {
            width: 100%;
            height: 500px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        .callout {
            background: #f0fdf4;
            border-left: 4px solid #10b981;
            padding: 20px;
            margin: 30px 0;
            border-radius: 0 8px 8px 0;
        }

        .callout p {
            margin: 0;
            font-style: italic;
        }

        code {
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
        }

        footer {
            text-align: center;
            padding: 40px 0;
            border-top: 1px solid #e0e0e0;
            margin-top: 60px;
            color: #666;
            font-size: 0.9rem;
        }
    </style>
</head>

<body>
    <div class="article-container">
        <header>
            <h1>Introduction to Bayesian Graphical Models</h1>
            <p class="meta">Published: December 2024 √Ç¬∑ 10 min read</p>
        </header>

        <article>
            <p>Bayesian graphical models represent a powerful framework for reasoning under uncertainty. They combine
                the mathematical rigor of probability theory with the intuitive representation of dependencies through
                directed graphs.</p>

            <h2>What are Graphical Models?</h2>

            <p>A graphical model is a probabilistic model where a graph expresses the conditional dependence structure
                between random variables. The graph consists of nodes representing variables and edges representing
                probabilistic dependencies between them.</p>

            <p>There are two main types of graphical models: directed graphical models (also known as Bayesian networks)
                and undirected graphical models (also known as Markov random fields). In this article, we focus on
                directed acyclic graphs (DAGs), which are the foundation of Bayesian networks.</p>

            <div class="callout">
                <p>"The great power of graphical models lies in their ability to represent complex joint probability
                    distributions through simple local relationships."</p>
            </div>

            <h2>Interactive Model Builder</h2>

            <p>The DoodleBUGS widget below allows you to interactively build and visualize Bayesian graphical models.
                Try adding nodes, creating edges, and see how the BUGS code is generated in real-time.</p>

            <div class="widget-section">
                <h3>√∞≈∏≈Ω¬® Interactive DAG Builder</h3>
                <div class="widget-container">
                    <doodle-bugs></doodle-bugs>
                </div>
            </div>

            <p>The widget supports various node types including <code>stochastic</code> nodes (represented by circles),
                <code>deterministic</code> nodes (double circles), <code>constant</code> nodes (squares), and
                <code>observed</code> data nodes. You can also create plates to represent repeated structures.</p>

            <h2>The BUGS Language</h2>

            <p>BUGS (Bayesian inference Using Gibbs Sampling) is a probabilistic programming language for specifying
                statistical models. The visual representation in the widget above is automatically converted to valid
                BUGS code that can be executed in various inference engines.</p>

            <p>For example, a simple hierarchical model might look like this:</p>

            <pre><code>model {
  for (i in 1:N) {
    y[i] ~ dnorm(mu, tau)
  }
  mu ~ dnorm(0, 0.001)
  tau ~ dgamma(0.001, 0.001)
}</code></pre>

            <h2>Why Use Graphical Models?</h2>

            <p>Graphical models offer several advantages over traditional statistical approaches:</p>

            <p><strong>Interpretability:</strong> The visual structure makes it easy to understand the relationships
                between variables and communicate your model to others.</p>

            <p><strong>Modularity:</strong> Complex models can be built from simpler components, and missing data is
                handled naturally within the framework.</p>

            <p><strong>Flexibility:</strong> Graphical models can represent a wide variety of probability distributions
                and are not limited to specific parametric families.</p>

            <h2>Getting Started with JuliaBUGS</h2>

            <p>JuliaBUGS is a Julia implementation of the BUGS language that provides efficient inference for Bayesian
                graphical models. Combined with the DoodleBUGS visual editor, it offers a complete workflow from model
                design to inference.</p>

            <p>The widget you see above is designed to integrate seamlessly with JuliaBUGS, allowing you to export your
                visual models as executable Julia code. This bridges the gap between intuitive model building and
                production-ready code.</p>

            <h2>Conclusion</h2>

            <p>Bayesian graphical models provide a principled way to reason about uncertainty. With tools like
                DoodleBUGS and JuliaBUGS, building and running these models has never been more accessible. Give the
                interactive widget above a try and start exploring the world of probabilistic modeling!</p>
        </article>

        <footer>
            <p>Built with DoodleBUGS √Ç¬∑ Part of the JuliaBUGS Project</p>
        </footer>
    </div>
</body>

</html>


================================================
FILE: experiments/DoodleWidget/examples.html
================================================
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DoodleBUGS Widget Examples</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e9f0 100%);
            min-height: 100vh;
            padding: 60px 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 60px;
        }

        .logo {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #10b981, #059669);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #6b7280;
            font-size: 1.1rem;
        }

        .examples-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 60px;
        }

        .example-card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            text-decoration: none;
            color: inherit;
            display: block;
        }

        .example-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .example-icon {
            font-size: 2.5rem;
            margin-bottom: 16px;
        }

        .example-card h2 {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 10px;
        }

        .example-card p {
            color: #6b7280;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .example-tag {
            display: inline-block;
            background: #ecfdf5;
            color: #059669;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 16px;
        }

        .usage-section {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .usage-section h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #1f2937;
        }

        .code-block {
            background: #1f2937;
            color: #e5e7eb;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            margin: 20px 0;
        }

        .code-block .comment {
            color: #6b7280;
        }

        .code-block .tag {
            color: #f472b6;
        }

        .code-block .attr {
            color: #a5b4fc;
        }

        .code-block .string {
            color: #86efac;
        }

        footer {
            text-align: center;
            margin-top: 60px;
            color: #6b7280;
            font-size: 0.9rem;
        }

        footer a {
            color: #10b981;
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="logo">üé®</div>
            <h1>DoodleBUGS Widget</h1>
            <p class="subtitle">Interactive visual editor for Bayesian graphical models</p>
        </header>

        <section class="examples-grid">
            <a href="demo.html" class="example-card">
                <div class="example-icon">üì¶</div>
                <h2>Basic Demo</h2>
                <p>Simple grid layout demonstrating the widget in a constrained container with surrounding elements.</p>
                <span class="example-tag">Getting Started</span>
            </a>

            <a href="embedded-article.html" class="example-card">
                <div class="example-icon">üìÑ</div>
                <h2>Embedded Article</h2>
                <p>Long scrollable article with the widget embedded mid-content, simulating a blog or documentation
                    page.</p>
                <span class="example-tag">Scrollable</span>
            </a>

            <a href="dashboard.html" class="example-card">
                <div class="example-icon">üìä</div>
                <h2>Dashboard</h2>
                <p>Dashboard layout with multiple widgets side-by-side for comparing different models.</p>
                <span class="example-tag">Multi-Widget</span>
            </a>

            <a href="index.html" class="example-card"
                onclick="alert('Render index.qmd with Quarto first: quarto render index.qmd'); return false;">
                <div class="example-icon">üìù</div>
                <h2>Quarto Document</h2>
                <p>Integration example for Quarto documents. Render index.qmd to see the result.</p>
                <span class="example-tag">Quarto</span>
            </a>
        </section>

        <section class="usage-section">
            <h2>Quick Start</h2>
            <p>Add the DoodleBUGS widget to your HTML page:</p>

            <div class="code-block">
                <span class="comment">&lt;!-- Include CSS and JS from dist-lib --&gt;</span>
                <span class="tag">&lt;link</span> <span class="attr">rel=</span><span class="string">"stylesheet"</span>
                <span class="attr">href=</span><span class="string">"path/to/doodlebugs.css"</span><span
                    class="tag">&gt;</span>
                <span class="tag">&lt;script</span> <span class="attr">type=</span><span class="string">"module"</span>
                <span class="attr">src=</span><span class="string">"path/to/doodlebugs.js"</span><span
                    class="tag">&gt;&lt;/script&gt;</span>

                <span class="comment">&lt;!-- Use the widget --&gt;</span>
                <span class="tag">&lt;div</span> <span class="attr">style=</span><span class="string">"width: 100%;
                    height: 500px;"</span><span class="tag">&gt;</span>
                <span class="tag">&lt;doodle-bugs&gt;&lt;/doodle-bugs&gt;</span>
                <span class="tag">&lt;/div&gt;</span>
            </div>

            <p>Build the widget library using <code>npm run build:lib</code>, then copy
                <code>dist-lib/doodlebugs.js</code> and <code>dist-lib/doodlebugs.css</code> to your project.</p>
        </section>

        <footer>
            <p>Part of <a href="https://github.com/TuringLang/JuliaBUGS.jl">JuliaBUGS</a> ¬∑ DoodleBUGS Visual Editor</p>
        </footer>
    </div>
</body>

</html>


================================================
FILE: experiments/DoodleWidget/index.html
================================================
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Shravan Goswami">

<title>DoodleBUGS Widget Demo</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="index_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="index_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="index_files/libs/quarto-html/anchor.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="index_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="index_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="index_files/libs/bootstrap/bootstrap-9e3ffae467580fdb927a41352e75a2e0.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<link rel="stylesheet" href="doodlebugs.css">
<script type="module" src="doodlebugs.js"></script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a>
  <ul class="collapse">
  <li><a href="#what-are-bayesian-graphical-models" id="toc-what-are-bayesian-graphical-models" class="nav-link" data-scroll-target="#what-are-bayesian-graphical-models">What are Bayesian Graphical Models?</a></li>
  <li><a href="#interactive-model-builder" id="toc-interactive-model-builder" class="nav-link" data-scroll-target="#interactive-model-builder">Interactive Model Builder</a></li>
  <li><a href="#example-simple-linear-regression" id="toc-example-simple-linear-regression" class="nav-link" data-scroll-target="#example-simple-linear-regression">Example: Simple Linear Regression</a></li>
  <li><a href="#using-the-generated-code" id="toc-using-the-generated-code" class="nav-link" data-scroll-target="#using-the-generated-code">Using the Generated Code</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">DoodleBUGS Widget Demo</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Shravan Goswami </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>DoodleBUGS is a visual graphical model editor for building Bayesian models. It provides an intuitive drag-and-drop interface for constructing directed acyclic graphs (DAGs) that can be exported as BUGS code for inference in JuliaBUGS.</p>
<p>This document demonstrates how to embed the DoodleBUGS widget in a Quarto document, making it easy to create interactive tutorials and documentation.</p>
<section id="what-are-bayesian-graphical-models" class="level2">
<h2 class="anchored" data-anchor-id="what-are-bayesian-graphical-models">What are Bayesian Graphical Models?</h2>
<p>Bayesian graphical models, also known as Bayesian networks, are a way to represent joint probability distributions using a graph structure. Each node in the graph represents a random variable, and edges represent probabilistic dependencies between variables.</p>
<p>The key insight is that joint distributions can often be factored into simpler conditional distributions:</p>
<p><span class="math display">\[P(X_1, X_2, ..., X_n) = \prod_{i=1}^{n} P(X_i | Pa(X_i))\]</span></p>
<p>where <span class="math inline">\(Pa(X_i)\)</span> denotes the parent nodes of <span class="math inline">\(X_i\)</span> in the graph.</p>
</section>
<section id="interactive-model-builder" class="level2">
<h2 class="anchored" data-anchor-id="interactive-model-builder">Interactive Model Builder</h2>
<p>Below is an embedded DoodleBUGS widget. You can use it to:</p>
<ul>
<li><strong>Add nodes</strong> using the toolbar (stochastic, deterministic, constant, observed)</li>
<li><strong>Create edges</strong> by connecting nodes to represent dependencies</li>
<li><strong>Organize models</strong> using plates for repeated structures</li>
<li><strong>Export BUGS code</strong> that can be used with JuliaBUGS</li>
</ul>
<doodle-bugs></doodle-bugs>
</section>
<section id="example-simple-linear-regression" class="level2">
<h2 class="anchored" data-anchor-id="example-simple-linear-regression">Example: Simple Linear Regression</h2>
<p>A simple Bayesian linear regression model can be specified as:</p>
<p><span class="math display">\[y_i \sim \text{Normal}(\alpha + \beta x_i, \tau)\]</span></p>
<p>where:</p>
<ul>
<li><span class="math inline">\(\alpha\)</span> is the intercept</li>
<li><span class="math inline">\(\beta\)</span> is the slope coefficient<br>
</li>
<li><span class="math inline">\(\tau\)</span> is the precision (inverse variance)</li>
</ul>
<p>Try building this model in the widget above! You√¢‚Ç¨‚Ñ¢ll need:</p>
<ol type="1">
<li>A <strong>constant</strong> node for <span class="math inline">\(x\)</span></li>
<li><strong>Stochastic</strong> nodes for <span class="math inline">\(\alpha\)</span>, <span class="math inline">\(\beta\)</span>, and <span class="math inline">\(\tau\)</span> (with appropriate priors)</li>
<li>An <strong>observed</strong> node for <span class="math inline">\(y\)</span></li>
<li>Edges connecting the parameters to <span class="math inline">\(y\)</span></li>
</ol>
</section>
<section id="using-the-generated-code" class="level2">
<h2 class="anchored" data-anchor-id="using-the-generated-code">Using the Generated Code</h2>
<p>Once you√¢‚Ç¨‚Ñ¢ve built your model, you can export the BUGS code and use it with JuliaBUGS:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">JuliaBUGS</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Paste your generated BUGS model here</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>model_code <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="st">model {</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="st">    # Your model specification</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Compile and run inference</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> <span class="fu">compile</span>(model_code, data)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>samples <span class="op">=</span> <span class="fu">sample</span>(model, <span class="fu">NUTS</span>(), <span class="fl">1000</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>DoodleBUGS makes it easy to visualize and build Bayesian models interactively. Combined with Quarto documents, you can create engaging tutorials that let readers experiment with models directly in the browser.</p>
<hr>
<p><em>Built with DoodleBUGS √Ç¬∑ Part of the JuliaBUGS Project</em></p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "√Æ¬ß‚Äπ";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>


================================================
FILE: experiments/DoodleWidget/index.qmd
================================================
---
title: "DoodleBUGS Widget Demo"
author: "Shravan Goswami"
include-in-header: 
    - text: |
        <link rel="stylesheet" href="doodlebugs.css">
        <script type="module" src="doodlebugs.js"></script>
toc: true
---

# Introduction

DoodleBUGS is a visual graphical model editor for building Bayesian models. It provides an intuitive drag-and-drop interface for constructing directed acyclic graphs (DAGs) that can be exported as BUGS code for inference in JuliaBUGS.

This document demonstrates how to embed the DoodleBUGS widget in a Quarto document, making it easy to create interactive tutorials and documentation.

## What are Bayesian Graphical Models?

Bayesian graphical models, also known as Bayesian networks, are a way to represent joint probability distributions using a graph structure. Each node in the graph represents a random variable, and edges represent probabilistic dependencies between variables.

The key insight is that joint distributions can often be factored into simpler conditional distributions:

$$P(X_1, X_2, ..., X_n) = \prod_{i=1}^{n} P(X_i | Pa(X_i))$$

where $Pa(X_i)$ denotes the parent nodes of $X_i$ in the graph.

## Interactive Model Builder

Below is an embedded DoodleBUGS widget. You can use it to:

- **Add nodes** using the toolbar (stochastic, deterministic, constant, observed)
- **Create edges** by connecting nodes to represent dependencies
- **Organize models** using plates for repeated structures
- **Export BUGS code** that can be used with JuliaBUGS

```{=html}
<doodle-bugs></doodle-bugs>
```

## Example: Simple Linear Regression

A simple Bayesian linear regression model can be specified as:

$$y_i \sim \text{Normal}(\alpha + \beta x_i, \tau)$$

where:

- $\alpha$ is the intercept
- $\beta$ is the slope coefficient  
- $\tau$ is the precision (inverse variance)

Try building this model in the widget above! You'll need:

1. A **constant** node for $x$
2. **Stochastic** nodes for $\alpha$, $\beta$, and $\tau$ (with appropriate priors)
3. An **observed** node for $y$
4. Edges connecting the parameters to $y$

## Using the Generated Code

Once you've built your model, you can export the BUGS code and use it with JuliaBUGS:

```julia
using JuliaBUGS

# Paste your generated BUGS model here
model_code = """
model {
    # Your model specification
}
"""

# Compile and run inference
model = compile(model_code, data)
samples = sample(model, NUTS(), 1000)
```

## Conclusion

DoodleBUGS makes it easy to visualize and build Bayesian models interactively. Combined with Quarto documents, you can create engaging tutorials that let readers experiment with models directly in the browser.

---

*Built with DoodleBUGS √Ç¬∑ Part of the JuliaBUGS Project*



================================================
FILE: public/examples/rats/model.json
================================================
{
  "name": "Rats: A Normal Hierarchical Model",
  "elements": [
    {
      "id": "plate_i",
      "name": "Plate.i",
      "type": "node",
      "nodeType": "plate",
      "position": {
        "x": 342.5,
        "y": 350
      },
      "loopVariable": "i",
      "loopRange": "1:N"
    },
    {
      "id": "plate_j",
      "name": "Plate.j",
      "type": "node",
      "nodeType": "plate",
      "position": {
        "x": 514,
        "y": 355
      },
      "parent": "plate_i",
      "loopVariable": "j",
      "loopRange": "1:T"
    },
    {
      "id": "node_Y",
      "name": "Y",
      "type": "node",
      "nodeType": "observed",
      "position": {
        "x": 513,
        "y": 487
      },
      "parent": "plate_j",
      "distribution": "dnorm",
      "indices": "i,j",
      "observed": true,
      "param1": "mu",
      "param2": "tau.c"
    },
    {
      "id": "node_mu",
      "name": "mu",
      "type": "node",
      "nodeType": "deterministic",
      "position": {
        "x": 513,
        "y": 355
      },
      "parent": "plate_j",
      "equation": "alpha[i] + beta[i] * (x[j] - xbar)",
      "indices": "i,j"
    },
    {
      "id": "node_alpha",
      "name": "alpha",
      "type": "node",
      "nodeType": "stochastic",
      "position": {
        "x": 153,
        "y": 223
      },
      "parent": "plate_i",
      "distribution": "dnorm",
      "indices": "i",
      "param1": "alpha.c",
      "param2": "alpha.tau"
    },
    {
      "id": "node_beta",
      "name": "beta",
      "type": "node",
      "nodeType": "stochastic",
      "position": {
        "x": 343,
        "y": 223
      },
      "parent": "plate_i",
      "distribution": "dnorm",
      "indices": "i",
      "param1": "beta.c",
      "param2": "beta.tau"
    },
    {
      "id": "node_tau.c",
      "name": "tau.c",
      "type": "node",
      "nodeType": "stochastic",
      "position": {
        "x": 735,
        "y": 355
      },
      "distribution": "dgamma",
      "param1": "0.001",
      "param2": "0.001"
    },
    {
      "id": "node_sigma",
      "name": "sigma",
      "type": "node",
      "nodeType": "deterministic",
      "position": {
        "x": 735,
        "y": 487
      },
      "equation": "1 / sqrt(tau.c)"
    },
    {
      "id": "node_alpha.c",
      "name": "alpha.c",
      "type": "node",
      "nodeType": "stochastic",
      "position": {
        "x": 317,
        "y": 41
      },
      "distribution": "dnorm",
      "param1": "0.0",
      "param2": "1.0E-6"
    },
    {
      "id": "node_alpha.tau",
      "name": "alpha.tau",
      "type": "node",
      "nodeType": "stochastic",
      "position": {
        "x": 41,
        "y": 41
      },
      "distribution": "dgamma",
      "param1": "0.001",
      "param2": "0.001"
    },
    {
      "id": "node_beta.c",
      "name": "beta.c",
      "type": "node",
      "nodeType": "stochastic",
      "position": {
        "x": 581,
        "y": 41
      },
      "distribution": "dnorm",
      "param1": "0.0",
      "param2": "1.0E-6"
    },
    {
      "id": "node_beta.tau",
      "name": "beta.tau",
      "type": "node",
      "nodeType": "stochastic",
      "position": {
        "x": 449,
        "y": 41
      },
      "distribution": "dgamma",
      "param1": "0.001",
      "param2": "0.001"
    },
    {
      "id": "node_alpha0",
      "name": "alpha0",
      "type": "node",
      "nodeType": "deterministic",
      "position": {
        "x": 735,
        "y": 223
      },
      "equation": "alpha.c - xbar * beta.c"
    },
    {
      "id": "node_x",
      "name": "x",
      "type": "node",
      "nodeType": "constant",
      "position": {
        "x": 515,
        "y": 223
      },
      "indices": "j",
      "parent": "plate_j"
    },
    {
      "id": "node_xbar",
      "name": "xbar",
      "type": "node",
      "nodeType": "constant",
      "position": {
        "x": 821,
        "y": 41
      }
    },
    {
      "id": "edge_mu_to_y",
      "type": "edge",
      "source": "node_mu",
      "target": "node_Y"
    },
    {
      "id": "edge_tauc_to_y",
      "type": "edge",
      "source": "node_tau.c",
      "target": "node_Y"
    },
    {
      "id": "edge_alphai_to_mu",
      "type": "edge",
      "source": "node_alpha",
      "target": "node_mu"
    },
    {
      "id": "edge_betai_to_mu",
      "type": "edge",
      "source": "node_beta",
      "target": "node_mu"
    },
    {
      "id": "edge_x_to_mu",
      "type": "edge",
      "source": "node_x",
      "target": "node_mu"
    },
    {
      "id": "edge_xbar_to_mu",
      "type": "edge",
      "source": "node_xbar",
      "target": "node_mu"
    },
    {
      "id": "edge_alphac_to_alphai",
      "type": "edge",
      "source": "node_alpha.c",
      "target": "node_alpha"
    },
    {
      "id": "edge_alphatau_to_alphai",
      "type": "edge",
      "source": "node_alpha.tau",
      "target": "node_alpha"
    },
    {
      "id": "edge_betac_to_betai",
      "type": "edge",
      "source": "node_beta.c",
      "target": "node_beta"
    },
    {
      "id": "edge_betatau_to_betai",
      "type": "edge",
      "source": "node_beta.tau",
      "target": "node_beta"
    },
    {
      "id": "edge_tauc_to_sigma",
      "type": "edge",
      "source": "node_tau.c",
      "target": "node_sigma"
    },
    {
      "id": "edge_alphac_to_alpha0",
      "type": "edge",
      "source": "node_alpha.c",
      "target": "node_alpha0"
    },
    {
      "id": "edge_xbar_to_alpha0",
      "type": "edge",
      "source": "node_xbar",
      "target": "node_alpha0"
    },
    {
      "id": "edge_betac_to_alpha0",
      "type": "edge",
      "source": "node_beta.c",
      "target": "node_alpha0"
    }
  ],
  "dataContent": "{\n  \"data\": {\n    \"N\": 30,\n    \"T\": 5,\n    \"x\": [\n      8,\n      15,\n      22,\n      29,\n      36\n    ],\n    \"xbar\": 22,\n    \"Y\": [\n      [\n        151,\n        199,\n        246,\n        283,\n        320\n      ],\n      [\n        145,\n        199,\n        249,\n        293,\n        354\n      ],\n      [\n        147,\n        214,\n        263,\n        312,\n        328\n      ],\n      [\n        155,\n        200,\n        237,\n        272,\n        297\n      ],\n      [\n        135,\n        188,\n        230,\n        280,\n        323\n      ],\n      [\n        159,\n        210,\n        252,\n        298,\n        331\n      ],\n      [\n        141,\n        189,\n        231,\n        275,\n        305\n      ],\n      [\n        159,\n        201,\n        248,\n        297,\n        338\n      ],\n      [\n        177,\n        236,\n        285,\n        350,\n        376\n      ],\n      [\n        134,\n        182,\n        220,\n        260,\n        296\n      ],\n      [\n        160,\n        208,\n        261,\n        313,\n        352\n      ],\n      [\n        143,\n        188,\n        220,\n        273,\n        314\n      ],\n      [\n        154,\n        200,\n        244,\n        289,\n        325\n      ],\n      [\n        171,\n        221,\n        270,\n        326,\n        358\n      ],\n      [\n        163,\n        216,\n        242,\n        281,\n        312\n      ],\n      [\n        160,\n        207,\n        248,\n        288,\n        324\n      ],\n      [\n        142,\n        187,\n        234,\n        280,\n        316\n      ],\n      [\n        156,\n        203,\n        243,\n        283,\n        317\n      ],\n      [\n        157,\n        212,\n        259,\n        307,\n        336\n      ],\n      [\n        152,\n        203,\n        246,\n        286,\n        321\n      ],\n      [\n        154,\n        205,\n        253,\n        298,\n        334\n      ],\n      [\n        139,\n        190,\n        225,\n        267,\n        302\n      ],\n      [\n        146,\n        191,\n        229,\n        272,\n        302\n      ],\n      [\n        157,\n        211,\n        250,\n        285,\n        323\n      ],\n      [\n        132,\n        185,\n        237,\n        286,\n        331\n      ],\n      [\n        160,\n        207,\n        257,\n        303,\n        345\n      ],\n      [\n        169,\n        216,\n        261,\n        295,\n        333\n      ],\n      [\n        157,\n        205,\n        248,\n        289,\n        316\n      ],\n      [\n        137,\n        180,\n        219,\n        258,\n        291\n      ],\n      [\n        153,\n        200,\n        244,\n        286,\n        324\n      ]\n    ]\n  },\n  \"inits\": {\n    \"alpha\": [\n      250,\n      250,\n      250,\n      250,\n      250,\n      250,\n      250,\n      250,\n      250,\n      250,\n      250,\n      250,\n      250,\n      250,\n      250,\n      250,\n      250,\n      250,\n      250,\n      250,\n      250,\n      250,\n      250,\n      250,\n      250,\n      250,\n      250,\n      250,\n      250,\n      250\n    ],\n    \"beta\": [\n      6,\n      6,\n      6,\n      6,\n      6,\n      6,\n      6,\n      6,\n      6,\n      6,\n      6,\n      6,\n      6,\n      6,\n      6,\n      6,\n      6,\n      6,\n      6,\n      6,\n      6,\n      6,\n      6,\n      6,\n      6,\n      6,\n      6,\n      6,\n      6,\n      6\n    ],\n    \"alpha.c\": 150,\n    \"beta.c\": 10,\n    \"tau.c\": 1,\n    \"alpha.tau\": 1,\n    \"beta.tau\": 1\n  }\n}",
  "version": 1,
  "layout": {
    "showCodePanel": false,
    "codePanelWidth": 400,
    "codePanelHeight": 300,
    "showDataPanel": true,
    "dataPanelX": 40,
    "dataPanelY": 90,
    "dataPanelWidth": 400,
    "dataPanelHeight": 300
  }
}


================================================
FILE: src/App.vue
================================================
<script setup lang="ts">
import MainLayout from './components/layouts/MainLayout.vue'
import Toast from 'primevue/toast'
</script>

<template>
  <MainLayout />
  <Toast position="top-center" />
</template>



================================================
FILE: src/DoodleWidget.vue
================================================
<script setup lang="ts">
import { ref, onMounted, onUnmounted, watch, computed, reactive, nextTick } from 'vue'
import { storeToRefs } from 'pinia'
import Toast from 'primevue/toast'

import GraphEditor from './components/canvas/GraphEditor.vue'
import FloatingBottomToolbar from './components/canvas/FloatingBottomToolbar.vue'
import FloatingPanel from './components/common/FloatingPanel.vue'
import LeftSidebar from './components/layouts/LeftSidebar.vue'
import RightSidebar from './components/layouts/RightSidebar.vue'
import CodePreviewPanel from './components/panels/CodePreviewPanel.vue'
import DataInputPanel from './components/panels/DataInputPanel.vue'
import AboutModal from './components/layouts/AboutModal.vue'
import FaqModal from './components/layouts/FaqModal.vue'
import ExportModal from './components/layouts/ExportModal.vue'
import GraphStyleModal from './components/layouts/GraphStyleModal.vue'
import ShareModal from './components/layouts/ShareModal.vue'
import ValidationIssuesModal from './components/layouts/ValidationIssuesModal.vue'
import BaseModal from './components/common/BaseModal.vue'
import DebugPanel from './components/common/DebugPanel.vue'
import BaseButton from './components/ui/BaseButton.vue'
import BaseInput from './components/ui/BaseInput.vue'
import ScriptSettingsPanel from './components/panels/ScriptSettingsPanel.vue'

import { useProjectStore } from './stores/projectStore'
import { useGraphStore } from './stores/graphStore'
import { useUiStore } from './stores/uiStore'
import { useDataStore } from './stores/dataStore'
import { useScriptStore } from './stores/scriptStore'
import { useGraphElements } from './composables/useGraphElements'
import { useBugsCodeGenerator, generateStandaloneScript } from './composables/useBugsCodeGenerator'
import { useGraphValidator } from './composables/useGraphValidator'
import { useGraphInstance } from './composables/useGraphInstance'
import { useGraphLayout } from './composables/useGraphLayout'
import { usePersistence } from './composables/usePersistence'
import { useShareExport } from './composables/useShareExport'
import { useImportExport } from './composables/useImportExport'
import type { NodeType, GraphElement } from './types'
import { examples, isUrl } from './config/examples'

const props = defineProps<{
  initialState?: string
  defaultModel?: string
}>()

const emit = defineEmits<{
  (e: 'state-update', payload: string): void
  (e: 'code-update', payload: string): void
}>()

const projectStore = useProjectStore()
const graphStore = useGraphStore()
const uiStore = useUiStore()
const dataStore = useDataStore()
const scriptStore = useScriptStore()

// Ensure sidebars are closed by default for the widget
uiStore.isLeftSidebarOpen = false
uiStore.isRightSidebarOpen = false

// Widget-specific flag to prevent sidebar flash during initialization
const widgetInitialized = ref(false)

// Widget Viewport & Edit Mode State
const widgetRoot = ref<HTMLElement | null>(null)
const isWidgetInView = ref(true) // Default to true to prevent initial flash
const isEditMode = ref(false)
let observer: IntersectionObserver | null = null

const currentMode = ref('select')
const currentNodeType = ref<NodeType>('stochastic')

const showAboutModal = ref(false)
const showFaqModal = ref(false)
const showExportModal = ref(false)
const currentExportType = ref<'png' | 'jpg' | 'svg' | null>(null)
const showStyleModal = ref(false)
const showShareModal = ref(false)
const showValidationModal = ref(false)
const showScriptSettingsModal = ref(false)
const showNewProjectModal = ref(false)
const showNewGraphModal = ref(false)
const newProjectName = ref('')
const newGraphName = ref('')

// Panel positions and sizes
const codePanelPos = reactive({ x: 0, y: 0 })
const codePanelSize = reactive({ width: 400, height: 300 })
const dataPanelPos = reactive({ x: 0, y: 0 })
const dataPanelSize = reactive({ width: 400, height: 300 })

// Import Graph State
const graphImportInput = ref<HTMLInputElement | null>(null)
const isDragOver = ref(false)

// UI Dragging State
const isDraggingUI = ref(false)

// Computed window width
const windowWidth = ref(typeof window !== 'undefined' ? window.innerWidth : 1920)

// Flag to prevent premature canvas rendering
const isInitialized = ref(false)

// LocalStorage key for widget UI state
const WIDGET_UI_STATE_KEY = 'doodlebugs-widget-ui-state'

const { loadUIState, saveUIState, getStoredGraphElements, getStoredDataContent } =
  usePersistence('doodlebugs')

const saveWidgetUIState = () => {
  saveUIState(WIDGET_UI_STATE_KEY, {
    leftSidebar: {
      open: uiStore.isLeftSidebarOpen,
      x: leftDrag.x.value,
      y: leftDrag.y.value,
    },
    rightSidebar: {
      open: uiStore.isRightSidebarOpen,
      x: rightDrag.x.value,
      y: rightDrag.y.value,
    },
    codePanel: {
      open: isCodePanelOpen.value,
      x: codePanelPos.x,
      y: codePanelPos.y,
      width: codePanelSize.width,
      height: codePanelSize.height,
    },
    dataPanel: {
      open: isDataPanelOpen.value,
      x: dataPanelPos.x,
      y: dataPanelPos.y,
      width: dataPanelSize.width,
      height: dataPanelSize.height,
    },
    currentGraphId: graphStore.currentGraphId || undefined,
    // Persist edit mode
    editMode: isEditMode.value,
  })
}

const { elements, selectedElement, updateElement, deleteElement } = useGraphElements()
const { parsedGraphData } = storeToRefs(dataStore)
const { generatedCode } = useBugsCodeGenerator(elements)
const { validateGraph, validationErrors } = useGraphValidator(elements, parsedGraphData)
const { getCyInstance, getUndoRedoInstance } = useGraphInstance()
const { smartFit, applyLayoutWithFit } = useGraphLayout()
const { shareUrl, minifyGraph, generateShareLink } = useShareExport()
const { importedGraphData, processGraphFile, clearImportedData } = useImportExport()

// CSS for teleported widget content
// NOTE: Z-index for PrimeVue components (popovers, dropdowns) must be > sidebar wrapper (2200)
// We set them to 3000 to ensure they appear on top.
const WIDGET_STYLES_ID = 'doodlebugs-widget-teleport-styles'

const widgetTeleportCSS = `
/* DoodleBUGS Widget - Teleported Content Styles */
.db-ui-overlay,
.db-sidebar-wrapper,
.db-floating-panel,
.p-dialog,
.p-popover,
.p-toast,
.p-select-overlay,
.p-tooltip {
  font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  font-size: 12px;
  line-height: 1.5;
  letter-spacing: normal;
  font-weight: 400;
  color: var(--theme-text-primary, #1f2937);
  box-sizing: border-box;
}

.db-ui-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 2000;
  pointer-events: none;
}

.db-ui-overlay > * {
  pointer-events: auto;
}

/* Specifically target the toolbar container to ensure it is clickable */
.db-ui-overlay .db-toolbar-container {
  pointer-events: auto !important;
}

.db-sidebar-wrapper {
  position: fixed;
  pointer-events: auto;
  z-index: 2200;
  display: flex;
  flex-direction: row;
  align-items: flex-start;
  gap: 4px;
  left: 0;
  top: 0;
}

/* Override RightSidebar positioning for widget mode */
/* Forces the sidebar to respect the wrapper's flow rather than its internal absolute positioning */
.db-sidebar-wrapper.db-right .db-floating-sidebar.db-right {
  position: relative !important;
  right: auto !important;
  left: auto !important;
  margin: 0 !important;
  /* Re-apply shadow that might be clipped or reset */
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); 
}

/* Force PrimeVue overlays to appear above our sidebars */
.p-popover,
.p-select-overlay,
.p-dialog,
.p-toast,
.p-tooltip {
  z-index: 3000 !important;
}

.p-dialog-mask {
  z-index: 2900 !important;
}
`

const injectWidgetStyles = () => {
  if (document.getElementById(WIDGET_STYLES_ID)) return
  const styleElement = document.createElement('style')
  styleElement.id = WIDGET_STYLES_ID
  styleElement.textContent = widgetTeleportCSS
  document.head.appendChild(styleElement)
}

const removeWidgetStyles = () => {
  const styleElement = document.getElementById(WIDGET_STYLES_ID)
  if (styleElement) {
    styleElement.remove()
  }
}

const initGraph = async () => {
  if (projectStore.projects.length === 0) {
    projectStore.createProject('Default Project')
  }

  if (!projectStore.currentProjectId && projectStore.projects.length > 0) {
    projectStore.selectProject(projectStore.projects[0].id)
  }

  const proj = projectStore.currentProject
  if (!proj) return

  // Logic for default-model prop
  // If prop provided, try to load it first
  if (props.defaultModel) {
    await handleLoadExample(props.defaultModel)
  }

  // If after checking prop we still have no graphs, create a default one
  if (proj.graphs.length === 0) {
    projectStore.addGraphToProject(proj.id, 'Model 1')
  }

  // If no graph selected, select the first one
  if (proj.graphs.length > 0 && !graphStore.currentGraphId) {
    graphStore.selectGraph(proj.graphs[0].id)
  }

  if (graphStore.currentGraphId && !graphStore.graphContents.has(graphStore.currentGraphId)) {
    graphStore.createNewGraphContent(graphStore.currentGraphId)
  }
}

const toggleEditMode = () => {
  isEditMode.value = !isEditMode.value
  if (!isEditMode.value) {
    // When stopping edit, close sidebars
    uiStore.isLeftSidebarOpen = false
    uiStore.isRightSidebarOpen = false
  }
  // Save state immediately when toggled
  saveWidgetUIState()
}

// Handler to force Cytoscape resize on scroll
// This fixes the issue where click coordinates are offset after scrolling the host page
const handleWindowScroll = () => {
  if (graphStore.currentGraphId) {
    const cy = getCyInstance(graphStore.currentGraphId)
    if (cy) {
      cy.resize()
    }
  }
}

onMounted(async () => {
  // Intersection Observer for Widget View
  if (widgetRoot.value) {
    observer = new IntersectionObserver(
      (entries) => {
        isWidgetInView.value = entries[0].isIntersecting
      },
      { threshold: 0.1 }
    )
    observer.observe(widgetRoot.value)
  }

  // Attach scroll listener to fix coordinate offsets
  window.addEventListener('scroll', handleWindowScroll, { passive: true, capture: true })

  graphStore.selectGraph(undefined as unknown as string)

  projectStore.loadProjects()

  if (props.initialState) {
    try {
      const state = JSON.parse(props.initialState)
      if (state.project) projectStore.importState(state.project)
      if (state.graphs)
        state.graphs.forEach(
          (g: {
            graphId: string
            elements: GraphElement[]
            lastLayout?: string
            zoom?: number
            pan?: { x: number; y: number }
          }) => graphStore.graphContents.set(g.graphId, g)
        )
      if (state.data)
        state.data.forEach((d: { graphId: string; content: string }) =>
          dataStore.updateGraphData(d.graphId, { content: d.content })
        )
    } catch (e) {
      console.error('DoodleBUGS: Failed to parse state', e)
    }
  }

  const savedUIState = loadUIState(WIDGET_UI_STATE_KEY)
  let rightSidebarLoaded = false

  if (savedUIState) {
    if (savedUIState.leftSidebar) {
      leftDrag.x.value = savedUIState.leftSidebar.x
      leftDrag.y.value = savedUIState.leftSidebar.y
      uiStore.isLeftSidebarOpen = savedUIState.leftSidebar.open
    }
    if (savedUIState.rightSidebar) {
      rightDrag.x.value = savedUIState.rightSidebar.x
      rightDrag.y.value = savedUIState.rightSidebar.y
      uiStore.isRightSidebarOpen = savedUIState.rightSidebar.open
      rightSidebarLoaded = true
    }
    if (savedUIState.codePanel) {
      codePanelPos.x = savedUIState.codePanel.x
      codePanelPos.y = savedUIState.codePanel.y
      codePanelSize.width = savedUIState.codePanel.width
      codePanelSize.height = savedUIState.codePanel.height
    }
    if (savedUIState.dataPanel) {
      dataPanelPos.x = savedUIState.dataPanel.x
      dataPanelPos.y = savedUIState.dataPanel.y
      dataPanelSize.width = savedUIState.dataPanel.width
      dataPanelSize.height = savedUIState.dataPanel.height
    }
    if (savedUIState.currentGraphId) {
      graphStore.selectGraph(savedUIState.currentGraphId)
    }
    // FIX: Removed casting to any and accessing editMode safely
    if (savedUIState.editMode !== undefined) {
      isEditMode.value = savedUIState.editMode
    }
  }

  // Force default right sidebar position if not loaded from state or looks invalid
  nextTick(() => {
    const docWidth = document.documentElement.clientWidth || window.innerWidth
    const defaultRightX = docWidth - 320 - 20

    if (!rightSidebarLoaded || rightDrag.x.value <= 0 || docWidth - rightDrag.x.value > 450) {
      rightDrag.x.value = defaultRightX
    }
    if (!rightSidebarLoaded) {
      rightDrag.y.value = 10
    }
  })

  await initGraph()
  isInitialized.value = true
  widgetInitialized.value = true
  validateGraph()

  injectWidgetStyles()

  const handleResize = () => {
    windowWidth.value = window.innerWidth
    if (window.innerWidth - rightDrag.x.value < 500) {
      rightDrag.x.value = window.innerWidth - 320 - 4
    }
  }
  window.addEventListener('resize', handleResize)

  onUnmounted(() => {
    window.removeEventListener('resize', handleResize)
    window.removeEventListener('scroll', handleWindowScroll, { capture: true })
    if (observer) observer.disconnect()
  })
})

onUnmounted(() => {
  document.body.classList.remove('db-dark-mode')
  document.documentElement.classList.remove('db-dark-mode')
  removeWidgetStyles()
})

watch(
  [() => projectStore.projects, () => graphStore.graphContents, () => dataStore.dataContent],
  () => {
    const fullState = {
      project: projectStore.exportState(),
      graphs: Array.from(graphStore.graphContents.entries()).map(([, v]) => v),
      data: Array.from(graphStore.graphContents.keys()).map((gid) => ({
        graphId: gid,
        content: dataStore.getGraphData(gid).content,
      })),
    }
    emit('state-update', JSON.stringify(fullState))
  },
  { deep: true }
)

watch(generatedCode, (code) => {
  emit('code-update', code)
})

// Unified Example Loader Logic
const handleLoadExample = async (exampleIdOrUrl: string) => {
  if (!projectStore.currentProjectId) return

  try {
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    let modelData: any = null
    let modelName = 'Imported Model'

    const config = examples.find((e) => e.id === exampleIdOrUrl)

    if (config) {
      modelName = config.name
      if (config.type === 'local' && config.data) {
        modelData = config.data
      } else if (config.url) {
        const response = await fetch(config.url)
        if (!response.ok) throw new Error(`Fetch failed: ${response.statusText}`)
        modelData = await response.json()
      }
    } else if (isUrl(exampleIdOrUrl)) {
      const response = await fetch(exampleIdOrUrl)
      if (!response.ok) throw new Error(`Fetch failed: ${response.statusText}`)
      modelData = await response.json()
      modelName = modelData.name || 'Remote Model'
    } else {
      console.warn(`Unknown example ID: ${exampleIdOrUrl}`)
      return
    }

    if (modelData) {
      const newGraphMeta = projectStore.addGraphToProject(
        projectStore.currentProjectId,
        modelData.name || modelName
      )
      if (!newGraphMeta) return

      // Handle Elements (FIX: Typed as GraphElement[])
      if (modelData.elements) {
        graphStore.updateGraphElements(newGraphMeta.id, modelData.elements as GraphElement[])
      } else if (modelData.graphJSON) {
        // Legacy support
        graphStore.updateGraphElements(newGraphMeta.id, modelData.graphJSON as GraphElement[])
      }

      // Handle Data/Inits
      if (modelData.dataContent) {
        dataStore.updateGraphData(newGraphMeta.id, { content: modelData.dataContent })
      } else if (modelData.data || modelData.inits) {
        // Legacy separate fields
        const content = JSON.stringify(
          { data: modelData.data || {}, inits: modelData.inits || {} },
          null,
          2
        )
        dataStore.updateGraphData(newGraphMeta.id, { content })
      }

      // Handle Layout
      graphStore.updateGraphLayout(newGraphMeta.id, 'preset')
      if (modelData.layout) {
        projectStore.updateGraphLayout(
          projectStore.currentProjectId,
          newGraphMeta.id,
          modelData.layout
        )
      }

      graphStore.selectGraph(newGraphMeta.id)
    }
  } catch (error) {
    console.error('Failed to load example model:', error)
  }
}

const isCodePanelOpen = computed(() => {
  if (!projectStore.currentProject || !graphStore.currentGraphId) return false
  const graph = projectStore.currentProject.graphs.find((g) => g.id === graphStore.currentGraphId)
  return !!graph?.showCodePanel
})

const toggleCodePanel = () => {
  if (!projectStore.currentProject || !graphStore.currentGraphId) return
  const graph = projectStore.currentProject.graphs.find((g) => g.id === graphStore.currentGraphId)
  if (graph) {
    projectStore.updateGraphLayout(projectStore.currentProject.id, graphStore.currentGraphId, {
      showCodePanel: !graph.showCodePanel,
    })
  }
}

const isDataPanelOpen = computed(() => {
  if (!projectStore.currentProject || !graphStore.currentGraphId) return false
  const graph = projectStore.currentProject.graphs.find((g) => g.id === graphStore.currentGraphId)
  return !!graph?.showDataPanel
})

const toggleDataPanel = () => {
  if (!projectStore.currentProject || !graphStore.currentGraphId) return
  const graph = projectStore.currentProject.graphs.find((g) => g.id === graphStore.currentGraphId)
  if (graph) {
    projectStore.updateGraphLayout(projectStore.currentProject.id, graphStore.currentGraphId, {
      showDataPanel: !graph.showDataPanel,
    })
  }
}

const handleUndo = () => {
  if (graphStore.currentGraphId) getUndoRedoInstance(graphStore.currentGraphId)?.undo()
}
const handleRedo = () => {
  if (graphStore.currentGraphId) getUndoRedoInstance(graphStore.currentGraphId)?.redo()
}
const handleZoomIn = () => {
  if (graphStore.currentGraphId)
    getCyInstance(graphStore.currentGraphId)?.zoom(
      getCyInstance(graphStore.currentGraphId)!.zoom() * 1.2
    )
}
const handleZoomOut = () => {
  if (graphStore.currentGraphId)
    getCyInstance(graphStore.currentGraphId)?.zoom(
      getCyInstance(graphStore.currentGraphId)!.zoom() * 0.8
    )
}
const handleFit = () => {
  if (graphStore.currentGraphId) {
    const cy = getCyInstance(graphStore.currentGraphId)
    if (cy) smartFit(cy, true)
  }
}

const handleGraphLayout = (layoutName: string) => {
  const cy = graphStore.currentGraphId ? getCyInstance(graphStore.currentGraphId) : null
  if (!cy) return

  applyLayoutWithFit(cy, layoutName)
  if (graphStore.currentGraphId) graphStore.updateGraphLayout(graphStore.currentGraphId, layoutName)
}

const openExportModal = (format: 'png' | 'jpg' | 'svg') => {
  currentExportType.value = format
  showExportModal.value = true
}

const handleConfirmExport = (options: {
  bg: string
  full: boolean
  scale: number
  quality?: number
}) => {
  const cy = graphStore.currentGraphId ? getCyInstance(graphStore.currentGraphId) : null
  if (!cy || !currentExportType.value) return

  try {
    let blob: Blob
    const baseOptions = { bg: options.bg, full: options.full, scale: options.scale }

    if (currentExportType.value === 'svg') {
      blob = new Blob([cy.svg(baseOptions)], { type: 'image/svg+xml;charset=utf-8' })
    } else if (currentExportType.value === 'png') {
      blob = cy.png({ ...baseOptions, output: 'blob' }) as unknown as Blob
    } else {
      blob = cy.jpg({
        ...baseOptions,
        quality: options.quality || 0.9,
        output: 'blob',
      }) as unknown as Blob
    }

    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = `graph.${currentExportType.value}`
    document.body.appendChild(a)
    a.click()
    document.body.removeChild(a)
    URL.revokeObjectURL(url)
  } catch (err) {
    console.error('Export failed', err)
  }
}

const handleGenerateStandalone = () => {
  const script = generateStandaloneScript({
    modelCode: generatedCode.value,
    data: dataStore.parsedGraphData.data || {},
    inits: dataStore.parsedGraphData.inits || {},
    settings: {
      n_samples: scriptStore.samplerSettings.n_samples,
      n_adapts: scriptStore.samplerSettings.n_adapts,
      n_chains: scriptStore.samplerSettings.n_chains,
      seed: scriptStore.samplerSettings.seed ?? undefined,
    },
  })
  scriptStore.standaloneScript = script
  uiStore.setActiveRightTab('script')
  uiStore.isRightSidebarOpen = true
}

const handleDownloadBugs = () => {
  const content = generatedCode.value
  const blob = new Blob([content], { type: 'text/plain;charset=utf-8' })
  const fileName = 'model.bugs'
  const url = URL.createObjectURL(blob)
  const a = document.createElement('a')
  a.href = url
  a.download = fileName
  document.body.appendChild(a)
  a.click()
  document.body.removeChild(a)
  URL.revokeObjectURL(url)
}

const handleDownloadScript = () => {
  const content =
    scriptStore.standaloneScript ||
    generateStandaloneScript({
      modelCode: generatedCode.value,
      data: dataStore.parsedGraphData.data || {},
      inits: dataStore.parsedGraphData.inits || {},
      settings: {
        n_samples: scriptStore.samplerSettings.n_samples,
        n_adapts: scriptStore.samplerSettings.n_adapts,
        n_chains: scriptStore.samplerSettings.n_chains,
        seed: scriptStore.samplerSettings.seed ?? undefined,
      },
    })
  if (!content) return
  const blob = new Blob([content], { type: 'text/plain' })
  const url = URL.createObjectURL(blob)
  const a = document.createElement('a')
  a.href = url
  a.download = 'model_script.jl'
  document.body.appendChild(a)
  a.click()
  document.body.removeChild(a)
  URL.revokeObjectURL(url)
}

const handleNewProject = () => {
  newProjectName.value = `Project ${projectStore.projects.length + 1}`
  showNewProjectModal.value = true
}

const createNewProject = () => {
  if (newProjectName.value.trim()) {
    projectStore.createProject(newProjectName.value.trim())
    showNewProjectModal.value = false
    newProjectName.value = ''
  }
}

const handleNewGraph = () => {
  if (projectStore.currentProjectId && projectStore.currentProject) {
    newGraphName.value = `Graph ${projectStore.currentProject.graphs.length + 1}`
    showNewGraphModal.value = true
  }
}

const createNewGraph = () => {
  if (projectStore.currentProjectId && (newGraphName.value.trim() || importedGraphData.value)) {
    const name = newGraphName.value.trim() || importedGraphData.value?.name || 'New Graph'
    const newGraphMeta = projectStore.addGraphToProject(projectStore.currentProjectId!, name)

    if (newGraphMeta && importedGraphData.value) {
      // FIX: Typed as GraphElement[]
      graphStore.updateGraphElements(
        newGraphMeta.id,
        importedGraphData.value.elements as GraphElement[]
      )

      if (importedGraphData.value.dataContent) {
        dataStore.updateGraphData(newGraphMeta.id, { content: importedGraphData.value.dataContent })
      }

      graphStore.updateGraphLayout(newGraphMeta.id, 'preset')
    } else if (newGraphMeta) {
      graphStore.selectGraph(newGraphMeta.id)
    }

    showNewGraphModal.value = false
    newGraphName.value = ''
    clearImportedData()
    if (graphImportInput.value) graphImportInput.value.value = ''
  }
}

const triggerGraphImport = () => {
  graphImportInput.value?.click()
}

const handleGraphImportFile = (event: Event) => {
  const file = (event.target as HTMLInputElement).files?.[0]
  if (file) {
    processGraphFile(file)
      .then((data) => {
        if (data && !newGraphName.value && data.name) {
          newGraphName.value = data.name + ' (Imported)'
        }
      })
      .catch((error) => {
        alert(error.message || 'Failed to process graph file.')
      })
  }
}

const handleDrop = (event: DragEvent) => {
  isDragOver.value = false
  const file = event.dataTransfer?.files?.[0]
  if (file) {
    processGraphFile(file)
      .then((data) => {
        if (data && !newGraphName.value && data.name) {
          newGraphName.value = data.name + ' (Imported)'
        }
      })
      .catch((error) => {
        alert(error.message || 'Failed to process graph file.')
      })
  }
}

const handleLoadExampleAction = (exampleKey: string) => {
  handleLoadExample(exampleKey)
}

const handleShare = () => {
  if (!graphStore.currentGraphId) return
  shareUrl.value = ''
  showShareModal.value = true
}

const handleGenerateShareLink = async (options: {
  scope: 'current' | 'project' | 'custom'
  selectedGraphIds?: string[]
}) => {
  if (!projectStore.currentProject) return

  const getGraphDataForShare = (graphId: string) => {
    // FIX: Explicitly typed graphElements
    let graphElements: GraphElement[] = []
    let dataContent = '{}'
    let name = 'Graph'

    const graphMeta = projectStore.currentProject?.graphs.find((g) => g.id === graphId)
    if (graphMeta) name = graphMeta.name

    if (graphId === graphStore.currentGraphId) {
      graphElements = graphStore.currentGraphElements
      dataContent = dataStore.dataContent
    } else {
      // FIX: Cast to GraphElement[]
      graphElements = getStoredGraphElements(graphId) as GraphElement[]
      dataContent = getStoredDataContent(graphId)
    }
    return { name, elements: graphElements, dataContent }
  }

  let payload = {}
  if (options.scope === 'current') {
    const targetId = options.selectedGraphIds?.[0] || graphStore.currentGraphId
    if (!targetId) return
    const { name, elements: graphElements, dataContent } = getGraphDataForShare(targetId)
    payload = { v: 2, n: name, e: minifyGraph(graphElements), d: dataContent }
  } else {
    const targetIds =
      options.scope === 'project'
        ? projectStore.currentProject.graphs.map((g) => g.id)
        : options.selectedGraphIds || []
    const graphsData = targetIds.map((id) => {
      const { name, elements: graphElements, dataContent } = getGraphDataForShare(id)
      return { n: name, e: minifyGraph(graphElements), d: dataContent }
    })
    payload = { v: 3, pn: projectStore.currentProject.name, g: graphsData }
  }
  await generateShareLink(payload)
}

const handleShareGraph = () => {
  shareUrl.value = ''
  showShareModal.value = true
}

const handleShareProjectUrl = () => {
  shareUrl.value = ''
  showShareModal.value = true
}

const handleExportJson = () => {
  if (!graphStore.currentGraphId || !projectStore.currentProject) return

  const graphMeta = projectStore.currentProject.graphs.find(
    (g) => g.id === graphStore.currentGraphId
  )
  if (!graphMeta) return

  const exportData = {
    name: graphMeta.name,
    elements: graphStore.currentGraphElements,
    dataContent: dataStore.dataContent,
    version: 1,
  }

  const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' })
  const url = URL.createObjectURL(blob)
  const a = document.createElement('a')
  a.href = url
  a.download = `${graphMeta.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.json`
  document.body.appendChild(a)
  a.click()
  document.body.removeChild(a)
  URL.revokeObjectURL(url)
}

const handleElementSelected = (element: GraphElement | null) => {
  graphStore.setSelectedElement(element)
  if (element) {
    uiStore.setActiveRightTab('properties')
    if (isEditMode.value) {
      uiStore.isRightSidebarOpen = true
    }
  } else {
    if (!uiStore.isRightTabPinned && uiStore.isRightSidebarOpen) {
      uiStore.isRightSidebarOpen = false
    }
  }
}

const handleSelectNodeFromModal = (nodeId: string) => {
  const el = elements.value.find((e) => e.id === nodeId)
  if (el) handleElementSelected(el)
}

const {
  isLeftSidebarOpen,
  isRightSidebarOpen,
  isGridEnabled,
  gridSize,
  showZoomControls,
  showDebugPanel,
  activeLeftAccordionTabs,
  isDetachModeActive,
  showDetachModeControl,
  isDarkMode,
  canvasGridStyle,
} = storeToRefs(uiStore)

const pinnedGraphTitle = computed(
  () =>
    projectStore.currentProject?.graphs.find((g) => g.id === graphStore.currentGraphId)?.name ||
    'Graph'
)
const isModelValid = computed(() => validationErrors.value.size === 0)

watch(
  isDarkMode,
  (val) => {
    const html = document.documentElement
    if (val) {
      html.classList.add('db-dark-mode')
      document.body.classList.add('db-dark-mode')
    } else {
      html.classList.remove('db-dark-mode')
      document.body.classList.remove('db-dark-mode')
    }
  },
  { immediate: true }
)

const useDrag = (initialX: number, initialY: number) => {
  const x = ref(initialX)
  const y = ref(initialY)
  const isDragging = ref(false)
  const startX = ref(0)
  const startY = ref(0)
  const dragThreshold = 3
  let initialDragX = 0
  let initialDragY = 0
  let animationFrameId: number | null = null

  const startDrag = (e: MouseEvent | TouchEvent) => {
    isDragging.value = true
    isDraggingUI.value = true
    const clientX = e instanceof MouseEvent ? e.clientX : e.touches[0].clientX
    const clientY = e instanceof MouseEvent ? e.clientY : e.touches[0].clientY

    startX.value = clientX - x.value
    startY.value = clientY - y.value
    initialDragX = clientX
    initialDragY = clientY

    if (e instanceof MouseEvent) {
      window.addEventListener('mousemove', onMouseMove)
      window.addEventListener('mouseup', onMouseUp)
    } else {
      window.addEventListener('touchmove', onTouchMove, { passive: false })
      window.addEventListener('touchend', onTouchEnd)
    }
  }

  const onMouseMove = (e: MouseEvent) => {
    if (!isDragging.value) return
    if (animationFrameId) cancelAnimationFrame(animationFrameId)

    animationFrameId = requestAnimationFrame(() => {
      x.value = e.clientX - startX.value
      y.value = e.clientY - startY.value
    })
  }

  const onTouchMove = (e: TouchEvent) => {
    if (!isDragging.value) return
    e.preventDefault()
    if (animationFrameId) cancelAnimationFrame(animationFrameId)

    animationFrameId = requestAnimationFrame(() => {
      x.value = e.touches[0].clientX - startX.value
      y.value = e.touches[0].clientY - startY.value
    })
  }

  const finishDrag = (clientX: number, clientY: number) => {
    isDragging.value = false
    isDraggingUI.value = false
    if (animationFrameId) cancelAnimationFrame(animationFrameId)
    const dist = Math.hypot(clientX - initialDragX, clientY - initialDragY)
    return dist < dragThreshold
  }

  const onMouseUp = (e: MouseEvent) => {
    const isClick = finishDrag(e.clientX, e.clientY)
    window.removeEventListener('mousemove', onMouseMove)
    window.removeEventListener('mouseup', onMouseUp)
    return isClick
  }

  const onTouchEnd = (e: TouchEvent) => {
    const touch = e.changedTouches[0]
    finishDrag(touch.clientX, touch.clientY)
    window.removeEventListener('touchmove', onTouchMove)
    window.removeEventListener('touchend', onTouchEnd)
  }

  return {
    x,
    y,
    startDrag,
    onMouseUp,
    style: computed(() => ({
      transform: `translate3d(${x.value}px, ${y.value}px, 0)`,
      left: '0px',
      top: '0px',
    })),
  }
}

// Left sidebar initialized higher (y=10)
const leftDrag = useDrag(20, 10)
// Right sidebar initialized (y=10 to match left)
const rightDrag = useDrag(typeof window !== 'undefined' ? window.innerWidth - 320 - 20 : 1580, 10)

watch(
  [
    () => leftDrag.x.value,
    () => leftDrag.y.value,
    () => rightDrag.x.value,
    () => rightDrag.y.value,
    () => uiStore.isLeftSidebarOpen,
    () => uiStore.isRightSidebarOpen,
    isCodePanelOpen,
    isDataPanelOpen,
    () => codePanelPos.x,
    () => codePanelPos.y,
    () => codePanelSize.width,
    () => codePanelSize.height,
    () => dataPanelPos.x,
    () => dataPanelPos.y,
    () => dataPanelSize.width,
    () => dataPanelSize.height,
    () => graphStore.currentGraphId,
    // Add isEditMode to persisted state
    isEditMode,
  ],
  () => {
    saveWidgetUIState()
  },
  { deep: true }
)

const onLeftHeaderDragStart = (e: MouseEvent | TouchEvent) => {
  leftDrag.startDrag(e)
  if (e instanceof MouseEvent) {
    const originalMouseUp = leftDrag.onMouseUp
    const handleUp = (upEvent: MouseEvent) => {
      const isClick = originalMouseUp(upEvent)
      if (isClick) {
        uiStore.toggleLeftSidebar()
      }
      window.removeEventListener('mouseup', handleUp)
    }
    window.addEventListener('mouseup', handleUp)
  }
}

const onRightHeaderDragStart = (e: MouseEvent | TouchEvent) => {
  rightDrag.startDrag(e)
  if (e instanceof MouseEvent) {
    const originalMouseUp = rightDrag.onMouseUp
    const handleUp = (upEvent: MouseEvent) => {
      const isClick = originalMouseUp(upEvent)
      if (isClick) {
        uiStore.toggleRightSidebar()
      }
      window.removeEventListener('mouseup', handleUp)
    }
    window.addEventListener('mouseup', handleUp)
  }
}

const handleToolbarNavigation = (view: string) => {
  if (view === 'project') {
    if (
      uiStore.isLeftSidebarOpen &&
      activeLeftAccordionTabs.value.includes('project') &&
      activeLeftAccordionTabs.value.length === 1
    ) {
      uiStore.isLeftSidebarOpen = false
    } else {
      uiStore.isLeftSidebarOpen = true
      activeLeftAccordionTabs.value = ['project']
    }
  } else if (view === 'view') {
    if (
      uiStore.isLeftSidebarOpen &&
      activeLeftAccordionTabs.value.includes('view') &&
      activeLeftAccordionTabs.value.length === 1
    ) {
      uiStore.isLeftSidebarOpen = false
    } else {
      uiStore.isLeftSidebarOpen = true
      activeLeftAccordionTabs.value = ['view']
    }
  } else if (view === 'help') {
    if (uiStore.isLeftSidebarOpen && activeLeftAccordionTabs.value.includes('help')) {
      uiStore.isLeftSidebarOpen = false
    } else {
      uiStore.isLeftSidebarOpen = true
      activeLeftAccordionTabs.value = ['help', 'devtools']
    }
  } else if (view === 'export') {
    if (uiStore.isRightSidebarOpen && uiStore.activeRightTab === 'export') {
      uiStore.isRightSidebarOpen = false
    } else {
      uiStore.isRightSidebarOpen = true
      uiStore.setActiveRightTab('export')
    }
  }
}

const handleUIInteractionStart = () => {
  isDraggingUI.value = true
}

const handleUIInteractionEnd = () => {
  isDraggingUI.value = false
}
</script>

<template>
  <div
    ref="widgetRoot"
    class="db-widget-root"
    :class="{ 'db-dark-mode': isDarkMode }"
    style="width: 100%; height: 100%; position: relative; overflow: hidden"
  >
    <div
      class="db-canvas-layer"
      :style="{
        position: 'absolute',
        top: 0,
        left: 0,
        right: 0,
        bottom: 0,
        width: '100%',
        height: '100%',
        pointerEvents: isDraggingUI ? 'none' : 'auto',
      }"
    >
      <GraphEditor
        v-if="isInitialized && graphStore.currentGraphId"
        :key="graphStore.currentGraphId"
        :graph-id="graphStore.currentGraphId"
        :is-grid-enabled="isGridEnabled"
        :grid-size="gridSize"
        :grid-style="canvasGridStyle"
        :current-mode="currentMode"
        :elements="elements"
        :current-node-type="currentNodeType"
        :validation-errors="validationErrors"
        :show-zoom-controls="false"
        @update:current-mode="currentMode = $event"
        @update:current-node-type="currentNodeType = $event"
        @element-selected="handleElementSelected"
        @layout-updated="(name) => graphStore.updateGraphLayout(graphStore.currentGraphId!, name)"
        @viewport-changed="
          (v) => graphStore.updateGraphViewport(graphStore.currentGraphId!, v.zoom, v.pan)
        "
        @update:is-grid-enabled="isGridEnabled = $event"
        @update:grid-size="gridSize = $event"
      />
      <div v-else class="db-empty-placeholder">
        <div class="db-msg-box">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Initializing...</p>
        </div>
      </div>
    </div>

    <!-- Edit Toggle Button -->
    <div
      class="db-edit-toggle-wrapper"
      style="position: absolute; top: 10px; right: 10px; z-index: 500"
    >
      <button
        @click="toggleEditMode"
        :title="isEditMode ? 'Stop Editing' : 'Edit Graph'"
        style="
          width: 40px;
          height: 40px;
          border-radius: 50%;
          background: white;
          border: 1px solid #e5e7eb;
          color: #4b5563;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
          padding: 0;
          transition: all 0.2s;
        "
        :style="isEditMode ? 'background: #ef4444; border-color: #ef4444; color: white;' : ''"
      >
        <svg
          v-if="!isEditMode"
          viewBox="0 0 24 24"
          width="18"
          height="18"
          xmlns="http://www.w3.org/2000/svg"
          fill="currentColor"
        >
          <path
            d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"
          />
        </svg>

        <svg
          v-else
          viewBox="0 0 76.00 76.00"
          xmlns="http://www.w3.org/2000/svg"
          width="22"
          height="22"
          fill="currentColor"
        >
          <path
            fill="currentColor"
            d="M 53.2929,21.2929L 54.7071,22.7071C 56.4645,24.4645 56.4645,27.3137 54.7071,29.0711L 52.2323,31.5459L 44.4541,23.7677L 46.9289,21.2929C 48.6863,19.5355 51.5355,19.5355 53.2929,21.2929 Z M 31.7262,52.052L 23.948,44.2738L 43.0399,25.182L 50.818,32.9601L 31.7262,52.052 Z M 23.2409,47.1023L 28.8977,52.7591L 21.0463,54.9537L 23.2409,47.1023 Z M 17,28L 17,23L 23,23L 23,17L 28,17L 28,23L 34,23L 34,28L 28,28L 28,34L 23,34L 23,28L 17,28 Z "
          ></path>
        </svg>
      </button>
    </div>

    <Teleport to="body">
      <!-- Only show main UI if Editing AND Widget is visible in viewport -->
      <div
        class="db-ui-overlay"
        :class="{ 'db-dark-mode': isDarkMode, 'db-widget-ready': widgetInitialized }"
        v-show="isWidgetInView && isEditMode"
      >
        <Toast position="top-center" />

        <!-- Left Sidebar (Floating) -->
        <div
          v-if="widgetInitialized && isLeftSidebarOpen"
          class="db-sidebar-wrapper db-left"
          :style="leftDrag.style.value"
        >
          <LeftSidebar
            v-show="isLeftSidebarOpen"
            :activeAccordionTabs="activeLeftAccordionTabs"
            @update:activeAccordionTabs="activeLeftAccordionTabs = $event"
            :projectName="projectStore.currentProject?.name || 'Project'"
            :pinnedGraphTitle="pinnedGraphTitle"
            :isGridEnabled="isGridEnabled"
            :gridSize="gridSize"
            :showZoomControls="showZoomControls"
            :showDebugPanel="showDebugPanel"
            :isCodePanelOpen="isCodePanelOpen"
            :isDetachModeActive="isDetachModeActive"
            :showDetachModeControl="showDetachModeControl"
            :enableDrag="true"
            @toggle-left-sidebar="uiStore.toggleLeftSidebar"
            @new-project="handleNewProject"
            @new-graph="handleNewGraph"
            @update:currentMode="currentMode = $event"
            @update:currentNodeType="currentNodeType = $event"
            @update:isGridEnabled="isGridEnabled = $event"
            @update:gridSize="gridSize = $event"
            @update:showZoomControls="showZoomControls = $event"
            @update:showDebugPanel="showDebugPanel = $event"
            @update:isDetachModeActive="isDetachModeActive = $event"
            @update:show-detach-mode-control="showDetachModeControl = $event"
            @toggle-code-panel="toggleCodePanel"
            @load-example="handleLoadExampleAction"
            @open-about-modal="showAboutModal = true"
            @open-faq-modal="showFaqModal = true"
            @toggle-dark-mode="uiStore.toggleDarkMode"
            @share-graph="handleShareGraph"
            @share-project-url="handleShareProjectUrl"
            @header-drag-start="onLeftHeaderDragStart"
          />
        </div>

        <div
          v-if="widgetInitialized && isRightSidebarOpen"
          class="db-sidebar-wrapper db-right"
          :style="rightDrag.style.value"
        >
          <RightSidebar
            v-show="isRightSidebarOpen"
            :selectedElement="selectedElement"
            :validationErrors="validationErrors"
            :isModelValid="isModelValid"
            :enableDrag="true"
            @toggle-right-sidebar="uiStore.toggleRightSidebar"
            @update-element="updateElement"
            @delete-element="deleteElement"
            @show-validation-issues="showValidationModal = true"
            @open-script-settings="showScriptSettingsModal = true"
            @download-script="handleDownloadScript"
            @generate-script="handleGenerateStandalone"
            @share="handleShare"
            @open-export-modal="openExportModal"
            @export-json="handleExportJson"
            @header-drag-start="onRightHeaderDragStart"
          />
        </div>

        <FloatingBottomToolbar
          :current-mode="currentMode"
          :current-node-type="currentNodeType"
          :show-zoom-controls="showZoomControls"
          :show-code-panel="isCodePanelOpen"
          :show-data-panel="isDataPanelOpen"
          :is-detach-mode-active="isDetachModeActive"
          :show-detach-mode-control="showDetachModeControl"
          :is-widget="true"
          @update:current-mode="currentMode = $event"
          @update:current-node-type="currentNodeType = $event"
          @undo="handleUndo"
          @redo="handleRedo"
          @zoom-in="handleZoomIn"
          @zoom-out="handleZoomOut"
          @fit="handleFit"
          @layout-graph="handleGraphLayout"
          @toggle-code-panel="toggleCodePanel"
          @toggle-data-panel="toggleDataPanel"
          @toggle-detach-mode="uiStore.toggleDetachMode"
          @open-style-modal="showStyleModal = true"
          @share="handleShare"
          @nav="handleToolbarNavigation"
          @drag-start="handleUIInteractionStart"
          @drag-end="handleUIInteractionEnd"
        />

        <FloatingPanel
          title="BUGS Code Preview"
          icon="fas fa-code"
          :is-open="isCodePanelOpen"
          :default-width="codePanelSize.width"
          :default-height="codePanelSize.height"
          :default-x="codePanelPos.x"
          :default-y="codePanelPos.y"
          :show-download="true"
          @close="toggleCodePanel"
          @download="handleDownloadBugs"
          @drag-start="handleUIInteractionStart"
          @drag-end="
            (pos) => {
              codePanelPos.x = pos.x
              codePanelPos.y = pos.y
              handleUIInteractionEnd()
            }
          "
          @resize-start="handleUIInteractionStart"
          @resize-end="
            (size) => {
              codePanelSize.width = size.width
              codePanelSize.height = size.height
              handleUIInteractionEnd()
            }
          "
        >
          <CodePreviewPanel :is-active="isCodePanelOpen" />
        </FloatingPanel>

        <FloatingPanel
          title="Data & Inits"
          icon="fas fa-database"
          badge="JSON"
          :is-open="isDataPanelOpen"
          :default-width="dataPanelSize.width"
          :default-height="dataPanelSize.height"
          :default-x="dataPanelPos.x || windowWidth - 420"
          :default-y="dataPanelPos.y"
          @close="toggleDataPanel"
          @drag-start="handleUIInteractionStart"
          @drag-end="
            (pos) => {
              dataPanelPos.x = pos.x
              dataPanelPos.y = pos.y
              handleUIInteractionEnd()
            }
          "
          @resize-start="handleUIInteractionStart"
          @resize-end="
            (size) => {
              dataPanelSize.width = size.width
              dataPanelSize.height = size.height
              handleUIInteractionEnd()
            }
          "
        >
          <DataInputPanel :is-active="isDataPanelOpen" />
        </FloatingPanel>

        <AboutModal :is-open="showAboutModal" @close="showAboutModal = false" />
        <FaqModal :is-open="showFaqModal" @close="showFaqModal = false" />
        <ExportModal
          :is-open="showExportModal"
          :export-type="currentExportType"
          @close="showExportModal = false"
          @confirm-export="handleConfirmExport"
        />
        <GraphStyleModal :is-open="showStyleModal" @close="showStyleModal = false" />
        <ShareModal
          :is-open="showShareModal"
          :url="shareUrl"
          :project="projectStore.currentProject"
          :current-graph-id="graphStore.currentGraphId"
          @close="showShareModal = false"
          @generate="handleGenerateShareLink"
        />
        <ValidationIssuesModal
          :is-open="showValidationModal"
          :validation-errors="validationErrors"
          :elements="elements"
          @close="showValidationModal = false"
          @select-node="handleSelectNodeFromModal"
        />
        <BaseModal :is-open="showScriptSettingsModal" @close="showScriptSettingsModal = false">
          <template #header>
            <h3>Script Settings</h3>
          </template>
          <template #body>
            <ScriptSettingsPanel />
          </template>
          <template #footer>
            <BaseButton @click="showScriptSettingsModal = false">Done</BaseButton>
          </template>
        </BaseModal>

        <BaseModal :is-open="showNewProjectModal" @close="showNewProjectModal = false">
          <template #header>
            <h3>Create New Project</h3>
          </template>
          <template #body>
            <div class="db-modal-form-row">
              <label>Project Name:</label>
              <BaseInput
                v-model="newProjectName"
                placeholder="Enter project name"
                @keyup.enter="createNewProject"
              />
            </div>
          </template>
          <template #footer>
            <BaseButton @click="createNewProject" type="primary">Create</BaseButton>
          </template>
        </BaseModal>

        <BaseModal :is-open="showNewGraphModal" @close="showNewGraphModal = false">
          <template #header>
            <h3>Create New Graph</h3>
          </template>
          <template #body>
            <div class="flex flex-col gap-2">
              <div class="db-form-group">
                <label for="new-graph-name">Graph Name</label>
                <BaseInput
                  id="new-graph-name"
                  v-model="newGraphName"
                  placeholder="Enter a name for your graph"
                  @keyup.enter="createNewGraph"
                />
              </div>

              <div class="db-import-section">
                <label class="db-section-label">Import from JSON (Optional)</label>

                <div
                  class="db-drop-zone"
                  :class="{ 'db-loaded': importedGraphData, 'db-drag-over': isDragOver }"
                  @click="triggerGraphImport"
                  @dragover.prevent="isDragOver = true"
                  @dragleave.prevent="isDragOver = false"
                  @drop.prevent="handleDrop"
                >
                  <input
                    type="file"
                    ref="graphImportInput"
                    accept=".json"
                    @change="handleGraphImportFile"
                    class="db-hidden-input"
                  />

                  <div v-if="!importedGraphData" class="db-drop-zone-content">
                    <div class="db-icon-circle">
                      <i class="fas fa-file-import"></i>
                    </div>
                    <div class="db-text-content">
                      <span class="db-action-text">Click or Drag & Drop JSON file</span>
                      <small class="db-sub-text">Restore a previously exported graph</small>
                    </div>
                  </div>

                  <div v-else class="db-drop-zone-content db-success">
                    <div class="db-icon-circle db-success">
                      <i class="fas fa-check"></i>
                    </div>
                    <div class="db-text-content">
                      <span class="db-action-text">File Loaded Successfully</span>
                      <small class="db-sub-text">{{
                        importedGraphData.name || 'Untitled Graph'
                      }}</small>
                    </div>
                    <button
                      class="db-remove-file-btn"
                      @click.stop="clearImportedData"
                      title="Remove file"
                    >
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </template>
          <template #footer>
            <BaseButton @click="createNewGraph" type="primary">Create Graph</BaseButton>
          </template>
        </BaseModal>

        <DebugPanel v-if="showDebugPanel" @close="showDebugPanel = false" />
      </div>
    </Teleport>
  </div>
</template>

<style>
/* CSS unchanged */
.db-widget-root {
  width: 100%;
  height: 100%;
  position: relative;
  overflow: hidden;
  background: var(--theme-bg-canvas);
  z-index: 0;
  display: flex;
  flex-direction: column;

  --theme-bg-canvas: #f3f4f6;
  --theme-grid-line: #d1d5db;
  --theme-bg-panel: #ffffff;
  --theme-text-primary: #111827;
  --theme-text-secondary: #4b5563;
  --theme-text-muted: #9ca3af;
  --theme-text-inverse: #ffffff;
  --theme-border: #e5e7eb;
  --theme-border-hover: #d1d5db;
  --theme-primary: #10b981;
  --theme-primary-hover: #059669;
  --theme-danger: #ef4444;
  --theme-success: #10b981;
  --theme-warning: #f59e0b;
}

.db-widget-root.db-dark-mode {
  --theme-bg-canvas: #0f1115;
  --theme-grid-line: #3f3f46;
  --theme-bg-panel: #18181b;
  --theme-text-primary: #f3f4f6;
  --theme-text-secondary: #a1a1aa;
  --theme-border: #27272a;
}

/* Edit Toggle Button Styles */
.db-edit-toggle-wrapper {
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 500;
}

.db-edit-toggle-btn {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--theme-bg-panel);
  border: 1px solid var(--theme-border);
  color: var(--theme-text-secondary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: var(--shadow-md);
  transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
  padding: 0;
}

.db-edit-toggle-btn:hover {
  background: var(--theme-bg-hover);
  color: var(--theme-primary);
  transform: scale(1.05);
}

.db-edit-toggle-btn.db-active {
  background: var(--theme-danger);
  border-color: var(--theme-danger);
  color: white;
}

.db-widget-root .db-canvas-layer {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  width: 100%;
  height: 100%;
  z-index: 0;
}

.db-widget-root .db-graph-editor-container {
  display: flex;
  flex-direction: column;
  width: 100%;
  height: 100%;
  overflow: hidden;
  position: relative;
}

.db-widget-root .db-cytoscape-container,
.db-cytoscape-container {
  flex: 1;
  display: block;
  width: 100%;
  height: 100%;
  min-height: 200px;
  position: relative !important;
  background-color: var(--theme-bg-canvas);
  background-position: 0 0;
  background-repeat: repeat;
}

.db-widget-root .db-cytoscape-container.db-grid-background.db-grid-lines,
.db-cytoscape-container.db-grid-background.db-grid-lines {
  background-image:
    linear-gradient(to right, var(--theme-grid-line) 1px, transparent 1px),
    linear-gradient(to bottom, var(--theme-grid-line) 1px, transparent 1px);
}

.db-widget-root .db-cytoscape-container.db-grid-background.db-grid-dots,
.db-cytoscape-container.db-grid-background.db-grid-dots {
  background-image: radial-gradient(circle, var(--theme-text-secondary) 1px, transparent 1px);
}

/* Dark mode grid styling for widget */
.db-widget-root.db-dark-mode .db-cytoscape-container.db-grid-background.db-grid-dots {
  background-image: radial-gradient(circle,
      rgba(255, 255, 255, 0.2) 1.2px,
      transparent 1px) !important;
}

.db-widget-root.db-dark-mode .db-cytoscape-container.db-grid-background.db-grid-lines {
  background-image:
    linear-gradient(to right, rgba(255, 255, 255, 0.08) 1px, transparent 1px),
    linear-gradient(to bottom, rgba(255, 255, 255, 0.08) 1px, transparent 1px) !important;
}

.cdnd-grabbed-node {
  background-color: #ffd700 !important;
  opacity: 0.7;
  border: 2px dashed #ffa500;
}

.cdnd-drop-target {
  border: 3px solid #32cd32 !important;
  background-color: rgba(50, 205, 50, 0.1) !important;
}

.db-widget-root .db-empty-placeholder {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--theme-bg-canvas);
}

.db-widget-root .db-empty-placeholder .db-msg-box {
  text-align: center;
  color: var(--theme-text-secondary);
}

.db-modal-form-row {
  display: flex;
  align-items: center;
  gap: 12px;
}

.db-modal-form-row label {
  min-width: 100px;
  font-weight: 500;
  color: var(--theme-text-primary);
}

/* Collapsed Sidebar Triggers Styles */
.db-collapsed-sidebar-trigger {
  position: absolute;
  top: 16px;
  z-index: 100;
  padding: 8px 12px;
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  transition: all 0.2s ease;
  border: 1px solid var(--theme-border);
  background: var(--theme-bg-panel);
  cursor: pointer;
  min-width: 140px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.db-collapsed-sidebar-trigger.db-left-trigger {
  left: 16px;
  min-width: 200px;
}

.db-collapsed-sidebar-trigger.db-right {
  left: auto;
  right: 16px;
}

.db-collapsed-sidebar-trigger:hover {
  box-shadow: var(--shadow-md);
  transform: scale(1.01);
  background: var(--theme-bg-hover);
}

.db-sidebar-trigger-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
}

.db-logo-text-minimized {
  font-family: var(--font-family-sans);
  font-size: 14px;
  font-weight: 600;
  color: var(--theme-text-primary);
}

.db-sidebar-title-minimized {
  font-size: 13px;
  font-weight: 600;
  color: var(--theme-text-primary);
}

.db-theme-toggle-header {
  background: transparent;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 4px;
  color: var(--theme-text-secondary);
  font-size: 0.85rem;
  transition: color 0.2s;
  border-radius: 4px;
}

.db-theme-toggle-header:hover {
  color: var(--theme-text-primary);
  background: var(--theme-bg-hover);
}

.db-toggle-icon-wrapper {
  display: flex;
  align-items: center;
}

.db-toggle-icon {
  color: var(--theme-text-secondary);
}

.db-header-icon-btn {
  background: transparent;
  border: none;
  cursor: pointer;
  color: var(--theme-text-secondary);
  font-size: 14px;
  padding: 6px;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.db-header-icon-btn:hover {
  background-color: var(--theme-bg-hover);
  color: var(--theme-text-primary);
}

.db-collapsed-share-btn {
  width: 24px;
  height: 24px;
  padding: 0;
}

.db-status-indicator {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;
  cursor: help;
}

.db-validation-status {
  font-size: 1.1em;
  margin: 0 5px;
}

.db-validation-status.db-valid {
  color: var(--theme-success);
}

.db-validation-status.db-invalid {
  color: var(--theme-warning);
}

.fade-enter-active,
.fade-leave-active {
  transition: opacity 0.2s ease;
}

.fade-enter-from,
.fade-leave-to {
  opacity: 0;
}

.db-desktop-text {
  display: inline;
}

.db-mobile-text {
  display: none;
}

/* Modal and Drop Zone Styles */
.db-form-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.db-form-group label {
  font-size: 0.9em;
  font-weight: 600;
  color: var(--theme-text-secondary);
}

.db-section-label {
  font-size: 0.9em;
  font-weight: 600;
  color: var(--theme-text-secondary);
  margin-bottom: 8px;
  display: block;
}

.db-drop-zone {
  border: 2px dashed var(--theme-border);
  border-radius: var(--radius-md);
  padding: 24px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  background-color: var(--theme-bg-hover);
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 160px;
}

.db-drop-zone:hover {
  border-color: var(--theme-text-muted);
  background-color: var(--theme-bg-active);
}

.db-drop-zone.db-drag-over {
  border-color: var(--theme-primary);
  background-color: rgba(16, 185, 129, 0.1);
  transform: scale(1.02);
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
}

.db-drop-zone.db-loaded {
  border-style: solid;
  border-color: var(--theme-success);
  background-color: rgba(16, 185, 129, 0.05);
}

.db-drop-zone-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  pointer-events: none;
  width: 100%;
}

.db-drop-zone-content.db-success {
  pointer-events: auto;
}

.db-icon-circle {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background-color: var(--theme-bg-panel);
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: var(--shadow-sm);
  color: var(--theme-text-muted);
  font-size: 24px;
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.db-drop-zone:hover .db-icon-circle {
  transform: scale(1.1);
  color: var(--theme-primary);
}

.db-drop-zone.db-drag-over .db-icon-circle {
  transform: scale(1.2);
  background-color: var(--theme-primary);
  color: white;
}

.db-icon-circle.db-success {
  background-color: var(--theme-success);
  color: white;
}

.db-text-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}

.db-action-text {
  font-weight: 600;
  color: var(--theme-text-primary);
  font-size: 1rem;
}

.db-sub-text {
  color: var(--theme-text-secondary);
  font-size: 0.85em;
}

.db-hidden-input {
  display: none;
}

.db-remove-file-btn {
  position: absolute;
  top: 10px;
  right: 10px;
  background: var(--theme-bg-panel);
  border: 1px solid var(--theme-border);
  color: var(--theme-text-secondary);
  cursor: pointer;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  box-shadow: var(--shadow-sm);
}

.db-remove-file-btn:hover {
  background-color: var(--theme-danger);
  border-color: var(--theme-danger);
  color: white;
}

@media (max-width: 768px) {
  .db-desktop-text {
    display: none;
  }

  .db-mobile-text {
    display: inline;
  }

  .db-collapsed-sidebar-trigger {
    min-width: auto !important;
    max-width: 42%;
    padding: 8px;
  }

  .db-collapsed-sidebar-trigger.db-left-trigger {
    min-width: auto !important;
  }

  .db-logo-text-minimized {
    font-size: 12px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block;
  }

  .db-sidebar-trigger-content {
    gap: 4px;
  }
}
</style>



================================================
FILE: src/main.ce.ts
================================================
import {
  defineCustomElement,
  h,
  createApp,
  getCurrentInstance,
  type ComponentInternalInstance,
} from 'vue'
import { createPinia } from 'pinia'
import PrimeVue from 'primevue/config'
import ToastService from 'primevue/toastservice'
import Aura from '@primevue/themes/aura'
import DoodleWidget from './DoodleWidget.vue'

import './assets/styles/global.css'
import 'primeicons/primeicons.css'

interface WidgetProps {
  initialState?: string
  defaultModel?: string
}

export const DoodleBugsElement = defineCustomElement({
  props: { 
    initialState: String,
    defaultModel: String 
  },
  setup(props: WidgetProps) {
    const app = createApp(DoodleWidget)

    app.use(createPinia())
    app.use(PrimeVue, {
      theme: {
        preset: Aura,
        options: {
          darkModeSelector: '.db-dark-mode',
        },
      },
    })
    app.use(ToastService)

    const inst = getCurrentInstance()
    if (inst) {
      Object.assign(inst.appContext, app._context)
      Object.assign(
        (inst as ComponentInternalInstance & { provides: Record<string, unknown> }).provides,
        app._context.provides
      )
    }

    return () => h(DoodleWidget, props)
  },
  styles: DoodleWidget.styles,
})

customElements.define('doodle-bugs', DoodleBugsElement)



================================================
FILE: src/main.ts
================================================
import { createApp } from 'vue'
import { createPinia } from 'pinia'
import PrimeVue from 'primevue/config'
import Aura from '@primevue/themes/aura'
import ToastService from 'primevue/toastservice'
import App from './App.vue'
import './assets/styles/global.css'
import 'primeicons/primeicons.css'

const app = createApp(App)

app.use(createPinia())
app.use(PrimeVue, {
  theme: {
    preset: Aura,
    options: {
      darkModeSelector: '.db-dark-mode',
    },
  },
})
app.use(ToastService)

app.mount('#app')



================================================
FILE: src/assets/styles/global.css
================================================
@import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css');

:root {
  /* Fonts */
  --font-family-sans: -apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  --font-size-xs: 10px;
  --font-size-sm: 12px;
  --font-size-md: 13px;
  --font-size-lg: 14px;
  --font-size-xl: 16px;

  /* Backgrounds */
  --theme-bg-canvas: #f3f4f6;
  --theme-bg-panel: #ffffff;
  --theme-bg-panel-transparent: rgba(255, 255, 255, 0.90);
  --theme-bg-hover: #f3f4f6;
  --theme-bg-active: #e5e7eb;

  /* Text */
  --theme-text-primary: #111827;
  --theme-text-secondary: #4b5563;
  --theme-text-muted: #9ca3af;
  --theme-text-inverse: #ffffff;

  /* Borders */
  --theme-border: #e5e7eb;
  --theme-border-hover: #d1d5db;

  /* Grids */
  --theme-grid-line: #d1d5db;

  /* Accents - GREEN THEME (Emerald) */
  --theme-primary: #10b981;
  --theme-primary-hover: #059669;
  --theme-danger: #ef4444;
  --theme-success: #10b981;
  --theme-warning: #f59e0b;

  /* Geometry */
  --radius-sm: 6px;
  --radius-md: 8px;
  --radius-lg: 12px;
  --radius-pill: 9999px;

  /* Shadows */
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --shadow-floating: 0 8px 24px -4px rgba(0, 0, 0, 0.12), 0 4px 12px -2px rgba(0, 0, 0, 0.08);

  /* PrimeVue Mappings */
  --p-content-background: var(--theme-bg-panel);
  --p-text-color: var(--theme-text-primary);
  --p-content-border-color: var(--theme-border);
  --p-primary-color: var(--theme-primary);
  --p-primary-500: var(--theme-primary);
  --p-primary-600: var(--theme-primary-hover);

  /* Legacy/Component Compatibility Aliases */
  --color-primary: var(--theme-primary);
  --color-primary-hover: var(--theme-primary-hover);
  --color-secondary: var(--theme-text-secondary);
  --color-secondary-hover: var(--theme-text-primary);
  --color-danger: var(--theme-danger);
  --color-success: var(--theme-success);
  --color-warning: var(--theme-warning);
  --color-info: var(--theme-primary);

  --color-text: var(--theme-text-primary);
  --color-text-light: var(--theme-text-inverse);
  --color-text-secondary: var(--theme-text-secondary);
  --color-heading: var(--theme-text-primary);

  --color-background-soft: var(--theme-bg-canvas);
  --color-background-mute: var(--theme-bg-active);
  --color-background-dark: #1f2937;

  --color-border: var(--theme-border);
  --color-border-light: var(--theme-border);
  --color-border-dark: var(--theme-text-secondary);
}

html.db-dark-mode {
  /* Semantic Theme Configuration (Dark Mode) */
  /* Backgrounds */
  --theme-bg-canvas: #0f1115;
  --theme-bg-panel: #18181b;
  --theme-bg-panel-transparent: rgba(24, 24, 27, 0.85);
  --theme-bg-hover: #27272a;
  --theme-bg-active: #3f3f46;

  /* Text */
  --theme-text-primary: #f3f4f6;
  --theme-text-secondary: #a1a1aa;
  --theme-text-muted: #52525b;

  /* Borders */
  --theme-border: #27272a;
  --theme-border-hover: #3f3f46;

  /* Grids */
  --theme-grid-line: #3f3f46;

  /* Accents */
  --theme-primary: #10b981;
  --theme-primary-hover: #34d399;
  --theme-success: #10b981;

  /* Shadows */
  --shadow-floating: 0 10px 30px -4px rgba(0, 0, 0, 0.6);
}

body {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  background-color: var(--theme-bg-canvas);
  color: var(--theme-text-primary);
  font-family: var(--font-family-sans);
  font-size: var(--font-size-sm);
  -webkit-font-smoothing: antialiased;
}

#app {
  display: flex;
  flex-direction: column;
  height: 100vh;
  width: 100vw;
  overflow: hidden;
}

/* Utility classes */
.flex {
  display: flex;
}

.flex-col {
  flex-direction: column;
}

.items-center {
  align-items: center;
}

.justify-center {
  justify-content: center;
}

.justify-between {
  justify-content: space-between;
}

.gap-1 {
  gap: 4px;
}

.gap-2 {
  gap: 8px;
}

.gap-3 {
  gap: 12px;
}

.p-2 {
  padding: 8px;
}

.text-xs {
  font-size: var(--font-size-xs);
}

.text-sm {
  font-size: var(--font-size-sm);
}

.text-md {
  font-size: var(--font-size-md);
}

.font-bold {
  font-weight: 600;
}

.w-full {
  width: 100%;
}

.h-full {
  height: 100%;
}

/* Custom Base Modal Responsive Width */
.base-modal-responsive {
  width: 50vw;
}

@media (max-width: 768px) {
  .base-modal-responsive {
    width: 95vw !important;
  }
}

/* Input Placeholder and Styling */
input::placeholder,
textarea::placeholder {
  font-size: 12px !important;
  color: var(--theme-text-muted);
  opacity: 0.8;
}

.p-inputtext,
.p-inputnumber-input,
.p-select-label {
  font-size: 12px !important;
}

/* Cytoscape Grid */
.cytoscape-container.grid-background {
  background-image:
    linear-gradient(to right, var(--theme-grid-line) 1px, transparent 1px),
    linear-gradient(to bottom, var(--theme-grid-line) 1px, transparent 1px);
}

html.db-dark-mode .cytoscape-container.grid-background {
  background-image:
    linear-gradient(to right, rgba(255, 255, 255, 0.08) 1px, transparent 1px),
    linear-gradient(to bottom, rgba(255, 255, 255, 0.08) 1px, transparent 1px);
}

html.db-dark-mode .cytoscape-container {
  background-color: var(--theme-bg-canvas) !important;
}

/* Scrollbar Styling */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: transparent;
}

::-webkit-scrollbar-thumb {
  background: var(--theme-border);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--theme-text-secondary);
}

/* Glassmorphism Utility */
.glass-panel {
  background: var(--theme-bg-panel-transparent);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border: 1px solid var(--theme-border);
  box-shadow: var(--shadow-floating);
}

/* Debug Panel - Green Theme */
.debug-panel {
  border-top-color: var(--theme-primary) !important;
  color: #fff !important;
}

.debug-header {
  background: rgba(16, 185, 129, 0.2) !important;
  border-bottom-color: var(--theme-primary) !important;
  color: #fff !important;
}

.debug-btn {
  border-color: var(--theme-primary) !important;
  color: var(--theme-primary) !important;
  background: transparent !important;
}

.log-type.type-log {
  color: var(--theme-primary) !important;
}


================================================
FILE: src/components/canvas/FloatingBottomToolbar.vue
================================================
<script setup lang="ts">
import { computed, ref, onUnmounted, watch } from 'vue'
import type { NodeType } from '../../types'
import { nodeDefinitions } from '../../config/nodeDefinitions'
import DropdownMenu from '../common/DropdownMenu.vue'

const props = defineProps<{
  currentMode: string
  currentNodeType: NodeType
  showCodePanel?: boolean
  showDataPanel?: boolean
  showZoomControls?: boolean
  isDetachModeActive?: boolean
  showDetachModeControl?: boolean
  isWidget?: boolean
}>()

const emit = defineEmits<{
  (e: 'update:currentMode', mode: string): void
  (e: 'update:currentNodeType', type: NodeType): void
  (e: 'undo'): void
  (e: 'redo'): void
  (e: 'zoom-in'): void
  (e: 'zoom-out'): void
  (e: 'fit'): void
  (e: 'layout-graph', layout: string): void
  (e: 'toggle-code-panel'): void
  (e: 'toggle-data-panel'): void
  (e: 'toggle-detach-mode'): void
  (e: 'open-style-modal'): void
  (e: 'share'): void
  (e: 'nav', view: string): void
  (e: 'drag-start'): void
  (e: 'drag-end', position: { x: number; y: number }): void
}>()

const availableNodeTypes = computed(() => {
  return nodeDefinitions.map((def) => ({
    label: def.label,
    value: def.nodeType,
    icon: def.icon,
  }))
})

const setMode = (mode: string) => {
  emit('update:currentMode', mode)
}

const nodeIcons: Record<string, string> = {
  stochastic: 'fas fa-random',
  deterministic: 'fas fa-calculator',
  constant: 'fas fa-square',
  observed: 'fas fa-eye',
  plate: 'fas fa-th-large',
}

const nodeColors: Record<string, string> = {
  stochastic: '#ef4444',
  deterministic: '#10b981',
  constant: '#6b7280',
  observed: '#3b82f6',
  plate: '#8b5cf6',
  edge: '#f59e0b',
}

const lastAddTool = ref<NodeType | 'edge'>(props.currentNodeType)

watch(
  () => props.currentMode,
  (newMode) => {
    if (newMode === 'add-edge') {
      lastAddTool.value = 'edge'
    } else if (newMode === 'add-node') {
      lastAddTool.value = props.currentNodeType
    }
  }
)

watch(
  () => props.currentNodeType,
  (newType) => {
    if (props.currentMode === 'add-node') {
      lastAddTool.value = newType
    }
  }
)

const currentAddToolIcon = computed(() => {
  if (lastAddTool.value === 'edge') return 'fas fa-bezier-curve'
  return nodeIcons[lastAddTool.value] || 'fas fa-circle'
})

const currentAddToolColor = computed(() => {
  if (lastAddTool.value === 'edge') return nodeColors.edge
  return nodeColors[lastAddTool.value] || 'var(--theme-primary)'
})

const currentAddToolLabel = computed(() => {
  if (lastAddTool.value === 'edge') return 'Edge'
  const node = availableNodeTypes.value.find((n) => n.value === lastAddTool.value)
  return node ? node.label : 'Node'
})

const isAddModeActive = computed(() => {
  if (lastAddTool.value === 'edge') return props.currentMode === 'add-edge'
  return props.currentMode === 'add-node' && props.currentNodeType === lastAddTool.value
})

const selectAddTool = (tool: NodeType | 'edge') => {
  lastAddTool.value = tool
  if (tool === 'edge') {
    emit('update:currentMode', 'add-edge')
  } else {
    emit('update:currentNodeType', tool)
    emit('update:currentMode', 'add-node')
  }
}

const addButtonStyle = computed(() => {
  if (isAddModeActive.value) {
    const color = currentAddToolColor.value
    return {
      backgroundColor: color,
      borderColor: color,
      color: '#ffffff',
    }
  }
  return {}
})

// --- Smooth Dragging Logic (Transform-based) ---
const toolbarRef = ref<HTMLElement | null>(null)
const isDragging = ref(false)
// Initial CSS state: Centered at bottom
const styleState = ref({
  left: '50%',
  bottom: '24px',
  top: 'auto',
  transform: 'translateX(-50%)',
})
const dragOffset = ref({ x: 0, y: 0 })
let animationFrameId: number | null = null

const startDrag = (event: MouseEvent) => {
  if (
    (event.target as HTMLElement).closest('button') ||
    (event.target as HTMLElement).closest('select') ||
    (event.target as HTMLElement).closest('.p-popover') ||
    (event.target as HTMLElement).closest('input')
  )
    return

  if (!toolbarRef.value) return

  isDragging.value = true
  emit('drag-start') // Signal start of drag
  const rect = toolbarRef.value.getBoundingClientRect()

  dragOffset.value = {
    x: event.clientX - rect.left,
    y: event.clientY - rect.top,
  }

  // Switch to absolute positioning with transform for performance
  // We lock left/top to 0 and use translate3d for the actual position
  styleState.value = {
    left: '0px',
    top: '0px',
    bottom: 'auto',
    transform: `translate3d(${rect.left}px, ${rect.top}px, 0)`,
  }

  window.addEventListener('mousemove', onDrag)
  window.addEventListener('mouseup', stopDrag)
}

const onDrag = (event: MouseEvent) => {
  if (!isDragging.value) return

  // Throttle updates using requestAnimationFrame
  if (animationFrameId) return

  animationFrameId = requestAnimationFrame(() => {
    const x = event.clientX - dragOffset.value.x
    const y = event.clientY - dragOffset.value.y
    styleState.value.transform = `translate3d(${x}px, ${y}px, 0)`
    animationFrameId = null
  })
}

const stopDrag = () => {
  isDragging.value = false
  emit('drag-end', { x: 0, y: 0 })
  if (animationFrameId) cancelAnimationFrame(animationFrameId)
  animationFrameId = null
  window.removeEventListener('mousemove', onDrag)
  window.removeEventListener('mouseup', stopDrag)
}

// Touch Support
const startDragTouch = (event: TouchEvent) => {
  if (
    (event.target as HTMLElement).closest('button') ||
    (event.target as HTMLElement).closest('select') ||
    (event.target as HTMLElement).closest('.p-popover') ||
    (event.target as HTMLElement).closest('input')
  )
    return

  if (!toolbarRef.value) return

  isDragging.value = true
  emit('drag-start') // Signal start of drag
  const rect = toolbarRef.value.getBoundingClientRect()
  const touch = event.touches[0]

  dragOffset.value = {
    x: touch.clientX - rect.left,
    y: touch.clientY - rect.top,
  }

  styleState.value = {
    left: '0px',
    top: '0px',
    bottom: 'auto',
    transform: `translate3d(${rect.left}px, ${rect.top}px, 0)`,
  }

  window.addEventListener('touchmove', onDragTouch, { passive: false })
  window.addEventListener('touchend', stopDragTouch)
}

const onDragTouch = (event: TouchEvent) => {
  if (!isDragging.value) return
  event.preventDefault() // Prevent scrolling while dragging
  const touch = event.touches[0]

  if (animationFrameId) return

  animationFrameId = requestAnimationFrame(() => {
    const x = touch.clientX - dragOffset.value.x
    const y = touch.clientY - dragOffset.value.y
    styleState.value.transform = `translate3d(${x}px, ${y}px, 0)`
    animationFrameId = null
  })
}

const stopDragTouch = () => {
  isDragging.value = false
  emit('drag-end', { x: 0, y: 0 })
  if (animationFrameId) cancelAnimationFrame(animationFrameId)
  animationFrameId = null
  window.removeEventListener('touchmove', onDragTouch)
  window.removeEventListener('touchend', stopDragTouch)
}

onUnmounted(() => {
  window.removeEventListener('mousemove', onDrag)
  window.removeEventListener('mouseup', stopDrag)
  window.removeEventListener('touchmove', onDragTouch)
  window.removeEventListener('touchend', stopDragTouch)
})
</script>

<template>
  <div
    class="db-toolbar-container"
    ref="toolbarRef"
    :style="styleState"
    @mousedown="startDrag"
    @touchstart="startDragTouch"
  >
    <div class="db-floating-dock db-glass-panel">
      <div class="db-drag-handle" title="Drag Toolbar">
        <i class="fas fa-grip-vertical"></i>
      </div>

      <!-- Widget-Only Navigation Group -->
      <template v-if="isWidget">
        <button class="db-dock-btn" @click="$emit('nav', 'project')" title="Projects">
          <i class="fas fa-folder"></i>
        </button>
        <button class="db-dock-btn" @click="$emit('nav', 'view')" title="View Options">
          <i class="fas fa-eye"></i>
        </button>
        <div class="db-divider"></div>
      </template>

      <!-- Tools Group -->
      <button
        class="db-dock-btn"
        :class="{ 'db-active': currentMode === 'select' }"
        @click="setMode('select')"
        title="Select Tool (V)"
        type="button"
      >
        <i class="fas fa-mouse-pointer"></i>
      </button>

      <DropdownMenu class="db-dock-dropdown add-tool-dropdown">
        <template #trigger>
          <button
            class="db-add-tool-btn"
            :class="{ 'db-active': isAddModeActive }"
            :style="addButtonStyle"
            title="Add Node or Edge"
            type="button"
          >
            <i
              :class="currentAddToolIcon"
              class="db-tool-icon"
              :style="{ color: isAddModeActive ? 'white' : currentAddToolColor }"
            ></i>
            <span
              class="db-tool-label"
              :style="{ color: isAddModeActive ? 'white' : 'var(--theme-text-primary)' }"
            >
              {{ currentAddToolLabel }}
            </span>
            <i
              class="fas fa-chevron-down db-arrow-icon"
              :style="{ color: isAddModeActive ? 'white' : 'var(--theme-text-muted)' }"
            ></i>
          </button>
        </template>
        <template #content>
          <div class="db-dropdown-section-title">Nodes</div>
          <a
            href="#"
            v-for="type in availableNodeTypes"
            :key="type.value"
            @click.prevent="selectAddTool(type.value)"
          >
            <i
              :class="nodeIcons[type.value]"
              :style="{ color: nodeColors[type.value] }"
              class="menu-icon"
            ></i>
            {{ type.label }}
          </a>
          <div class="db-dropdown-divider"></div>
          <div class="db-dropdown-section-title">Connections</div>
          <a href="#" @click.prevent="selectAddTool('edge')">
            <i class="fas fa-bezier-curve menu-icon" :style="{ color: nodeColors.edge }"></i> Edge
          </a>
        </template>
      </DropdownMenu>

      <div class="db-divider"></div>

      <!-- Detach Mode (Touch) -->
      <template v-if="showDetachModeControl">
        <button
          class="db-dock-btn"
          :class="{ 'db-active': isDetachModeActive }"
          @click="$emit('toggle-detach-mode')"
          title="Detach Mode (Simulates Alt/Option key)"
          type="button"
        >
          <i class="fas fa-unlink"></i>
        </button>
        <div class="db-divider"></div>
      </template>

      <!-- History & Panels -->
      <button class="db-dock-btn" @click="$emit('undo')" title="Undo (Ctrl+Z)" type="button">
        <i class="fas fa-undo"></i>
      </button>
      <button class="db-dock-btn" @click="$emit('redo')" title="Redo (Ctrl+Y)" type="button">
        <i class="fas fa-redo"></i>
      </button>

      <button
        class="db-dock-btn"
        :class="{ 'db-active': showCodePanel }"
        @click="$emit('toggle-code-panel')"
        title="BUGS Code"
        type="button"
      >
        <i class="fas fa-code"></i>
      </button>

      <button
        class="db-dock-btn"
        :class="{ 'db-active': showDataPanel }"
        @click="$emit('toggle-data-panel')"
        title="Data Panel"
        type="button"
      >
        <i class="fas fa-database"></i>
      </button>

      <button
        class="db-dock-btn"
        @click="$emit('open-style-modal')"
        title="Graph Style"
        type="button"
      >
        <i class="fas fa-palette"></i>
      </button>

      <template v-if="showZoomControls">
        <div class="db-divider"></div>
        <button class="db-dock-btn" @click="$emit('zoom-in')" title="Zoom In" type="button">
          <i class="fas fa-plus"></i>
        </button>
        <button class="db-dock-btn" @click="$emit('zoom-out')" title="Zoom Out" type="button">
          <i class="fas fa-minus"></i>
        </button>
        <button class="db-dock-btn" @click="$emit('fit')" title="Fit to View" type="button">
          <i class="fas fa-compress-arrows-alt"></i>
        </button>
      </template>

      <div class="db-divider"></div>

      <!-- Widget-Only Export & Help Group -->
      <template v-if="isWidget">
        <button class="db-dock-btn" @click="$emit('nav', 'export')" title="Export">
          <i class="fas fa-file-export"></i>
        </button>
        <button class="db-dock-btn" @click="$emit('nav', 'help')" title="Help & Dev Tools">
          <i class="fas fa-question-circle"></i>
        </button>
        <div class="db-divider"></div>
      </template>

      <!-- Layout Dropdown -->
      <DropdownMenu class="db-dock-dropdown">
        <template #trigger>
          <button class="db-dock-btn" title="Graph Layout" type="button">
            <i class="fas fa-sitemap"></i>
          </button>
        </template>
        <template #content>
          <div class="db-dropdown-section-title">Layout</div>
          <a href="#" @click.prevent="$emit('layout-graph', 'dagre')">Dagre</a>
          <a href="#" @click.prevent="$emit('layout-graph', 'fcose')">fCoSE</a>
          <a href="#" @click.prevent="$emit('layout-graph', 'cola')">Cola</a>
          <a href="#" @click.prevent="$emit('layout-graph', 'klay')">KLay</a>
          <a href="#" @click.prevent="$emit('layout-graph', 'preset')">Reset</a>
        </template>
      </DropdownMenu>
    </div>
  </div>
</template>

<style scoped>
.db-toolbar-container {
  position: fixed;
  z-index: 400; /* Layer 5: Toolbar - above panels, below dropdowns */
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  cursor: grab;
  touch-action: none;
  /* Hardware acceleration for smooth movement */
  will-change: transform;
}

.db-toolbar-container:active {
  cursor: grabbing;
}

.db-floating-dock {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 6px 8px;
  border-radius: var(--radius-pill);
  transition: box-shadow 0.2s ease;
  /* Prevent text selection during drag */
  user-select: none;
}

.db-drag-handle {
  color: var(--theme-text-muted);
  cursor: grab;
  padding: 0 6px;
  display: flex;
  align-items: center;
  font-size: 12px;
}

.db-drag-handle:active {
  cursor: grabbing;
}

.db-dock-btn {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: none;
  background: transparent;
  color: var(--theme-text-secondary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  transition: all 0.2s;
}

.db-dock-btn:hover {
  background: var(--theme-bg-hover);
  color: var(--theme-text-primary);
}

.db-dock-btn.db-active {
  background: var(--theme-primary);
  color: white;
}

.db-divider {
  width: 1px;
  height: 16px;
  background: var(--theme-border);
  margin: 0 4px;
}

.db-add-tool-btn {
  display: flex;
  align-items: center;
  height: 32px;
  border: none;
  background: transparent;
  border-radius: 16px;
  padding: 0 10px;
  cursor: pointer;
  transition: all 0.2s;
  border: 1px solid transparent;
}

.db-add-tool-btn:hover {
  background: var(--theme-bg-hover);
  border-color: var(--theme-border);
}

/* When active, styles are applied via :style binding (colored background) */
.db-add-tool-btn.db-active {
  border-color: transparent;
}

.db-tool-icon {
  font-size: 14px;
  margin-right: 6px;
  pointer-events: none;
}

.db-tool-label {
  font-size: 12px;
  font-weight: 600;
  margin-right: 6px;
  white-space: nowrap;
  pointer-events: none;
}

.db-arrow-icon {
  font-size: 10px;
  opacity: 0.7;
  pointer-events: none;
}

/* Menu Icons */
.menu-icon {
  width: 20px;
  text-align: center;
  margin-right: 4px;
}

/* Dropdown adjustments */
.db-dock-dropdown {
  display: flex;
  align-items: center;
}

.db-dock-dropdown :deep(.p-popover) {
  margin-bottom: 8px;
}

@media (max-width: 768px) {
  .db-toolbar-container {
    bottom: 16px !important;
    left: 50% !important;
    top: auto !important;
    /* Maintain transform for centering on mobile initially, JS will override if dragged */
    width: 100%;
    max-width: 100vw;
  }
  .db-floating-dock {
    max-width: calc(100vw - 32px);
    overflow-x: auto;
    justify-content: flex-start;
  }
  .db-floating-dock::-webkit-scrollbar {
    display: none;
  }
  .db-floating-dock {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .db-drag-handle {
    display: none;
  }
}

/* Glass Panel Polyfill */
.db-glass-panel {
  background: var(--theme-bg-panel-transparent, rgba(255, 255, 255, 0.95));
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border: 1px solid var(--theme-border);
  box-shadow: var(--shadow-floating);
}
</style>



================================================
FILE: src/components/canvas/GraphCanvas.vue
================================================
<script setup lang="ts">
import { ref, onMounted, onUnmounted, watch } from 'vue'
import type { Core, EventObject, NodeSingular, ElementDefinition } from 'cytoscape'
import { useToast } from 'primevue/usetoast'
import { useGraphInstance } from '../../composables/useGraphInstance'
import { useGridSnapping } from '../../composables/useGridSnapping'
import type {
  GraphElement,
  GraphNode,
  GraphEdge,
  NodeType,
  PaletteItemType,
  ValidationError,
} from '../../types'
import type { GridStyle } from '../../stores/uiStore'
import { useUiStore } from '../../stores/uiStore'

const props = defineProps<{
  graphId: string
  elements: GraphElement[]
  isGridEnabled: boolean
  gridSize: number
  gridStyle?: GridStyle
  currentMode: string
  validationErrors: Map<string, ValidationError[]>
  showZoomControls?: boolean
  initialViewport?: { zoom: number; pan: { x: number; y: number } }
}>()

const emit = defineEmits<{
  (e: 'canvas-tap', event: EventObject): void
  (
    e: 'node-moved',
    payload: { nodeId: string; position: { x: number; y: number }; parentId: string | undefined }
  ): void
  (e: 'node-dropped', payload: { nodeType: NodeType; position: { x: number; y: number } }): void
  (e: 'plate-emptied', plateId: string): void
  (e: 'element-remove', elementId: string): void
  (e: 'update:show-zoom-controls', value: boolean): void
  (e: 'graph-updated', elements: GraphElement[]): void
  (e: 'viewport-changed', viewport: { zoom: number; pan: { x: number; y: number } }): void
}>()

const cyContainer = ref<HTMLElement | null>(null)
let cy: Core | null = null
const cyInstance = ref<Core | null>(null)
let resizeObserver: ResizeObserver | null = null

const toast = useToast()
const { initCytoscape, destroyCytoscape, getCyInstance, getUndoRedoInstance } = useGraphInstance()
const getCy = () => getCyInstance(props.graphId)
const { enableGridSnapping, disableGridSnapping, setGridSize } = useGridSnapping(getCy)
const uiStore = useUiStore()

const isGraphVisible = ref(false)
const isGraphReady = ref(false)

const validNodeTypes: NodeType[] = ['stochastic', 'deterministic', 'constant', 'observed', 'plate']

const formatElementsForCytoscape = (
  elements: GraphElement[],
  errors: Map<string, ValidationError[]>
): ElementDefinition[] => {
  return elements.map((el) => {
    if (el.type === 'node') {
      const node = el as GraphNode
      const hasError = errors.has(node.id)
      return {
        group: 'nodes',
        data: { ...node, hasError },
        position: node.position,
      }
    } else {
      const edge = el as GraphEdge
      const targetNode = elements.find((n) => n.id === edge.target && n.type === 'node') as
        | GraphNode
        | undefined
      const relType =
        targetNode?.nodeType === 'stochastic' || targetNode?.nodeType === 'observed'
          ? 'stochastic'
          : 'deterministic'
      return {
        group: 'edges',
        data: {
          ...edge,
          relationshipType: relType,
        },
      }
    }
  })
}

const syncGraphWithProps = (
  elementsToSync: GraphElement[],
  errorsToSync: Map<string, ValidationError[]>
) => {
  if (!cy) return

  const formattedElements = formatElementsForCytoscape(elementsToSync, errorsToSync)

  cy.batch(() => {
    const newElementIds = new Set(elementsToSync.map((el) => el.id))

    // Remove deleted elements, preserving ghost nodes used for drag operations
    cy!.elements().forEach((cyEl) => {
      if (!newElementIds.has(cyEl.id()) && !cyEl.id().startsWith('ghost_')) {
        cyEl.remove()
      }
    })

    const nodes = formattedElements.filter((el) => el.group === 'nodes')
    const edges = formattedElements.filter((el) => el.group === 'edges')

    // Sort nodes by depth (parents before children) to ensure correct parentage assignment
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    const nodeDefMap = new Map<string, any>(nodes.map((n) => [n.data.id as string, n]))
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    const getDepth = (n: any, visited = new Set<string>()): number => {
      const id = n.data.id
      if (visited.has(id)) return 0
      visited.add(id)
      const parentId = n.data.parent
      if (!parentId) return 0
      const parentDef = nodeDefMap.get(parentId)
      if (parentDef) {
        return 1 + getDepth(parentDef, visited)
      }
      return 0
    }
    nodes.sort((a, b) => getDepth(a) - getDepth(b))

    nodes.forEach((formattedEl) => {
      if (!formattedEl.data.id) return

      const existingCyEl = cy!.getElementById(formattedEl.data.id)

      if (existingCyEl.empty()) {
        cy!.add(formattedEl)
      } else {
        // Optimization: Only update data if changed
        const currentData = existingCyEl.data()
        const newData = formattedEl.data
        if (JSON.stringify(currentData) !== JSON.stringify(newData)) {
          existingCyEl.data(newData)
        }

        const newNode = formattedEl as ElementDefinition & { position: { x: number; y: number } }
        const currentCyPos = existingCyEl.position()
        if (
          Math.abs(newNode.position.x - currentCyPos.x) > 0.01 ||
          Math.abs(newNode.position.y - currentCyPos.y) > 0.01
        ) {
          existingCyEl.position(newNode.position)
        }

        const parentCollection = existingCyEl.parent()
        const currentParentId =
          parentCollection.length > 0 ? parentCollection.first().id() : undefined

        if (newNode.data.parent !== currentParentId) {
          existingCyEl.move({ parent: newNode.data.parent ?? null })
        }
      }
    })

    edges.forEach((formattedEl) => {
      if (!formattedEl.data.id) return

      const existingCyEl = cy!.getElementById(formattedEl.data.id)

      if (existingCyEl.empty()) {
        const srcId = formattedEl.data.source
        const tgtId = formattedEl.data.target
        // Safety check: ensure source and target exist before adding edge
        if (cy!.getElementById(srcId).nonempty() && cy!.getElementById(tgtId).nonempty()) {
          cy!.add(formattedEl)
        } else {
          console.warn(
            `Skipping edge ${formattedEl.data.id}: source ${srcId} or target ${tgtId} missing`
          )
        }
      } else {
        if (JSON.stringify(existingCyEl.data()) !== JSON.stringify(formattedEl.data)) {
          existingCyEl.data(formattedEl.data)
        }
      }
    })
  })
}

const getSerializedElements = (): GraphElement[] => {
  if (!cy) return []
  return (
    cy
      .elements()
      .toArray()
      // Exclude temporary "ghost" nodes from serialization
      .filter((ele) => !ele.id().startsWith('ghost_'))
      .map((ele) => {
        const data = ele.data()
        // Remove temporary UI state flags
        // eslint-disable-next-line @typescript-eslint/no-unused-vars
        const { hasError, ...cleanData } = data

        if (ele.isNode()) {
          const parentCollection = ele.parent()
          const parentId = parentCollection.length > 0 ? parentCollection.first().id() : undefined
          return {
            ...cleanData,
            type: 'node',
            position: ele.position(),
            parent: parentId,
          } as GraphNode
        } else {
          return {
            ...cleanData,
            type: 'edge',
            source: ele.source().id(),
            target: ele.target().id(),
          } as GraphEdge
        }
      })
  )
}

const updateGridStyle = () => {
  if (!cyContainer.value || !cy) return

  if (props.isGridEnabled && props.gridSize > 0) {
    const pan = cy.pan()
    const zoom = cy.zoom()
    const scaledSize = props.gridSize * zoom

    cyContainer.value.style.backgroundPosition = `${pan.x}px ${pan.y}px`
    cyContainer.value.style.backgroundSize = `${scaledSize}px ${scaledSize}px`

    const isDarkMode = uiStore.isDarkMode

    if (props.gridStyle === 'dots') {
      const dotColor = isDarkMode ? 'rgba(255, 255, 255, 0.2)' : '#4b5563'
      cyContainer.value.style.backgroundImage = `radial-gradient(circle, ${dotColor} 1.2px, transparent 1px)`
    } else if (props.gridStyle === 'lines') {
      const lineColor = isDarkMode ? 'rgba(255, 255, 255, 0.08)' : '#d1d5db'
      cyContainer.value.style.backgroundImage = `linear-gradient(to right, ${lineColor} 1px, transparent 1px), linear-gradient(to bottom, ${lineColor} 1px, transparent 1px)`
    }
  } else {
    cyContainer.value.style.backgroundPosition = ''
    cyContainer.value.style.backgroundSize = ''
    cyContainer.value.style.backgroundImage = ''
  }
}

// Updated mapping for dynamic summary based on severity
const summaryMap: Record<'info' | 'warn' | 'error' | 'success', string> = {
  info: 'Info',
  warn: 'Warning',
  error: 'Error',
  success: 'Success',
}

const handleToast = (message: string, severity: 'info' | 'warn' | 'error' | 'success' = 'info') => {
  toast.add({ severity: severity, summary: summaryMap[severity], detail: message, life: 3000 })
}

onMounted(() => {
  if (cyContainer.value) {
    // Initialize Cytoscape (elements synced later on resize)
    cy = initCytoscape(cyContainer.value, [], props.graphId, handleToast)
    cyInstance.value = cy

    setGridSize(props.gridSize)

    if (props.isGridEnabled) {
      enableGridSnapping()
    } else {
      disableGridSnapping()
    }

    const ur = getUndoRedoInstance(props.graphId)
    if (ur) {
      cy.on('afterUndo afterRedo afterDo', () => {
        if (!cy) return
        emit('graph-updated', getSerializedElements())
      })
    }

    cy.on('layoutstop', () => {
      if (cy && cy.elements().length > 0) {
        emit('graph-updated', getSerializedElements())
      }
      updateGridStyle()
    })

    let rafId: number | null = null
    const emitViewport = () => {
      if (!cy) return
      updateGridStyle()
      emit('viewport-changed', { zoom: cy.zoom(), pan: cy.pan() })
      rafId = null
    }
    cy.on('pan zoom', () => {
      if (rafId === null) {
        rafId = requestAnimationFrame(emitViewport)
      }
    })

    cy.container()?.addEventListener('cxt-remove', (event: Event) => {
      const customEvent = event as CustomEvent
      if (customEvent.detail.elementId) {
        emit('element-remove', customEvent.detail.elementId)
      }
    })

    cy.on('tap', (evt: EventObject) => {
      emit('canvas-tap', evt)
    })

    cy.on('free', 'node', (evt: EventObject) => {
      const node = evt.target as NodeSingular

      if (node.id().startsWith('ghost_')) return

      const parentCollection = node.parent()
      const parentId = parentCollection.length > 0 ? parentCollection.first().id() : undefined

      emit('node-moved', {
        nodeId: node.id(),
        position: node.position(),
        parentId: parentId,
      })
    })

    cy.on('tap', 'node, edge', (evt: EventObject) => {
      cy?.elements().removeClass('cy-selected')
      evt.target.addClass('cy-selected')
    })
    cy.on('tap', (evt: EventObject) => {
      if (evt.target === cy) {
        cy?.elements().removeClass('cy-selected')
      }
    })

    cyContainer.value.addEventListener('dragover', (event) => {
      event.preventDefault()
      if (event.dataTransfer) {
        event.dataTransfer.dropEffect = 'copy'
      }
    })

    cyContainer.value.addEventListener('drop', (event) => {
      event.preventDefault()

      if (event.dataTransfer) {
        const droppedItemType = event.dataTransfer.getData('text/plain') as PaletteItemType
        if (validNodeTypes.includes(droppedItemType as NodeType)) {
          const bbox = cyContainer.value?.getBoundingClientRect()
          if (bbox && cy) {
            const clientX = event.clientX
            const clientY = event.clientY
            const renderedPos = { x: clientX - bbox.left, y: clientY - bbox.top }
            const pan = cy.pan()
            const zoom = cy.zoom()
            const modelPos = {
              x: (renderedPos.x - pan.x) / zoom,
              y: (renderedPos.y - pan.y) / zoom,
            }
            emit('node-dropped', { nodeType: droppedItemType as NodeType, position: modelPos })
          }
        }
      }
    })

    resizeObserver = new ResizeObserver(() => {
      if (cy) {
        cy.resize()
        const containerWidth = cyContainer.value?.clientWidth || 0
        const containerHeight = cyContainer.value?.clientHeight || 0

        if (containerWidth > 0 && containerHeight > 0) {
          if (!isGraphReady.value) {
            isGraphReady.value = true

            syncGraphWithProps(props.elements, props.validationErrors)

            if (props.initialViewport) {
              cy.viewport({
                zoom: props.initialViewport.zoom,
                pan: props.initialViewport.pan,
              })
            } else if (props.elements.length > 0) {
              cy.fit(undefined, 50)
              if (cy.zoom() > 0.8) {
                cy.zoom(0.8)
                cy.center()
              }
            }

            updateGridStyle()

            requestAnimationFrame(() => {
              isGraphVisible.value = true
            })
          } else {
            updateGridStyle()
          }
        }
      }
    })
    resizeObserver.observe(cyContainer.value)
  }
})

onUnmounted(() => {
  if (resizeObserver) {
    resizeObserver.disconnect()
    resizeObserver = null
  }
  if (cy) {
    destroyCytoscape(props.graphId)
  }
})

watch(
  () => props.isGridEnabled,
  (newValue: boolean) => {
    if (newValue) {
      enableGridSnapping()
      updateGridStyle()
    } else {
      disableGridSnapping()
      if (cyContainer.value) {
        cyContainer.value.style.backgroundPosition = ''
        cyContainer.value.style.backgroundSize = ''
      }
    }
  }
)

watch(
  () => props.gridSize,
  (newValue: number) => {
    setGridSize(newValue)
    if (props.isGridEnabled) {
      enableGridSnapping()
      updateGridStyle()
    }
  }
)

watch(
  () => props.gridStyle,
  () => {
    if (props.isGridEnabled) {
      updateGridStyle()
    }
  }
)

// Watch for theme changes to update grid color
watch(
  () => uiStore.isDarkMode,
  () => {
    // Wait for DOM update of class
    requestAnimationFrame(() => {
        updateGridStyle()
    })
  }
)

watch(
  [() => props.elements, () => props.validationErrors],
  ([newElements, newErrors]) => {
    // Only sync if graph is ready (container sized and initialized)
    if (isGraphReady.value) {
      syncGraphWithProps(newElements, newErrors)
    }
  },
  { deep: true }
)

// Watch for global style changes and force update (for both nodes and edges)
watch(
  [() => uiStore.nodeStyles, () => uiStore.edgeStyles],
  () => {
    if (cy) {
      cy.style().update()
    }
  },
  { deep: true }
)
</script>

<template>
  <div
    ref="cyContainer"
    class="db-cytoscape-container"
    :class="{
      'db-grid-background': isGridEnabled && gridSize > 0,
      'db-grid-lines': gridStyle === 'lines' && isGridEnabled && gridSize > 0,
      'db-grid-dots': gridStyle === 'dots' && isGridEnabled && gridSize > 0,
      'db-mode-add-node': currentMode === 'add-node',
      'db-mode-add-edge': currentMode === 'add-edge',
      'db-mode-select': currentMode === 'select',
      'db-graph-ready': isGraphVisible,
    }"
    :style="{
      position: 'relative',
      width: '100%',
      height: '100%',
      minHeight: '200px',
      backgroundColor: 'var(--theme-bg-canvas)',
      opacity: isGraphVisible ? 1 : 0,
      transition: isGraphVisible ? 'opacity 0.3s ease-in-out' : 'none',
    }"
  ></div>
</template>

<style scoped>
.db-cytoscape-container {
  flex-grow: 1;
  background-color: var(--theme-bg-canvas);
  position: relative !important;
  overflow: hidden;
  cursor: grab;
  background-position: 0 0;
  background-repeat: repeat;
  width: 100%;
  height: 100%;
  min-height: 200px;
}

.db-cytoscape-container.db-mode-add-node {
  cursor: crosshair;
}

.db-cytoscape-container.db-mode-add-edge {
  cursor: alias;
}

/* NOTE: .cdnd- classes are usually injected by extensions or used globally.
  We are keeping them as-is.
*/
:deep(.cdnd-grabbed-node) {
  background-color: #ffd700 !important;
  opacity: 0.7;
  border: 2px dashed #ffa500;
}

:deep(.cdnd-drop-target) {
  border: 3px solid #32cd32 !important;
  background-color: rgba(50, 205, 50, 0.1) !important;
}

:deep(.cdnd-drag-out) {
  border: 2px dashed #ff0000 !important;
  background-color: rgba(255, 0, 0, 0.1) !important;
}

/* Grid Dots Styling - Uses variables for automatic Dark Mode support */
.db-cytoscape-container.db-grid-background.db-grid-dots {
  background-image: radial-gradient(
    circle,
    var(--theme-text-secondary) 1.2px,
    transparent 1px
  ) !important;
}

/* Grid Lines Styling - Uses variables for automatic Dark Mode support */
.db-cytoscape-container.db-grid-background.db-grid-lines {
  background-image:
    linear-gradient(to right, var(--theme-grid-line) 1px, transparent 1px),
    linear-gradient(to bottom, var(--theme-grid-line) 1px, transparent 1px) !important;
}

/* Dark mode overrides using :global to catch class on widget root or body (for teleported content) */
:global(.db-dark-mode) .db-cytoscape-container.db-grid-background.db-grid-dots,
:global(body.db-dark-mode) .db-cytoscape-container.db-grid-background.db-grid-dots {
  background-image: radial-gradient(
    circle,
    rgba(255, 255, 255, 0.2) 1.2px,
    transparent 1px
  ) !important;
}

:global(.db-dark-mode) .db-cytoscape-container.db-grid-background.db-grid-lines,
:global(body.db-dark-mode) .db-cytoscape-container.db-grid-background.db-grid-lines {
  background-image:
    linear-gradient(to right, rgba(255, 255, 255, 0.08) 1px, transparent 1px),
    linear-gradient(to bottom, rgba(255, 255, 255, 0.08) 1px, transparent 1px) !important;
}
</style>



================================================
FILE: src/components/canvas/GraphEditor.vue
================================================
<script setup lang="ts">
import { ref, watch, computed } from 'vue'
import type { NodeSingular, EventObject, Core } from 'cytoscape'
import GraphCanvas from './GraphCanvas.vue'
import { useGraphElements } from '../../composables/useGraphElements'
import { useGraphInstance } from '../../composables/useGraphInstance'
import { useGraphStore } from '../../stores/graphStore'
import type { GraphElement, GraphNode, GraphEdge, NodeType, ValidationError } from '../../types'
import type { GridStyle } from '../../stores/uiStore'
import { getDefaultNodeData } from '../../config/nodeDefinitions'

// Fallback UUID generator for iOS Safari
const generateUUID = (): string => {
  if (typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function') {
    return crypto.randomUUID()
  }
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c) => {
    const r = (Math.random() * 16) | 0
    const v = c === 'x' ? r : (r & 0x3) | 0x8
    return v.toString(16)
  })
}

const props = defineProps<{
  graphId: string
  isGridEnabled: boolean
  gridSize: number
  gridStyle?: GridStyle
  currentMode: string
  currentNodeType: NodeType
  elements: GraphElement[]
  validationErrors: Map<string, ValidationError[]>
  showZoomControls?: boolean
}>()

const emit = defineEmits<{
  (e: 'element-selected', element: GraphElement | null): void
  (e: 'update:currentMode', mode: string): void
  (e: 'update:currentNodeType', type: NodeType): void
  (e: 'layout-updated', layoutName: string): void
  (e: 'update:show-zoom-controls', value: boolean): void
  (e: 'update:isGridEnabled', value: boolean): void
  (e: 'update:gridSize', value: number): void
  (e: 'viewport-changed', value: { zoom: number; pan: { x: number; y: number } }): void
}>()

const graphStore = useGraphStore()
const {
  elements: graphElements,
  addElement,
  updateElement,
  deleteElement,
} = useGraphElements(props.graphId)
const { getCyInstance, getUndoRedoInstance } = useGraphInstance()

const initialViewport = computed(() => {
  if (props.graphId && graphStore.graphContents.has(props.graphId)) {
    const content = graphStore.graphContents.get(props.graphId)
    if (content && content.zoom !== undefined && content.pan) {
      return { zoom: content.zoom, pan: content.pan }
    }
  }
  return undefined
})

const handleGraphUpdated = (newElements: GraphElement[]) => {
  graphElements.value = newElements
}

const formatForCy = (el: GraphElement) => {
  if (el.type === 'node') {
    const node = el as GraphNode
    return { group: 'nodes', data: node, position: node.position }
  } else {
    const edge = el as GraphEdge
    return { group: 'edges', data: edge }
  }
}

const sourceNode = ref<NodeSingular | null>(null)
const isConnecting = ref(false)

const greekAlphabet = [
  'alpha',
  'beta',
  'gamma',
  'delta',
  'epsilon',
  'zeta',
  'eta',
  'theta',
  'iota',
  'kappa',
  'lambda',
  'mu',
  'nu',
  'xi',
  'omicron',
  'pi',
  'rho',
  'sigma',
  'tau',
  'upsilon',
  'phi',
  'chi',
  'psi',
  'omega',
]

const getNextNodeName = (): string => {
  const existingNames = new Set(
    graphElements.value
      .filter((el: GraphElement) => el.type === 'node')
      .map((el: GraphElement) => (el as GraphNode).name)
  )

  for (const letter of greekAlphabet) {
    if (!existingNames.has(letter)) {
      return letter
    }
  }

  for (let i = 1; i < 1000; i++) {
    const fallbackName = `var${i}`
    if (!existingNames.has(fallbackName)) {
      return fallbackName
    }
  }

  return `node_${Date.now()}`
}

const createNode = (
  nodeType: NodeType,
  position: { x: number; y: number },
  parentId?: string
): GraphNode => {
  const defaultData = getDefaultNodeData(nodeType)
  const newId = `node_${generateUUID().substring(0, 8)}`
  const newName = nodeType === 'plate' ? 'Plate' : getNextNodeName()

  const newNode: GraphNode = {
    ...defaultData,
    id: newId,
    type: 'node',
    nodeType: nodeType,
    position: position,
    parent: parentId,
    name: newName,
  }

  if (newNode.nodeType === 'stochastic' || newNode.nodeType === 'observed') {
    if (newNode.distribution === 'dnorm') {
      newNode.param1 = '0.0'
      newNode.param2 = '1.0'
    }
    if (newNode.distribution === 'dgamma') {
      newNode.param1 = '0.001'
      newNode.param2 = '0.001'
    }
  }

  return newNode
}

const createPlateWithNode = (position: { x: number; y: number }, parentId?: string): GraphNode => {
  const newPlate = createNode('plate', position, parentId)
  const innerNode = createNode('stochastic', { x: position.x, y: position.y }, newPlate.id)

  const ur = getUndoRedoInstance(props.graphId)
  if (ur) {
    ur.do('batch', [
      { name: 'add', param: formatForCy(newPlate) },
      { name: 'add', param: formatForCy(innerNode) },
    ])
  } else {
    graphElements.value = [...graphElements.value, newPlate, innerNode]
  }
  return newPlate
}

const handleCanvasTap = (event: EventObject) => {
  const { position, target } = event
  const cy = getCyInstance(props.graphId) as Core

  if (!cy) return

  const isBackgroundClick = target === cy
  const isPlateClick = !isBackgroundClick && target.isNode() && target.data('nodeType') === 'plate'
  const isNodeClick = !isBackgroundClick && target.isNode()
  const isEdgeClick = !isBackgroundClick && target.isEdge()

  switch (props.currentMode) {
    case 'add-node':
      if (isBackgroundClick || isPlateClick) {
        if (props.currentNodeType === 'plate') {
          const newPlate = createPlateWithNode(
            position,
            isPlateClick ? (target as NodeSingular).id() : undefined
          )
          emit('element-selected', newPlate)
          // Don't switch back to select mode automatically
        } else {
          const newNode = createNode(
            props.currentNodeType,
            position,
            isPlateClick ? (target as NodeSingular).id() : undefined
          )
          const ur = getUndoRedoInstance(props.graphId)
          if (ur) {
            ur.do('add', formatForCy(newNode))
          } else {
            addElement(newNode)
          }
          emit('element-selected', newNode)
          // Don't switch back to select mode automatically
        }
      }
      break

    case 'add-edge':
      if (isNodeClick) {
        const tappedNode = target as NodeSingular

        if (sourceNode.value && sourceNode.value.id() !== tappedNode.id()) {
          const newEdge: GraphEdge = {
            id: `edge_${generateUUID().substring(0, 8)}`,
            type: 'edge',
            source: sourceNode.value.id(),
            target: tappedNode.id(),
            name: ``,
          }
          const ur = getUndoRedoInstance(props.graphId)
          if (ur) {
            ur.do('add', formatForCy(newEdge))
          } else {
            addElement(newEdge)
          }
          sourceNode.value?.removeClass('cy-connecting')
          sourceNode.value = null
          isConnecting.value = false
          // Keep in add-edge mode to allow adding multiple edges
          // But clear selection so next click can start new edge?
          // Usually edge tool resets or waits for new source.
          // Let's keep it waiting for new source.
          emit('element-selected', newEdge)
        } else if (!sourceNode.value) {
          sourceNode.value = tappedNode
          sourceNode.value.addClass('cy-connecting')
          isConnecting.value = true
          emit('element-selected', sourceNode.value.data())
        } else if (sourceNode.value.id() === tappedNode.id()) {
          // Clicked same node again, maybe deselect?
          sourceNode.value.removeClass('cy-connecting')
          sourceNode.value = null
          isConnecting.value = false
        }
      } else if (isBackgroundClick) {
        sourceNode.value?.removeClass('cy-connecting')
        sourceNode.value = null
        isConnecting.value = false
        emit('element-selected', null)
      }
      break

    default:
      if (isNodeClick || isEdgeClick) {
        emit('element-selected', target.data())
      } else if (isBackgroundClick) {
        emit('element-selected', null)
      }
      break
  }
}

const handleNodeMoved = (payload: {
  nodeId: string
  position: { x: number; y: number }
  parentId: string | undefined
}) => {
  const elementToUpdate = graphElements.value.find(
    (el: GraphElement) => el.id === payload.nodeId
  ) as GraphNode | undefined

  if (elementToUpdate) {
    const updatedNode: GraphNode = {
      ...elementToUpdate,
      position: payload.position,
      parent: payload.parentId,
    }
    updateElement(updatedNode)
    emit('layout-updated', 'preset')
  }
}

const handleNodeDropped = (payload: { nodeType: NodeType; position: { x: number; y: number } }) => {
  const { nodeType, position } = payload
  const cy = getCyInstance(props.graphId)
  let parentPlateId: string | undefined = undefined

  if (nodeType === 'plate') {
    if (cy) {
      const plates = cy.nodes('[nodeType="plate"]')
      for (const plate of plates) {
        const bb = plate.boundingBox()
        if (position.x > bb.x1 && position.x < bb.x2 && position.y > bb.y1 && position.y < bb.y2) {
          parentPlateId = plate.id()
          break
        }
      }
    }
    const newPlate = createPlateWithNode(position, parentPlateId)
    emit('element-selected', newPlate)
    // emit('update:currentMode', 'select'); // DND usually implies a one-off, but let's be consistent if drag from outside
    return
  }

  if (cy) {
    const plates = cy.nodes('[nodeType="plate"]')
    for (const plate of plates) {
      const bb = plate.boundingBox()
      if (position.x > bb.x1 && position.x < bb.x2 && position.y > bb.y1 && position.y < bb.y2) {
        parentPlateId = plate.id()
        break
      }
    }
  }

  const newNode = createNode(nodeType, position, parentPlateId)
  const ur = getUndoRedoInstance(props.graphId)
  if (ur) {
    ur.do('add', formatForCy(newNode))
  } else {
    addElement(newNode)
  }
  emit('element-selected', newNode)
}

const handleDeleteElement = (elementId: string) => {
  const ur = getUndoRedoInstance(props.graphId)
  const cy = getCyInstance(props.graphId)
  if (ur && cy) {
    const el = cy.getElementById(elementId)
    if (el.length > 0) {
      ur.do('remove', el)
    }
  } else {
    deleteElement(elementId)
  }
}

watch(
  () => props.currentMode,
  (newMode) => {
    if (newMode !== 'add-edge') {
      sourceNode.value?.removeClass('cy-connecting')
      sourceNode.value = null
      isConnecting.value = false
    }
  }
)
</script>

<template>
  <div
    class="db-graph-editor-container"
    style="
      display: flex;
      flex-direction: column;
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
    "
  >
    <GraphCanvas
      :graph-id="props.graphId"
      :elements="props.elements"
      :is-grid-enabled="isGridEnabled"
      :grid-size="gridSize"
      :grid-style="gridStyle"
      :current-mode="props.currentMode"
      :validation-errors="props.validationErrors"
      :show-zoom-controls="props.showZoomControls"
      :initial-viewport="initialViewport"
      @canvas-tap="handleCanvasTap"
      @node-moved="handleNodeMoved"
      @node-dropped="handleNodeDropped"
      @element-remove="handleDeleteElement"
      @graph-updated="handleGraphUpdated"
      @viewport-changed="(v) => emit('viewport-changed', v)"
      @update:show-zoom-controls="(value: boolean) => emit('update:show-zoom-controls', value)"
    />
  </div>
</template>

<style scoped>
.db-graph-editor-container {
  flex-grow: 1;
  display: flex;
  flex-direction: column;
  position: relative;
  overflow: hidden;
  height: 100%;
  width: 100%;
}
</style>



================================================
FILE: src/components/common/BaseModal.vue
================================================
<script setup lang="ts">
import Dialog from 'primevue/dialog'
import { computed } from 'vue'

const props = defineProps<{
  isOpen: boolean
  header?: string
}>()

const emit = defineEmits(['close'])

const visible = computed({
  get: () => props.isOpen,
  set: (value) => {
    if (!value) emit('close')
  },
})
</script>

<template>
  <Dialog
    v-model:visible="visible"
    modal
    :header="header"
    class="db-base-modal-responsive"
    dismissableMask
  >
    <template #header v-if="$slots.header">
      <slot name="header"></slot>
    </template>

    <slot name="body"></slot>
    <slot></slot>

    <template #footer v-if="$slots.footer">
      <slot name="footer"></slot>
    </template>
  </Dialog>
</template>

<style>
/* Global styles for the PrimeVue Dialog class. 
  We use the specific class 'db-base-modal-responsive' to target only our modals.
*/
.db-base-modal-responsive {
  width: 50vw;
}

@media (max-width: 768px) {
  .db-base-modal-responsive {
    width: 95vw !important;
  }
}
</style>



================================================
FILE: src/components/common/DebugPanel.vue
================================================
<script setup lang="ts">
import { ref, computed, onMounted, onUnmounted, watch } from 'vue'
import JsonEditorPanel from '../right-sidebar/JsonEditorPanel.vue'
import { useGraphStore } from '../../stores/graphStore'

interface LogEntry {
  timestamp: string
  message: string
  type: 'log' | 'error' | 'warn'
}

const emit = defineEmits(['close', 'resize'])

const graphStore = useGraphStore()
const logs = ref<LogEntry[]>([])
const isVisible = ref(true)
const maxLogs = 100
const copySuccess = ref(false)
const filterType = ref<'all' | 'log' | 'error' | 'warn'>('all')
const activeTab = ref<'console' | 'json'>('console')

// Resizing State
const panelHeight = ref(300) // Default height
const isResizing = ref(false)
const HEADER_HEIGHT = 40 // Height of the header bar when collapsed

const filteredLogs = computed(() => {
  if (filterType.value === 'all') return logs.value
  return logs.value.filter((log) => log.type === filterType.value)
})

const formatValue = (value: unknown): string => {
  if (value === null) return 'null'
  if (value === undefined) return 'undefined'
  if (typeof value === 'string') return value
  if (typeof value === 'number' || typeof value === 'boolean') return String(value)
  if (value instanceof Error) {
    return `${value.name}: ${value.message}\n${value.stack || ''}`
  }
  if (typeof value === 'object') {
    try {
      return JSON.stringify(
        value,
        (key, val) => {
          if (val instanceof Error) {
            return `Error: ${val.message}`
          }
          return val
        },
        2
      )
    } catch {
      return `[Object: ${Object.prototype.toString.call(value)}]`
    }
  }
  return String(value)
}

const addLog = (message: string, type: 'log' | 'error' | 'warn' = 'log') => {
  const timestamp = new Date().toLocaleTimeString()
  logs.value.unshift({ timestamp, message, type })
  if (logs.value.length > maxLogs) {
    logs.value.pop()
  }
}

const getLogClass = (log: LogEntry) => {
  const classes: string[] = []

  if (log.type === 'error') classes.push('db-log-error')
  if (log.type === 'warn') classes.push('db-log-warn')

  if (
    log.message.includes('[GraphEditor]') ||
    log.message.includes('[GraphCanvas]') ||
    log.message.includes('[MainLayout]')
  ) {
    classes.push('db-log-important')
  }

  return classes.join(' ')
}

const clearLogs = () => {
  logs.value = []
}

const toggleVisibility = () => {
  isVisible.value = !isVisible.value
}

const copyLogs = async () => {
  const logsText = filteredLogs.value
    .map((log) => `[${log.timestamp}] ${log.type.toUpperCase()}: ${log.message}`)
    .join('\n')

  try {
    await navigator.clipboard.writeText(logsText)
    copySuccess.value = true
    setTimeout(() => (copySuccess.value = false), 2000)
  } catch {
    const textarea = document.createElement('textarea')
    textarea.value = logsText
    textarea.style.position = 'fixed'
    textarea.style.opacity = '0'
    document.body.appendChild(textarea)
    textarea.select()
    try {
      document.execCommand('copy')
      copySuccess.value = true
      setTimeout(() => (copySuccess.value = false), 2000)
    } catch {
      console.error('Clipboard not supported')
    }
    document.body.removeChild(textarea)
  }
}

const copyJson = async () => {
  const jsonString = JSON.stringify(graphStore.currentGraphElements, null, 2)
  try {
    await navigator.clipboard.writeText(jsonString)
    copySuccess.value = true
    setTimeout(() => (copySuccess.value = false), 2000)
  } catch (err) {
    console.error('Failed to copy JSON', err)
  }
}

const originalLog = console.log
const originalError = console.error
const originalWarn = console.warn

const handleKeydown = (e: KeyboardEvent) => {
  if (e.key === 'Escape') {
    emit('close')
  }
}

// Resizing Logic
const startResize = () => {
  isResizing.value = true
  window.addEventListener('mousemove', onResize)
  window.addEventListener('mouseup', stopResize)
  // Prevent selection during drag
  document.body.style.userSelect = 'none'
}

const onResize = (e: MouseEvent) => {
  if (!isResizing.value) return

  // Calculate height from bottom
  const newHeight = window.innerHeight - e.clientY

  // Constraints
  const minHeight = 100
  const maxHeight = window.innerHeight - 100

  if (newHeight >= minHeight && newHeight <= maxHeight) {
    panelHeight.value = newHeight
  }
}

const stopResize = () => {
  isResizing.value = false
  window.removeEventListener('mousemove', onResize)
  window.removeEventListener('mouseup', stopResize)
  document.body.style.userSelect = ''
}

// Emit height changes so parent can adjust layout
watch([panelHeight, isVisible], () => {
  if (isVisible.value) {
    emit('resize', panelHeight.value)
  } else {
    emit('resize', HEADER_HEIGHT)
  }
})

onMounted(() => {
  console.log = (...args: unknown[]) => {
    originalLog(...args)
    addLog(args.map(formatValue).join(' '), 'log')
  }

  console.error = (...args: unknown[]) => {
    originalError(...args)
    addLog(args.map(formatValue).join(' '), 'error')
  }

  console.warn = (...args: unknown[]) => {
    originalWarn(...args)
    addLog(args.map(formatValue).join(' '), 'warn')
  }

  window.addEventListener('keydown', handleKeydown)

  // Emit initial height
  emit('resize', isVisible.value ? panelHeight.value : HEADER_HEIGHT)

  addLog('Debug panel initialized', 'log')
})

onUnmounted(() => {
  console.log = originalLog
  console.error = originalError
  console.warn = originalWarn
  window.removeEventListener('keydown', handleKeydown)
  window.removeEventListener('mousemove', onResize)
  window.removeEventListener('mouseup', stopResize)

  // Reset parent layout on unmount (implicit via parent logic usually, but consistent behavior)
  emit('resize', 0)
})
</script>

<template>
  <div
    class="db-debug-panel"
    :class="{ 'db-collapsed': !isVisible }"
    :style="{ height: isVisible ? `${panelHeight}px` : `${HEADER_HEIGHT}px` }"
  >
    <!-- Resize Handle -->
    <div class="db-resize-handle" @mousedown="startResize"></div>

    <div class="db-debug-header">
      <div class="db-debug-tabs">
        <button
          @click="activeTab = 'console'"
          class="db-tab-btn"
          :class="{ 'db-active': activeTab === 'console' }"
        >
          üêõ Console
        </button>
        <button
          @click="activeTab = 'json'"
          class="db-tab-btn"
          :class="{ 'db-active': activeTab === 'json' }"
        >
          Graph JSON
        </button>
      </div>
      <div class="db-debug-controls">
        <button
          v-if="activeTab === 'json'"
          @click="copyJson"
          class="db-debug-btn"
          :title="copySuccess ? 'Copied!' : 'Copy JSON'"
        >
          <span v-if="copySuccess">‚úì</span>
          <i v-else class="fas fa-copy"></i>
        </button>

        <template v-if="activeTab === 'console'">
          <button
            @click="copyLogs"
            class="db-debug-btn"
            :title="copySuccess ? 'Copied!' : 'Copy logs'"
          >
            <span v-if="copySuccess">‚úì</span>
            <i v-else class="fas fa-copy"></i>
          </button>
          <button @click="clearLogs" class="db-debug-btn" title="Clear logs">
            <i class="fas fa-trash"></i>
          </button>
        </template>
        <button @click="toggleVisibility" class="db-debug-btn" title="Toggle visibility">
          <i :class="isVisible ? 'fas fa-chevron-down' : 'fas fa-chevron-up'"></i>
        </button>
        <button @click="$emit('close')" class="db-debug-btn db-close-btn" title="Close Debug Panel">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    <div v-show="isVisible" class="db-debug-body">
      <div v-show="activeTab === 'console'" class="db-debug-content-wrapper">
        <div class="db-debug-filters">
          <button
            v-for="type in ['all', 'log', 'error', 'warn']"
            :key="type"
            @click="filterType = type as typeof filterType"
            class="db-filter-btn"
            :class="{ 'db-active': filterType === type }"
          >
            {{ type === 'all' ? 'All' : type.charAt(0).toUpperCase() + type.slice(1) }}
            <span v-if="type !== 'all'" class="db-count">
              {{ logs.filter((l) => l.type === type).length }}
            </span>
            <span v-else class="db-count">{{ logs.length }}</span>
          </button>
        </div>
        <div class="db-debug-logs">
          <div
            v-for="(log, index) in filteredLogs"
            :key="index"
            class="db-debug-log-entry"
            :class="getLogClass(log)"
          >
            <span class="db-log-time">[{{ log.timestamp }}]</span>
            <span class="db-log-type" :class="`db-type-${log.type}`"
              >[{{ log.type.toUpperCase() }}]</span
            >
            <span class="db-log-message">{{ log.message }}</span>
          </div>
          <div v-if="filteredLogs.length === 0" class="db-debug-empty">
            {{
              logs.length === 0 ? 'No logs yet. Waiting for activity...' : `No ${filterType} logs`
            }}
          </div>
        </div>
      </div>
      <div v-show="activeTab === 'json'" class="db-debug-content-wrapper db-json-wrapper">
        <JsonEditorPanel :is-active="activeTab === 'json' && isVisible" />
      </div>
    </div>
  </div>
</template>

<style scoped>
.db-debug-panel {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: rgba(0, 0, 0, 0.95);
  color: #00ff00;
  font-family: 'Courier New', monospace;
  font-size: 11px;
  z-index: 99999;
  pointer-events: auto;
  border-top: 1px solid #00ff00;
  display: flex;
  flex-direction: column;
  box-shadow: 0 -4px 20px rgba(0, 255, 0, 0.3);
  transition: height 0.1s ease; /* Faster transition for resize responsiveness */
}

.db-resize-handle {
  height: 5px;
  width: 100%;
  cursor: ns-resize;
  background-color: transparent;
  position: absolute;
  top: -3px;
  left: 0;
  z-index: 100000;
}

.db-resize-handle:hover {
  background-color: rgba(0, 255, 0, 0.5);
}

.db-debug-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 12px;
  background: rgba(0, 100, 0, 0.3);
  border-bottom: 1px solid #00ff00;
  height: 40px;
  flex-shrink: 0;
}

.db-debug-tabs {
  display: flex;
  height: 100%;
}

.db-tab-btn {
  background: transparent;
  border: none;
  color: #00aa00;
  font-weight: bold;
  padding: 0 16px;
  cursor: pointer;
  border-right: 1px solid rgba(0, 255, 0, 0.3);
  height: 100%;
  transition: all 0.2s;
}

.db-tab-btn:hover {
  background: rgba(0, 255, 0, 0.1);
  color: #00ff00;
}

.db-tab-btn.db-active {
  background: rgba(0, 255, 0, 0.2);
  color: #fff;
  border-bottom: 2px solid #00ff00;
}

.db-debug-controls {
  display: flex;
  gap: 8px;
}

.db-debug-btn {
  background: rgba(0, 255, 0, 0.2);
  border: 1px solid #00ff00;
  color: #00ff00;
  padding: 4px 8px;
  border-radius: 3px;
  cursor: pointer;
  font-size: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 30px;
  transition: all 0.2s;
}

.db-debug-btn:active {
  background: rgba(0, 255, 0, 0.4);
  transform: scale(0.95);
}

.db-debug-btn span {
  font-size: 14px;
  color: #00ff00;
  font-weight: bold;
}

.db-debug-btn.db-close-btn {
  border-color: #ff4444 !important;
  color: #ff4444 !important;
  margin-left: 8px;
}

.db-debug-btn.db-close-btn:hover {
  background: rgba(255, 68, 68, 0.2);
  color: #ffaaaa !important;
}

.db-debug-body {
  flex: 1;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.db-debug-content-wrapper {
  display: flex;
  flex-direction: column;
  overflow: hidden;
  flex: 1;
  min-height: 0;
}

.db-json-wrapper {
  background-color: #282c34; /* CodeMirror theme background match */
  padding: 0;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

/* Adjustments for JsonEditorPanel when inside DebugPanel */
.db-json-wrapper :deep(.json-editor-panel) {
  height: 100%;
  padding: 8px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}

.db-json-wrapper :deep(.editor-wrapper) {
  flex: 1;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  min-height: 0;
}

.db-json-wrapper :deep(.json-editor-container) {
  flex: 1;
  height: 100%;
  overflow: auto;
}

.db-json-wrapper :deep(h4),
.db-json-wrapper :deep(.description) {
  display: none; /* Hide header text inside debug console */
}

.db-json-wrapper :deep(.footer-section) {
  min-height: 30px;
  padding-top: 4px;
  flex-shrink: 0;
}

.db-debug-filters {
  display: flex;
  gap: 4px;
  padding: 6px 12px;
  background: rgba(0, 100, 0, 0.2);
  border-bottom: 1px solid rgba(0, 255, 0, 0.3);
}

.db-filter-btn {
  background: rgba(0, 255, 0, 0.1);
  border: 1px solid rgba(0, 255, 0, 0.3);
  color: #88ff88;
  padding: 3px 8px;
  border-radius: 3px;
  cursor: pointer;
  font-size: 10px;
  font-family: inherit;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 4px;
}

.db-filter-btn:hover {
  background: rgba(0, 255, 0, 0.2);
  border-color: #00ff00;
}

.db-filter-btn.db-active {
  background: rgba(0, 255, 0, 0.3);
  border-color: #00ff00;
  color: #00ff00;
  font-weight: bold;
}

.db-filter-btn .db-count {
  background: rgba(0, 255, 0, 0.2);
  padding: 1px 5px;
  border-radius: 10px;
  font-size: 9px;
}

.db-debug-logs {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
  -webkit-overflow-scrolling: touch;
}

.db-debug-log-entry {
  padding: 4px 8px;
  border-bottom: 1px solid rgba(0, 255, 0, 0.1);
  word-break: break-word;
  line-height: 1.4;
  display: flex;
  gap: 6px;
}

.db-debug-log-entry:hover {
  background: rgba(0, 255, 0, 0.05);
}

.db-log-time {
  color: #666;
  flex-shrink: 0;
}

.db-log-type {
  flex-shrink: 0;
  font-weight: bold;
  min-width: 50px;
}

.db-log-type.db-type-log {
  color: #88ff88;
}

.db-log-type.db-type-error {
  color: #ff4444;
}

.db-log-type.db-type-warn {
  color: #ffaa00;
}

.db-log-message {
  flex: 1;
}

.db-debug-empty {
  text-align: center;
  padding: 20px;
  color: #666;
  font-style: italic;
}

.db-debug-log-entry.db-log-error .db-log-message {
  color: #ff4444;
}

.db-debug-log-entry.db-log-warn .db-log-message {
  color: #ffaa00;
}

.db-debug-log-entry.db-log-important {
  background: rgba(0, 100, 255, 0.1);
  border-left: 3px solid #4a90e2;
}
</style>



================================================
FILE: src/components/common/DropdownMenu.vue
================================================
<script setup lang="ts">
import { ref } from 'vue'
import Popover from 'primevue/popover'

const op = ref()

const toggle = (event: Event) => {
  op.value.toggle(event)
}

const close = () => {
  op.value.hide()
}

const onContentClick = (event: MouseEvent) => {
  const target = event.target as HTMLElement
  if (target.closest('input, select, textarea, label')) {
    return
  }
  close()
}
</script>

<template>
  <div class="inline-block">
    <div @click="toggle" class="cursor-pointer inline-block">
      <slot name="trigger"></slot>
    </div>
    <Popover ref="op">
      <div class="flex flex-col min-w-[150px] py-1" @click="onContentClick">
        <slot name="content"></slot>
      </div>
    </Popover>
  </div>
</template>

<style>
.p-popover-content a {
  display: block;
  padding: 0.5rem 1rem;
  color: var(--p-text-color);
  text-decoration: none;
  transition: background-color 0.2s;
}
.p-popover-content a:hover {
  background-color: var(--p-content-hover-background);
}

.db-dropdown-divider {
  height: 1px;
  background-color: var(--p-content-border-color);
  margin: 0.25rem 0;
}

.db-dropdown-section-title {
  padding: 0.5rem 1rem;
  font-weight: 600;
  color: var(--p-text-muted-color);
  font-size: 0.875rem;
}
</style>



================================================
FILE: src/components/common/FloatingPanel.vue
================================================
<script setup lang="ts">
import { ref, computed, onUnmounted, watch } from 'vue'

const props = defineProps<{
  title: string
  icon?: string
  badge?: string
  isOpen: boolean
  defaultWidth?: number
  defaultHeight?: number
  defaultX?: number
  defaultY?: number
  minWidth?: number
  minHeight?: number
  showDownload?: boolean
  showImport?: boolean
}>()

const emit = defineEmits<{
  (e: 'close'): void
  (e: 'download'): void
  (e: 'import'): void
  (e: 'drag-start'): void
  (e: 'drag-end', position: { x: number; y: number }): void
  (e: 'resize-start'): void
  (e: 'resize-end', size: { width: number; height: number }): void
}>()

const panelRef = ref<HTMLElement | null>(null)

// Position and size state
const width = ref(props.defaultWidth || 400)
const height = ref(props.defaultHeight || 300)
const x = ref(
  props.defaultX ||
    (typeof window !== 'undefined' ? window.innerWidth / 2 - (props.defaultWidth || 400) / 2 : 0)
)
const y = ref(
  props.defaultY ||
    (typeof window !== 'undefined' ? window.innerHeight - (props.defaultHeight || 300) - 100 : 0)
)

// Watch for prop changes to sync with internal state
watch(
  () => props.defaultWidth,
  (newWidth) => {
    if (newWidth !== undefined && newWidth !== width.value) {
      width.value = newWidth
    }
  }
)

watch(
  () => props.defaultHeight,
  (newHeight) => {
    if (newHeight !== undefined && newHeight !== height.value) {
      height.value = newHeight
    }
  }
)

watch(
  () => props.defaultX,
  (newX) => {
    if (newX !== undefined && newX !== x.value) {
      x.value = newX
    }
  }
)

watch(
  () => props.defaultY,
  (newY) => {
    if (newY !== undefined && newY !== y.value) {
      y.value = newY
    }
  }
)

// Dragging state
const isDragging = ref(false)
const dragOffsetX = ref(0)
const dragOffsetY = ref(0)
let dragAnimationFrame: number | null = null
let lastDragX = 0
let lastDragY = 0

// Resizing state
const isResizing = ref(false)
const resizeStartX = ref(0)
const resizeStartY = ref(0)
const resizeStartWidth = ref(0)
const resizeStartHeight = ref(0)
let resizeAnimationFrame: number | null = null
let lastResizeX = 0
let lastResizeY = 0

const panelStyle = computed(() => ({
  // Use translate3d for smooth GPU-accelerated movement
  transform: `translate3d(${x.value}px, ${y.value}px, 0)`,
  // Force top/left to 0 so translate3d works from the origin
  left: '0px',
  top: '0px',
  width: `${width.value}px`,
  height: `${height.value}px`,
}))

// Drag handlers
const startDrag = (e: MouseEvent | TouchEvent) => {
  if (!panelRef.value) return

  isDragging.value = true
  emit('drag-start')

  const rect = panelRef.value.getBoundingClientRect()
  const clientX = e instanceof MouseEvent ? e.clientX : e.touches[0].clientX
  const clientY = e instanceof MouseEvent ? e.clientY : e.touches[0].clientY

  dragOffsetX.value = clientX - rect.left
  dragOffsetY.value = clientY - rect.top

  if (e instanceof MouseEvent) {
    document.addEventListener('mousemove', onDragMove)
    document.addEventListener('mouseup', onDragEnd)
  } else {
    document.addEventListener('touchmove', onDragMoveTouch, { passive: false })
    document.addEventListener('touchend', onDragEnd)
  }
}

const onDragMove = (e: MouseEvent) => {
  if (!isDragging.value) return

  lastDragX = e.clientX - dragOffsetX.value
  lastDragY = e.clientY - dragOffsetY.value

  if (dragAnimationFrame) return

  dragAnimationFrame = requestAnimationFrame(() => {
    x.value = lastDragX
    y.value = lastDragY
    dragAnimationFrame = null
  })
}

const onDragMoveTouch = (e: TouchEvent) => {
  if (!isDragging.value) return
  e.preventDefault()

  lastDragX = e.touches[0].clientX - dragOffsetX.value
  lastDragY = e.touches[0].clientY - dragOffsetY.value

  if (dragAnimationFrame) return

  dragAnimationFrame = requestAnimationFrame(() => {
    x.value = lastDragX
    y.value = lastDragY
    dragAnimationFrame = null
  })
}

const onDragEnd = () => {
  isDragging.value = false
  emit('drag-end', { x: x.value, y: y.value })
  if (dragAnimationFrame) {
    cancelAnimationFrame(dragAnimationFrame)
    dragAnimationFrame = null
  }
  document.removeEventListener('mousemove', onDragMove)
  document.removeEventListener('mouseup', onDragEnd)
  document.removeEventListener('touchmove', onDragMoveTouch)
  document.removeEventListener('touchend', onDragEnd)
}

// Resize handlers
const startResize = (e: MouseEvent | TouchEvent) => {
  e.stopPropagation()
  isResizing.value = true
  emit('resize-start')

  const clientX = e instanceof MouseEvent ? e.clientX : e.touches[0].clientX
  const clientY = e instanceof MouseEvent ? e.clientY : e.touches[0].clientY

  resizeStartX.value = clientX
  resizeStartY.value = clientY
  resizeStartWidth.value = width.value
  resizeStartHeight.value = height.value

  if (e instanceof MouseEvent) {
    document.addEventListener('mousemove', onResizeMove)
    document.addEventListener('mouseup', onResizeEnd)
  } else {
    document.addEventListener('touchmove', onResizeMoveTouch, { passive: false })
    document.addEventListener('touchend', onResizeEnd)
  }
}

const onResizeMove = (e: MouseEvent) => {
  if (!isResizing.value) return

  lastResizeX = e.clientX
  lastResizeY = e.clientY

  if (resizeAnimationFrame) return

  resizeAnimationFrame = requestAnimationFrame(() => {
    const deltaX = lastResizeX - resizeStartX.value
    const deltaY = lastResizeY - resizeStartY.value

    width.value = Math.max(props.minWidth || 300, resizeStartWidth.value + deltaX)
    height.value = Math.max(props.minHeight || 200, resizeStartHeight.value + deltaY)
    resizeAnimationFrame = null
  })
}

const onResizeMoveTouch = (e: TouchEvent) => {
  if (!isResizing.value) return
  e.preventDefault()

  lastResizeX = e.touches[0].clientX
  lastResizeY = e.touches[0].clientY

  if (resizeAnimationFrame) return

  resizeAnimationFrame = requestAnimationFrame(() => {
    const deltaX = lastResizeX - resizeStartX.value
    const deltaY = lastResizeY - resizeStartY.value

    width.value = Math.max(props.minWidth || 300, resizeStartWidth.value + deltaX)
    height.value = Math.max(props.minHeight || 200, resizeStartHeight.value + deltaY)
    resizeAnimationFrame = null
  })
}

const onResizeEnd = () => {
  isResizing.value = false
  emit('resize-end', { width: width.value, height: height.value })
  if (resizeAnimationFrame) {
    cancelAnimationFrame(resizeAnimationFrame)
    resizeAnimationFrame = null
  }
  document.removeEventListener('mousemove', onResizeMove)
  document.removeEventListener('mouseup', onResizeEnd)
  document.removeEventListener('touchmove', onResizeMoveTouch)
  document.removeEventListener('touchend', onResizeEnd)
}

onUnmounted(() => {
  if (dragAnimationFrame) {
    cancelAnimationFrame(dragAnimationFrame)
  }
  if (resizeAnimationFrame) {
    cancelAnimationFrame(resizeAnimationFrame)
  }
  onDragEnd()
  onResizeEnd()
})
</script>

<template>
  <div v-if="isOpen" ref="panelRef" class="db-floating-panel db-glass-panel" :style="panelStyle">
    <div class="db-panel-header" @mousedown="startDrag" @touchstart="startDrag">
      <span class="db-graph-title">
        <i v-if="icon" :class="icon"></i>
        {{ title }}
        <span v-if="badge" class="db-badge-json">{{ badge }}</span>
      </span>
      <div class="db-panel-actions">
        <button
          v-if="showDownload"
          class="db-action-btn"
          @click.stop="emit('download')"
          @mousedown.stop
          @touchstart.stop
          title="Download"
        >
          <i class="fas fa-download"></i>
        </button>
        <button
          v-if="showImport"
          class="db-action-btn"
          @click.stop="emit('import')"
          @mousedown.stop
          @touchstart.stop
          title="Import"
        >
          <i class="fas fa-file-upload"></i>
        </button>
        <button class="db-close-btn" @click.stop="emit('close')" @mousedown.stop @touchstart.stop>
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
    <div class="db-panel-content">
      <slot></slot>
    </div>
    <div
      class="db-resize-handle"
      @mousedown.stop="startResize"
      @touchstart.stop.prevent="startResize"
    >
      <i class="fas fa-chevron-right" style="transform: rotate(45deg)"></i>
    </div>
  </div>
</template>

<style scoped>
.db-floating-panel {
  position: fixed;
  pointer-events: auto;
  z-index: 300; /* Layer 4: Floating panels (code/data) - above sidebars, below toolbar */
  background: var(--theme-bg-panel);
  border: 1px solid var(--theme-border);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-floating);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  /* Hardware acceleration for smooth dragging */
  will-change: transform;
}

.db-panel-header {
  height: 36px;
  background-color: var(--theme-bg-hover);
  border-bottom: 1px solid var(--theme-border);
  display: flex;
  align-items: center;
  padding: 0 10px;
  justify-content: space-between;
  user-select: none;
  cursor: move;
}

.db-graph-title {
  font-weight: 600;
  font-size: 12px;
  color: var(--theme-text-primary);
  display: flex;
  align-items: center;
  gap: 6px;
}

.db-badge-json {
  font-size: 0.7em;
  background-color: var(--theme-primary);
  color: white;
  padding: 2px 4px;
  border-radius: 3px;
  margin-left: 6px;
  font-weight: normal;
  vertical-align: middle;
}

.db-panel-actions {
  display: flex;
  align-items: center;
  gap: 4px;
}

.db-action-btn {
  background: transparent;
  border: none;
  color: var(--theme-text-secondary);
  cursor: pointer;
  font-size: 13px;
  padding: 4px;
  display: flex;
  align-items: center;
  transition: color 0.2s;
}

.db-action-btn:hover {
  color: var(--theme-text-primary);
}

.db-close-btn {
  background: transparent;
  border: none;
  color: var(--theme-text-secondary);
  cursor: pointer;
  font-size: 13px;
  padding: 4px;
  display: flex;
  align-items: center;
  transition: all 0.2s;
}

.db-close-btn:hover {
  background: var(--theme-bg-active);
  color: var(--theme-danger);
}

.db-panel-content {
  flex: 1;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  background-color: var(--theme-bg-panel);
}

.db-panel-content :deep(.code-preview-panel),
.db-panel-content :deep(.data-input-panel),
.db-panel-content :deep(.json-editor-panel) {
  height: 100%;
  padding: 0;
}

.db-panel-content :deep(.header-section) {
  display: none;
}

.db-panel-content :deep(.header-controls) {
  display: none;
}

.db-panel-content :deep(.panel-title),
.db-panel-content :deep(.description) {
  display: none;
}

.db-resize-handle {
  position: absolute;
  bottom: 0;
  right: 0;
  width: 20px;
  height: 20px;
  cursor: nwse-resize;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--theme-text-muted);
  font-size: 10px;
  user-select: none;
  opacity: 0.5;
  transition: opacity 0.2s;
}

.db-resize-handle:hover {
  opacity: 1;
  color: var(--theme-text-primary);
}

/* Glass Panel Polyfill */
.db-glass-panel {
  background: var(--theme-bg-panel-transparent, rgba(255, 255, 255, 0.95));
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border: 1px solid var(--theme-border);
  box-shadow: var(--shadow-floating);
}
</style>



================================================
FILE: src/components/layouts/AboutModal.vue
================================================
<template>
  <BaseModal :is-open="isOpen" @close="emit('close')">
    <template #header>
      <h3>About DoodleBUGS</h3>
    </template>
    <template #body>
      <div class="db-about-content">
        <p>
          <strong>DoodleBUGS</strong> is a graphical modelling tool designed to simplify the
          creation of Bayesian models for analysis with the BUGS language using
          <a
            href="https://github.com/TuringLang/JuliaBUGS.jl"
            target="_blank"
            rel="noopener noreferrer"
            >JuliaBUGS.jl</a
          >.
        </p>
        <p>
          Our goal is to provide an intuitive, visual interface for statisticians, researchers, and
          students to build, understand, and share complex probabilistic models.
        </p>

        <div class="db-resources-section">
          <h4>Resources</h4>
          <div class="db-links-list">
            <a
              href="https://github.com/TuringLang/JuliaBUGS.jl"
              target="_blank"
              rel="noopener noreferrer"
              class="db-resource-link"
            >
              <i class="fab fa-github"></i> Codebase
            </a>
            <a
              href="https://github.com/TuringLang/JuliaBUGS.jl/issues?q=is%3Aissue%20state%3Aopen%20label%3ADoodleBUGS"
              target="_blank"
              rel="noopener noreferrer"
              class="db-resource-link"
            >
              <i class="fas fa-list"></i> Issue Tracker
            </a>
            <a
              href="https://github.com/TuringLang/JuliaBUGS.jl/issues/new?template=doodlebugs.md"
              target="_blank"
              rel="noopener noreferrer"
              class="db-resource-link"
            >
              <i class="fas fa-bug"></i> Report Issue
            </a>
          </div>
        </div>
      </div>
    </template>
  </BaseModal>
</template>

<script setup lang="ts">
import BaseModal from '../common/BaseModal.vue'

defineProps<{
  isOpen: boolean
}>()

const emit = defineEmits(['close'])
</script>

<style scoped>
.db-about-content {
  display: flex;
  flex-direction: column;
  gap: 12px;
  color: var(--color-text);
  line-height: 1.6;
}

.db-about-content p {
  margin: 0;
}

.db-about-content a {
  color: var(--color-primary);
  text-decoration: none;
  font-weight: 500;
}
.db-about-content a:hover {
  text-decoration: underline;
}

.db-resources-section {
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px solid var(--theme-border);
}

.db-resources-section h4 {
  margin: 0 0 10px 0;
  color: var(--theme-text-primary);
  font-size: 0.95rem;
}

.db-links-list {
  display: flex;
  flex-direction: row;
  flex-wrap: wrap;
  gap: 12px;
}

.db-resource-link {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 12px;
  background-color: var(--theme-bg-hover);
  border-radius: var(--radius-sm);
  color: var(--theme-text-primary) !important;
  font-weight: 500;
  transition: background-color 0.2s;
  border: 1px solid transparent;
  flex: 1;
  justify-content: center;
  min-width: 120px;
}

.db-resource-link:hover {
  background-color: var(--theme-bg-active);
  text-decoration: none !important;
  border-color: var(--theme-border);
}

.db-resource-link i {
  width: 20px;
  text-align: center;
  color: var(--theme-text-secondary);
}
</style>



================================================
FILE: src/components/layouts/ExportModal.vue
================================================
<script setup lang="ts">
import { ref, watch, computed } from 'vue'
import BaseModal from '../common/BaseModal.vue'
import BaseButton from '../ui/BaseButton.vue'
import BaseInput from '../ui/BaseInput.vue'

export type ExportType = 'png' | 'jpg' | 'svg'

interface ExportOptions {
  bg: string
  full: boolean
  scale: number
  quality?: number
  maxWidth?: number
  maxHeight?: number
}

const props = defineProps<{
  isOpen: boolean
  exportType: ExportType | null
}>()

const emit = defineEmits(['close', 'confirm-export'])

const options = ref({
  bg: '#ffffff',
  full: true,
  scale: 2,
  quality: 0.92,
  maxWidth: '' as string,
  maxHeight: '' as string,
})

watch(
  () => props.isOpen,
  (newVal) => {
    if (newVal) {
      options.value = {
        bg: props.exportType === 'png' || props.exportType === 'svg' ? 'transparent' : '#ffffff',
        full: true,
        scale: 2,
        quality: 0.92,
        maxWidth: '',
        maxHeight: '',
      }
    }
  }
)

const title = computed(() => {
  if (!props.exportType) return 'Export'
  return `Export as ${props.exportType.toUpperCase()}`
})

const handleConfirm = () => {
  const exportOptions: ExportOptions = {
    bg: options.value.bg,
    full: options.value.full,
    scale: options.value.scale,
  }

  if (props.exportType === 'jpg') {
    exportOptions.quality = options.value.quality
  }

  if (options.value.maxWidth) {
    exportOptions.maxWidth = Number(options.value.maxWidth)
  }
  if (options.value.maxHeight) {
    exportOptions.maxHeight = Number(options.value.maxHeight)
  }

  emit('confirm-export', exportOptions)
  emit('close')
}
</script>

<template>
  <BaseModal :is-open="isOpen" @close="$emit('close')">
    <template #header>
      <h3>{{ title }}</h3>
    </template>
    <template #body>
      <div class="db-export-options-form">
        <div class="db-form-group">
          <label for="export-bg">Background Color:</label>
          <BaseInput id="export-bg" type="color" v-model="options.bg" />
        </div>

        <div class="db-form-group checkbox-group">
          <label for="export-full">Export Full Graph:</label>
          <input id="export-full" type="checkbox" v-model="options.full" />
          <small class="db-help-text">(Uncheck to export current view only)</small>
        </div>

        <div class="db-form-group">
          <label for="export-scale">Scale:</label>
          <BaseInput
            id="export-scale"
            type="number"
            v-model.number="options.scale"
            min="0.1"
            step="0.1"
          />
        </div>

        <template v-if="exportType === 'png' || exportType === 'jpg'">
          <div class="db-form-group">
            <label for="export-maxWidth">Max Width (optional):</label>
            <BaseInput
              id="export-maxWidth"
              type="number"
              v-model="options.maxWidth"
              placeholder="e.g., 1920"
            />
          </div>
          <div class="db-form-group">
            <label for="export-maxHeight">Max Height (optional):</label>
            <BaseInput
              id="export-maxHeight"
              type="number"
              v-model="options.maxHeight"
              placeholder="e.g., 1080"
            />
          </div>
        </template>

        <template v-if="exportType === 'jpg'">
          <div class="db-form-group">
            <label for="export-quality">JPG Quality (0 to 1):</label>
            <input
              id="export-quality"
              type="range"
              v-model.number="options.quality"
              min="0"
              max="1"
              step="0.01"
            />
            <span>{{ options.quality.toFixed(2) }}</span>
          </div>
        </template>
      </div>
    </template>
    <template #footer>
      <BaseButton @click="handleConfirm" type="primary">Export</BaseButton>
    </template>
  </BaseModal>
</template>

<style scoped>
.db-export-options-form {
  display: flex;
  flex-direction: column;
  gap: 15px;
}
.db-form-group {
  display: flex;
  flex-direction: column;
  gap: 5px;
}
.db-form-group.checkbox-group {
  flex-direction: row;
  align-items: center;
}
.db-form-group label {
  font-weight: 500;
  color: var(--color-text);
  font-size: 0.9em;
}
.db-form-group input[type='range'] {
  flex-grow: 1;
}
.db-form-group span {
  font-size: 0.9em;
  font-variant-numeric: tabular-nums;
}
.db-help-text {
  font-size: 0.8em;
  color: var(--color-secondary);
  font-style: italic;
}
</style>



================================================
FILE: src/components/layouts/FaqModal.vue
================================================
<script setup lang="ts">
import { ref, computed } from 'vue'
import BaseModal from '../common/BaseModal.vue'

defineProps<{
  isOpen: boolean
}>()

const emit = defineEmits(['close'])

interface FaqItem {
  q: string
  a: string
  open: boolean
}

const faqs = ref<FaqItem[]>([
  {
    q: 'How do I create a loop (Plate)?',
    a: 'Drag a "Plate" node from the left sidebar onto the canvas. You can then drop other nodes inside the plate to nest them, or drag existing nodes into it.',
    open: false,
  },
  {
    q: 'How do I connect nodes?',
    a: 'Select the <strong>Edge</strong> tool from the bottom toolbar (click the node icon to switch to the connector icon, or select "Edge" from the dropdown). Tap the source node first, then tap the target node to create a connection.',
    open: false,
  },
  {
    q: 'How do I run the model locally?',
    a: 'Use the "Script for Local Run" option in the bottom toolbar (under the Code menu) or the "Script" tab in the right sidebar. This generates a standalone Julia script that includes your model definition, data, and initial values. You can run this script using your local Julia installation.',
    open: false,
  },
  {
    q: 'Does this work on tablets/iPads?',
    a: 'Yes! DoodleBUGS supports touch interactions. However, for building complex models, we recommend using a desktop device with a mouse and keyboard for the best experience.',
    open: false,
  },
  {
    q: 'Which distributions are supported?',
    a: 'We support standard BUGS distributions including Normal (dnorm), Gamma (dgamma), Beta (dbeta), Binomial (dbin), Poisson (dpois), Student-t (dt), and Uniform (dunif). You can select these in the Node Properties panel.',
    open: false,
  },
  {
    q: 'What are Stochastic vs Deterministic edges?',
    a: '<strong>Stochastic edges</strong> (dashed) represent probabilistic dependencies (e.g., parameters of a distribution). <strong>Deterministic edges</strong> (solid) represent functional relationships (e.g., variables in an equation). The system automatically selects the edge type based on the target node.',
    open: false,
  },
  {
    q: 'Why is the Share URL so long?',
    a: 'DoodleBUGS is a client-side application. We do not store your data on a server. Instead, the entire model structure, parameters, and data are compressed and encoded directly into the URL. This ensures your model remains private and accessible without a database.',
    open: false,
  },
  {
    q: 'Troubleshooting Sharing & URL Shortener',
    a: 'The URL shortener (is.gd) is a third-party service. It may fail if: <ul style="margin: 5px 0 5px 20px; padding: 0;"><li>Your project contains a large dataset, making the URL too long for browsers or the shortener service.</li><li>You have generated too many links quickly (rate limiting).</li></ul> In these cases, please use the <strong>Export JSON</strong> feature in the Inspector panel to share your work.',
    open: false,
  },
  {
    q: 'How do I enter data?',
    a: 'Use the "Data & Inits" panel (accessible from the bottom toolbar). You can enter data in either JSON format or Julia syntax. The system will automatically parse it for the model.',
    open: false,
  },
  {
    q: 'Is my work saved?',
    a: "Yes, your projects and graphs are automatically saved to your browser's local storage. You can also export your graph as a JSON file to backup or share it.",
    open: false,
  },
])

const allExpanded = computed(() => faqs.value.every((item) => item.open))

const toggleAll = () => {
  const targetState = !allExpanded.value
  faqs.value.forEach((item) => (item.open = targetState))
}

const toggleItem = (index: number) => {
  faqs.value[index].open = !faqs.value[index].open
}
</script>

<template>
  <BaseModal :is-open="isOpen" @close="emit('close')">
    <template #header>
      <div class="db-header-row">
        <h3>Frequently Asked Questions</h3>
        <button
          class="db-toggle-all-btn"
          @click="toggleAll"
          :title="allExpanded ? 'Collapse All' : 'Expand All'"
        >
          <i :class="allExpanded ? 'fas fa-compress-alt' : 'fas fa-expand-alt'"></i>
        </button>
      </div>
    </template>
    <template #body>
      <div class="db-faq-layout">
        <div class="db-faq-list">
          <div
            v-for="(item, index) in faqs"
            :key="index"
            class="db-faq-item"
            :class="{ 'is-open': item.open }"
          >
            <div class="db-question" @click="toggleItem(index)">
              <div class="db-q-content">
                <span class="db-q-text">{{ item.q }}</span>
              </div>
              <i class="fas fa-chevron-down db-toggle-icon"></i>
            </div>
            <div class="db-answer-wrapper" :class="{ 'db-open': item.open }">
              <div class="db-answer" v-html="item.a"></div>
            </div>
          </div>
        </div>

        <div class="db-faq-footer">
          <p>Can't find your answer?</p>
          <a
            href="https://github.com/TuringLang/JuliaBUGS.jl/issues/new?template=doodlebugs.md"
            target="_blank"
            class="db-support-link"
          >
            Ask here <i class="fas fa-external-link-alt"></i>
          </a>
        </div>
      </div>
    </template>
  </BaseModal>
</template>

<style scoped>
.db-header-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
  padding-right: 20px;
}

.db-header-row h3 {
  margin: 0;
}

.db-toggle-all-btn {
  background: transparent;
  border: 1px solid var(--theme-border);
  border-radius: 4px;
  cursor: pointer;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--theme-text-secondary);
  transition: all 0.2s;
}

.db-toggle-all-btn:hover {
  background: var(--theme-bg-hover);
  color: var(--theme-primary);
  border-color: var(--theme-primary);
}

.db-faq-layout {
  display: flex;
  flex-direction: column;
  max-height: 60vh;
  padding-top: 10px;
}

.db-faq-list {
  flex-grow: 1;
  overflow-y: auto;
  padding-right: 6px;
  display: flex;
  flex-direction: column;
  gap: 0;
}

.db-faq-item {
  border-bottom: 1px solid var(--theme-border);
}

.db-faq-item:last-child {
  border-bottom: none;
}

.db-question {
  font-weight: 600;
  color: var(--theme-text-primary);
  font-size: 0.95em;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  cursor: pointer;
  background-color: transparent;
  transition: color 0.2s;
  user-select: none;
}

.db-question:hover {
  color: var(--theme-primary);
}

.db-q-content {
  display: flex;
  align-items: center;
  gap: 10px;
}

.db-q-content::before {
  content: 'Q';
  color: var(--theme-primary);
  font-weight: 800;
  font-size: 0.85em;
  opacity: 0.8;
}

.db-toggle-icon {
  transition: transform 0.3s ease;
  font-size: 0.85em;
  color: var(--theme-text-muted);
  margin-left: 10px;
}

.db-faq-item.is-open .db-toggle-icon {
  transform: rotate(180deg);
  color: var(--theme-primary);
}

.db-answer-wrapper {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.db-answer-wrapper.db-open {
  max-height: 1000px;
  transition: max-height 0.6s ease-in-out;
}

.db-answer {
  color: var(--theme-text-secondary);
  font-size: 0.9em;
  line-height: 1.6;
  padding: 0 0 15px 20px;
}

.db-faq-footer {
  margin-top: 15px;
  padding: 15px;
  background-color: var(--theme-bg-hover);
  border-radius: var(--radius-md);
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 5px;
  flex-shrink: 0;
  border-top: 1px solid var(--theme-border);
}

.db-faq-footer p {
  margin: 0;
  font-weight: 500;
  color: var(--theme-text-primary);
}

.db-support-link {
  color: var(--theme-primary);
  font-weight: 600;
  text-decoration: none;
  display: flex;
  align-items: center;
  gap: 5px;
}

.db-support-link:hover {
  text-decoration: underline;
}
</style>



================================================
FILE: src/components/layouts/GraphStyleModal.vue
================================================
<script setup lang="ts">
import { ref, onMounted } from 'vue'
import type { NodeType } from '../../types'
import { nodeDefinitions, defaultEdgeStyles } from '../../config/nodeDefinitions'
import BaseModal from '../common/BaseModal.vue'
import BaseInput from '../ui/BaseInput.vue'
import BaseSelect from '../ui/BaseSelect.vue'
import BaseButton from '../ui/BaseButton.vue'
import { useUiStore } from '../../stores/uiStore'

defineProps<{
  isOpen: boolean
}>()

const emit = defineEmits(['close'])

const uiStore = useUiStore()

const editingCategory = ref<'node' | 'edge'>('node')
const editingNodeType = ref<NodeType>('stochastic')
const editingEdgeType = ref<'stochastic' | 'deterministic'>('stochastic')
const applyFontToAllNodes = ref(false)

const tempNodeStyle = ref({
  backgroundColor: '',
  borderColor: '',
  borderWidth: 2,
  borderStyle: 'solid',
  backgroundOpacity: 1,
  shape: '',
  width: 60,
  height: 60,
  labelFontSize: 10,
  labelColor: '#000000',
})

const tempEdgeStyle = ref({
  color: '',
  width: 3,
  lineStyle: 'solid',
  labelFontSize: 10,
  labelColor: '#000000',
  labelBackgroundColor: '#ffffff',
  labelBackgroundOpacity: 1,
  labelBorderColor: '#cccccc',
  labelBorderWidth: 1,
  labelBackgroundShape: 'rectangle' as 'rectangle' | 'roundrectangle',
})

const nodeTypeOptions = nodeDefinitions.map((def) => ({ label: def.label, value: def.nodeType }))

const shapeOptions = [
  { label: 'Ellipse', value: 'ellipse' },
  { label: 'Rectangle', value: 'rectangle' },
  { label: 'Round Rectangle', value: 'round-rectangle' },
  { label: 'Triangle', value: 'triangle' },
  { label: 'Diamond', value: 'diamond' },
  { label: 'Pentagon', value: 'pentagon' },
  { label: 'Hexagon', value: 'hexagon' },
  { label: 'Star', value: 'star' },
]

const borderStyleOptions = [
  { label: 'Solid', value: 'solid' },
  { label: 'Dotted', value: 'dotted' },
  { label: 'Dashed', value: 'dashed' },
  { label: 'Double', value: 'double' },
]

const edgeStyleOptions = [
  { label: 'Solid', value: 'solid' },
  { label: 'Dashed', value: 'dashed' },
  { label: 'Dotted', value: 'dotted' },
]

const labelShapeOptions = [
  { label: 'Rectangle', value: 'rectangle' },
  { label: 'Rounded', value: 'roundrectangle' },
]

const loadNodeStyle = () => {
  const currentStyle = uiStore.nodeStyles[editingNodeType.value]
  tempNodeStyle.value = { ...currentStyle }
}

const loadEdgeStyle = () => {
  const currentStyle = uiStore.edgeStyles[editingEdgeType.value]
  tempEdgeStyle.value = { ...currentStyle }
}

onMounted(() => {
  loadNodeStyle()
  loadEdgeStyle()
})

const switchNodeType = (type: NodeType) => {
  editingNodeType.value = type
  loadNodeStyle()
}

const switchEdgeType = (type: 'stochastic' | 'deterministic') => {
  editingEdgeType.value = type
  loadEdgeStyle()
}

const saveStyleSettings = () => {
  if (editingCategory.value === 'node') {
    uiStore.nodeStyles[editingNodeType.value] = { ...tempNodeStyle.value }

    if (applyFontToAllNodes.value) {
      Object.keys(uiStore.nodeStyles).forEach((key) => {
        if (key !== editingNodeType.value) {
          uiStore.nodeStyles[key].labelFontSize = tempNodeStyle.value.labelFontSize
          uiStore.nodeStyles[key].labelColor = tempNodeStyle.value.labelColor
        }
      })
    }
  } else {
    uiStore.edgeStyles[editingEdgeType.value] = { ...tempEdgeStyle.value }
  }
  emit('close')
}

const resetStyleSettings = () => {
  if (editingCategory.value === 'node') {
    const def = nodeDefinitions.find((d) => d.nodeType === editingNodeType.value)
    if (def) {
      tempNodeStyle.value = { ...def.defaultStyle }
    }
  } else {
    tempEdgeStyle.value = { ...defaultEdgeStyles[editingEdgeType.value] }
  }
}
</script>

<template>
  <BaseModal :is-open="isOpen" @close="emit('close')">
    <template #header>
      <h3>Graph Styles</h3>
    </template>
    <template #body>
      <div class="db-style-container">
        <div class="db-category-tabs">
          <button
            :class="{ 'db-active': editingCategory === 'node' }"
            @click="editingCategory = 'node'"
          >
            Nodes
          </button>
          <button
            :class="{ 'db-active': editingCategory === 'edge' }"
            @click="editingCategory = 'edge'"
          >
            Edges
          </button>
        </div>

        <!-- Node Styling Form -->
        <div class="db-style-form" v-if="editingCategory === 'node'">
          <div class="db-form-group">
            <label>Node Type</label>
            <BaseSelect
              :model-value="editingNodeType"
              :options="nodeTypeOptions"
              @update:model-value="switchNodeType($event as NodeType)"
            />
          </div>

          <div class="db-scrollable-form">
            <div class="db-form-group">
              <label>Shape</label>
              <BaseSelect
                :model-value="tempNodeStyle.shape"
                :options="shapeOptions"
                @update:model-value="tempNodeStyle.shape = $event"
              />
            </div>
            <div class="db-grid-2">
              <div class="db-form-group">
                <label>Fill Color</label>
                <div class="db-color-wrapper">
                  <input type="color" v-model="tempNodeStyle.backgroundColor" />
                </div>
              </div>
              <div class="db-form-group">
                <label>Border Color</label>
                <div class="db-color-wrapper">
                  <input type="color" v-model="tempNodeStyle.borderColor" />
                </div>
              </div>
            </div>
            <div class="db-grid-2">
              <div class="db-form-group">
                <label>Border Width (px)</label>
                <BaseInput type="number" v-model.number="tempNodeStyle.borderWidth" min="0" />
              </div>
              <div class="db-form-group">
                <label>Border Style</label>
                <BaseSelect
                  :model-value="tempNodeStyle.borderStyle"
                  :options="borderStyleOptions"
                  @update:model-value="tempNodeStyle.borderStyle = $event"
                />
              </div>
            </div>
            <div class="db-form-group">
              <label>Opacity ({{ tempNodeStyle.backgroundOpacity }})</label>
              <input
                type="range"
                min="0"
                max="1"
                step="0.1"
                v-model.number="tempNodeStyle.backgroundOpacity"
                class="w-full"
              />
            </div>
            <div class="db-grid-2" v-if="editingNodeType !== 'plate'">
              <div class="db-form-group">
                <label>Width (px)</label>
                <BaseInput type="number" v-model.number="tempNodeStyle.width" />
              </div>
              <div class="db-form-group">
                <label>Height (px)</label>
                <BaseInput type="number" v-model.number="tempNodeStyle.height" />
              </div>
            </div>
            <div class="db-grid-2">
              <div class="db-form-group">
                <label>Label Size (px)</label>
                <BaseInput type="number" v-model.number="tempNodeStyle.labelFontSize" min="1" />
              </div>
              <div class="db-form-group">
                <label>Label Color</label>
                <div class="db-color-wrapper">
                  <input type="color" v-model="tempNodeStyle.labelColor" />
                </div>
              </div>
            </div>
            <div class="db-form-group db-checkbox-row">
              <input type="checkbox" id="apply-font-all" v-model="applyFontToAllNodes" />
              <label for="apply-font-all">Apply font settings to all node types</label>
            </div>
          </div>
        </div>

        <!-- Edge Styling Form -->
        <div class="db-style-form" v-else>
          <div class="db-edge-type-switcher">
            <BaseButton
              size="small"
              :type="editingEdgeType === 'stochastic' ? 'primary' : 'secondary'"
              @click="switchEdgeType('stochastic')"
              >Stochastic</BaseButton
            >
            <BaseButton
              size="small"
              :type="editingEdgeType === 'deterministic' ? 'primary' : 'secondary'"
              @click="switchEdgeType('deterministic')"
              >Deterministic</BaseButton
            >
          </div>
          <div class="db-scrollable-form">
            <div class="db-grid-2">
              <div class="db-form-group">
                <label>Line Color</label>
                <div class="db-color-wrapper">
                  <input type="color" v-model="tempEdgeStyle.color" />
                </div>
              </div>
              <div class="db-form-group">
                <label>Width (px)</label>
                <BaseInput type="number" v-model.number="tempEdgeStyle.width" min="1" />
              </div>
            </div>
            <div class="db-form-group">
              <label>Line Style</label>
              <BaseSelect
                :model-value="tempEdgeStyle.lineStyle"
                :options="edgeStyleOptions"
                @update:model-value="tempEdgeStyle.lineStyle = $event"
              />
            </div>
            <div class="db-grid-2">
              <div class="db-form-group">
                <label>Label Size (px)</label>
                <BaseInput type="number" v-model.number="tempEdgeStyle.labelFontSize" min="1" />
              </div>
              <div class="db-form-group">
                <label>Label Color</label>
                <div class="db-color-wrapper">
                  <input type="color" v-model="tempEdgeStyle.labelColor" />
                </div>
              </div>
            </div>

            <div class="db-dropdown-divider"></div>
            <h5 class="db-sub-title">Label Background</h5>
            <div class="db-grid-2">
              <div class="db-form-group">
                <label>Background Color</label>
                <div class="db-color-wrapper">
                  <input type="color" v-model="tempEdgeStyle.labelBackgroundColor" />
                </div>
              </div>
              <div class="db-form-group">
                <label>Opacity ({{ tempEdgeStyle.labelBackgroundOpacity }})</label>
                <input
                  type="range"
                  min="0"
                  max="1"
                  step="0.1"
                  v-model.number="tempEdgeStyle.labelBackgroundOpacity"
                  class="w-full h-8"
                />
              </div>
            </div>
            <div class="db-grid-2">
              <div class="db-form-group">
                <label>Border Color</label>
                <div class="db-color-wrapper">
                  <input type="color" v-model="tempEdgeStyle.labelBorderColor" />
                </div>
              </div>
              <div class="db-form-group">
                <label>Border Width</label>
                <BaseInput type="number" v-model.number="tempEdgeStyle.labelBorderWidth" min="0" />
              </div>
            </div>
            <div class="db-form-group">
              <label>Background Shape</label>
              <BaseSelect
                :model-value="tempEdgeStyle.labelBackgroundShape"
                :options="labelShapeOptions"
                @update:model-value="tempEdgeStyle.labelBackgroundShape = $event"
              />
            </div>

            <div class="db-info-box">
              <i class="fas fa-info-circle"></i>
              <small
                >Note: Stochastic edges connect to stochastic/observed nodes. Deterministic edges
                connect to deterministic nodes.</small
              >
            </div>
          </div>
        </div>
      </div>
    </template>
    <template #footer>
      <div class="db-modal-footer">
        <BaseButton type="secondary" @click="resetStyleSettings">Reset to Default</BaseButton>
        <div class="db-footer-actions">
          <BaseButton type="primary" @click="saveStyleSettings">Save</BaseButton>
        </div>
      </div>
    </template>
  </BaseModal>
</template>

<style scoped>
.db-style-container {
  display: flex;
  flex-direction: column;
  gap: 15px;
  max-height: 60vh;
}

.db-category-tabs {
  display: flex;
  border-bottom: 1px solid var(--theme-border);
  gap: 10px;
}

.db-category-tabs button {
  background: transparent;
  border: none;
  border-bottom: 2px solid transparent;
  padding: 8px 16px;
  font-weight: 600;
  color: var(--theme-text-secondary);
  cursor: pointer;
  transition: all 0.2s;
}

.db-category-tabs button.db-active {
  color: var(--theme-primary);
  border-bottom-color: var(--theme-primary);
}

.db-style-form {
  display: flex;
  flex-direction: column;
  gap: 12px;
  flex: 1;
  overflow: hidden;
}

.db-scrollable-form {
  overflow-y: auto;
  padding-right: 5px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.db-form-group {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.db-form-group label {
  font-size: 0.85em;
  font-weight: 600;
}

.db-checkbox-row {
  flex-direction: row;
  align-items: center;
  gap: 8px;
}

.db-sub-title {
  font-size: 0.9em;
  font-weight: 600;
  color: var(--color-heading);
  margin: 4px 0 0 0;
}

.db-grid-2 {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.db-color-wrapper {
  height: 32px;
  border: 1px solid var(--color-border);
  border-radius: 4px;
  padding: 2px;
}

.db-color-wrapper input {
  width: 100%;
  height: 100%;
  border: none;
  padding: 0;
  cursor: pointer;
  background: none;
}

.db-edge-type-switcher {
  display: flex;
  gap: 8px;
  margin-bottom: 8px;
}

.db-info-box {
  background-color: var(--color-background-mute);
  padding: 8px;
  border-radius: 4px;
  font-size: 0.8em;
  color: var(--color-text-secondary);
  display: flex;
  gap: 6px;
  align-items: flex-start;
}

.db-modal-footer {
  display: flex;
  justify-content: space-between;
  width: 100%;
  flex-wrap: wrap;
  gap: 10px;
}

.db-footer-actions {
  display: flex;
  gap: 8px;
}

.h-8 {
  height: 32px;
}
</style>



================================================
FILE: src/components/layouts/LeftSidebar.vue
================================================
<script setup lang="ts">
import { type StyleValue } from 'vue'
import Accordion from 'primevue/accordion'
import AccordionPanel from 'primevue/accordionpanel'
import AccordionHeader from 'primevue/accordionheader'
import AccordionContent from 'primevue/accordioncontent'
import ToggleSwitch from 'primevue/toggleswitch'
import BaseSelect from '../ui/BaseSelect.vue'
import BaseButton from '../ui/BaseButton.vue'
import ProjectManager from '../left-sidebar/ProjectManager.vue'
import type { NodeType } from '../../types'
import { examples } from '../../config/examples'
import { useUiStore } from '../../stores/uiStore'
import { storeToRefs } from 'pinia'

const props = defineProps<{
  activeAccordionTabs: string[]
  projectName: string | null
  pinnedGraphTitle: string | null
  isGridEnabled: boolean
  gridSize: number
  showZoomControls: boolean
  showDebugPanel: boolean
  isCodePanelOpen: boolean
  showDetachModeControl: boolean
  enableDrag?: boolean
}>()

const emit = defineEmits<{
  (e: 'toggle-left-sidebar'): void
  (e: 'new-project'): void
  (e: 'new-graph'): void
  (e: 'update:currentMode', mode: string): void
  (e: 'update:currentNodeType', type: NodeType): void
  (e: 'update:isGridEnabled', value: boolean): void
  (e: 'update:gridSize', value: number): void
  (e: 'update:showZoomControls', value: boolean): void
  (e: 'update:showDebugPanel', value: boolean): void
  (e: 'update:showDetachModeControl', value: boolean): void
  (e: 'toggle-code-panel'): void
  (e: 'load-example', exampleId: string): void
  (e: 'open-about-modal'): void
  (e: 'open-faq-modal'): void
  (e: 'toggle-dark-mode'): void
  (e: 'share-graph', graphId: string): void
  (e: 'share-project-url', projectId: string): void
  (e: 'header-drag-start', event: MouseEvent | TouchEvent): void
}>()

const uiStore = useUiStore()
const { isLeftSidebarOpen, canvasGridStyle, isDarkMode } = storeToRefs(uiStore)

const gridStyleOptions = [
  { label: 'Dots', value: 'dots' },
  { label: 'Lines', value: 'lines' },
]

const updateCanvasGridStyle = (val: string) => {
  canvasGridStyle.value = val as 'dots' | 'lines'
}

const sidebarStyle = (isOpen: boolean): StyleValue => {
  if (!isOpen) {
    return {
      transform: 'scale(0)',
      opacity: 0,
      pointerEvents: 'none',
    }
  }
  return {
    transform: 'scale(1)',
    opacity: 1,
    pointerEvents: 'auto',
  }
}

const handleGridSizeInput = (event: Event) => {
  const target = event.target as HTMLInputElement
  emit('update:gridSize', Number(target.value))
}

const handleHeaderMouseDown = (e: MouseEvent | TouchEvent) => {
  if (props.enableDrag) {
    emit('header-drag-start', e)
  }
}

const handleHeaderClick = () => {
  if (!props.enableDrag) {
    emit('toggle-left-sidebar')
  }
}
</script>

<template>
  <aside
    class="db-floating-sidebar db-left db-glass-panel"
    :style="sidebarStyle(isLeftSidebarOpen)"
  >
    <div
      class="db-sidebar-header"
      @mousedown="handleHeaderMouseDown"
      @touchstart="handleHeaderMouseDown"
      @click="handleHeaderClick"
      :style="{ cursor: enableDrag ? 'move' : 'pointer' }"
    >
      <span class="db-sidebar-title">
        {{ pinnedGraphTitle ? `DoodleBUGS / ${pinnedGraphTitle}` : 'DoodleBUGS' }}
      </span>
      <div class="flex items-center ml-auto">
        <button
          @click.stop="uiStore.toggleDarkMode()"
          @mousedown.stop
          @touchstart.stop
          class="db-theme-toggle-header"
          :title="isDarkMode ? 'Switch to Light Mode' : 'Switch to Dark Mode'"
        >
          <i :class="isDarkMode ? 'fas fa-sun' : 'fas fa-moon'"></i>
        </button>
        <div class="flex items-center">
          <svg width="20" height="20" fill="none" viewBox="0 0 24 24" class="db-toggle-icon">
            <path
              fill="currentColor"
              fill-rule="evenodd"
              d="M10 7h8a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1h-8zM9 7H6a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h3zM4 8a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2z"
              clip-rule="evenodd"
            ></path>
          </svg>
        </div>
      </div>
    </div>

    <div class="db-sidebar-content-scrollable">
      <Accordion :value="activeAccordionTabs" multiple class="db-sidebar-accordion">
        <AccordionPanel value="project">
          <AccordionHeader><i class="fas fa-folder db-icon-12"></i> Project</AccordionHeader>
          <AccordionContent>
            <div class="db-panel-content-wrapper">
              <ProjectManager
                @new-project="$emit('new-project')"
                @new-graph="$emit('new-graph')"
                @share-graph="(id: string) => $emit('share-graph', id)"
                @share-project-url="(id: string) => $emit('share-project-url', id)"
              />
              <div class="db-divider"></div>
              <div class="db-example-row">
                <label class="db-example-label">Examples</label>
                <BaseSelect
                  :modelValue="null"
                  :options="examples"
                  optionLabel="name"
                  optionValue="id"
                  @update:modelValue="$emit('load-example', $event)"
                  placeholder="Load Example..."
                  class="db-examples-dropdown"
                >
                  <template #option="{ option }">
                    <div class="flex items-center gap-2">
                      <i v-if="option.type === 'github'" class="fab fa-github" title="GitHub"></i>
                      <i v-else class="fas fa-hdd" title="Local"></i>
                      <span>{{ option.name }}</span>
                    </div>
                  </template>
                </BaseSelect>
              </div>
            </div>
          </AccordionContent>
        </AccordionPanel>

        <AccordionPanel value="view">
          <AccordionHeader><i class="fas fa-eye db-icon-12"></i> View Options</AccordionHeader>
          <AccordionContent>
            <div class="db-menu-panel flex-col gap-3">
              <div class="db-menu-row">
                <label>Canvas Grid</label>
                <ToggleSwitch
                  :modelValue="isGridEnabled"
                  @update:modelValue="$emit('update:isGridEnabled', $event)"
                />
              </div>
              <div class="db-menu-row">
                <label>Canvas Style</label>
                <BaseSelect
                  :modelValue="canvasGridStyle"
                  :options="gridStyleOptions"
                  class="w-24"
                  @update:modelValue="updateCanvasGridStyle"
                />
              </div>
              <div class="db-menu-row">
                <label>Canvas Size</label>
                <input
                  type="number"
                  :value="gridSize"
                  @input="handleGridSizeInput"
                  step="5"
                  min="5"
                  max="100"
                  class="db-native-number-input"
                />
              </div>
              <div class="db-divider"></div>
              <div class="db-menu-row">
                <label title="Show Detach button in toolbar">Show Node Detach Option</label>
                <ToggleSwitch
                  :modelValue="showDetachModeControl"
                  @update:modelValue="$emit('update:showDetachModeControl', $event)"
                />
              </div>
              <div class="db-menu-row">
                <label>Zoom Controls</label>
                <ToggleSwitch
                  :modelValue="showZoomControls"
                  @update:modelValue="$emit('update:showZoomControls', $event)"
                />
              </div>
            </div>
          </AccordionContent>
        </AccordionPanel>

        <AccordionPanel value="help">
          <AccordionHeader><i class="fas fa-question-circle db-icon-12"></i> Help</AccordionHeader>
          <AccordionContent>
            <div class="db-menu-panel flex-col gap-1">
              <BaseButton type="ghost" class="db-menu-btn" @click="$emit('open-faq-modal')"
                ><i class="fas fa-question"></i> FAQ</BaseButton
              >
              <BaseButton type="ghost" class="db-menu-btn" @click="$emit('open-about-modal')"
                ><i class="fas fa-info-circle"></i> About</BaseButton
              >
              <a
                href="https://github.com/TuringLang/JuliaBUGS.jl/issues/new?template=doodlebugs.md"
                target="_blank"
                class="db-menu-btn db-ghost-btn"
              >
                <i class="fab fa-github"></i> Report Issue
              </a>
            </div>
          </AccordionContent>
        </AccordionPanel>

        <AccordionPanel value="devtools">
          <AccordionHeader
            ><i class="fas fa-terminal db-icon-12"></i> Developer Tools</AccordionHeader
          >
          <AccordionContent>
            <div class="db-menu-panel flex-col gap-3">
              <div class="db-menu-row">
                <label>Debug Console</label>
                <ToggleSwitch
                  :modelValue="showDebugPanel"
                  @update:modelValue="$emit('update:showDebugPanel', $event)"
                />
              </div>
            </div>
          </AccordionContent>
        </AccordionPanel>
      </Accordion>
    </div>
  </aside>
</template>

<style scoped>
.db-floating-sidebar {
  position: absolute;
  top: 16px;
  height: auto;
  max-height: calc(100dvh - 32px);
  bottom: auto;
  z-index: 50;
  display: flex;
  flex-direction: column;
  border-radius: var(--radius-lg);
  overflow: hidden;
  transition:
    transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1),
    opacity 0.3s ease;
  background: var(--theme-bg-panel);
  box-shadow: var(--shadow-floating);
}

.db-floating-sidebar.db-left {
  left: 16px;
  width: 300px !important;
  transform-origin: top left;
}

@media (max-width: 768px) {
  .db-floating-sidebar.db-left {
    width: calc(100vw - 32px) !important;
  }

  .db-sidebar-content-scrollable {
    padding-bottom: 80px;
  }
}

.db-sidebar-header {
  padding: 12px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid var(--theme-border);
  background: var(--theme-bg-panel-transparent);
  color: var(--theme-text-primary);
  flex-shrink: 0;
}

.db-sidebar-title {
  font-weight: 600;
  font-size: var(--font-size-md);
  user-select: none;
}

.db-theme-toggle-header {
  background: transparent;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 4px;
  color: var(--theme-text-secondary);
  font-size: 0.85rem;
  transition: color 0.2s;
  border-radius: 4px;
}
.db-theme-toggle-header:hover {
  color: var(--theme-text-primary);
  background: var(--theme-bg-hover);
}

.db-toggle-icon {
  color: var(--theme-text-secondary);
  pointer-events: none;
}

.db-sidebar-content-scrollable {
  overflow-y: auto;
  flex: 1;
  background: var(--theme-bg-panel);
  min-height: 0;
}

:deep(.db-sidebar-accordion .p-accordion-header-link) {
  padding: 0.75rem 1rem;
  font-size: 0.9rem;
  font-weight: 600;
  color: var(--theme-text-primary);
  background: transparent;
  border: none;
  border-bottom: 1px solid var(--theme-border);
  outline: none;
  justify-content: flex-start;
}

:deep(.db-sidebar-accordion .p-accordion-header:not(.p-disabled) .p-accordion-header-link:focus) {
  box-shadow: none;
  background: var(--theme-bg-hover);
}

:deep(.db-sidebar-accordion .p-accordion-content-content) {
  padding: 0;
  background: transparent;
}

:deep(.db-sidebar-accordion .p-accordion-panel) {
  border: none;
}

:deep(.p-inputtext) {
  font-size: 12px !important;
  padding: 0.4rem 0.5rem !important;
}

:deep(.p-inputtext::placeholder) {
  font-size: 12px !important;
}

:deep(.p-select-label) {
  font-size: 12px !important;
  padding: 0.4rem 0.5rem !important;
}

:deep(.p-select-option) {
  font-size: 12px !important;
}

:deep(.p-inputnumber-input) {
  font-size: 12px !important;
  padding: 0.4rem 0.5rem !important;
}

:deep(.p-select-dropdown) {
  width: 2rem;
}

.db-icon-12 {
  font-size: 12px;
  width: 20px;
  text-align: center;
  margin-right: 8px;
  color: var(--theme-text-secondary);
}

.db-panel-content-wrapper {
  padding: 4px;
  background: var(--theme-bg-panel);
}

/* Project Manager Container Override */
:deep(.db-project-manager) {
  background: transparent;
  height: auto !important;
  overflow: visible !important;
  padding: 8px;
  border: none;
}

.db-menu-panel {
  display: flex;
  padding: 8px;
}
.db-menu-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: var(--font-size-sm);
  color: var(--theme-text-primary);
  margin-bottom: 8px;
}
.db-menu-btn {
  justify-content: flex-start !important;
  gap: 10px;
  width: 100%;
  padding: 10px !important;
  font-size: var(--font-size-sm);
  color: var(--theme-text-primary);
  border-radius: var(--radius-sm);
  transition: background-color 0.2s;
}
.db-menu-btn:hover {
  background-color: var(--theme-bg-hover);
}
.db-ghost-btn {
  color: var(--theme-text-secondary);
  text-decoration: none;
  display: flex;
  align-items: center;
  border-radius: var(--radius-sm);
  padding: 8px;
}
.db-ghost-btn:hover {
  background: var(--theme-bg-hover);
  color: var(--theme-text-primary);
}
.db-divider {
  height: 1px;
  background: var(--theme-border);
  margin: 12px 0;
}
.db-native-number-input {
  width: 60px;
  padding: 0.25rem 0.5rem;
  border: 1px solid var(--theme-border);
  border-radius: var(--radius-sm);
  background: var(--theme-bg-panel);
  color: var(--theme-text-primary);
  font-size: 0.85rem;
  text-align: left;
}
.db-native-number-input:focus {
  outline: none;
  border-color: var(--theme-primary);
}

.db-example-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 8px 8px 8px;
  gap: 10px;
}

.db-example-label {
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--theme-text-secondary);
  white-space: nowrap;
}

.db-examples-dropdown {
  width: 100% !important;
  flex-grow: 1;
}

.db-glass-panel {
  background: var(--theme-bg-panel-transparent, rgba(255, 255, 255, 0.95));
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border: 1px solid var(--theme-border);
  box-shadow: var(--shadow-floating);
}
</style>



================================================
FILE: src/components/layouts/MainLayout.vue
================================================
<script setup lang="ts">
import { ref, onMounted, onUnmounted, watch, computed, reactive } from 'vue'
import { storeToRefs } from 'pinia'
import type { Core } from 'cytoscape'
import GraphEditor from '../canvas/GraphEditor.vue'
import FloatingBottomToolbar from '../canvas/FloatingBottomToolbar.vue'
import FloatingPanel from '../common/FloatingPanel.vue'
import BaseModal from '../common/BaseModal.vue'
import BaseInput from '../ui/BaseInput.vue'
import BaseButton from '../ui/BaseButton.vue'
import LeftSidebar from './LeftSidebar.vue'
import RightSidebar from './RightSidebar.vue'
import AboutModal from './AboutModal.vue'
import FaqModal from './FaqModal.vue'
import ExportModal from './ExportModal.vue'
import GraphStyleModal from './GraphStyleModal.vue'
import ShareModal from './ShareModal.vue'
import ValidationIssuesModal from './ValidationIssuesModal.vue'
import DebugPanel from '../common/DebugPanel.vue'
import CodePreviewPanel from '../panels/CodePreviewPanel.vue'
import DataInputPanel from '../panels/DataInputPanel.vue'
import ScriptSettingsPanel from '../panels/ScriptSettingsPanel.vue'
import { useGraphElements } from '../../composables/useGraphElements'
import { useProjectStore } from '../../stores/projectStore'
import { useGraphStore } from '../../stores/graphStore'
import { useUiStore } from '../../stores/uiStore'
import { useDataStore } from '../../stores/dataStore'
import { useScriptStore } from '../../stores/scriptStore'
import { useGraphInstance } from '../../composables/useGraphInstance'
import { useGraphValidator } from '../../composables/useGraphValidator'
import { useGraphLayout } from '../../composables/useGraphLayout'
import { usePersistence } from '../../composables/usePersistence'
import {
  useBugsCodeGenerator,
  generateStandaloneScript,
} from '../../composables/useBugsCodeGenerator'
import { useShareExport } from '../../composables/useShareExport'
import { useImportExport } from '../../composables/useImportExport'
import type { GraphElement, NodeType, UnifiedModelData } from '../../types'
import { examples, isUrl } from '../../config/examples'

interface ExportOptions {
  bg: string
  full: boolean
  scale: number
  quality?: number
  maxWidth?: number
  maxHeight?: number
}

const props = defineProps<{
  defaultModel?: string
}>()

const projectStore = useProjectStore()
const graphStore = useGraphStore()
const uiStore = useUiStore()
const dataStore = useDataStore()
const scriptStore = useScriptStore()

const { parsedGraphData } = storeToRefs(dataStore)
const { elements, selectedElement, updateElement, deleteElement } = useGraphElements()
const { generatedCode } = useBugsCodeGenerator(elements)
const { getCyInstance, getUndoRedoInstance } = useGraphInstance()
const { validateGraph, validationErrors } = useGraphValidator(elements, parsedGraphData)
const { samplerSettings, standaloneScript } = storeToRefs(scriptStore)
const { smartFit, applyLayoutWithFit } = useGraphLayout()
const { loadLastGraphId, getStoredGraphElements, getStoredDataContent } = usePersistence()
const { shareUrl, decodeAndDecompress, minifyGraph, expandGraph, generateShareLink } =
  useShareExport()
const { importedGraphData, processGraphFile, clearImportedData } = useImportExport()
const {
  isLeftSidebarOpen,
  isRightSidebarOpen,
  canvasGridStyle,
  isDarkMode,
  activeRightTab,
  isGridEnabled,
  gridSize,
  showZoomControls,
  showDebugPanel,
  activeLeftAccordionTabs,
  isDetachModeActive,
  showDetachModeControl,
} = storeToRefs(uiStore)

const currentMode = ref<string>('select')
const currentNodeType = ref<NodeType>('stochastic')

// Modals State
const showNewProjectModal = ref(false)
const newProjectName = ref('')
const showNewGraphModal = ref(false)
const newGraphName = ref('')
const showAboutModal = ref(false)
const showFaqModal = ref(false)
const showValidationModal = ref(false)
const showScriptSettingsModal = ref(false)
const showExportModal = ref(false)
const showStyleModal = ref(false)
const showShareModal = ref(false)
const currentExportType = ref<'png' | 'jpg' | 'svg' | null>(null)

// Data Import Ref
const dataImportInput = ref<HTMLInputElement | null>(null)
const graphImportInput = ref<HTMLInputElement | null>(null)
const isDragOver = ref(false)

// Local viewport state for smooth UI updates
const viewportState = ref({ zoom: 1, pan: { x: 0, y: 0 } })

// Panel positions and sizes
const codePanelPos = reactive({
  x: typeof window !== 'undefined' ? window.innerWidth - 420 : 0,
  y: typeof window !== 'undefined' ? window.innerHeight - 380 : 0,
})
const codePanelSize = reactive({ width: 400, height: 300 })
const dataPanelPos = reactive({
  x: 20,
  y: typeof window !== 'undefined' ? window.innerHeight - 380 : 0,
})
const dataPanelSize = reactive({ width: 400, height: 300 })

// Computed property for validation status
const isModelValid = computed(() => validationErrors.value.size === 0)

// Pinned Graph Title Computation
const pinnedGraphTitle = computed(() => {
  if (!projectStore.currentProject || !graphStore.currentGraphId) return null
  const graph = projectStore.currentProject.graphs.find((g) => g.id === graphStore.currentGraphId)
  return graph ? graph.name : null
})

// Code Panel Visibility
const isCodePanelOpen = computed(() => {
  if (!projectStore.currentProject || !graphStore.currentGraphId) return false
  const graph = projectStore.currentProject.graphs.find((g) => g.id === graphStore.currentGraphId)
  return !!graph?.showCodePanel
})

const toggleCodePanel = () => {
  if (!projectStore.currentProject || !graphStore.currentGraphId) return
  const graph = projectStore.currentProject.graphs.find((g) => g.id === graphStore.currentGraphId)
  if (graph) {
    projectStore.updateGraphLayout(projectStore.currentProject.id, graphStore.currentGraphId, {
      showCodePanel: !graph.showCodePanel,
    })
  }
}

// Data Panel Visibility
const isDataPanelOpen = computed(() => {
  if (!projectStore.currentProject || !graphStore.currentGraphId) return false
  const graph = projectStore.currentProject.graphs.find((g) => g.id === graphStore.currentGraphId)
  return !!graph?.showDataPanel
})

const toggleDataPanel = () => {
  if (!projectStore.currentProject || !graphStore.currentGraphId) return
  const graph = projectStore.currentProject.graphs.find((g) => g.id === graphStore.currentGraphId)
  if (graph) {
    projectStore.updateGraphLayout(projectStore.currentProject.id, graphStore.currentGraphId, {
      showDataPanel: !graph.showDataPanel,
    })
  }
}

const toggleJsonPanel = () => {
  showDebugPanel.value = true
}

// Dark Mode Handling
watch(
  isDarkMode,
  (val) => {
    const element = document.querySelector('html')
    if (val) element?.classList.add('db-dark-mode')
    else element?.classList.remove('db-dark-mode')
  },
  { immediate: true }
)

// Viewport Persistence Logic
let saveViewportTimeout: ReturnType<typeof setTimeout> | null = null

const persistViewport = () => {
  if (saveViewportTimeout) {
    clearTimeout(saveViewportTimeout)
    saveViewportTimeout = null
  }
  if (graphStore.currentGraphId) {
    graphStore.updateGraphViewport(
      graphStore.currentGraphId,
      viewportState.value.zoom,
      viewportState.value.pan
    )
  }
}

const handleShare = () => {
  if (!graphStore.currentGraphId) return
  shareUrl.value = ''
  showShareModal.value = true
}

const handleGenerateShareLink = async (options: {
  scope: 'current' | 'project' | 'custom'
  selectedGraphIds?: string[]
}) => {
  if (!projectStore.currentProject) return

  let payload = {}

  // Helper to get graph data (from memory or storage)
  const getGraphDataForShare = (graphId: string) => {
    let elements: GraphElement[] = []
    let dataContent = '{}'
    let name = 'Graph'

    const graphMeta = projectStore.currentProject?.graphs.find((g) => g.id === graphId)
    if (graphMeta) name = graphMeta.name

    if (graphId === graphStore.currentGraphId) {
      elements = graphStore.currentGraphElements
      dataContent = dataStore.dataContent
    } else {
      elements = getStoredGraphElements(graphId) as GraphElement[]
      dataContent = getStoredDataContent(graphId)
    }

    // Minify Data
    try {
      const d = JSON.parse(dataContent)
      dataContent = JSON.stringify(d)
    } catch {
      /* ignore */
    }

    return { name, elements, dataContent }
  }

  if (options.scope === 'current') {
    const targetId = options.selectedGraphIds?.[0] || graphStore.currentGraphId
    if (!targetId) return

    const { name, elements, dataContent } = getGraphDataForShare(targetId)
    payload = {
      v: 2,
      n: name,
      e: minifyGraph(elements),
      d: dataContent,
    }
  } else {
    // Project or Custom Scope - Use v3 format
    const targetIds =
      options.scope === 'project'
        ? projectStore.currentProject.graphs.map((g) => g.id)
        : options.selectedGraphIds || []

    const graphsData = targetIds.map((id) => {
      const { name, elements, dataContent } = getGraphDataForShare(id)
      return {
        n: name,
        e: minifyGraph(elements),
        d: dataContent,
      }
    })

    payload = {
      v: 3,
      pn: projectStore.currentProject.name,
      g: graphsData,
    }
  }

  await generateShareLink(payload)
}

// Data Import Logic
const handleDataImport = (event: Event) => {
  const file = (event.target as HTMLInputElement).files?.[0]
  if (!file) return

  const reader = new FileReader()
  reader.onload = (e) => {
    const content = e.target?.result as string
    try {
      JSON.parse(content)
      dataStore.dataContent = content
    } catch {
      alert('Invalid JSON file format.')
    }
    if (dataImportInput.value) dataImportInput.value.value = ''
  }
  reader.readAsText(file)
}

const triggerGraphImport = () => {
  graphImportInput.value?.click()
}

const handleGraphImportFile = (event: Event) => {
  const file = (event.target as HTMLInputElement).files?.[0]
  if (file) {
    processGraphFile(file)
      .then((data) => {
        if (data && !newGraphName.value && data.name) {
          newGraphName.value = data.name + ' (Imported)'
        }
      })
      .catch((error) => {
        alert(error.message || 'Failed to process graph file.')
      })
  }
}

const handleDrop = (event: DragEvent) => {
  isDragOver.value = false
  const file = event.dataTransfer?.files?.[0]
  if (file) {
    processGraphFile(file)
      .then((data) => {
        if (data && !newGraphName.value && data.name) {
          newGraphName.value = data.name + ' (Imported)'
        }
      })
      .catch((error) => {
        alert(error.message || 'Failed to process graph file.')
      })
  }
}

// Shared Model Loader
const handleLoadShared = async () => {
  const params = new URLSearchParams(window.location.search)
  const shareParam = params.get('share')

  let jsonStr: string | null = null

  if (shareParam) {
    try {
      jsonStr = await decodeAndDecompress(shareParam)
    } catch {
      console.error('Failed to decode base64 share')
    }
  }

  if (jsonStr) {
    try {
      const payload = JSON.parse(jsonStr)

      // Handle V3 (Project)
      if (payload.v === 3 && payload.pn && payload.g) {
        projectStore.createProject(payload.pn + ' (Shared)')
        if (projectStore.currentProjectId) {
          // eslint-disable-next-line @typescript-eslint/no-explicit-any
          payload.g.forEach((graphData: any) => {
            const newGraph = projectStore.addGraphToProject(
              projectStore.currentProjectId!,
              graphData.n
            )
            if (newGraph) {
              try {
                const elements = expandGraph(graphData.e)
                graphStore.updateGraphElements(newGraph.id, elements)
                graphStore.updateGraphLayout(newGraph.id, 'preset')

                if (graphData.d) {
                  try {
                    const dObj = JSON.parse(graphData.d)
                    dataStore.updateGraphData(newGraph.id, {
                      content: JSON.stringify(dObj, null, 2),
                    })
                  } catch {
                    dataStore.updateGraphData(newGraph.id, { content: graphData.d })
                  }
                }
              } catch (e) {
                console.error(`Error loading graph ${graphData.n}:`, e)
              }
            }
          })

          projectStore.saveProjects()

          if (projectStore.currentProject?.graphs.length) {
            graphStore.selectGraph(projectStore.currentProject.graphs[0].id)
          }
        }
      }
      // Handle V2 (Single Graph)
      else if (payload && payload.n && payload.e) {
        projectStore.createProject('Shared Project')
        if (projectStore.currentProjectId) {
          const newGraph = projectStore.addGraphToProject(projectStore.currentProjectId, payload.n)
          if (newGraph) {
            let elements = payload.e
            if (payload.v === 2) {
              elements = expandGraph(payload.e)
            }

            graphStore.updateGraphElements(newGraph.id, elements)
            graphStore.updateGraphLayout(newGraph.id, 'preset')

            if (payload.d) {
              try {
                const dObj = JSON.parse(payload.d)
                dataStore.updateGraphData(newGraph.id, { content: JSON.stringify(dObj, null, 2) })
              } catch {
                dataStore.updateGraphData(newGraph.id, { content: payload.d })
              }
            }
            projectStore.saveProjects()
            graphStore.selectGraph(newGraph.id)
          }
        }
      }

      const newUrl = window.location.origin + window.location.pathname
      window.history.replaceState({}, document.title, newUrl)

      setTimeout(() => {
        handleFit()
      }, 500)
    } catch (e) {
      console.error('Failed to load shared model:', e)
      alert('Invalid or corrupted share link.')
    }
  }
}

// Generic Loader for both bundled and remote models
const loadModelData = async (data: UnifiedModelData | Record<string, unknown>, name: string) => {
  if (!projectStore.currentProjectId) return

  const newGraphMeta = projectStore.addGraphToProject(
    projectStore.currentProjectId,
    (data as UnifiedModelData).name || name
  )
  if (!newGraphMeta) return

  // Handle Elements
  if ((data as UnifiedModelData).elements) {
    graphStore.updateGraphElements(
      newGraphMeta.id,
      (data as UnifiedModelData).elements as GraphElement[]
    )
  } else if ((data as UnifiedModelData).graphJSON) {
    // Legacy support
    graphStore.updateGraphElements(
      newGraphMeta.id,
      (data as UnifiedModelData).graphJSON as GraphElement[]
    )
  }

  // Handle Data/Inits
  if ((data as UnifiedModelData).dataContent) {
    dataStore.updateGraphData(newGraphMeta.id, {
      content: (data as UnifiedModelData).dataContent || '',
    })
  } else if ((data as UnifiedModelData).data || (data as UnifiedModelData).inits) {
    // Legacy separate fields
    const content = JSON.stringify(
      {
        data: (data as UnifiedModelData).data || {},
        inits: (data as UnifiedModelData).inits || {},
      },
      null,
      2
    )
    dataStore.updateGraphData(newGraphMeta.id, { content })
  }

  // Handle Layout
  graphStore.updateGraphLayout(newGraphMeta.id, 'preset')
  if ((data as UnifiedModelData).layout) {
    projectStore.updateGraphLayout(
      projectStore.currentProjectId,
      newGraphMeta.id,
      (data as UnifiedModelData).layout
    )
  }

  graphStore.selectGraph(newGraphMeta.id)
}

// Unified Example Loader
const handleLoadExample = async (exampleIdOrUrl: string) => {
  if (!projectStore.currentProjectId) return

  try {
    let modelData = null
    let modelName = 'Imported Model'

    // 1. Check if it's a known example ID
    const config = examples.find((e) => e.id === exampleIdOrUrl)

    if (config) {
      modelName = config.name
      if (config.type === 'local' && config.data) {
        modelData = config.data
      } else if (config.url) {
        const response = await fetch(config.url)
        if (!response.ok) throw new Error(`Fetch failed: ${response.statusText}`)
        modelData = await response.json()
      }
    }
    // 2. Check if it's a direct URL
    else if (isUrl(exampleIdOrUrl)) {
      const response = await fetch(exampleIdOrUrl)
      if (!response.ok) throw new Error(`Fetch failed: ${response.statusText}`)
      modelData = await response.json()
      modelName = modelData.name || 'Remote Model'
    } else {
      console.warn(`Unknown example ID or invalid URL: ${exampleIdOrUrl}`)
      return
    }

    if (modelData) {
      await loadModelData(modelData, modelName)
    }
  } catch (error) {
    console.error('Failed to load example model:', error)
    alert('Failed to load model. Check console for details.')
  }
}

onMounted(async () => {
  projectStore.loadProjects()

  if (window.location.search.includes('share=')) {
    await handleLoadShared()
  }

  if (projectStore.projects.length === 0) {
    projectStore.createProject('Default Project')
    // Load default model if provided in props
    if (props.defaultModel) {
      await handleLoadExample(props.defaultModel)
    } else if (projectStore.currentProjectId) {
      // Fallback default
      await handleLoadExample('rats')
    }
  } else {
    // If returning user, only load default if explicitly requested via prop and no session active
    // But usually we prefer restoring session.
    // If props.defaultModel is present, maybe we should prompt or force load?
    // For now, let's prioritize the session unless empty.
    if (!window.location.search.includes('share=')) {
      const lastGraphId = loadLastGraphId()
      if (lastGraphId && projectStore.currentProject?.graphs.some((g) => g.id === lastGraphId)) {
        graphStore.selectGraph(lastGraphId)
      } else if (projectStore.currentProject?.graphs.length) {
        graphStore.selectGraph(projectStore.currentProject.graphs[0].id)
      } else if (props.defaultModel) {
        await handleLoadExample(props.defaultModel)
      }
    }
  }
  validateGraph()

  if (window.innerWidth < 768) {
    showZoomControls.value = false
  }

  window.addEventListener('beforeunload', persistViewport)
})

onUnmounted(() => {
  window.removeEventListener('beforeunload', persistViewport)
  persistViewport()
})

// Sync viewport state when graph changes
watch(
  () => graphStore.currentGraphId,
  (newId) => {
    if (newId) {
      const content = graphStore.graphContents.get(newId)
      if (content) {
        viewportState.value = {
          zoom: content.zoom ?? 1,
          pan: content.pan ?? { x: 0, y: 0 },
        }
      }
    }
  },
  { immediate: true }
)

// Initialize Code Panel Position if missing
watch(
  [isCodePanelOpen, () => graphStore.currentGraphId],
  ([isOpen, graphId]) => {
    if (isOpen && graphId && projectStore.currentProject) {
      const graph = projectStore.currentProject.graphs.find((g) => g.id === graphId)

      if (graph) {
        const needsInit = graph.codePanelX === undefined || graph.codePanelY === undefined
        if (needsInit) {
          const panelW = 400
          const panelH = 300
          const viewportW = window.innerWidth
          const rightSidebarOffset = isRightSidebarOpen.value ? 340 : 20
          let targetScreenX = viewportW - rightSidebarOffset - panelW - 10
          if (targetScreenX < 20) targetScreenX = 20
          const targetScreenY = 90

          projectStore.updateGraphLayout(projectStore.currentProject.id, graphId, {
            codePanelX: targetScreenX,
            codePanelY: targetScreenY,
            codePanelWidth: panelW,
            codePanelHeight: panelH,
          })
        }
      }
    }
  },
  { immediate: true }
)

// Initialize Data Panel Position if missing
watch(
  [isDataPanelOpen, () => graphStore.currentGraphId],
  ([isOpen, graphId]) => {
    if (isOpen && graphId && projectStore.currentProject) {
      const graph = projectStore.currentProject.graphs.find((g) => g.id === graphId)

      if (graph) {
        const needsInit = graph.dataPanelX === undefined || graph.dataPanelY === undefined
        if (needsInit) {
          const panelW = 400
          const panelH = 300
          const leftSidebarOffset = isLeftSidebarOpen.value ? 320 : 20
          const targetScreenX = leftSidebarOffset + 20
          const targetScreenY = 90

          projectStore.updateGraphLayout(projectStore.currentProject.id, graphId, {
            dataPanelX: targetScreenX,
            dataPanelY: targetScreenY,
            dataPanelWidth: panelW,
            dataPanelHeight: panelH,
          })
        }
      }
    }
  },
  { immediate: true }
)

const handleLayoutUpdated = (layoutName: string) => {
  if (graphStore.currentGraphId) {
    graphStore.updateGraphLayout(graphStore.currentGraphId, layoutName)
  }
}

const handleViewportChanged = (v: { zoom: number; pan: { x: number; y: number } }) => {
  viewportState.value = v
  if (saveViewportTimeout) clearTimeout(saveViewportTimeout)
  saveViewportTimeout = setTimeout(persistViewport, 200)
}

const handleGraphLayout = (layoutName: string) => {
  const cy = graphStore.currentGraphId ? getCyInstance(graphStore.currentGraphId) : null
  if (!cy) return
  applyLayoutWithFit(cy, layoutName)
  handleLayoutUpdated(layoutName)
}

const handleElementSelected = (element: GraphElement | null) => {
  selectedElement.value = element
  if (element) {
    if (!uiStore.isRightTabPinned) {
      uiStore.setActiveRightTab('properties')
      const isMobile = window.innerWidth < 768
      if (isMobile && isLeftSidebarOpen.value) {
        isLeftSidebarOpen.value = false
      }
      if (!isRightSidebarOpen.value) isRightSidebarOpen.value = true
    }
  } else {
    if (!uiStore.isRightTabPinned && isRightSidebarOpen.value) {
      isRightSidebarOpen.value = false
    }
  }
}

const handleSelectNodeFromModal = (nodeId: string) => {
  const targetNode = elements.value.find((el) => el.id === nodeId)
  if (targetNode) {
    handleElementSelected(targetNode)
    const cy = getCyInstance(graphStore.currentGraphId!)
    if (cy) {
      cy.elements().removeClass('cy-selected')
      const cyNode = cy.getElementById(nodeId)
      cyNode.addClass('cy-selected')
      cy.animate({
        fit: { eles: cyNode, padding: 50 },
        duration: 500,
      })
    }
  }
}

const createNewProject = () => {
  if (newProjectName.value.trim()) {
    projectStore.createProject(newProjectName.value.trim())
    showNewProjectModal.value = false
    newProjectName.value = ''
    activeLeftAccordionTabs.value = [...new Set([...activeLeftAccordionTabs.value, 'project'])]
    isLeftSidebarOpen.value = true
  }
}

const createNewGraph = () => {
  if (projectStore.currentProject && (newGraphName.value.trim() || importedGraphData.value)) {
    const name = newGraphName.value.trim() || importedGraphData.value?.name || 'New Graph'
    const newGraphMeta = projectStore.addGraphToProject(projectStore.currentProjectId!, name)

    if (newGraphMeta && importedGraphData.value) {
      // Populate with imported data
      graphStore.updateGraphElements(
        newGraphMeta.id,
        importedGraphData.value.elements as GraphElement[]
      )

      if (importedGraphData.value.dataContent) {
        dataStore.updateGraphData(newGraphMeta.id, { content: importedGraphData.value.dataContent })
      }

      graphStore.updateGraphLayout(newGraphMeta.id, 'preset')
    }

    showNewGraphModal.value = false
    newGraphName.value = ''
    clearImportedData()
    if (graphImportInput.value) graphImportInput.value.value = ''
  }
}

const openExportModal = (format: 'png' | 'jpg' | 'svg') => {
  if (!graphStore.currentGraphId) return
  currentExportType.value = format
  showExportModal.value = true
}

const handleDownloadBugs = () => {
  const content = generatedCode.value
  const blob = new Blob([content], { type: 'text/plain;charset=utf-8' })
  const fileName = 'model.bugs'
  const url = URL.createObjectURL(blob)
  const a = document.createElement('a')
  a.href = url
  a.download = fileName
  document.body.appendChild(a)
  a.click()
  document.body.removeChild(a)
  URL.revokeObjectURL(url)
}

const handleConfirmExport = (options: ExportOptions) => {
  const cy = (
    graphStore.currentGraphId ? getCyInstance(graphStore.currentGraphId) : null
  ) as Core | null
  if (!cy || !currentExportType.value) return

  const fileName = `graph.${currentExportType.value}`

  try {
    let blob: Blob

    if (currentExportType.value === 'svg') {
      const svgOptions = { bg: options.bg, full: options.full, scale: options.scale }
      blob = new Blob([cy.svg(svgOptions)], { type: 'image/svg+xml;charset=utf-8' })
    } else {
      const baseOptions = {
        bg: options.bg,
        full: options.full,
        scale: options.scale,
        maxWidth: options.maxWidth,
        maxHeight: options.maxHeight,
        output: 'blob' as const,
      }

      if (currentExportType.value === 'png') {
        blob = cy.png(baseOptions) as unknown as Blob
      } else {
        blob = cy.jpg({ ...baseOptions, quality: options.quality }) as unknown as Blob
      }
    }

    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = fileName
    document.body.appendChild(a)
    a.click()
    document.body.removeChild(a)
    URL.revokeObjectURL(url)
  } catch (err) {
    console.error(`Failed to export ${currentExportType.value}:`, err)
  }
}

const handleExportGraphJson = () => {
  if (!graphStore.currentGraphId || !projectStore.currentProject) return

  const graphMeta = projectStore.currentProject.graphs.find(
    (g) => g.id === graphStore.currentGraphId
  )
  if (!graphMeta) return

  const exportData = {
    name: graphMeta.name,
    elements: graphStore.currentGraphElements,
    dataContent: dataStore.dataContent,
    version: 1,
    layout: {
      showCodePanel: graphMeta.showCodePanel,
      codePanelX: graphMeta.codePanelX,
      codePanelY: graphMeta.codePanelY,
      codePanelWidth: graphMeta.codePanelWidth,
      codePanelHeight: graphMeta.codePanelHeight,
      showDataPanel: graphMeta.showDataPanel,
      dataPanelX: graphMeta.dataPanelX,
      dataPanelY: graphMeta.dataPanelY,
      dataPanelWidth: graphMeta.dataPanelWidth,
      dataPanelHeight: graphMeta.dataPanelHeight,
      gridEnabled: graphMeta.gridEnabled,
      gridSize: graphMeta.gridSize,
      gridStyle: graphMeta.gridStyle,
    },
  }

  const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' })
  const url = URL.createObjectURL(blob)
  const a = document.createElement('a')
  a.href = url
  a.download = `${graphMeta.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.json`
  document.body.appendChild(a)
  a.click()
  document.body.removeChild(a)
  URL.revokeObjectURL(url)
}

const getScriptContent = () => {
  const dataPayload = parsedGraphData.value.data || {}
  const initsPayload = parsedGraphData.value.inits || {}
  return generateStandaloneScript({
    modelCode: generatedCode.value,
    data: dataPayload,
    inits: initsPayload,
    settings: {
      n_samples: samplerSettings.value.n_samples,
      n_adapts: samplerSettings.value.n_adapts,
      n_chains: samplerSettings.value.n_chains,
      seed: samplerSettings.value.seed ?? undefined,
    },
  })
}

const handleGenerateStandalone = () => {
  const script = getScriptContent()
  scriptStore.standaloneScript = script
  uiStore.setActiveRightTab('script')
  uiStore.isRightSidebarOpen = true
}

// Auto-update script if it exists or script panel is open
watch(
  [generatedCode, parsedGraphData, samplerSettings],
  () => {
    // Update if script already exists OR if the panel is open
    if (standaloneScript.value || (activeRightTab.value === 'script' && isRightSidebarOpen.value)) {
      scriptStore.standaloneScript = getScriptContent()
    }
  },
  { deep: true }
)

const handleScriptSettingsDone = () => {
  // Also regenerate immediately on settings close
  const script = getScriptContent()
  scriptStore.standaloneScript = script
  showScriptSettingsModal.value = false
}

const handleDownloadScript = () => {
  const content = standaloneScript.value
  if (!content) return
  const blob = new Blob([content], { type: 'text/plain;charset=utf-8' })
  const fileName = 'DoodleBUGS-Julia-Script.jl'
  const url = URL.createObjectURL(blob)
  const a = document.createElement('a')
  a.href = url
  a.download = fileName
  document.body.appendChild(a)
  a.click()
  document.body.removeChild(a)
  URL.revokeObjectURL(url)
}

const handleOpenScriptSettings = () => {
  showScriptSettingsModal.value = true
}

const toggleLeftSidebar = () => {
  const isMobile = window.innerWidth < 768
  if (!isLeftSidebarOpen.value && isMobile) {
    isRightSidebarOpen.value = false
  }
  isLeftSidebarOpen.value = !isLeftSidebarOpen.value
}

const toggleRightSidebar = () => {
  const isMobile = window.innerWidth < 768
  if (!isRightSidebarOpen.value && isMobile) {
    isLeftSidebarOpen.value = false
  }
  isRightSidebarOpen.value = !isRightSidebarOpen.value
}

const handleUndo = () => {
  if (graphStore.currentGraphId) {
    getUndoRedoInstance(graphStore.currentGraphId)?.undo()
  }
}

const handleRedo = () => {
  if (graphStore.currentGraphId) {
    getUndoRedoInstance(graphStore.currentGraphId)?.redo()
  }
}

const handleZoomIn = () => {
  if (graphStore.currentGraphId) {
    const cy = getCyInstance(graphStore.currentGraphId)
    if (cy) cy.zoom(cy.zoom() * 1.2)
  }
}

const handleZoomOut = () => {
  if (graphStore.currentGraphId) {
    const cy = getCyInstance(graphStore.currentGraphId)
    if (cy) cy.zoom(cy.zoom() * 0.8)
  }
}

const handleFit = () => {
  if (graphStore.currentGraphId) {
    const cy = getCyInstance(graphStore.currentGraphId)
    if (cy) smartFit(cy, true)
  }
}

// Panel event handlers for FloatingPanel component
const handleCodePanelDragEnd = (pos: { x: number; y: number }) => {
  codePanelPos.x = pos.x
  codePanelPos.y = pos.y
  if (projectStore.currentProject && graphStore.currentGraphId) {
    projectStore.updateGraphLayout(projectStore.currentProject.id, graphStore.currentGraphId, {
      codePanelX: pos.x,
      codePanelY: pos.y,
    })
  }
}

const handleCodePanelResizeEnd = (size: { width: number; height: number }) => {
  codePanelSize.width = size.width
  codePanelSize.height = size.height
  if (projectStore.currentProject && graphStore.currentGraphId) {
    projectStore.updateGraphLayout(projectStore.currentProject.id, graphStore.currentGraphId, {
      codePanelWidth: size.width,
      codePanelHeight: size.height,
    })
  }
}

const handleDataPanelDragEnd = (pos: { x: number; y: number }) => {
  dataPanelPos.x = pos.x
  dataPanelPos.y = pos.y
  if (projectStore.currentProject && graphStore.currentGraphId) {
    projectStore.updateGraphLayout(projectStore.currentProject.id, graphStore.currentGraphId, {
      dataPanelX: pos.x,
      dataPanelY: pos.y,
    })
  }
}

const handleDataPanelResizeEnd = (size: { width: number; height: number }) => {
  dataPanelSize.width = size.width
  dataPanelSize.height = size.height
  if (projectStore.currentProject && graphStore.currentGraphId) {
    projectStore.updateGraphLayout(projectStore.currentProject.id, graphStore.currentGraphId, {
      dataPanelWidth: size.width,
      dataPanelHeight: size.height,
    })
  }
}

// Load panel positions and sizes from graph state
watch(
  [() => graphStore.currentGraphId, () => projectStore.currentProject?.graphs],
  () => {
    const currentGraphId = graphStore.currentGraphId
    if (currentGraphId && projectStore.currentProject) {
      const graph = projectStore.currentProject.graphs.find((g) => g.id === currentGraphId)
      if (graph) {
        // Use saved positions or defaults: data panel on bottom-left, code panel on bottom-right
        const defaultCodeX = typeof window !== 'undefined' ? window.innerWidth - 420 : 0
        const defaultY = typeof window !== 'undefined' ? window.innerHeight - 380 : 0
        codePanelPos.x = graph.codePanelX ?? defaultCodeX
        codePanelPos.y = graph.codePanelY ?? defaultY
        codePanelSize.width = graph.codePanelWidth ?? 400
        codePanelSize.height = graph.codePanelHeight ?? 300
        dataPanelPos.x = graph.dataPanelX ?? 20
        dataPanelPos.y = graph.dataPanelY ?? defaultY
        dataPanelSize.width = graph.dataPanelWidth ?? 400
        dataPanelSize.height = graph.dataPanelHeight ?? 300
      }
    }
  },
  { immediate: true, deep: true }
)

const handleSidebarContainerClick = (e: MouseEvent) => {
  if ((e.target as HTMLElement).closest('.db-theme-toggle-header')) return
  if (!isLeftSidebarOpen.value) {
    toggleLeftSidebar()
  }
}

watch(showNewGraphModal, (val) => {
  if (!val) {
    clearImportedData()
    newGraphName.value = ''
    if (graphImportInput.value) graphImportInput.value.value = ''
    isDragOver.value = false
  }
})

// Update the Left Sidebar Accordion model from the store
const updateActiveAccordionTabs = (val: string | string[]) => {
  // PrimeVue might emit single value or array depending on config, but multiple=true implies array
  const newVal = Array.isArray(val) ? val : [val]
  activeLeftAccordionTabs.value = newVal
}
</script>
<template>
  <div class="db-app-layout">
    <main class="db-canvas-area">
      <GraphEditor
        v-if="graphStore.currentGraphId"
        :key="graphStore.currentGraphId"
        :graph-id="graphStore.currentGraphId"
        :is-grid-enabled="isGridEnabled"
        @update:is-grid-enabled="isGridEnabled = $event"
        :grid-size="gridSize"
        @update:grid-size="gridSize = $event"
        :grid-style="canvasGridStyle"
        :current-mode="currentMode"
        :elements="elements"
        :current-node-type="currentNodeType"
        :validation-errors="validationErrors"
        :show-zoom-controls="false"
        @update:current-mode="currentMode = $event"
        @update:current-node-type="currentNodeType = $event"
        @element-selected="handleElementSelected"
        @layout-updated="handleLayoutUpdated"
        @viewport-changed="handleViewportChanged"
      />
      <div v-else class="db-empty-state">
        <p>No graph selected. Create or select a graph to start.</p>
        <BaseButton @click="showNewGraphModal = true" type="primary">Create New Graph</BaseButton>
      </div>
    </main>

    <!-- Left Sidebar -->
    <LeftSidebar
      :activeAccordionTabs="activeLeftAccordionTabs"
      @update:activeAccordionTabs="updateActiveAccordionTabs"
      :projectName="projectStore.currentProject?.name || null"
      :pinnedGraphTitle="pinnedGraphTitle"
      :isGridEnabled="isGridEnabled"
      :gridSize="gridSize"
      :showZoomControls="showZoomControls"
      :showDebugPanel="showDebugPanel"
      :isCodePanelOpen="isCodePanelOpen"
      :isDetachModeActive="isDetachModeActive"
      :showDetachModeControl="showDetachModeControl"
      @toggle-left-sidebar="toggleLeftSidebar"
      @new-project="showNewProjectModal = true"
      @new-graph="showNewGraphModal = true"
      @update:currentMode="currentMode = $event"
      @update:currentNodeType="currentNodeType = $event"
      @update:isGridEnabled="isGridEnabled = $event"
      @update:gridSize="gridSize = $event"
      @update:showZoomControls="showZoomControls = $event"
      @update:showDebugPanel="showDebugPanel = $event"
      @update:isDetachModeActive="isDetachModeActive = $event"
      @update:showDetachModeControl="showDetachModeControl = $event"
      @toggle-code-panel="toggleCodePanel"
      @load-example="handleLoadExample"
      @open-about-modal="showAboutModal = true"
      @open-faq-modal="showFaqModal = true"
    />

    <Transition name="fade">
      <div
        v-if="!isLeftSidebarOpen"
        class="db-collapsed-sidebar-trigger db-left-trigger"
        @click="handleSidebarContainerClick"
      >
        <div class="db-sidebar-trigger-content gap-1">
          <div
            class="flex-grow flex items-center gap-2 overflow-hidden"
            style="flex-grow: 1; overflow: hidden"
          >
            <span class="db-logo-text-minimized">
              <span class="db-desktop-text">{{
                pinnedGraphTitle ? `DoodleBUGS / ${pinnedGraphTitle}` : 'DoodleBUGS'
              }}</span>
              <span class="db-mobile-text">DoodleBUGS</span>
            </span>
          </div>
          <div class="flex items-center flex-shrink-0" style="flex-shrink: 0">
            <button
              @click.stop="uiStore.toggleDarkMode()"
              class="db-theme-toggle-header"
              :title="isDarkMode ? 'Switch to Light Mode' : 'Switch to Dark Mode'"
            >
              <i :class="isDarkMode ? 'fas fa-sun' : 'fas fa-moon'"></i>
            </button>
            <div class="db-toggle-icon-wrapper">
              <svg width="20" height="20" fill="none" viewBox="0 0 24 24" class="db-toggle-icon">
                <path
                  fill="currentColor"
                  fill-rule="evenodd"
                  d="M10 7h8a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1h-8zM9 7H6a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h3zM4 8a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2z"
                  clip-rule="evenodd"
                ></path>
              </svg>
            </div>
          </div>
        </div>
      </div>
    </Transition>

    <!-- Right Sidebar -->
    <RightSidebar
      :selectedElement="selectedElement"
      :validationErrors="validationErrors"
      :isModelValid="isModelValid"
      @toggle-right-sidebar="toggleRightSidebar"
      @update-element="updateElement"
      @delete-element="deleteElement"
      @show-validation-issues="showValidationModal = true"
      @open-script-settings="handleOpenScriptSettings"
      @download-script="handleDownloadScript"
      @generate-script="handleGenerateStandalone"
      @share="handleShare"
      @open-export-modal="openExportModal"
      @export-json="handleExportGraphJson"
    />

    <Transition name="fade">
      <div
        v-if="!isRightSidebarOpen"
        class="db-collapsed-sidebar-trigger db-right"
        @click="toggleRightSidebar"
      >
        <div class="db-sidebar-trigger-content gap-2">
          <span class="db-sidebar-title-minimized">Inspector</span>
          <div class="flex items-center">
            <div
              class="db-status-indicator db-validation-status"
              @click.stop="showValidationModal = true"
              :class="isModelValid ? 'db-valid' : 'db-invalid'"
            >
              <i :class="isModelValid ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle'"></i>
              <div class="db-instant-tooltip">
                {{ isModelValid ? 'Model Valid' : 'Validation Errors Found' }}
              </div>
            </div>
            <button
              class="db-header-icon-btn db-collapsed-share-btn"
              @click.stop="handleShare"
              title="Share via URL"
            >
              <i class="fas fa-share-alt"></i>
            </button>
            <div class="db-toggle-icon-wrapper">
              <svg width="20" height="20" fill="none" viewBox="0 0 24 24" class="db-toggle-icon">
                <path
                  fill="currentColor"
                  fill-rule="evenodd"
                  d="M10 7h8a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1h-8zM9 7H6a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h3zM4 8a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2z"
                  clip-rule="evenodd"
                ></path>
              </svg>
            </div>
          </div>
        </div>
      </div>
    </Transition>

    <!-- Code Panel using FloatingPanel -->
    <FloatingPanel
      v-if="isCodePanelOpen && graphStore.currentGraphId"
      title="BUGS Code Preview"
      icon="fas fa-code"
      :is-open="isCodePanelOpen"
      :default-width="codePanelSize.width"
      :default-height="codePanelSize.height"
      :default-x="codePanelPos.x"
      :default-y="codePanelPos.y"
      :show-download="true"
      @close="toggleCodePanel"
      @download="handleDownloadBugs"
      @drag-end="handleCodePanelDragEnd"
      @resize-end="handleCodePanelResizeEnd"
    >
      <CodePreviewPanel :is-active="true" />
    </FloatingPanel>

    <!-- Data Panel using FloatingPanel -->
    <FloatingPanel
      v-if="isDataPanelOpen && graphStore.currentGraphId"
      title="Data & Inits"
      icon="fas fa-database"
      badge="JSON"
      :is-open="isDataPanelOpen"
      :default-width="dataPanelSize.width"
      :default-height="dataPanelSize.height"
      :default-x="dataPanelPos.x"
      :default-y="dataPanelPos.y"
      :show-import="true"
      @close="toggleDataPanel"
      @import="dataImportInput?.click()"
      @drag-end="handleDataPanelDragEnd"
      @resize-end="handleDataPanelResizeEnd"
    >
      <DataInputPanel :is-active="true" />
      <!-- Hidden file input for Data Import -->
      <input
        type="file"
        ref="dataImportInput"
        accept=".json"
        style="display: none"
        @change="handleDataImport"
      />
    </FloatingPanel>

    <FloatingBottomToolbar
      :current-mode="currentMode"
      :current-node-type="currentNodeType"
      :show-code-panel="isCodePanelOpen"
      :show-data-panel="isDataPanelOpen"
      :show-json-panel="false"
      :show-zoom-controls="showZoomControls"
      :is-detach-mode-active="isDetachModeActive"
      :show-detach-mode-control="showDetachModeControl"
      @update:current-mode="currentMode = $event"
      @update:current-node-type="currentNodeType = $event"
      @undo="handleUndo"
      @redo="handleRedo"
      @zoom-in="handleZoomIn"
      @zoom-out="handleZoomOut"
      @fit="handleFit"
      @layout-graph="handleGraphLayout"
      @toggle-code-panel="toggleCodePanel"
      @toggle-data-panel="toggleDataPanel"
      @toggle-json-panel="toggleJsonPanel"
      @toggle-detach-mode="uiStore.toggleDetachMode"
      @open-style-modal="showStyleModal = true"
      @share="handleShare"
    />

    <BaseModal :is-open="showNewProjectModal" @close="showNewProjectModal = false">
      <template #header>
        <h3>Create New Project</h3>
      </template>
      <template #body>
        <div class="flex items-center gap-3">
          <label style="min-width: 100px; font-weight: 500">Project Name:</label>
          <BaseInput
            v-model="newProjectName"
            placeholder="Enter project name"
            @keyup.enter="createNewProject"
          />
        </div>
      </template>
      <template #footer>
        <BaseButton @click="createNewProject" type="primary">Create</BaseButton>
      </template>
    </BaseModal>

    <BaseModal :is-open="showNewGraphModal" @close="showNewGraphModal = false">
      <template #header>
        <h3>Create New Graph</h3>
      </template>
      <template #body>
        <div class="flex flex-col gap-2">
          <div class="db-form-group">
            <label for="new-graph-name">Graph Name</label>
            <BaseInput
              id="new-graph-name"
              v-model="newGraphName"
              placeholder="Enter a name for your graph"
              @keyup.enter="createNewGraph"
            />
          </div>

          <div class="db-import-section">
            <label class="db-section-label">Import from JSON (Optional)</label>

            <div
              class="db-drop-zone"
              :class="{ 'db-loaded': importedGraphData, 'db-drag-over': isDragOver }"
              @click="triggerGraphImport"
              @dragover.prevent="isDragOver = true"
              @dragleave.prevent="isDragOver = false"
              @drop.prevent="handleDrop"
            >
              <input
                type="file"
                ref="graphImportInput"
                accept=".json"
                @change="handleGraphImportFile"
                class="db-hidden-input"
              />

              <div v-if="!importedGraphData" class="db-drop-zone-content">
                <div class="db-icon-circle">
                  <i class="fas fa-file-import"></i>
                </div>
                <div class="db-text-content">
                  <span class="db-action-text">Click or Drag & Drop JSON file</span>
                  <small class="db-sub-text">Restore a previously exported graph</small>
                </div>
              </div>

              <div v-else class="db-drop-zone-content db-success">
                <div class="db-icon-circle db-success">
                  <i class="fas fa-check"></i>
                </div>
                <div class="db-text-content">
                  <span class="db-action-text">File Loaded Successfully</span>
                  <small class="db-sub-text">{{
                    importedGraphData.name || 'Untitled Graph'
                  }}</small>
                </div>
                <button
                  class="db-remove-file-btn"
                  @click.stop="clearImportedData"
                  title="Remove file"
                >
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </template>
      <template #footer>
        <BaseButton @click="createNewGraph" type="primary">Create Graph</BaseButton>
      </template>
    </BaseModal>

    <BaseModal :is-open="showScriptSettingsModal" @close="showScriptSettingsModal = false">
      <template #header>
        <h3>Script Configuration</h3>
      </template>
      <template #body>
        <ScriptSettingsPanel />
      </template>
      <template #footer>
        <BaseButton @click="handleScriptSettingsDone">Done</BaseButton>
      </template>
    </BaseModal>

    <AboutModal :is-open="showAboutModal" @close="showAboutModal = false" />
    <FaqModal :is-open="showFaqModal" @close="showFaqModal = false" />
    <ExportModal
      :is-open="showExportModal"
      :export-type="currentExportType"
      @close="showExportModal = false"
      @confirm-export="handleConfirmExport"
    />
    <ValidationIssuesModal
      :is-open="showValidationModal"
      :validation-errors="validationErrors"
      :elements="elements"
      @select-node="handleSelectNodeFromModal"
      @close="showValidationModal = false"
    />
    <GraphStyleModal :is-open="showStyleModal" @close="showStyleModal = false" />
    <ShareModal
      :is-open="showShareModal"
      :url="shareUrl"
      :project="projectStore.currentProject"
      :current-graph-id="graphStore.currentGraphId"
      @close="showShareModal = false"
      @generate="handleGenerateShareLink"
    />
    <DebugPanel v-if="showDebugPanel" @close="showDebugPanel = false" />
  </div>
</template>

<style scoped>
.db-app-layout {
  position: relative;
  width: 100vw;
  height: 100dvh;
  height: 100vh;
  overflow: hidden;
  background-color: var(--theme-bg-canvas);
}

.db-canvas-area {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  bottom: 0;
  z-index: 0;
  /* Base layer: Canvas */
  transition: bottom 0.1s ease;
}

.db-collapsed-sidebar-trigger {
  position: absolute;
  top: 16px;
  z-index: 100;
  /* Layer 2: Collapsed sidebar triggers */
  padding: 8px 12px;
  border-radius: var(--radius-md);
  display: flex;
  align-items: center;
  transition: all 0.2s ease;
  border: 1px solid var(--theme-border);
  background: var(--theme-bg-panel);
  cursor: pointer;
  min-width: 140px;
}

.db-collapsed-sidebar-trigger.db-left-trigger {
  left: 16px;
  min-width: 200px;
}

.db-collapsed-sidebar-trigger.db-right {
  left: auto;
  right: 16px;
}

.db-collapsed-sidebar-trigger:hover {
  box-shadow: var(--shadow-md);
  transform: scale(1.01);
}

.db-sidebar-trigger-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
}

.db-logo-text-minimized {
  font-family: var(--font-family-sans);
  font-size: 14px;
  font-weight: 600;
  color: var(--theme-text-primary);
}

.db-sidebar-title-minimized {
  font-size: 13px;
  font-weight: 600;
  color: var(--theme-text-primary);
}

.db-theme-toggle-header {
  background: transparent;
  border: none;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 4px;
  color: var(--theme-text-secondary);
  font-size: 0.85rem;
  transition: color 0.2s;
  border-radius: 4px;
}

.db-theme-toggle-header:hover {
  color: var(--theme-text-primary);
  background: var(--theme-bg-hover);
}

.db-toggle-icon-wrapper {
  display: flex;
  align-items: center;
}

.db-toggle-icon {
  color: var(--theme-text-secondary);
}

.db-empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: var(--theme-text-secondary);
  gap: 1rem;
}

.db-status-indicator {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;
  cursor: help;
}

.db-validation-status {
  font-size: 1.1em;
  margin: 0;
}

.db-validation-status.db-valid {
  color: var(--theme-success);
}

.db-validation-status.db-invalid {
  color: var(--theme-warning);
}

.db-instant-tooltip {
  position: absolute;
  top: 100%;
  right: 0;
  transform: none;
  background: var(--color-background-dark);
  color: var(--color-text-light);
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.75rem;
  white-space: nowrap;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.1s;
  margin-top: 6px;
  z-index: 600;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
}

.db-status-indicator:hover .db-instant-tooltip {
  opacity: 1;
}

.db-header-icon-btn {
  background: transparent;
  border: none;
  cursor: pointer;
  color: var(--theme-text-secondary);
  font-size: 14px;
  padding: 6px;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.db-header-icon-btn:hover {
  background-color: var(--theme-bg-hover);
  color: var(--theme-text-primary);
}

.db-collapsed-share-btn {
  width: 24px;
  height: 24px;
  padding: 0;
}

.fade-enter-active,
.fade-leave-active {
  transition: opacity 0.2s ease;
}

.fade-enter-from,
.fade-leave-to {
  opacity: 0;
}

.db-json-textarea {
  width: 100%;
  height: 120px;
  padding: 8px;
  font-family: monospace;
  font-size: 0.85em;
  border: 1px solid var(--theme-border);
  border-radius: var(--radius-sm);
  background-color: var(--theme-bg-hover);
  color: var(--theme-text-primary);
  resize: vertical;
}

.db-file-upload-wrapper {
  margin-top: 5px;
}

.db-desktop-text {
  display: inline;
}

.db-mobile-text {
  display: none;
}

.db-divider {
  height: 1px;
  background: var(--theme-border);
  width: 100%;
}

.text-green-500 {
  color: var(--theme-success);
}

.font-bold {
  font-weight: bold;
}

.text-xs {
  font-size: 0.75rem;
}

/* New Graph Modal Styles */
.db-form-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.db-form-group label {
  font-size: 0.9em;
  font-weight: 600;
  color: var(--theme-text-secondary);
}

.db-section-label {
  font-size: 0.9em;
  font-weight: 600;
  color: var(--theme-text-secondary);
  margin-bottom: 8px;
  display: block;
}

.db-drop-zone {
  border: 2px dashed var(--theme-border);
  border-radius: var(--radius-md);
  padding: 24px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  background-color: var(--theme-bg-hover);
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 160px;
}

.db-drop-zone:hover {
  border-color: var(--theme-text-muted);
  background-color: var(--theme-bg-active);
}

.db-drop-zone.db-drag-over {
  border-color: var(--theme-primary);
  background-color: rgba(16, 185, 129, 0.1);
  transform: scale(1.02);
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
}

.db-drop-zone.db-loaded {
  border-style: solid;
  border-color: var(--theme-success);
  background-color: rgba(16, 185, 129, 0.05);
}

.db-drop-zone-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  pointer-events: none;
  width: 100%;
}

.db-drop-zone-content.db-success {
  pointer-events: auto;
}

.db-icon-circle {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background-color: var(--theme-bg-panel);
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: var(--shadow-sm);
  color: var(--theme-text-muted);
  font-size: 24px;
  transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.db-drop-zone:hover .db-icon-circle {
  transform: scale(1.1);
  color: var(--theme-primary);
}

.db-drop-zone.db-drag-over .db-icon-circle {
  transform: scale(1.2);
  background-color: var(--theme-primary);
  color: white;
}

.db-icon-circle.db-success {
  background-color: var(--theme-success);
  color: white;
}

.db-text-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}

.db-action-text {
  font-weight: 600;
  color: var(--theme-text-primary);
  font-size: 1rem;
}

.db-sub-text {
  color: var(--theme-text-secondary);
  font-size: 0.85em;
}

.db-hidden-input {
  display: none;
}

.db-remove-file-btn {
  position: absolute;
  top: 10px;
  right: 10px;
  background: var(--theme-bg-panel);
  border: 1px solid var(--theme-border);
  color: var(--theme-text-secondary);
  cursor: pointer;
  width: 28px;
  height: 28px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  box-shadow: var(--shadow-sm);
}

.db-remove-file-btn:hover {
  background-color: var(--theme-danger);
  border-color: var(--theme-danger);
  color: white;
}

@media (max-width: 768px) {
  .db-desktop-text {
    display: none;
  }

  .db-mobile-text {
    display: inline;
  }

  .db-collapsed-sidebar-trigger {
    min-width: auto !important;
    max-width: 42%;
    padding: 8px;
  }

  .db-collapsed-sidebar-trigger.db-left-trigger {
    min-width: auto !important;
  }

  .db-logo-text-minimized {
    font-size: 12px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block;
  }

  .db-sidebar-trigger-content {
    gap: 4px;
  }
}
</style>



================================================
FILE: src/components/layouts/RightSidebar.vue
================================================
<script setup lang="ts">
import { type StyleValue } from 'vue'
import { storeToRefs } from 'pinia'
import NodePropertiesPanel from '../right-sidebar/NodePropertiesPanel.vue'
import LocalScriptPanel from '../right-sidebar/LocalScriptPanel.vue'
import BaseButton from '../ui/BaseButton.vue'
import { useUiStore } from '../../stores/uiStore'
import type { GraphElement, ValidationError } from '../../types'

const props = defineProps<{
  selectedElement: GraphElement | null
  validationErrors: Map<string, ValidationError[]>
  isModelValid: boolean
  enableDrag?: boolean
}>()

const emit = defineEmits<{
  (e: 'toggle-right-sidebar'): void
  (e: 'update-element', element: GraphElement): void
  (e: 'delete-element', elementId: string): void
  (e: 'show-validation-issues'): void
  (e: 'open-script-settings'): void
  (e: 'download-script'): void
  (e: 'generate-script'): void
  (e: 'share'): void
  (e: 'open-export-modal', format: 'png' | 'jpg' | 'svg'): void
  (e: 'export-json'): void
  (e: 'header-drag-start', event: MouseEvent | TouchEvent): void
}>()

const uiStore = useUiStore()
const { isRightSidebarOpen, activeRightTab } = storeToRefs(uiStore)

const sidebarStyle = (isOpen: boolean): StyleValue => {
  if (!isOpen) {
    return {
      transform: 'scale(0)',
      opacity: 0,
      pointerEvents: 'none',
    }
  }
  return {
    transform: 'scale(1)',
    opacity: 1,
    pointerEvents: 'auto',
  }
}

const handleHeaderMouseDown = (e: MouseEvent | TouchEvent) => {
  if (props.enableDrag) {
    emit('header-drag-start', e)
  }
}

const handleHeaderClick = () => {
  if (!props.enableDrag) {
    emit('toggle-right-sidebar')
  }
}
</script>

<template>
  <aside
    class="db-floating-sidebar db-right db-glass-panel"
    :style="sidebarStyle(isRightSidebarOpen)"
  >
    <div
      class="db-sidebar-header"
      @mousedown="handleHeaderMouseDown"
      @touchstart="handleHeaderMouseDown"
      @click="handleHeaderClick"
      :style="{ cursor: enableDrag ? 'move' : 'pointer' }"
    >
      <span class="db-sidebar-title">Inspector</span>

      <div class="flex items-center ml-auto" @click.stop @mousedown.stop @touchstart.stop>
        <div
          class="db-status-indicator db-validation-status"
          @click="$emit('show-validation-issues')"
          :class="isModelValid ? 'db-valid' : 'db-invalid'"
        >
          <i :class="isModelValid ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle'"></i>
          <div class="db-instant-tooltip">
            {{ isModelValid ? 'Model Valid' : 'Validation Errors Found' }}
          </div>
        </div>

        <button class="db-header-icon-btn" @click="$emit('share')" title="Share via URL">
          <i class="fas fa-share-alt"></i>
        </button>
      </div>

      <div class="pointer-events-none flex items-center ml-2">
        <svg width="20" height="20" fill="none" viewBox="0 0 24 24" class="db-toggle-icon">
          <path
            fill="currentColor"
            fill-rule="evenodd"
            d="M10 7h8a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1h-8zM9 7H6a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h3zM4 8a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2z"
            clip-rule="evenodd"
          ></path>
        </svg>
      </div>
    </div>

    <div class="db-sidebar-tabs">
      <button
        :class="{ 'db-active': activeRightTab === 'properties' }"
        @click="uiStore.setActiveRightTab('properties')"
      >
        Props
      </button>
      <button
        :class="{ 'db-active': activeRightTab === 'script' }"
        @click="uiStore.setActiveRightTab('script')"
      >
        Script
      </button>
      <button
        :class="{ 'db-active': activeRightTab === 'export' }"
        @click="uiStore.setActiveRightTab('export')"
      >
        Export
      </button>
    </div>

    <div class="db-sidebar-content">
      <NodePropertiesPanel
        v-show="activeRightTab === 'properties'"
        :selected-element="selectedElement"
        :validation-errors="validationErrors"
        @update-element="$emit('update-element', $event)"
        @delete-element="$emit('delete-element', $event)"
      />

      <LocalScriptPanel
        v-show="activeRightTab === 'script'"
        :is-active="activeRightTab === 'script'"
        @open-settings="$emit('open-script-settings')"
        @download="$emit('download-script')"
        @generate="$emit('generate-script')"
      />

      <div v-show="activeRightTab === 'export'" class="db-export-panel">
        <div class="db-menu-panel flex-col gap-3">
          <h5 class="db-section-title">Image Export</h5>
          <BaseButton type="ghost" class="db-menu-btn" @click="$emit('open-export-modal', 'png')"
            ><i class="fas fa-image"></i> PNG Image</BaseButton
          >
          <BaseButton type="ghost" class="db-menu-btn" @click="$emit('open-export-modal', 'jpg')"
            ><i class="fas fa-file-image"></i> JPG Image</BaseButton
          >
          <BaseButton type="ghost" class="db-menu-btn" @click="$emit('open-export-modal', 'svg')"
            ><i class="fas fa-draw-polygon"></i> SVG Vector</BaseButton
          >

          <div class="db-divider"></div>

          <h5 class="db-section-title">Model Export</h5>
          <BaseButton type="ghost" class="db-menu-btn" @click="$emit('export-json')"
            ><i class="fas fa-file-code"></i>Export Graph, Data & Inits as JSON</BaseButton
          >
        </div>
      </div>
    </div>
  </aside>
</template>

<style scoped>
.db-floating-sidebar {
  position: absolute;
  top: 16px;
  height: auto;
  max-height: calc(100dvh - 32px);
  bottom: auto;
  z-index: 50;
  display: flex;
  flex-direction: column;
  border-radius: var(--radius-lg);
  overflow: hidden;
  transition:
    transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1),
    opacity 0.3s ease;
  background: var(--theme-bg-panel);
  box-shadow: var(--shadow-floating);
}

.db-floating-sidebar.db-right {
  right: 16px;
  width: 320px;
  transform-origin: top right;
}

@media (max-width: 768px) {
  .db-floating-sidebar.db-right {
    width: calc(100vw - 32px) !important;
  }
  .db-sidebar-tabs button {
    padding: 8px 4px;
    font-size: 0.8rem;
  }
  .db-sidebar-content {
    padding-bottom: 80px; /* Space for floating toolbar on mobile */
  }
}

.db-sidebar-header {
  padding: 12px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid var(--theme-border);
  background: var(--theme-bg-panel-transparent);
  color: var(--theme-text-primary);
  flex-shrink: 0;
}

.db-sidebar-title {
  font-weight: 600;
  font-size: var(--font-size-md);
  user-select: none;
}

.db-toggle-icon {
  color: var(--theme-text-secondary);
}

.db-status-indicator {
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;
  cursor: help;
}

.db-validation-status {
  font-size: 1.1em;
  margin: 0 5px;
}
.db-validation-status.db-valid {
  color: var(--theme-success);
}
.db-validation-status.db-invalid {
  color: var(--theme-warning);
}

.db-instant-tooltip {
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: var(--color-background-dark);
  color: var(--color-text-light);
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.75rem;
  white-space: nowrap;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.1s;
  margin-top: 6px;
  z-index: 100;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
}

.db-status-indicator:hover .db-instant-tooltip {
  opacity: 1;
}

.db-header-icon-btn {
  background: transparent;
  border: none;
  cursor: pointer;
  color: var(--theme-text-secondary);
  font-size: 14px;
  padding: 6px;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.db-header-icon-btn:hover {
  background-color: var(--theme-bg-hover);
  color: var(--theme-text-primary);
}

.db-sidebar-tabs {
  display: flex;
  background: var(--theme-bg-hover);
  padding: 4px;
  gap: 4px;
  border-bottom: 1px solid var(--theme-border);
}

.db-sidebar-tabs button {
  flex: 1;
  background: transparent;
  border: none;
  padding: 8px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  color: var(--theme-text-secondary);
  transition: all 0.2s;
  font-weight: 500;
}

.db-sidebar-tabs button:hover {
  background: rgba(0, 0, 0, 0.05);
  color: var(--theme-text-primary);
}

.db-sidebar-tabs button.db-active {
  background: var(--theme-bg-panel);
  color: var(--theme-primary);
  box-shadow: var(--shadow-sm);
}

.db-sidebar-content {
  flex: 1;
  overflow-y: auto;
  background: var(--theme-bg-panel);
}

.db-export-panel {
  padding: 10px;
}

.db-menu-panel {
  display: flex;
  padding: 8px;
}

.db-menu-btn {
  justify-content: flex-start !important;
  gap: 10px;
  width: 100%;
  padding: 10px !important;
  font-size: var(--font-size-sm);
  color: var(--theme-text-primary);
  border-radius: var(--radius-sm);
  transition: background-color 0.2s;
}
.db-menu-btn:hover {
  background-color: var(--theme-bg-hover);
}

.db-divider {
  height: 1px;
  background: var(--theme-border);
  margin: 12px 0;
}

.db-section-title {
  font-size: 0.85em;
  font-weight: 600;
  color: var(--theme-text-secondary);
  margin: 0 0 4px 4px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.db-glass-panel {
  background: var(--theme-bg-panel-transparent, rgba(255, 255, 255, 0.95));
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border: 1px solid var(--theme-border);
  box-shadow: var(--shadow-floating);
}
</style>



================================================
FILE: src/components/layouts/ShareModal.vue
================================================
<script setup lang="ts">
import { ref, watch, computed } from 'vue'
import BaseModal from '../common/BaseModal.vue'
import BaseInput from '../ui/BaseInput.vue'
import BaseButton from '../ui/BaseButton.vue'
import type { Project } from '../../stores/projectStore'

const props = defineProps<{
  isOpen: boolean
  url: string
  project?: Project | null
  currentGraphId?: string | null
}>()

const emit = defineEmits(['close', 'generate'])

type ShareScope = 'current' | 'project' | 'custom'

const activeTab = ref<ShareScope>('current')
const selectedGraphs = ref<Set<string>>(new Set())

const copySuccess = ref(false)
const shortUrl = ref<string | null>(null)
const isLoadingShort = ref(false)
const shortError = ref<string | null>(null)

// Track which history item shows the "Copied" state
const copiedHistoryIndex = ref<number | null>(null)

interface HistoryItem {
  shortUrl: string
  label: string
  timestamp: number
}

const urlHistory = ref<HistoryItem[]>([])

const projectGraphs = computed(() => props.project?.graphs || [])

// Load history from localStorage
const storedHistory = localStorage.getItem('doodlebugs-urlHistory')
if (storedHistory) {
  try {
    urlHistory.value = JSON.parse(storedHistory)
  } catch {
    urlHistory.value = []
  }
}

const saveHistory = () => {
  localStorage.setItem('doodlebugs-urlHistory', JSON.stringify(urlHistory.value))
}

const deleteHistoryItem = (index: number) => {
  urlHistory.value.splice(index, 1)
  saveHistory()
}

// Reset state when modal opens
watch(
  () => props.isOpen,
  (val) => {
    if (val) {
      activeTab.value = 'current'
      selectedGraphs.value = new Set()
      if (props.currentGraphId) {
        selectedGraphs.value.add(props.currentGraphId)
      }
      resetUrlState()
      triggerGeneration()
    }
  }
)

// Regenerate when tab changes
watch(activeTab, () => {
  resetUrlState()
  triggerGeneration()
})

const resetUrlState = () => {
  copySuccess.value = false
  shortUrl.value = null
  shortError.value = null
  isLoadingShort.value = false
  copiedHistoryIndex.value = null
}

const toggleGraphSelection = (id: string) => {
  if (selectedGraphs.value.has(id)) {
    selectedGraphs.value.delete(id)
  } else {
    selectedGraphs.value.add(id)
  }
  resetUrlState()
  triggerGeneration()
}

const triggerGeneration = () => {
  let ids: string[] = []

  if (activeTab.value === 'current') {
    if (props.currentGraphId) ids = [props.currentGraphId]
  } else if (activeTab.value === 'project') {
    ids = projectGraphs.value.map((g) => g.id)
  } else if (activeTab.value === 'custom') {
    ids = Array.from(selectedGraphs.value)
  }

  // Only generate if we have something to share
  if (ids.length > 0) {
    emit('generate', { scope: activeTab.value, selectedGraphIds: ids })
  }
}

const displayUrl = computed(() => shortUrl.value || props.url)

const copyToClipboard = async () => {
  if (!displayUrl.value) return
  await performCopy(displayUrl.value)
  copySuccess.value = true
  setTimeout(() => (copySuccess.value = false), 2000)
}

const copyHistoryItem = async (text: string, index: number) => {
  await performCopy(text)
  copiedHistoryIndex.value = index
  setTimeout(() => {
    if (copiedHistoryIndex.value === index) {
      copiedHistoryIndex.value = null
    }
  }, 2000)
}

const performCopy = async (text: string) => {
  try {
    await navigator.clipboard.writeText(text)
  } catch {
    const input = document.createElement('textarea')
    input.value = text
    document.body.appendChild(input)
    input.select()
    document.execCommand('copy')
    document.body.removeChild(input)
  }
}

const shortenUrl = async () => {
  if (shortUrl.value || !props.url) return

  isLoadingShort.value = true
  shortError.value = null

  try {
    const target = `https://is.gd/create.php?format=json&url=${encodeURIComponent(props.url)}`
    const proxy = `https://api.allorigins.win/get?url=${encodeURIComponent(target)}`

    const response = await fetch(proxy)
    if (!response.ok) throw new Error(`HTTP Error ${response.status}`)

    const proxyData = await response.json()

    if (proxyData.contents) {
      const data = JSON.parse(proxyData.contents)
      if (data.errorcode) throw new Error(data.errormessage || 'Unknown is.gd error')
      if (data.shorturl) {
        shortUrl.value = data.shorturl

        // Add to history
        let label = 'Shared Model'
        if (activeTab.value === 'current' && props.currentGraphId) {
          const g = projectGraphs.value.find((g) => g.id === props.currentGraphId)
          label = g ? g.name : 'Current Graph'
        } else if (activeTab.value === 'project' && props.project) {
          label = `Project: ${props.project.name}`
        } else if (activeTab.value === 'custom') {
          label = `Selection (${selectedGraphs.value.size} graphs)`
        }

        const newItem: HistoryItem = {
          shortUrl: data.shorturl,
          label,
          timestamp: Date.now(),
        }

        // Add to history (avoid duplicates, limit to 10)
        urlHistory.value = [
          newItem,
          ...urlHistory.value.filter((i) => i.shortUrl !== data.shorturl),
        ].slice(0, 10)
        saveHistory()
      } else {
        throw new Error('Invalid response from is.gd')
      }
    } else {
      throw new Error('Empty response from proxy')
    }
  } catch (e: unknown) {
    console.error('Shortening failed:', e)
    shortError.value = e instanceof Error ? e.message : String(e)
    if (shortError.value?.includes('Rate limit')) {
      shortError.value = 'Rate limit exceeded. Please try again later.'
    } else if (shortError.value?.includes('Failed to fetch') || shortError.value?.includes('414')) {
      shortError.value = 'URL is too long for the shortener service. Please use the Long URL.'
    }
  } finally {
    isLoadingShort.value = false
  }
}

const handleUrlFocus = (event: FocusEvent) => {
  ;(event.target as HTMLInputElement).select()
}
</script>

<template>
  <BaseModal :is-open="isOpen" @close="emit('close')">
    <template #header>
      <h3>Share Model</h3>
    </template>
    <template #body>
      <div class="db-share-layout">
        <!-- Tab Navigation -->
        <div class="db-share-tabs">
          <button
            class="db-tab-btn"
            :class="{ 'db-active': activeTab === 'current' }"
            @click="activeTab = 'current'"
          >
            <i class="fas fa-file-alt"></i> Current Graph
          </button>
          <button
            class="db-tab-btn"
            :class="{ 'db-active': activeTab === 'project' }"
            @click="activeTab = 'project'"
          >
            <i class="fas fa-folder"></i> Whole Project
          </button>
          <button
            class="db-tab-btn"
            :class="{ 'db-active': activeTab === 'custom' }"
            @click="activeTab = 'custom'"
          >
            <i class="fas fa-check-square"></i> Select Graphs
          </button>
        </div>

        <!-- Custom Selection Area -->
        <div v-if="activeTab === 'custom'" class="db-selection-area">
          <div class="db-selection-header">Select graphs to include:</div>
          <div class="db-graph-list">
            <div v-for="graph in projectGraphs" :key="graph.id" class="db-graph-item">
              <label>
                <input
                  type="checkbox"
                  :checked="selectedGraphs.has(graph.id)"
                  @change="toggleGraphSelection(graph.id)"
                />
                <span class="db-graph-name">{{ graph.name }}</span>
              </label>
            </div>
          </div>
        </div>

        <div class="db-divider"></div>

        <!-- URL Result Area -->
        <div class="db-result-area">
          <div v-if="!url" class="db-empty-message">Select graphs to generate a link.</div>
          <template v-else>
            <label class="db-url-label">Share Link ({{ shortUrl ? 'Shortened' : 'Base64' }})</label>
            <div class="db-url-row">
              <BaseInput
                :model-value="displayUrl"
                readonly
                class="db-url-input"
                :class="{ 'db-is-short': !!shortUrl }"
                @focus="handleUrlFocus"
              />
              <BaseButton
                @click="copyToClipboard"
                type="primary"
                class="db-icon-only-btn"
                title="Copy to Clipboard"
              >
                <i :class="copySuccess ? 'fas fa-check' : 'fas fa-copy'"></i>
              </BaseButton>
            </div>

            <div class="db-actions-row">
              <BaseButton
                v-if="!shortUrl"
                @click="shortenUrl"
                type="secondary"
                size="small"
                :disabled="isLoadingShort"
                class="db-shorten-btn"
              >
                <i v-if="isLoadingShort" class="fas fa-spinner fa-spin"></i>
                <span v-else>Shorten URL (is.gd)</span>
              </BaseButton>

              <div v-if="shortError" class="db-error-msg">
                <i class="fas fa-exclamation-circle"></i> {{ shortError }}
              </div>
            </div>

            <div class="db-info-note">
              <i class="fas fa-info-circle"></i>
              <span
                >The model, data & inits are directly encoded as the base64 URL. Nothing is stored
                on our servers.</span
              >
            </div>

            <div class="db-disclaimer-box">
              <i class="fas fa-exclamation-triangle"></i>
              <small>
                <strong>Note:</strong>
                <a
                  href="https://is.gd"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="db-text-link"
                  >is.gd</a
                >
                is a third-party service. Please avoid generating short links excessively to prevent
                hitting rate limits. If generation fails, use the Long URL above.
              </small>
            </div>
          </template>
        </div>

        <!-- History Section -->
        <div v-if="urlHistory.length > 0" class="db-history-section">
          <div class="db-divider"></div>
          <div class="db-history-header">Recent Short Links</div>
          <div class="db-history-list">
            <div v-for="(item, index) in urlHistory" :key="item.shortUrl" class="db-history-item">
              <div class="db-history-info">
                <span class="db-history-label">{{ item.label }}</span>
                <a :href="item.shortUrl" target="_blank" class="db-history-link">{{
                  item.shortUrl
                }}</a>
              </div>
              <div class="db-history-actions">
                <button
                  @click="copyHistoryItem(item.shortUrl, index)"
                  class="db-icon-btn db-small"
                  :title="copiedHistoryIndex === index ? 'Copied' : 'Copy'"
                >
                  <i
                    :class="copiedHistoryIndex === index ? 'fas fa-check' : 'fas fa-copy'"
                    :style="{ color: copiedHistoryIndex === index ? 'var(--theme-success)' : '' }"
                  ></i>
                </button>
                <button
                  @click="deleteHistoryItem(index)"
                  class="db-icon-btn db-small db-danger"
                  title="Delete"
                >
                  <i class="fas fa-trash-alt"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </template>
  </BaseModal>
</template>

<style scoped>
.db-share-layout {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.db-share-tabs {
  display: flex;
  background-color: var(--theme-bg-hover);
  padding: 4px;
  border-radius: var(--radius-md);
  gap: 4px;
}

.db-tab-btn {
  flex: 1;
  border: none;
  background: transparent;
  padding: 8px;
  border-radius: var(--radius-sm);
  color: var(--theme-text-secondary);
  font-size: 0.9em;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.db-tab-btn:hover {
  color: var(--theme-text-primary);
  background-color: rgba(0, 0, 0, 0.05);
}

.db-tab-btn.db-active {
  background-color: var(--theme-bg-panel);
  color: var(--theme-primary);
  box-shadow: var(--shadow-sm);
  font-weight: 600;
}

.db-selection-area {
  border: 1px solid var(--theme-border);
  border-radius: var(--radius-md);
  padding: 10px;
  background-color: var(--theme-bg-canvas);
}

.db-selection-header {
  font-size: 0.85em;
  font-weight: 600;
  color: var(--theme-text-secondary);
  margin-bottom: 8px;
}

.db-graph-list {
  max-height: 120px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.db-graph-item label {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
  transition: background 0.2s;
}

.db-graph-item label:hover {
  background-color: var(--theme-bg-hover);
}

.db-divider {
  height: 1px;
  background-color: var(--theme-border);
  width: 100%;
}

.db-result-area {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.db-url-label {
  font-size: 0.85em;
  font-weight: 600;
  color: var(--theme-text-secondary);
}

.db-url-row {
  display: flex;
  gap: 8px;
}

.db-url-input {
  flex-grow: 1;
  font-family: monospace;
  font-size: 0.85em;
}

.db-url-input.db-is-short {
  color: var(--theme-primary);
  font-weight: 600;
}

.db-icon-only-btn {
  width: 36px;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.db-actions-row {
  display: flex;
  align-items: center;
  gap: 10px;
  min-height: 32px;
}

.db-shorten-btn {
  min-width: 140px;
}

.db-error-msg {
  font-size: 0.8em;
  color: var(--theme-danger);
}

.db-info-note {
  font-size: 0.8em;
  color: var(--theme-text-muted);
  background-color: var(--theme-bg-hover);
  padding: 8px;
  border-radius: var(--radius-sm);
  display: flex;
  gap: 8px;
  align-items: flex-start;
  line-height: 1.4;
}

.db-disclaimer-box {
  display: flex;
  gap: 8px;
  align-items: flex-start;
  font-size: 0.8em;
  color: var(--theme-text-secondary);
  background-color: rgba(245, 158, 11, 0.1);
  padding: 8px;
  border-radius: var(--radius-sm);
}

.db-disclaimer-box i {
  color: var(--theme-warning);
  margin-top: 2px;
}

.db-text-link {
  color: var(--theme-primary);
  text-decoration: underline;
  font-weight: 500;
}

.db-text-link:hover {
  color: var(--theme-primary-hover);
}

.db-empty-message {
  text-align: center;
  color: var(--theme-text-secondary);
  font-style: italic;
  padding: 20px;
}

.db-history-section {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.db-history-header {
  font-size: 0.85em;
  font-weight: 600;
  color: var(--theme-text-secondary);
}

.db-history-list {
  display: flex;
  flex-direction: column;
  gap: 6px;
  max-height: 150px;
  overflow-y: auto;
  border: 1px solid var(--theme-border);
  border-radius: var(--radius-sm);
  padding: 4px;
}

.db-history-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 6px 8px;
  background: var(--theme-bg-hover);
  border-radius: 4px;
  font-size: 0.85em;
}

.db-history-info {
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.db-history-label {
  font-weight: 600;
  color: var(--theme-text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.db-history-link {
  color: var(--theme-primary);
  text-decoration: none;
  font-size: 0.9em;
}

.db-history-link:hover {
  text-decoration: underline;
}

.db-history-actions {
  display: flex;
  gap: 4px;
  margin-left: 8px;
}

.db-icon-btn.db-small {
  width: 24px;
  height: 24px;
  font-size: 12px;
  background: transparent;
  border: none;
  color: var(--theme-text-secondary);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
}

.db-icon-btn.db-small:hover {
  background: rgba(0, 0, 0, 0.05);
  color: var(--theme-text-primary);
}

.db-icon-btn.db-small.db-danger:hover {
  color: var(--theme-danger);
  background: rgba(239, 68, 68, 0.1);
}
</style>



================================================
FILE: src/components/layouts/ValidationIssuesModal.vue
================================================
<script setup lang="ts">
import { computed, ref } from 'vue'
import BaseModal from '../common/BaseModal.vue'
import BaseButton from '../ui/BaseButton.vue'
import type { GraphElement, GraphNode, ValidationError } from '../../types'

const props = defineProps<{
  isOpen: boolean
  validationErrors: Map<string, ValidationError[]>
  elements: GraphElement[]
}>()

const emit = defineEmits(['close', 'select-node'])

const copySuccess = ref(false)

const nodeMap = computed(() => {
  const map = new Map<string, GraphNode>()
  for (const el of props.elements) {
    if (el.type === 'node') {
      map.set(el.id, el as GraphNode)
    }
  }
  return map
})

const errorsWithNodeNames = computed(() => {
  const allErrors: { nodeId: string; nodeName: string; errors: ValidationError[] }[] = []
  for (const [nodeId, errors] of props.validationErrors.entries()) {
    const node = nodeMap.value.get(nodeId)
    if (node) {
      allErrors.push({
        nodeId,
        nodeName: node.name,
        errors,
      })
    }
  }
  // Sort by node name for consistent order
  allErrors.sort((a, b) => a.nodeName.localeCompare(b.nodeName))
  return allErrors
})

const handleSelectNode = (nodeId: string) => {
  emit('select-node', nodeId)
  emit('close')
}

const copyLogs = () => {
  const logText = errorsWithNodeNames.value
    .map((item) => {
      const errorLines = item.errors.map((err) => `- ${err.message}`).join('\n')
      return `Node: ${item.nodeName}\n${errorLines}`
    })
    .join('\n\n')

  navigator.clipboard
    .writeText(logText)
    .then(() => {
      copySuccess.value = true
      setTimeout(() => {
        copySuccess.value = false
      }, 2000)
    })
    .catch((err) => {
      console.error('Failed to copy validation logs: ', err)
      alert('Could not copy logs to clipboard.')
    })
}
</script>

<template>
  <BaseModal :is-open="isOpen" @close="emit('close')">
    <template #header>
      <h3>Model Validation Issues</h3>
    </template>
    <template #body>
      <div v-if="errorsWithNodeNames.length === 0" class="db-no-issues">
        <i class="fas fa-check-circle"></i>
        <p>No validation issues found. The model appears to be valid!</p>
      </div>
      <div v-else class="db-issues-list">
        <div v-for="item in errorsWithNodeNames" :key="item.nodeId" class="db-issue-item">
          <div
            class="db-issue-header"
            @click="handleSelectNode(item.nodeId)"
            title="Click to select node"
          >
            <strong>Node: {{ item.nodeName }}</strong>
            <i class="fas fa-crosshairs"></i>
          </div>
          <ul class="db-error-details">
            <li v-for="(error, index) in item.errors" :key="index">
              {{ error.message }}
            </li>
          </ul>
        </div>
      </div>
    </template>
    <template #footer>
      <div class="w-full flex justify-end">
        <BaseButton @click="copyLogs" type="secondary" v-if="errorsWithNodeNames.length > 0">
          <i v-if="copySuccess" class="fas fa-check"></i>
          <span v-else>Copy Logs</span>
        </BaseButton>
      </div>
    </template>
  </BaseModal>
</template>

<style scoped>
.db-no-issues {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 20px;
  color: var(--theme-success);
}
.db-no-issues i {
  font-size: 3em;
  margin-bottom: 15px;
}
.db-no-issues p {
  font-size: 1.1em;
  font-weight: 500;
  margin: 0;
}
.db-issues-list {
  display: flex;
  flex-direction: column;
  gap: 15px;
}
.db-issue-item {
  background-color: var(--theme-bg-active);
  border: 1px solid var(--theme-border);
  border-left: 4px solid var(--theme-danger);
  border-radius: 4px;
  padding: 10px 15px;
}
.db-issue-header {
  font-weight: 600;
  color: var(--theme-text-primary);
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: color 0.2s ease;
}
.db-issue-header:hover {
  color: var(--theme-primary);
}
.db-issue-header i {
  opacity: 0.6;
}
.db-error-details {
  margin: 8px 0 0 0;
  padding-left: 20px;
  font-size: 0.9em;
  color: var(--theme-text-secondary);
}
</style>



================================================
FILE: src/components/left-sidebar/ProjectManager.vue
================================================
<script setup lang="ts">
import { ref, onMounted, onUnmounted, computed, nextTick } from 'vue'
import { useProjectStore, type Project, type GraphMeta } from '../../stores/projectStore'
import { useGraphStore } from '../../stores/graphStore'
import BaseButton from '../ui/BaseButton.vue'
import BaseModal from '../common/BaseModal.vue'
import BaseInput from '../ui/BaseInput.vue'

const projectStore = useProjectStore()
const graphStore = useGraphStore()

const showDeleteConfirmModal = ref(false)
const itemToDelete = ref<{
  type: 'project' | 'graph'
  id: string
  name: string
  projectId?: string
} | null>(null)

const showRenameModal = ref(false)
const itemToRename = ref<{
  type: 'project' | 'graph'
  id: string
  name: string
  projectId?: string
} | null>(null)
const newItemName = ref('')

const contextMenu = ref<{ type: 'project' | 'graph'; id: string; x: number; y: number } | null>(
  null
)
const contextMenuRef = ref<HTMLElement | null>(null)

const currentProject = computed(() => projectStore.currentProject)
const currentProjectGraphs = computed(() => {
  if (currentProject.value) {
    return projectStore.getGraphsForProject(currentProject.value.id)
  }
  return []
})

const handleClickOutside = (event: MouseEvent) => {
  if (contextMenuRef.value && !contextMenuRef.value.contains(event.target as Node)) {
    contextMenu.value = null
  }
}

onMounted(() => {
  projectStore.loadProjects()
  if (projectStore.projects.length > 0 && !projectStore.currentProjectId) {
    projectStore.selectProject(projectStore.projects[0].id)
  }
  document.addEventListener('click', handleClickOutside)
})

onUnmounted(() => {
  document.removeEventListener('click', handleClickOutside)
})

const selectGraph = (graphId: string) => {
  graphStore.selectGraph(graphId)
}

const openContextMenu = async (event: MouseEvent, type: 'project' | 'graph', id: string) => {
  event.stopPropagation()
  event.preventDefault()
  contextMenu.value = null
  await nextTick()
  contextMenu.value = { type, id, x: event.clientX, y: event.clientY }
}

const confirmDeletion = (
  type: 'project' | 'graph',
  id: string,
  name: string,
  projectId?: string
) => {
  itemToDelete.value = { type, id, name, projectId }
  showDeleteConfirmModal.value = true
  contextMenu.value = null
}

const executeDeletion = () => {
  if (itemToDelete.value) {
    if (itemToDelete.value.type === 'project') {
      projectStore.deleteProject(itemToDelete.value.id)
    } else if (itemToDelete.value.type === 'graph' && itemToDelete.value.projectId) {
      projectStore.deleteGraphFromProject(itemToDelete.value.projectId, itemToDelete.value.id)
      if (graphStore.currentGraphId === itemToDelete.value.id) {
        graphStore.selectGraph(null)
      }
    }
    showDeleteConfirmModal.value = false
    itemToDelete.value = null
  }
}

const openRenameModal = (
  type: 'project' | 'graph',
  id: string,
  name: string,
  projectId?: string
) => {
  itemToRename.value = { type, id, name, projectId }
  newItemName.value = name
  showRenameModal.value = true
  contextMenu.value = null
}

const executeRename = () => {
  if (itemToRename.value && newItemName.value.trim()) {
    if (itemToRename.value.type === 'project') {
      projectStore.renameProject(itemToRename.value.id, newItemName.value)
    } else if (itemToRename.value.type === 'graph' && itemToRename.value.projectId) {
      projectStore.renameGraphInProject(
        itemToRename.value.projectId,
        itemToRename.value.id,
        newItemName.value
      )
    }
  }
  showRenameModal.value = false
  itemToRename.value = null
  newItemName.value = ''
}

const emit = defineEmits(['newProject', 'newGraph'])

const handleNewProject = () => {
  emit('newProject')
  contextMenu.value = null
}

const handleNewGraph = () => {
  emit('newGraph')
  contextMenu.value = null
}
</script>

<template>
  <div class="db-project-manager">
    <div class="db-panel-header">
      <h4>Projects</h4>
      <div class="db-header-actions">
        <BaseButton
          @click="handleNewGraph"
          type="ghost"
          size="small"
          class="db-action-icon-btn"
          title="New Graph in Current Project"
          :disabled="!currentProject"
        >
          <i class="fas fa-hexagon-nodes"></i>
        </BaseButton>
        <BaseButton
          @click="handleNewProject"
          type="ghost"
          size="small"
          class="db-action-icon-btn"
          title="New Project"
        >
          <i class="fas fa-folder" style="color: #10b981"></i>
        </BaseButton>
      </div>
    </div>

    <!-- Empty state namespaced -->
    <div v-if="projectStore.projects.length === 0" class="db-empty-state">
      <p>No projects yet.</p>
      <BaseButton @click="handleNewProject" type="primary">Create New Project</BaseButton>
    </div>

    <!-- Project list structure namespaced -->
    <div v-else class="db-project-list">
      <div v-for="project in projectStore.projects" :key="project.id" class="db-project-item">
        <div
          class="db-project-header"
          @click="projectStore.selectProject(project.id)"
          @touchend.prevent="projectStore.selectProject(project.id)"
          :class="{ 'db-active': projectStore.currentProjectId === project.id }"
        >
          <i
            class="db-icon-chevron fas fa-chevron-right"
            :class="{ 'db-open': projectStore.currentProjectId === project.id }"
          ></i>
          <i class="db-icon-folder fas fa-folder"></i>
          <span class="db-project-name">{{ project.name }}</span>
          <div class="db-project-actions">
            <button
              @click.stop="openContextMenu($event, 'project', project.id)"
              class="db-context-trigger-btn"
            >
              <i class="fas fa-ellipsis-v"></i>
            </button>
          </div>
        </div>
        <transition name="slide-fade">
          <div v-if="projectStore.currentProject?.id === project.id" class="db-graph-list">
            <div
              v-for="graph in currentProjectGraphs"
              :key="graph.id"
              class="db-graph-item"
              :class="{ 'db-active': graphStore.currentGraphId === graph.id }"
              @click="selectGraph(graph.id)"
              @touchend.prevent="selectGraph(graph.id)"
            >
              <i class="db-icon-file fas fa-hexagon-nodes"></i>
              <span>{{ graph.name }}</span>
              <button
                @click.stop="openContextMenu($event, 'graph', graph.id)"
                class="db-context-trigger-btn"
              >
                <i class="fas fa-ellipsis-v"></i>
              </button>
            </div>
            <div v-if="currentProjectGraphs.length === 0" class="db-empty-state-inner">
              <p>No graphs in this project.</p>
              <BaseButton @click="handleNewGraph" type="secondary" size="small"
                >Create New Graph</BaseButton
              >
            </div>
          </div>
        </transition>
      </div>
    </div>

    <Teleport to="body">
      <div
        v-if="contextMenu"
        ref="contextMenuRef"
        class="db-context-menu"
        :style="{ top: `${contextMenu.y}px`, left: `${contextMenu.x}px` }"
      >
        <template v-if="contextMenu.type === 'project'">
          <div class="db-context-menu-item" @click="handleNewGraph">
            <i class="fas fa-hexagon-nodes"></i> New Graph
          </div>
          <div
            class="db-context-menu-item"
            @click="
              openRenameModal(
                'project',
                contextMenu!.id,
                projectStore.projects.find((p) => p.id === contextMenu!.id)!.name
              )
            "
          >
            <i class="fas fa-edit"></i> Rename
          </div>
          <div
            class="db-context-menu-item db-danger"
            @click="
              confirmDeletion(
                'project',
                contextMenu!.id,
                projectStore.projects.find((p: Project) => p.id === contextMenu!.id)!.name
              )
            "
          >
            <i class="fas fa-trash-alt"></i> Delete Project
          </div>
        </template>
        <template v-if="contextMenu.type === 'graph'">
          <div
            class="db-context-menu-item"
            @click="
              openRenameModal(
                'graph',
                contextMenu!.id,
                currentProjectGraphs.find((g) => g.id === contextMenu!.id)!.name,
                currentProject!.id
              )
            "
          >
            <i class="fas fa-edit"></i> Rename
          </div>
          <div
            class="db-context-menu-item db-danger"
            @click="
              confirmDeletion(
                'graph',
                contextMenu!.id,
                currentProjectGraphs.find((g: GraphMeta) => g.id === contextMenu!.id)!.name,
                currentProject!.id
              )
            "
          >
            <i class="fas fa-trash-alt"></i> Delete Graph
          </div>
        </template>
      </div>
    </Teleport>

    <BaseModal :is-open="showDeleteConfirmModal" @close="showDeleteConfirmModal = false">
      <template #header>
        <h3>Confirm Deletion</h3>
      </template>
      <template #body>
        <div class="db-confirm-body">
          <p v-if="itemToDelete">
            Are you sure you want to delete the {{ itemToDelete.type }}
            <strong>"{{ itemToDelete.name }}"</strong>?
            <span v-if="itemToDelete.type === 'project'"
              >This will also delete all of its graphs.</span
            >
            This action cannot be undone.
          </p>
        </div>
      </template>
      <template #footer>
        <BaseButton @click="executeDeletion" type="danger">Delete</BaseButton>
      </template>
    </BaseModal>

    <BaseModal :is-open="showRenameModal" @close="showRenameModal = false">
      <template #header>
        <h3>Rename {{ itemToRename?.type }}</h3>
      </template>
      <template #body>
        <div class="db-rename-body">
          <label for="new-item-name" style="display: block; margin-bottom: 8px; font-weight: 500"
            >New Name:</label
          >
          <BaseInput
            id="new-item-name"
            v-model="newItemName"
            :placeholder="`Enter new ${itemToRename?.type} name`"
            @keyup.enter="executeRename"
          />
        </div>
      </template>
      <template #footer>
        <BaseButton @click="executeRename" type="primary">Rename</BaseButton>
      </template>
    </BaseModal>
  </div>
</template>

<style scoped>
/*
  CRITICAL: All classes MUST have the 'db-' prefix (DoodleBUGS).
  This acts as a namespace to prevent collision with host application CSS
  when running as a widget.
*/

.db-project-manager {
  display: flex;
  flex-direction: column;
  height: 100%;
  background-color: transparent;
}

.db-panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 10px;
  border-bottom: 1px solid var(--theme-border);
  flex-shrink: 0;
}

.db-panel-header h4 {
  margin: 0;
  color: var(--theme-text-primary);
  font-size: 0.95em;
  font-weight: 600;
}

.db-header-actions {
  display: flex;
  align-items: center;
  gap: 4px;
}

.db-action-icon-btn {
  padding: 2px 6px !important;
}

.db-empty-state {
  flex-grow: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 20px;
  color: var(--theme-text-secondary);
}

.db-empty-state p {
  margin: 0 0 10px 0;
  font-size: 0.9em;
}

.db-empty-state-inner {
  color: var(--theme-text-secondary);
  text-align: center;
  padding: 8px;
  font-size: 0.8em;
}

.db-empty-state-inner p {
  margin: 0 0 6px 0;
}

.db-project-list {
  flex-grow: 1;
  overflow-y: auto;
  padding: 4px;
}

.db-project-item {
  margin-bottom: 2px;
}

.db-project-header {
  display: flex;
  align-items: center;
  padding: 6px 8px;
  cursor: pointer;
  transition: background-color 0.2s ease;
  gap: 6px;
  border-radius: 4px;
  position: relative;
  color: var(--theme-text-primary);
}

.db-project-header:hover {
  background-color: var(--theme-bg-hover);
}

.db-project-header.db-active {
  background-color: var(--theme-primary);
}

.db-project-header.db-active .db-project-name,
.db-project-header.db-active .db-icon-folder,
.db-project-header.db-active .db-icon-chevron {
  color: var(--theme-text-inverse);
}

.db-icon-chevron {
  font-size: 0.6em;
  color: var(--theme-text-secondary);
  transition: transform 0.2s ease-in-out;
  width: 10px;
  text-align: center;
}

.db-icon-chevron.db-open {
  transform: rotate(90deg);
}

.db-icon-folder {
  color: var(--theme-primary);
  font-size: 0.8em;
}

.db-project-header.db-active .db-icon-folder {
  color: var(--theme-text-inverse);
}

.db-project-name {
  flex-grow: 1;
  font-weight: 500;
  color: var(--theme-text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-size: 0.85em;
}

.db-project-actions {
  display: flex;
  align-items: center;
  margin-left: auto;
}

.db-context-trigger-btn {
  padding: 2px 4px;
  font-size: 0.85em;
  background-color: transparent;
  color: var(--theme-text-secondary);
  border: none;
  border-radius: 3px;
  opacity: 0;
  transition:
    opacity 0.2s ease,
    color 0.2s ease,
    background-color 0.2s ease;
  line-height: 1;
  cursor: pointer;
}

.db-project-header:hover .db-context-trigger-btn,
.db-graph-item:hover .db-context-trigger-btn,
.db-project-header.db-active .db-context-trigger-btn {
  opacity: 1;
}

.db-project-header.db-active .db-context-trigger-btn {
  color: var(--theme-text-inverse);
}

.db-context-trigger-btn:hover {
  background-color: var(--theme-border);
  color: var(--theme-text-primary);
}

.db-project-header.db-active .db-context-trigger-btn:hover {
  background-color: rgba(255, 255, 255, 0.2);
  color: white;
}

.db-graph-list {
  padding-left: 12px;
  overflow: hidden;
  border-left: 1px solid var(--theme-border);
  margin-left: 10px;
  padding-top: 2px;
  padding-bottom: 2px;
}

.slide-fade-enter-active,
.slide-fade-leave-active {
  transition: all 0.2s ease-out;
  max-height: 500px;
}
.slide-fade-enter-from,
.slide-fade-leave-to {
  max-height: 0;
  opacity: 0;
  transform: translateY(-10px);
}

.db-graph-item {
  display: flex;
  align-items: center;
  padding: 4px 8px;
  margin-top: 1px;
  cursor: pointer;
  transition:
    background-color 0.2s ease,
    color 0.2s ease;
  gap: 6px;
  border-radius: 4px;
  position: relative;
  color: var(--theme-text-primary);
}

.db-graph-item:hover {
  background-color: var(--theme-bg-hover);
}

.db-graph-item.db-active {
  background-color: var(--theme-primary);
}

.db-graph-item.db-active span,
.db-graph-item.db-active .db-icon-file {
  color: var(--theme-text-inverse);
}

.db-graph-item span {
  flex-grow: 1;
  font-size: 0.85em;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: var(--theme-text-primary);
}

.db-icon-file {
  font-size: 0.75em;
  color: var(--theme-text-secondary);
}

.db-graph-item.db-active .db-context-trigger-btn {
  color: var(--theme-text-inverse);
}

.db-graph-item.db-active .db-context-trigger-btn:hover {
  background-color: rgba(255, 255, 255, 0.2);
  color: white;
}

.db-graph-item .db-context-trigger-btn {
  margin-left: auto;
}

.db-context-menu {
  position: fixed;
  background-color: var(--theme-bg-panel);
  border: 1px solid var(--theme-border);
  box-shadow: var(--shadow-md);
  border-radius: 6px;
  padding: 4px 0;
  z-index: 100000; /* Increased z-index to appear above sidebars */
  min-width: 160px;
}

.db-context-menu-item {
  padding: 6px 12px;
  cursor: pointer;
  font-size: 0.85em;
  display: flex;
  align-items: center;
  gap: 8px;
  color: var(--theme-text-primary);
  transition:
    background-color 0.2s ease,
    color 0.2s ease;
}

.db-context-menu-item:hover {
  background-color: var(--theme-primary);
  color: var(--theme-text-inverse);
}

.db-context-menu-item.db-danger:hover {
  background-color: var(--theme-danger);
  color: white;
}

.db-context-menu-item .fas {
  width: 14px;
  text-align: center;
}

.db-rename-body,
.db-confirm-body {
  padding: 10px 0;
}
</style>



================================================
FILE: src/components/panels/CodePreviewPanel.vue
================================================
<script setup lang="ts">
import { ref, watch, onMounted, onUnmounted, nextTick, computed } from 'vue'
import { useGraphStore } from '../../stores/graphStore'
import { useBugsCodeGenerator } from '../../composables/useBugsCodeGenerator'

import 'codemirror/lib/codemirror.css'
import 'codemirror/theme/material-darker.css'
import 'codemirror/mode/julia/julia.js'
import 'codemirror/addon/scroll/simplescrollbars.css'
import 'codemirror/addon/scroll/simplescrollbars.js'
import 'codemirror/addon/fold/foldgutter.css'
import 'codemirror/addon/fold/foldgutter.js'
import 'codemirror/addon/fold/brace-fold.js'

import CodeMirror from 'codemirror'
import type { Editor } from 'codemirror'

const props = defineProps<{
  isActive: boolean
  graphId?: string
}>()

const graphStore = useGraphStore()

const targetElements = computed(() => {
  if (props.graphId) {
    return graphStore.graphContents.get(props.graphId)?.elements || []
  }
  return graphStore.currentGraphElements
})

const { generatedCode } = useBugsCodeGenerator(targetElements)

const copySuccess = ref(false)
const editorContainer = ref<HTMLDivElement | null>(null)
let cmInstance: Editor | null = null

onMounted(() => {
  if (editorContainer.value) {
    cmInstance = CodeMirror(editorContainer.value, {
      value: generatedCode.value,
      mode: 'julia',
      theme: 'material-darker',
      lineNumbers: true,
      readOnly: true,
      tabSize: 2,
      scrollbarStyle: 'simple',
      foldGutter: true,
      gutters: ['CodeMirror-linenumbers', 'CodeMirror-foldgutter'],
    })

    if (props.isActive) {
      nextTick(() => cmInstance?.refresh())
    }
  }
})

onUnmounted(() => {
  if (cmInstance) {
    const editorElement = cmInstance.getWrapperElement()
    editorElement.parentNode?.removeChild(editorElement)
    cmInstance = null
  }
})

watch(generatedCode, (newCode) => {
  if (cmInstance && cmInstance.getValue() !== newCode) {
    cmInstance.setValue(newCode)
  }
})

watch(
  () => props.isActive,
  (newVal) => {
    if (newVal && cmInstance) {
      nextTick(() => {
        cmInstance?.refresh()
      })
    }
  }
)

const copyCodeToClipboard = async () => {
  const text = generatedCode.value
  try {
    await navigator.clipboard.writeText(text)
    triggerSuccess()
  } catch {
    const textArea = document.createElement('textarea')
    textArea.value = text
    textArea.style.position = 'fixed'
    textArea.style.opacity = '0'
    document.body.appendChild(textArea)
    textArea.focus()
    textArea.select()
    try {
      const successful = document.execCommand('copy')
      if (successful) {
        triggerSuccess()
      } else {
        console.error('Fallback copy failed.')
        alert('Failed to copy code to clipboard.')
      }
    } catch (e) {
      console.error('Copy failed', e)
      alert('Failed to copy code to clipboard.')
    } finally {
      document.body.removeChild(textArea)
    }
  }
}

const triggerSuccess = () => {
  copySuccess.value = true
  setTimeout(() => {
    copySuccess.value = false
  }, 2000)
}
</script>

<template>
  <div class="db-code-preview-panel">
    <div class="db-cp-wrapper">
      <div ref="editorContainer" class="db-cp-container"></div>
      <button
        @click.stop="copyCodeToClipboard"
        class="db-cp-copy-btn"
        type="button"
        title="Copy Code"
      >
        <i v-if="copySuccess" class="fas fa-check"></i>
        <i v-else class="fas fa-copy"></i>
      </button>
    </div>
  </div>
</template>

<style scoped>
.db-code-preview-panel {
  padding: 0; /* Removed padding */
  height: 100%;
  display: flex;
  flex-direction: column;
  box-sizing: border-box;
}

.db-cp-wrapper {
  position: relative;
  flex-grow: 1;
  background-color: #282c34;
  overflow: hidden;
  height: 100%;
}

.db-cp-container {
  width: 100%;
  height: 100%;
}

.db-cp-copy-btn {
  position: absolute;
  bottom: 10px;
  right: 10px;
  width: 36px;
  height: 36px;
  background-color: rgba(255, 255, 255, 0.1);
  color: #fff;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  cursor: pointer;
  opacity: 0.7;
  transition:
    background-color 0.2s,
    opacity 0.2s;
  z-index: 1000;
  pointer-events: auto;
  border: 1px solid rgba(255, 255, 255, 0.2);
  outline: none;
}

.db-cp-copy-btn:hover {
  background-color: rgba(255, 255, 255, 0.2);
  opacity: 1;
}

.db-cp-copy-btn:active {
  transform: scale(0.95);
}

.db-cp-copy-btn .fa-copy,
.db-cp-copy-btn .fa-check {
  font-size: 1rem;
}

/* Scrollbar hiding logic */
:deep(.CodeMirror) {
  height: 100%;
}

:deep(.CodeMirror-scroll) {
  scrollbar-width: none; /* Firefox */
  -ms-overflow-style: none; /* IE/Edge */
}

:deep(.CodeMirror-scroll::-webkit-scrollbar) {
  display: none; /* Chrome/Safari/Webkit */
}

/* Hide CodeMirror specific simple scrollbars */
:deep(.CodeMirror-simplescroll-horizontal),
:deep(.CodeMirror-simplescroll-vertical) {
  display: none !important;
}
</style>



================================================
FILE: src/components/panels/DataInputPanel.vue
================================================
<script setup lang="ts">
import { ref, onMounted, onUnmounted, watch, nextTick } from 'vue'
import { useDataStore } from '../../stores/dataStore'
import 'codemirror/lib/codemirror.css'
import 'codemirror/theme/material-darker.css'
import 'codemirror/mode/javascript/javascript.js'
import 'codemirror/addon/scroll/simplescrollbars.css'
import 'codemirror/addon/scroll/simplescrollbars.js'
import 'codemirror/addon/fold/foldgutter.css'
import 'codemirror/addon/fold/foldgutter.js'
import 'codemirror/addon/fold/brace-fold.js'
import 'codemirror/addon/edit/matchbrackets.js'
import CodeMirror from 'codemirror'
import type { Editor } from 'codemirror'

const props = defineProps<{
  isActive: boolean
}>()

const dataStore = useDataStore()
const editorContainer = ref<HTMLDivElement | null>(null)

let cm: Editor | null = null
let isUpdatingFromSource = false
let resizeObserver: ResizeObserver | null = null

const jsonError = ref<string | null>(null)

const validateJson = (jsonString: string) => {
  try {
    JSON.parse(jsonString)
    jsonError.value = null
  } catch (e: unknown) {
    jsonError.value = e instanceof Error ? e.message : String(e)
  }
}

const setupCodeMirror = () => {
  if (cm) {
    const wrapper = cm.getWrapperElement()
    wrapper.parentNode?.removeChild(wrapper)
    cm = null
  }

  nextTick(() => {
    if (editorContainer.value) {
      cm = CodeMirror(editorContainer.value, {
        value: dataStore.dataContent,
        mode: { name: 'javascript', json: true },
        theme: 'material-darker',
        lineNumbers: true,
        tabSize: 2,
        scrollbarStyle: 'simple',
        lineWrapping: false,
        foldGutter: true,
        gutters: ['CodeMirror-linenumbers', 'CodeMirror-foldgutter'],
        matchBrackets: true,
      })

      cm.on('change', (instance) => {
        if (isUpdatingFromSource) return
        const val = instance.getValue()
        dataStore.dataContent = val
        validateJson(val)
      })
    }
  })
}

onMounted(() => {
  setupCodeMirror()

  if (editorContainer.value) {
    resizeObserver = new ResizeObserver(() => {
      if (cm) cm.refresh()
    })
    resizeObserver.observe(editorContainer.value)
  }
})

onUnmounted(() => {
  if (cm) {
    const wrapper = cm.getWrapperElement()
    wrapper.parentNode?.removeChild(wrapper)
  }
  if (resizeObserver) {
    resizeObserver.disconnect()
  }
})

watch(
  () => dataStore.dataContent,
  (newValue) => {
    if (!cm) return
    if (cm.getValue() !== newValue) {
      isUpdatingFromSource = true
      cm.setValue(newValue)
      validateJson(newValue)
      isUpdatingFromSource = false
    }
  }
)

watch(
  () => props.isActive,
  (newVal) => {
    if (newVal) {
      nextTick(() => {
        cm?.refresh()
      })
    }
  }
)
</script>

<template>
  <div class="db-data-input-panel">
    <!-- Status Header -->
    <div v-if="jsonError" class="db-di-status-header db-error">
      <div class="db-status-row">
        <i class="fas fa-times-circle"></i>
        <span class="db-status-label">Invalid JSON</span>
      </div>
      <div class="db-error-msg">{{ jsonError }}</div>
    </div>
    <div v-else class="db-di-status-header db-success">
      <i class="fas fa-check-circle"></i>
      <span class="db-status-label">Valid JSON</span>
    </div>

    <!-- Editor Wrapper -->
    <div class="db-di-wrapper flex-grow">
      <div ref="editorContainer" class="db-di-container"></div>
    </div>
  </div>
</template>

<style scoped>
.db-data-input-panel {
  height: 100%;
  display: flex;
  flex-direction: column;
  padding: 0;
  background-color: #282c34;
}

.db-di-status-header {
  flex-shrink: 0;
  padding: 6px 10px;
  font-size: 0.85em;
  display: flex;
  flex-direction: column;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.db-di-status-header.db-success {
  background-color: transparent;
  color: var(--color-success);
  flex-direction: row;
  align-items: center;
  gap: 6px;
  padding: 8px 10px;
}

.db-di-status-header.db-error {
  background-color: rgba(239, 68, 68, 0.2);
  color: #fca5a5;
  border-bottom: 1px solid rgba(239, 68, 68, 0.4);
}

.db-status-row {
  display: flex;
  align-items: center;
  gap: 6px;
  font-weight: 600;
}

.db-status-label {
  font-weight: 600;
}

.db-error-msg {
  margin-top: 4px;
  padding-left: 20px; /* Indent to align under icon roughly */
  font-family: monospace;
  font-size: 0.9em;
  white-space: pre-wrap;
  word-break: break-all;
  color: #fff;
  opacity: 0.9;
}

.db-di-wrapper {
  flex: 1;
  position: relative;
  min-height: 0;
}

.db-di-container {
  flex-grow: 1;
  position: relative;
  overflow: hidden;
  height: 100%;
}

/* Scrollbar hiding logic */
:deep(.CodeMirror) {
  height: 100%;
  font-family: monospace;
  font-size: 0.85em;
}

:deep(.CodeMirror-scroll) {
  scrollbar-width: none; /* Firefox */
  -ms-overflow-style: none; /* IE/Edge */
}

:deep(.CodeMirror-scroll::-webkit-scrollbar) {
  display: none; /* Chrome/Safari/Webkit */
}

/* Hide CodeMirror specific simple scrollbars */
:deep(.CodeMirror-simplescroll-horizontal),
:deep(.CodeMirror-simplescroll-vertical) {
  display: none !important;
}
</style>



================================================
FILE: src/components/panels/ScriptSettingsPanel.vue
================================================
<script setup lang="ts">
import { storeToRefs } from 'pinia'
import { useScriptStore } from '../../stores/scriptStore'
import BaseInput from '../ui/BaseInput.vue'

const scriptStore = useScriptStore()
const { samplerSettings } = storeToRefs(scriptStore)
</script>

<template>
  <div class="db-settings-panel">
    <div class="db-settings-section">
      <h4>Sampler Settings</h4>
      <div class="db-form-group">
        <label for="n_samples">Samples</label>
        <BaseInput id="n_samples" type="number" v-model.number="samplerSettings.n_samples" />
      </div>
      <div class="db-form-group">
        <label for="n_adapts">Adaptation Steps</label>
        <BaseInput id="n_adapts" type="number" v-model.number="samplerSettings.n_adapts" />
      </div>
      <div class="db-form-group">
        <label for="n_chains">Chains</label>
        <BaseInput id="n_chains" type="number" v-model.number="samplerSettings.n_chains" />
      </div>
      <div class="db-form-group">
        <label for="seed">Seed (optional)</label>
        <BaseInput
          id="seed"
          type="number"
          v-model.number="samplerSettings.seed"
          placeholder="Leave blank for random"
        />
      </div>
    </div>
  </div>
</template>

<style scoped>
.db-settings-panel {
  display: flex;
  flex-direction: column;
  gap: 20px;
}
.db-settings-section {
  display: flex;
  flex-direction: column;
  gap: 15px;
  border: 1px solid var(--color-border-light);
  padding: 15px;
  border-radius: 8px;
}
h4 {
  margin: 0;
  padding-bottom: 10px;
  border-bottom: 1px solid var(--color-border-light);
  color: var(--color-heading);
  font-weight: 600;
}
.db-form-group {
  display: flex;
  flex-direction: column;
  gap: 5px;
}
.db-form-group label {
  font-size: 0.9em;
  font-weight: 500;
}
</style>



================================================
FILE: src/components/right-sidebar/JsonEditorPanel.vue
================================================
<script setup lang="ts">
import { ref, watch, computed, onMounted, onUnmounted, nextTick } from 'vue'
import { useGraphStore } from '../../stores/graphStore'
import { useGraphElements } from '../../composables/useGraphElements'
import type { GraphElement } from '../../types'
import 'codemirror/lib/codemirror.css'
import 'codemirror/theme/material-darker.css'
import 'codemirror/mode/javascript/javascript.js'
import 'codemirror/addon/scroll/simplescrollbars.css'
import 'codemirror/addon/scroll/simplescrollbars.js'
import 'codemirror/addon/search/searchcursor.js'
import 'codemirror/addon/fold/foldgutter.css'
import 'codemirror/addon/fold/foldgutter.js'
import 'codemirror/addon/fold/brace-fold.js'
import 'codemirror/addon/edit/matchbrackets.js'

import CodeMirror from 'codemirror'
import type { Editor, TextMarker } from 'codemirror'

declare module 'codemirror' {
  interface Editor {
    getSearchCursor(
      query: string,
      pos?: CodeMirror.Position | null,
      caseFold?: boolean
    ): {
      findNext: () => boolean
      findPrevious: () => boolean
      from: () => CodeMirror.Position
      to: () => CodeMirror.Position
    }
    findMatchingBracket(
      pos: CodeMirror.Position,
      strict?: boolean
    ): { to: CodeMirror.Position | null } | null
  }
}

const props = defineProps<{
  isActive: boolean
}>()

const graphStore = useGraphStore()
const { selectedElement } = useGraphElements()

const errorText = ref('')
const editorContainer = ref<HTMLDivElement | null>(null)
let cmInstance: Editor | null = null
let isUpdatingFromSource = false
let existingMarks: Set<TextMarker> = new Set()

const graphElements = computed(() => graphStore.currentGraphElements)
const protectedFields = ['id', 'type', 'nodeType', 'source', 'target', 'parent']

const markProtectedFields = () => {
  if (!cmInstance) return

  const text = cmInstance.getValue()
  const lines = text.split('\n')
  const newMarks: Set<TextMarker> = new Set()

  lines.forEach((line: string, index: number) => {
    const trimmedLine = line.trim()
    const keyMatch = trimmedLine.match(/"([^"]+)"\s*:/)
    if (keyMatch && protectedFields.includes(keyMatch[1])) {
      const mark = cmInstance?.markText(
        { line: index, ch: 0 },
        { line: index, ch: line.length },
        { readOnly: true, className: 'cm-protected' }
      )
      if (mark) newMarks.add(mark)
    }
  })

  existingMarks.forEach((mark) => {
    if (!newMarks.has(mark)) {
      mark.clear()
    }
  })

  existingMarks = newMarks
}

onMounted(() => {
  if (editorContainer.value) {
    cmInstance = CodeMirror(editorContainer.value, {
      value: '[]',
      mode: { name: 'javascript', json: true },
      theme: 'material-darker',
      lineNumbers: true,
      tabSize: 2,
      scrollbarStyle: 'simple',
      lineWrapping: false,
      foldGutter: true,
      gutters: ['CodeMirror-linenumbers', 'CodeMirror-foldgutter'],
      matchBrackets: true,
    })
    cmInstance.on('change', (instance: Editor) => {
      if (isUpdatingFromSource) return
      handleJsonInput(instance.getValue())
    })
    const initialJson = JSON.stringify(graphElements.value, null, 2)
    isUpdatingFromSource = true
    cmInstance.setValue(initialJson)
    markProtectedFields()
    isUpdatingFromSource = false

    if (props.isActive) {
      nextTick(() => cmInstance?.refresh())
    }
  }
})

onUnmounted(() => {
  if (cmInstance) {
    const editorElement = cmInstance.getWrapperElement()
    editorElement.parentNode?.removeChild(editorElement)
    cmInstance = null
  }
})

watch(
  graphElements,
  (newElements) => {
    if (!cmInstance) return
    const currentEditorValue = cmInstance.getValue()
    const newJsonString = JSON.stringify(newElements, null, 2)
    try {
      if (
        JSON.stringify(JSON.parse(currentEditorValue)) === JSON.stringify(JSON.parse(newJsonString))
      ) {
        return
      }
    } catch {
      if (currentEditorValue === newJsonString) {
        return
      }
    }
    isUpdatingFromSource = true
    cmInstance.setValue(newJsonString)
    markProtectedFields()
    isUpdatingFromSource = false
  },
  { deep: true }
)

watch(
  () => props.isActive,
  (newVal) => {
    if (newVal && cmInstance) {
      nextTick(() => {
        cmInstance?.refresh()
      })
    }
  }
)

watch(selectedElement, async (newSelection) => {
  if (!newSelection || !cmInstance) return
  await nextTick()
  if (!cmInstance) return

  const searchText = `"id": "${newSelection.id}"`
  const idCursor = cmInstance.getSearchCursor(searchText)

  if (idCursor.findNext()) {
    const idPosition = idCursor.from()
    const objectStartCursor = cmInstance.getSearchCursor('{', idPosition)

    if (objectStartCursor.findPrevious()) {
      const fromPos = objectStartCursor.from()
      const foldRange = cmInstance.findMatchingBracket(fromPos, false)

      if (foldRange?.to) {
        const toPos = { line: foldRange.to.line, ch: foldRange.to.ch + 1 }

        cmInstance.focus()
        cmInstance.setSelection(fromPos, toPos)
        cmInstance.scrollIntoView({ from: fromPos, to: toPos }, 50)
      }
    }
  }
})

const handleJsonInput = (value: string) => {
  try {
    const newElements: GraphElement[] = JSON.parse(value)
    if (!Array.isArray(newElements)) {
      throw new Error('Invalid format: The root element must be an array of graph objects.')
    }
    if (graphStore.currentGraphId) {
      graphStore.updateGraphElements(graphStore.currentGraphId, newElements)
    }
    errorText.value = ''
  } catch (e: unknown) {
    errorText.value = (e as Error).message
  }
}
</script>

<template>
  <div class="db-json-editor-panel">
    <div class="db-header-section">
      <h4>Live Graph JSON</h4>
      <p class="db-description">
        Edit the JSON below to see live updates on the canvas. Read-only fields are protected.
      </p>
    </div>
    <div class="db-editor-wrapper">
      <div ref="editorContainer" class="db-json-editor-container"></div>
    </div>
    <div class="db-footer-section">
      <div v-if="errorText" class="db-error-message">
        {{ errorText }}
      </div>
      <span v-else class="db-status-text">
        <i class="fas fa-check-circle"></i> Live Sync Enabled
      </span>
    </div>
  </div>
</template>

<style>
.CodeMirror {
  height: 100%;
  font-family: monospace;
  font-size: 0.85em;
  border-radius: 8px;
}
.cm-protected {
  background-color: rgba(255, 255, 255, 0.1);
  cursor: not-allowed;
  opacity: 0.7;
}

.CodeMirror-simplescroll-horizontal div,
.CodeMirror-simplescroll-vertical div {
  background: #666;
  border-radius: 3px;
}
.CodeMirror-simplescroll-horizontal,
.CodeMirror-simplescroll-vertical {
  background: transparent;
  z-index: 99;
}
.CodeMirror-foldgutter-open,
.CodeMirror-foldgutter-folded {
  color: #999;
}
</style>

<style scoped>
.db-json-editor-panel {
  padding: 15px;
  display: flex;
  flex-direction: column;
  height: 100%;
  box-sizing: border-box;
}

.db-header-section {
  padding-bottom: 10px;
  flex-shrink: 0;
}

h4 {
  margin: 0 0 10px 0;
  color: var(--color-heading);
  text-align: center;
  border-bottom: 1px solid var(--color-border-light);
  padding-bottom: 10px;
}

.db-description {
  font-size: 0.85em;
  color: var(--color-secondary);
  text-align: center;
  margin: 0;
  line-height: 1.4;
}

.db-editor-wrapper {
  flex-grow: 1;
  border: 1px solid var(--color-border);
  border-radius: 8px;
  display: flex;
  position: relative;
  min-height: 0;
}

.db-json-editor-container {
  flex-grow: 1;
  position: relative;
  overflow-x: auto;
}

.db-footer-section {
  flex-shrink: 0;
  padding-top: 10px;
  min-height: 40px;
  height: auto;
  box-sizing: border-box;
  display: flex;
  align-items: center;
}

.db-status-text {
  font-size: 0.8em;
  color: var(--color-success);
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 5px;
}

.db-error-message {
  color: var(--color-danger);
  background-color: #ffe0e0;
  border: 1px solid var(--color-danger);
  border-radius: 4px;
  padding: 5px 10px;
  font-size: 0.8em;
  white-space: normal;
  word-break: break-word;
  width: 100%;
}
</style>



================================================
FILE: src/components/right-sidebar/LocalScriptPanel.vue
================================================
<script setup lang="ts">
import { ref, onMounted, onUnmounted, watch, nextTick } from 'vue'
import { useScriptStore } from '../../stores/scriptStore'
import { storeToRefs } from 'pinia'
import 'codemirror/lib/codemirror.css'
import 'codemirror/theme/material-darker.css'
import 'codemirror/mode/julia/julia.js'
import 'codemirror/addon/scroll/simplescrollbars.css'
import 'codemirror/addon/scroll/simplescrollbars.js'
import CodeMirror from 'codemirror'
import type { Editor } from 'codemirror'
import BaseButton from '../ui/BaseButton.vue'

const props = defineProps<{
  isActive: boolean
}>()

defineEmits<{
  (e: 'open-settings'): void
  (e: 'download'): void
  (e: 'generate'): void
}>()

const scriptStore = useScriptStore()
const { standaloneScript } = storeToRefs(scriptStore)

const editorContainer = ref<HTMLDivElement | null>(null)
let cmInstance: Editor | null = null
const copySuccess = ref(false)

onMounted(() => {
  if (editorContainer.value && standaloneScript.value) {
    initEditor()
  }
})

const initEditor = () => {
  if (!editorContainer.value) return
  if (cmInstance) {
    cmInstance.setValue(standaloneScript.value)
    return
  }
  cmInstance = CodeMirror(editorContainer.value, {
    value: standaloneScript.value,
    mode: 'julia',
    theme: 'material-darker',
    lineNumbers: true,
    readOnly: true,
    tabSize: 2,
    scrollbarStyle: 'simple',
    lineWrapping: false,
  })
}

onUnmounted(() => {
  if (cmInstance) {
    const wrapper = cmInstance.getWrapperElement()
    wrapper.parentNode?.removeChild(wrapper)
    cmInstance = null
  }
})

watch(standaloneScript, (newValue) => {
  if (newValue) {
    nextTick(() => {
      if (!cmInstance && editorContainer.value) {
        initEditor()
      }
      if (cmInstance && cmInstance.getValue() !== newValue) {
        cmInstance.setValue(newValue)
      }
    })
  }
})

watch(
  () => props.isActive,
  (newVal) => {
    if (newVal && cmInstance) {
      nextTick(() => cmInstance?.refresh())
    }
  }
)

const copyScript = async () => {
  try {
    await navigator.clipboard.writeText(standaloneScript.value)
    copySuccess.value = true
    setTimeout(() => (copySuccess.value = false), 2000)
  } catch {
    const textArea = document.createElement('textarea')
    textArea.value = standaloneScript.value
    textArea.style.position = 'fixed'
    textArea.style.opacity = '0'
    document.body.appendChild(textArea)
    textArea.focus()
    textArea.select()
    try {
      document.execCommand('copy')
      copySuccess.value = true
      setTimeout(() => (copySuccess.value = false), 2000)
    } catch (e) {
      console.error(e)
      alert('Failed to copy script.')
    }
    document.body.removeChild(textArea)
  }
}
</script>

<template>
  <div class="db-local-script-panel">
    <div v-if="!standaloneScript" class="db-ls-empty-state">
      <p>No script generated yet.</p>
      <BaseButton type="primary" @click="$emit('generate')">Generate Julia Script</BaseButton>
    </div>
    <div v-else class="db-ls-panel-container">
      <div class="db-ls-panel-header">
        <span class="db-ls-title">Julia Script</span>
        <div class="db-ls-actions">
          <button
            @click="$emit('open-settings')"
            title="Script Configuration"
            class="db-ls-action-btn"
          >
            <i class="fas fa-cog"></i>
          </button>
          <button @click="$emit('download')" title="Download" class="db-ls-action-btn">
            <i class="fas fa-download"></i>
          </button>
        </div>
      </div>
      <div class="db-ls-editor-wrapper">
        <div ref="editorContainer" class="db-ls-editor-container"></div>
        <button @click.stop="copyScript" class="db-ls-copy-btn" type="button" title="Copy Script">
          <i v-if="copySuccess" class="fas fa-check"></i>
          <i v-else class="fas fa-copy"></i>
        </button>
      </div>
    </div>
  </div>
</template>

<style scoped>
.db-local-script-panel {
  height: 100%;
  display: flex;
  flex-direction: column;
  padding: 0;
  box-sizing: border-box;
}

.db-ls-empty-state {
  flex-grow: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 15px;
  color: var(--color-text-secondary);
  font-style: italic;
  padding: 20px;
  text-align: center;
}

.db-ls-panel-container {
  display: flex;
  flex-direction: column;
  height: 100%;
  padding: 10px;
  gap: 10px;
}

.db-ls-panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--color-border);
}

.db-ls-title {
  font-weight: 600;
  color: var(--color-heading);
  font-size: 0.9em;
}

.db-ls-actions {
  display: flex;
  gap: 8px;
}

.db-ls-action-btn {
  background: transparent;
  border: none;
  cursor: pointer;
  color: var(--theme-text-secondary);
  font-size: 14px;
  padding: 4px;
  transition: color 0.2s;
}

.db-ls-action-btn:hover {
  color: var(--theme-text-primary);
}

.db-ls-editor-wrapper {
  flex-grow: 1;
  background-color: #282c34;
  border-radius: 4px;
  position: relative;
  overflow: hidden;
  min-height: 0;
}

.db-ls-editor-container {
  height: 100%;
}

:deep(.CodeMirror) {
  height: 100%;
  font-family: monospace;
  font-size: 0.85em;
}

.db-ls-copy-btn {
  position: absolute;
  bottom: 5px;
  right: 5px;
  width: 36px;
  height: 36px;
  background-color: transparent;
  color: #fff;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  cursor: pointer;
  opacity: 0.5;
  transition:
    background-color 0.2s,
    opacity 0.2s;
  z-index: 1000;
  pointer-events: auto;
  border: none;
  outline: none;
}

.db-ls-copy-btn:hover {
  background-color: transparent;
  opacity: 1;
}

.db-ls-copy-btn:active {
  transform: scale(0.95);
}

.db-ls-copy-btn .fa-copy,
.db-ls-copy-btn .fa-check {
  font-size: 1rem;
}
</style>



================================================
FILE: src/components/right-sidebar/NodePropertiesPanel.vue
================================================
<script setup lang="ts">
import { computed, ref, watch } from 'vue'
import type { GraphElement, GraphNode, GraphEdge, ValidationError } from '../../types'
import BaseInput from '../ui/BaseInput.vue'
import BaseSelect from '../ui/BaseSelect.vue'
import BaseButton from '../ui/BaseButton.vue'
import BaseModal from '../common/BaseModal.vue'
import {
  getNodeDefinition,
  getDistributionByName,
  type NodeDefinition,
} from '../../config/nodeDefinitions'

const props = defineProps<{
  selectedElement: GraphElement | null
  validationErrors: Map<string, ValidationError[]>
}>()

const emit = defineEmits<{
  (e: 'update-element', element: GraphElement): void
  (e: 'delete-element', elementId: string): void
}>()

const localElement = ref<GraphElement | null>(null)
const showDeleteConfirmModal = ref(false)

const currentDefinition = computed<NodeDefinition | undefined>(() => {
  if (localElement.value?.type === 'node') {
    return getNodeDefinition((localElement.value as GraphNode).nodeType)
  }
  return undefined
})

const currentDistribution = computed(() => {
  if (localElement.value?.type === 'node') {
    const node = localElement.value as GraphNode
    return getDistributionByName(node.distribution || '')
  }
  return undefined
})

const selectedDistributionOption = computed(() => {
  if (localElement.value?.type === 'node') {
    const node = localElement.value as GraphNode
    if (node.distribution) {
      const definition = getNodeDefinition(node.nodeType)
      const distProp = definition?.properties.find((p) => p.key === 'distribution')
      return distProp?.options?.find((opt) => opt.value === node.distribution)
    }
  }
  return undefined
})

const elementErrors = computed(() => {
  if (props.selectedElement) {
    return props.validationErrors.get(props.selectedElement.id) || []
  }
  return []
})

watch(
  () => props.selectedElement,
  (newVal) => {
    localElement.value = newVal ? JSON.parse(JSON.stringify(newVal)) : null
  },
  { deep: true, immediate: true }
)

const isNode = computed(() => localElement.value?.type === 'node')
const isEdge = computed(() => localElement.value?.type === 'edge')

const handleUpdate = () => {
  if (localElement.value) {
    emit('update-element', localElement.value)
  }
}

const confirmDelete = () => {
  if (localElement.value) {
    showDeleteConfirmModal.value = true
  }
}

const executeDelete = () => {
  if (localElement.value) {
    emit('delete-element', localElement.value.id)
    localElement.value = null
  }
  showDeleteConfirmModal.value = false
}

const cancelDelete = () => {
  showDeleteConfirmModal.value = false
}

const getErrorForField = (fieldKey: string): string | undefined => {
  if (localElement.value) {
    const errors = props.validationErrors.get(localElement.value.id)
    const error = errors?.find((err) => err.field === fieldKey)
    return error?.message
  }
  return undefined
}
</script>

<template>
  <div class="db-node-properties-panel">
    <h4>Properties</h4>
    <div v-if="!localElement" class="db-no-selection-message">
      <p>Select a node or edge on the canvas to view/edit its properties.</p>
    </div>
    <div v-else class="db-properties-form">
      <div v-if="elementErrors.length > 0" class="db-validation-errors-container">
        <h5 class="db-validation-title">
          <i class="fas fa-exclamation-triangle"></i> Validation Issues
        </h5>
        <ul>
          <li v-for="(error, index) in elementErrors" :key="index">
            {{ error.message }}
          </li>
        </ul>
      </div>

      <div class="db-form-group">
        <label for="element-id">ID:</label>
        <BaseInput id="element-id" :model-value="localElement.id" disabled />
      </div>

      <template v-if="isNode && currentDefinition">
        <div v-for="prop in currentDefinition.properties" :key="prop.key" class="db-form-group">
          <label :for="`prop-${prop.key}`">{{ prop.label }}:</label>
          <div class="db-input-wrapper">
            <BaseSelect
              v-if="prop.type === 'select'"
              :id="`prop-${prop.key}`"
              :model-value="String((localElement as GraphNode)[prop.key] || '')"
              :options="prop.options!"
              @update:model-value="
                (value) => {
                  ;(localElement as GraphNode)[prop.key] = value
                  handleUpdate()
                }
              "
              :class="{ 'db-has-error': getErrorForField(prop.key) }"
            />
            <input
              v-else-if="prop.type === 'checkbox'"
              type="checkbox"
              :id="`prop-${prop.key}`"
              v-model="(localElement as GraphNode)[prop.key]"
              @change="handleUpdate"
              class="db-form-checkbox"
            />
            <BaseInput
              v-else
              :id="`prop-${prop.key}`"
              :type="prop.type"
              :model-value="
                (localElement as GraphNode)[prop.key] !== undefined
                  ? String((localElement as GraphNode)[prop.key])
                  : ''
              "
              @update:model-value="
                (value) => {
                  // Convert value back to appropriate type based on prop.type
                  let convertedValue: string | number | null | undefined = value
                  if (prop.type === 'number' && value !== '') {
                    convertedValue = Number(value)
                  } else if (value === '') {
                    convertedValue = null
                  }
                  ;(localElement as GraphNode)[prop.key] = convertedValue
                  handleUpdate()
                }
              "
              :placeholder="prop.placeholder"
              :class="{ 'db-has-error': getErrorForField(prop.key) }"
            />
          </div>
          <small v-if="prop.helpText" class="db-help-text">{{ prop.helpText }}</small>
          <small
            v-if="prop.key === 'distribution' && selectedDistributionOption?.helpText"
            class="db-help-text db-distribution-help"
          >
            {{ selectedDistributionOption.helpText }}
          </small>
          <small v-if="getErrorForField(prop.key)" class="db-error-message">{{
            getErrorForField(prop.key)
          }}</small>
        </div>

        <template v-if="currentDistribution && currentDefinition.parameters">
          <div
            v-for="(paramName, index) in currentDistribution.paramNames"
            :key="paramName"
            class="db-form-group"
          >
            <label :for="`param-${index}`">{{ paramName }}:</label>
            <BaseInput
              :id="`param-${index}`"
              type="text"
              :model-value="
                (localElement as GraphNode)[`param${index + 1}`] !== undefined
                  ? String((localElement as GraphNode)[`param${index + 1}`])
                  : ''
              "
              @update:model-value="
                (value) => {
                  ;(localElement as GraphNode)[`param${index + 1}`] = value || null
                  handleUpdate()
                }
              "
              placeholder="Enter value or parent name"
              :class="{ 'db-has-error': getErrorForField(`param${index + 1}`) }"
            />
          </div>
        </template>
      </template>

      <template v-else-if="isEdge">
        <div class="db-form-group">
          <label for="edge-name">Name (Label):</label>
          <BaseInput
            id="edge-name"
            type="text"
            v-model="(localElement as GraphEdge).name"
            placeholder="Enter optional edge label"
            @input="handleUpdate"
          />
        </div>
      </template>

      <div class="db-action-buttons">
        <BaseButton @click="confirmDelete" type="danger" size="small">Delete Element</BaseButton>
      </div>
    </div>
    <BaseModal :is-open="showDeleteConfirmModal" @close="cancelDelete">
      <template #header>
        <h3>Confirm Deletion</h3>
      </template>
      <template #body>
        <p v-if="localElement">
          Are you sure you want to delete this {{ localElement.type }}?
          <strong v-if="'name' in localElement && localElement.name">{{
            localElement.name
          }}</strong>
          This action cannot be undone.
        </p>
      </template>
      <template #footer>
        <BaseButton @click="executeDelete" type="danger">Delete</BaseButton>
      </template>
    </BaseModal>
  </div>
</template>

<style scoped>
.db-node-properties-panel {
  padding: 10px;
  height: 100%;
  display: flex;
  flex-direction: column;
}

h4 {
  margin: 0 0 8px 0;
  color: var(--color-heading);
  text-align: center;
  border-bottom: 1px solid var(--color-border-light);
  padding-bottom: 8px;
  font-size: 0.95em;
}

.db-no-selection-message {
  text-align: center;
  padding: 20px;
  color: var(--color-secondary);
  font-style: italic;
  background-color: var(--color-background-mute);
  border-radius: 6px;
  margin-top: 15px;
  font-size: 0.9em;
}

.db-properties-form {
  display: flex;
  flex-direction: column;
  gap: 10px;
  padding-right: 2px;
}

.db-validation-errors-container {
  background-color: #fffbe6;
  border: 1px solid #ffe58f;
  border-radius: 4px;
  padding: 8px 10px;
  margin-bottom: 8px;
}

.db-validation-title {
  margin: 0 0 6px 0;
  font-size: 0.85em;
  font-weight: 600;
  color: #d46b08;
  display: flex;
  align-items: center;
  gap: 6px;
}

.db-validation-errors-container ul {
  margin: 0;
  padding-left: 18px;
  font-size: 0.8em;
  color: #d46b08;
}

.db-form-group {
  display: flex;
  flex-direction: column;
  gap: 3px;
}

.db-form-group label {
  font-weight: 500;
  color: var(--color-text);
  font-size: 0.85em;
  text-transform: capitalize;
}

.db-input-wrapper {
  position: relative;
  display: flex;
  align-items: center;
}

.db-input-wrapper .base-input,
.db-input-wrapper .base-select {
  flex-grow: 1;
}

.db-has-error {
  border-color: var(--color-danger) !important;
}

.db-has-error:focus {
  box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.25) !important;
}

.db-form-group .db-form-checkbox {
  width: 14px;
  height: 14px;
  align-self: flex-start;
}

.db-help-text {
  font-size: 0.75em;
  color: #888;
  margin-top: 1px;
  line-height: 1.3;
}

.db-distribution-help {
  background-color: var(--color-background-mute);
  padding: 4px 6px;
  border-radius: 3px;
}

.db-error-message {
  font-size: 0.75em;
  color: var(--color-danger);
  margin-top: 1px;
}

.db-action-buttons {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  margin-top: 15px;
  padding-top: 10px;
  border-top: 1px solid var(--color-border-light);
  flex-shrink: 0;
}
</style>



================================================
FILE: src/components/ui/BaseButton.vue
================================================
<script setup lang="ts">
import Button from 'primevue/button'
import { computed } from 'vue'

const props = defineProps<{
  type?: 'primary' | 'secondary' | 'danger' | 'ghost'
  size?: 'small' | 'medium' | 'large'
  disabled?: boolean
  icon?: string
}>()

const severity = computed(() => {
  switch (props.type) {
    case 'primary':
      return 'primary'
    case 'secondary':
      return 'secondary'
    case 'danger':
      return 'danger'
    case 'ghost':
      return 'secondary'
    default:
      return 'secondary'
  }
})

const variant = computed(() => {
  if (props.type === 'ghost') return 'text'
  return undefined
})

const primeSize = computed(() => {
  if (props.size === 'small') return 'small'
  if (props.size === 'large') return 'large'
  return undefined
})
</script>

<template>
  <Button
    :severity="severity"
    :variant="variant"
    :size="primeSize"
    :disabled="disabled"
    :icon="icon"
    class="db-btn-compact"
  >
    <slot></slot>
  </Button>
</template>

<style scoped>
.db-btn-compact {
  padding: 0.4rem 0.75rem;
}
:deep(.p-button.p-button-sm).db-btn-compact {
  padding: 0.25rem 0.5rem;
  font-size: 0.8rem;
}
</style>



================================================
FILE: src/components/ui/BaseInput.vue
================================================
<script setup lang="ts">
import InputText from 'primevue/inputtext'
import { computed } from 'vue'

const props = defineProps<{
  modelValue: string | number | null | undefined
  type?: string
  placeholder?: string
  disabled?: boolean
  readonly?: boolean
}>()

const emit = defineEmits(['update:modelValue', 'change', 'input', 'keyup.enter'])

const stringValue = computed(() => {
  if (props.modelValue === null || props.modelValue === undefined) return ''
  return String(props.modelValue)
})

const handleUpdate = (val: string | null | undefined) => {
  if (props.type === 'number' && val !== null && val !== undefined && val !== '') {
    const num = Number(val)
    emit('update:modelValue', isNaN(num) ? val : num)
  } else {
    emit('update:modelValue', val)
  }
}
</script>

<template>
  <InputText
    :type="type || 'text'"
    :model-value="stringValue"
    :placeholder="placeholder"
    :disabled="disabled"
    :readonly="readonly"
    @update:model-value="handleUpdate"
    @change="(e) => emit('change', e)"
    @input="(e) => emit('input', e)"
    @keyup.enter="(e) => emit('keyup.enter', e)"
    class="w-full db-input-field"
  />
</template>

<style scoped>
.db-input-field {
  font-size: 12px !important;
}
</style>



================================================
FILE: src/components/ui/BaseSelect.vue
================================================
<script setup lang="ts">
import Select from 'primevue/select'

// Relaxed interface to allow any object shape since we map with optionLabel/optionValue
export interface SelectOption {
  [key: string]: unknown
}

defineProps<{
  modelValue: string | number | null | undefined
  options: SelectOption[] | unknown[]
  disabled?: boolean
  placeholder?: string
  optionLabel?: string
  optionValue?: string
}>()

const emit = defineEmits(['update:modelValue', 'change'])
</script>

<template>
  <Select
    :model-value="modelValue"
    :options="options"
    :optionLabel="optionLabel || 'label'"
    :optionValue="optionValue || 'value'"
    :disabled="disabled"
    :placeholder="placeholder"
    @update:model-value="(val) => emit('update:modelValue', val)"
    @change="(e) => emit('change', e)"
    class="w-auto db-select-field"
  >
    <template #value="slotProps">
      <div v-if="slotProps.value" class="flex items-center">
        <slot name="value" :value="slotProps.value" :placeholder="slotProps.placeholder">
          {{
            // eslint-disable-next-line @typescript-eslint/ban-ts-comment
            // @ts-ignore - Dynamic access based on props
            options.find((o) => o[optionValue || 'value'] === slotProps.value)?.[
              optionLabel || 'label'
            ] || slotProps.value
          }}
        </slot>
      </div>
      <span v-else>
        {{ slotProps.placeholder || placeholder || 'Select...' }}
      </span>
    </template>

    <template #option="slotProps">
      <slot name="option" :option="slotProps.option">
        {{ slotProps.option[optionLabel || 'label'] }}
      </slot>
    </template>
  </Select>
</template>

<style scoped>
.db-select-field {
  font-size: 12px;
}
:deep(.p-select-label) {
  padding: 0.4rem 0.5rem;
}
</style>



================================================
FILE: src/composables/useBugsCodeGenerator.ts
================================================
import { computed } from 'vue'
import type { Ref } from 'vue'
import type { GraphElement, GraphNode, GraphEdge } from '../types'

/**
 * Composable that generates BUGS model code from graph elements.
 * @param elements - A ref to the graph elements.
 */
export function useBugsCodeGenerator(elements: Ref<GraphElement[]>) {
  const generatedCode = computed(() => {
    const nodes = elements.value.filter((el) => el.type === 'node') as GraphNode[]
    const edges = elements.value.filter((el) => el.type === 'edge') as GraphEdge[]
    const nodeMap = new Map(nodes.map((n) => [n.id, n]))
    const nameToNode = new Map(nodes.map((n) => [n.name, n]))

    if (nodes.length === 0) {
      return 'model {\n  # Your model will appear here...\n}'
    }

    // Topological Sort (Kahn's algorithm) to determine node definition order.
    const nodeInDegree: { [key: string]: number } = {}
    const adjacencyList: { [key: string]: string[] } = {}
    nodes.forEach((node) => {
      nodeInDegree[node.id] = 0
      adjacencyList[node.id] = []
    })
    edges.forEach((edge) => {
      if (adjacencyList[edge.source] && nodeInDegree[edge.target] !== undefined) {
        adjacencyList[edge.source].push(edge.target)
        nodeInDegree[edge.target]++
      }
    })
    const queue = nodes.filter((node) => nodeInDegree[node.id] === 0).map((n) => n.id)
    const sortedNodeIds: string[] = []
    while (queue.length > 0) {
      const currentNodeId = queue.shift()!
      sortedNodeIds.push(currentNodeId)
      adjacencyList[currentNodeId]?.forEach((childNodeId) => {
        if (nodeInDegree[childNodeId] !== undefined) {
          nodeInDegree[childNodeId]--
          if (nodeInDegree[childNodeId] === 0) {
            queue.push(childNodeId)
          }
        }
      })
    }

    interface TreeMember {
      id: string
      type: 'node' | 'plate'
      children: TreeMember[]
    }
    const treeRoot: TreeMember = { id: 'root', type: 'plate', children: [] }
    const treeMemberMap = new Map<string, TreeMember>([['root', treeRoot]])

    nodes.forEach((node) => {
      treeMemberMap.set(node.id, {
        id: node.id,
        type: node.nodeType === 'plate' ? 'plate' : 'node',
        children: [],
      })
    })

    nodes.forEach((node) => {
      const parentId = node.parent || 'root'
      const parentMember = treeMemberMap.get(parentId)
      const childMember = treeMemberMap.get(node.id)
      if (parentMember && childMember) {
        parentMember.children.push(childMember)
      }
    })

    const formatParam = (raw: string): string => {
      const p = String(raw).trim()
      if (!p) return p
      // If already indexed (e.g., foo[i,j]) leave as-is
      if (/\[[^\]]+\]\s*$/.test(p)) return p
      // If numeric literal or contains parentheses (function/expression), leave as-is
      if (/^[+-]?(?:\d+\.?\d*|\d*\.\d+)(?:[eE][+-]?\d+)?$/.test(p) || /[()]/.test(p)) return p
      const ref = nameToNode.get(p)
      if (ref && ref.indices && String(ref.indices).trim() !== '') {
        return `${p}[${ref.indices}]`
      }
      return p
    }

    const generateCodeRecursive = (member: TreeMember, indentLevel: number): string[] => {
      const lines: string[] = []
      const indent = '  '.repeat(indentLevel)

      const sortedChildren = member.children.sort((a, b) => {
        // Plates first
        if (a.type === 'plate' && b.type !== 'plate') return -1
        if (b.type === 'plate' && a.type !== 'plate') return 1
        // Among nodes: observed/stochastic before deterministic
        const na = a.type === 'node' ? nodeMap.get(a.id) : undefined
        const nb = b.type === 'node' ? nodeMap.get(b.id) : undefined
        const pa = na ? (na.nodeType === 'deterministic' ? 1 : 0) : 0
        const pb = nb ? (nb.nodeType === 'deterministic' ? 1 : 0) : 0
        if (pa !== pb) return pa - pb
        // Tiebreaker: topological order
        return sortedNodeIds.indexOf(a.id) - sortedNodeIds.indexOf(b.id)
      })

      sortedChildren.forEach((child) => {
        const childNode = nodeMap.get(child.id)
        if (!childNode) return

        if (child.type === 'plate') {
          lines.push(`${indent}for (${childNode.loopVariable} in ${childNode.loopRange}) {`)
          lines.push(...generateCodeRecursive(child, indentLevel + 1))
          lines.push(`${indent}}`)
        } else {
          const nodeName = childNode.indices
            ? `${childNode.name}[${childNode.indices}]`
            : childNode.name

          if (childNode.nodeType === 'stochastic' || childNode.nodeType === 'observed') {
            const params = Object.keys(childNode)
              .filter(
                (key) =>
                  key.startsWith('param') &&
                  childNode[key as keyof GraphNode] &&
                  String(childNode[key as keyof GraphNode]).trim() !== ''
              )
              .map((key) => formatParam(String(childNode[key as keyof GraphNode])))
              .join(', ')
            lines.push(`${indent}${nodeName} ~ ${childNode.distribution}(${params})`)
          } else if (childNode.nodeType === 'deterministic' && childNode.equation) {
            lines.push(`${indent}${nodeName} <- ${childNode.equation}`)
          }
        }
      })
      return lines
    }

    const finalCodeLines = generateCodeRecursive(treeRoot, 1)

    return ['model {', ...finalCodeLines, '}'].join('\n')
  })

  return {
    generatedCode,
  }
}

// Helpers to format JavaScript values as Julia literals for embedding
// Render a Julia NamedTuple field name: either bare identifier or var"..."
function juliaFieldLiteral(name: string): string {
  const s = String(name)
  const idok = /^[A-Za-z_][A-Za-z0-9_]*$/.test(s)
  if (idok) return s
  const escaped = s.replace(/"/g, '\\"')
  return `var"${escaped}"`
}

function isVectorOfNumbers(v: unknown): v is number[] {
  return Array.isArray(v) && v.every((x) => typeof x === 'number')
}

function isMatrixLike(v: unknown): v is number[][] {
  if (!Array.isArray(v) || v.length === 0) return false
  const rows = v as unknown[]
  const firstRow = rows[0]
  if (!Array.isArray(firstRow)) return false
  const cols = (firstRow as unknown[]).length
  return rows.every(
    (r) =>
      Array.isArray(r) &&
      (r as unknown[]).length === cols &&
      (r as unknown[]).every((x) => typeof x === 'number')
  )
}

function formatNumber(n: number): string {
  if (Number.isNaN(n)) return 'NaN'
  if (!Number.isFinite(n)) return n > 0 ? 'Inf' : '-Inf'
  return `${n}`
}

function formatVector(arr: number[]): string {
  return `[${arr.map(formatNumber).join(', ')}]`
}

function formatMatrix(mat: number[][]): string {
  const rows = mat.map((row) => row.map(formatNumber).join(' ')).join('\n        ')
  return `[\n        ${rows}\n    ]`
}

function formatValue(v: unknown): string {
  if (v === null) return 'missing'
  if (typeof v === 'number') return formatNumber(v)
  if (typeof v === 'boolean') return v ? 'true' : 'false'
  if (typeof v === 'string') return JSON.stringify(v)
  if (isMatrixLike(v)) return formatMatrix(v as number[][])
  if (isVectorOfNumbers(v)) return formatVector(v as number[])
  if (Array.isArray(v)) return JSON.stringify(v)
  if (v && typeof v === 'object') return JSON.stringify(v)
  return 'nothing'
}

function buildNamedTupleLiteral(obj: Record<string, unknown>): string {
  const entries = Object.entries(obj).map(
    ([k, val]) => `  ${juliaFieldLiteral(k)} = ${formatValue(val)}`
  )
  return entries.length ? `(\n${entries.join(',\n')}\n)` : '()'
}

// Standalone script generator: builds a Julia script matching the backend's standalone template
export interface StandaloneGeneratorSettings {
  n_samples: number
  n_adapts: number
  n_chains: number
  seed?: number | null
}

export interface StandaloneScriptInput {
  modelCode: string
  data: Record<string, unknown>
  inits: Record<string, unknown>
  settings: StandaloneGeneratorSettings
}

export function generateStandaloneScript(input: StandaloneScriptInput): string {
  const { modelCode, data, inits, settings } = input

  // Build literal NamedTuples
  const dataLiteral = buildNamedTupleLiteral(data as Record<string, unknown>)
  const initsLiteral = buildNamedTupleLiteral(inits as Record<string, unknown>)

  const nSamples = settings?.n_samples ?? 1000
  const nAdapts = settings?.n_adapts ?? 1000
  const nChains = settings?.n_chains ?? 1
  const seed = settings?.seed
  const seedLiteral =
    typeof seed === 'number' ? String(seed) : seed == null ? 'nothing' : JSON.stringify(seed)

  const script = `using JuliaBUGS, AbstractMCMC, AdvancedHMC, LogDensityProblems, LogDensityProblemsAD, MCMCChains, ReverseDiff, Random

data = ${dataLiteral}

inits = ${initsLiteral}

# Model definition using a string literal
model_def = JuliaBUGS.@bugs("""
${String(modelCode)}
""", true, false)

# Compile the model
model = JuliaBUGS.compile(model_def, data, inits)

# Wrap the model for automatic differentiation with ReverseDiff
ad_model = ADgradient(:ReverseDiff, model)
ld_model = AbstractMCMC.LogDensityModel(ad_model)

# Define sampling parameters
n_samples, n_adapts = ${nSamples}, ${nAdapts}
n_chains = ${nChains}
seed = ${seedLiteral}

seed_val = tryparse(Int, string(seed))
rng = seed === nothing ? Random.MersenneTwister() : (seed_val === nothing ? Random.MersenneTwister() : Random.MersenneTwister(seed_val))

D = LogDensityProblems.dimension(ad_model); initial_√é¬∏ = rand(rng, D)

# Sample the model using AbstractMCMC
if n_chains > 1 && Threads.nthreads() > 1
    chain = AbstractMCMC.sample(
        rng,
        ld_model,
        AdvancedHMC.NUTS(0.8),
        AbstractMCMC.MCMCThreads(),
        n_samples,
        n_chains;
        chain_type = Chains,
        n_adapts = n_adapts,
        init_params = initial_√é¬∏,
        discard_initial = n_adapts,
        progress = false,
    )
elseif n_chains > 1
    chain = AbstractMCMC.sample(
        rng,
        ld_model,
        AdvancedHMC.NUTS(0.8),
        AbstractMCMC.MCMCSerial(),
        n_samples,
        n_chains;
        chain_type = Chains,
        n_adapts = n_adapts,
        init_params = initial_√é¬∏,
        discard_initial = n_adapts,
        progress = false,
    )
else
    chain = AbstractMCMC.sample(
        rng,
        ld_model,
        AdvancedHMC.NUTS(0.8),
        n_samples;
        chain_type = Chains,
        n_adapts = n_adapts,
        init_params = initial_√é¬∏,
        discard_initial = n_adapts,
        progress = false,
    )
end

describe(chain)
`

  return script
}



================================================
FILE: src/composables/useCompoundDragDrop.ts
================================================
import type { Core, NodeSingular, Position, BoundingBox12, EventObject } from 'cytoscape'

export interface CompoundDragDropOptions {
  grabbedNode: (node: NodeSingular) => boolean
  dropTarget: (node: NodeSingular) => boolean
  dropSibling: () => boolean
  outThreshold: number
  onToast?: (message: string, severity?: 'info' | 'warn' | 'error' | 'success') => void
  shouldDetach?: () => boolean
}

interface DragState {
  isDragging: boolean
  draggedNode: NodeSingular | null
  originalParent: NodeSingular | null
  originalParentBounds: BoundingBox12 | null
  originalPosition: Position | null
  potentialDropTarget: NodeSingular | null
  platePositions: Map<string, Position>
  detachedOnGrab: boolean
  ghostNode: NodeSingular | null
  toastShown: boolean
}

// eslint-disable-next-line @typescript-eslint/no-explicit-any
type UndoRedoInstance = any

export function useCompoundDragDrop(
  cy: Core,
  options: CompoundDragDropOptions,
  ur?: UndoRedoInstance
) {
  const dragState: DragState = {
    isDragging: false,
    draggedNode: null,
    originalParent: null,
    originalParentBounds: null,
    originalPosition: null,
    potentialDropTarget: null,
    platePositions: new Map<string, Position>(),
    detachedOnGrab: false,
    ghostNode: null,
    toastShown: false,
  }

  /**
   * Checks if a node can be dropped into a potential target parent.
   */
  const canDropInto = (draggedNode: NodeSingular, targetNode: NodeSingular): boolean => {
    if (draggedNode.id() === targetNode.id()) return false

    let current = targetNode.parent()
    while (current.length > 0) {
      const currentNode = current[0]
      if (currentNode && currentNode.id() === draggedNode.id()) return false
      current = currentNode ? currentNode.parent() : cy.collection()
    }

    return options.dropTarget(targetNode)
  }

  /**
   * Finds the deepest valid drop target at a given position.
   */
  const findDropTargetAtPosition = (
    position: Position,
    draggedNode: NodeSingular
  ): NodeSingular | null => {
    const nodesAtPosition = cy.nodes().filter((node) => {
      if (node.id() === draggedNode.id()) return false
      const bb = node.boundingBox()
      return (
        position.x >= bb.x1 && position.x <= bb.x2 && position.y >= bb.y1 && position.y <= bb.y2
      )
    })

    const sortedNodes = nodesAtPosition.sort(
      (a, b) => getNodeDepth(b as NodeSingular) - getNodeDepth(a as NodeSingular)
    )

    for (const element of sortedNodes) {
      if (canDropInto(draggedNode, element as NodeSingular)) {
        return element as NodeSingular
      }
    }

    return null
  }

  const getNodeDepth = (node: NodeSingular): number => {
    let depth = 0
    let current = node.parent()
    while (current.length > 0) {
      depth++
      current = current[0].parent()
    }
    return depth
  }

  /**
   * Determines if a node has been dragged out of its parent's original bounds.
   * Returns true if the node is no longer fully contained within the original parent box.
   */
  const isOutsideOriginalParent = (node: NodeSingular): boolean => {
    if (!dragState.originalParentBounds) return false

    const nodeBounds = node.boundingBox({ includeOverlays: false, includeLabels: true })
    const parentBounds = dragState.originalParentBounds

    // Use a small buffer to tolerate slight border overlaps/jitter
    const buffer = 5

    const isContained =
      nodeBounds.x1 >= parentBounds.x1 - buffer &&
      nodeBounds.x2 <= parentBounds.x2 + buffer &&
      nodeBounds.y1 >= parentBounds.y1 - buffer &&
      nodeBounds.y2 <= parentBounds.y2 + buffer

    return !isContained
  }

  /**
   * Logic to transition a node into 'detached' mode (floating).
   * Creates a ghost node to hold parent shape and moves node to root.
   */
  const enterDetachMode = (node: NodeSingular) => {
    if (!dragState.originalParent || dragState.detachedOnGrab) return

    const ghostId = `ghost_${node.id()}_${Date.now()}`

    // Create node first without style object to avoid "bypass at creation" warning
    dragState.ghostNode = cy.add({
      group: 'nodes',
      data: {
        id: ghostId,
        parent: dragState.originalParent.id(),
        nodeType: 'constant',
        name: ' ', // Dummy name for label mapper
      },
      position: { ...(dragState.originalPosition || node.position()) },
      grabbable: false,
      selectable: false,
    })

    // Apply styles post-creation
    dragState.ghostNode.style({
      'background-opacity': 0,
      'border-opacity': 0,
      width: node.width(),
      height: node.height(),
      label: '',
      events: 'no',
    })

    // Detach Node
    dragState.detachedOnGrab = true

    // The ghost node is a transient visual element used only during the drag interaction
    // and is explicitly cleaned up in `endDrag`. It is intentionally excluded from the
    // undo history to prevent restoring temporary UI artifacts.
    if (ur) {
      ur.do('move', { eles: node, location: { parent: null } })
    } else {
      node.move({ parent: null })
    }
  }

  const startDrag = (event: EventObject) => {
    const node = event.target as NodeSingular
    if (!options.grabbedNode(node) || dragState.isDragging) return

    // Cleanup any orphaned ghost node from a previous cancelled interaction
    if (dragState.ghostNode) {
      cy.remove(dragState.ghostNode)
      dragState.ghostNode = null
    }

    dragState.isDragging = true
    dragState.draggedNode = node
    dragState.originalPosition = { ...node.position() }
    dragState.platePositions.clear()
    dragState.toastShown = false

    const currentParent = node.parent()
    const hasParent = currentParent.length > 0

    if (hasParent) {
      dragState.originalParent = currentParent[0]
      dragState.originalParentBounds = currentParent[0].boundingBox({
        includeOverlays: false,
        includeLabels: true,
      })
    } else {
      dragState.originalParent = null
      dragState.originalParentBounds = null
    }

    // Check for Alt key OR the detach mode toggle (for touch devices)
    const isAltPressed = event.originalEvent?.altKey || options.shouldDetach?.()

    if (isAltPressed && hasParent && dragState.originalParent) {
      enterDetachMode(node)
    } else {
      dragState.detachedOnGrab = false

      if (node.data('nodeType') !== 'plate') {
        cy.nodes('[nodeType="plate"]').forEach((plate) => {
          dragState.platePositions.set(plate.id(), { ...plate.position() })
        })
      }
    }

    node.addClass('cdnd-grabbed-node')
    cy.trigger('compound-drag-start', [{ node }])
  }

  const updateDrag = (node: NodeSingular, position: Position, event: EventObject) => {
    if (!dragState.isDragging || dragState.draggedNode?.id() !== node.id()) return

    // Dynamic Detach Mode: Trigger if Alt is pressed mid-drag OR detach mode is toggled
    const isAltPressed = event.originalEvent?.altKey || options.shouldDetach?.()

    if (isAltPressed && !dragState.detachedOnGrab && dragState.originalParent) {
      enterDetachMode(node)
    }

    const newDropTarget = findDropTargetAtPosition(position, node)

    if (
      dragState.potentialDropTarget &&
      dragState.potentialDropTarget.id() !== newDropTarget?.id()
    ) {
      dragState.potentialDropTarget.removeClass('cdnd-drop-target')
    }

    if (dragState.detachedOnGrab) {
      // Node is floating/detached
      if (newDropTarget) {
        dragState.potentialDropTarget = newDropTarget
        newDropTarget.addClass('cdnd-drop-target')
      } else {
        dragState.potentialDropTarget = null
      }
    } else {
      // Node is still attached as a child
      const currentParentNode = node.parent().length > 0 ? node.parent()[0] : null

      if (currentParentNode && isOutsideOriginalParent(node)) {
        if (!dragState.toastShown && options.onToast) {
          options.onToast(
            'Hold Alt/Option (√¢≈í¬•) key or enable Detach Mode  in View Options from left sidebar to remove node',
            'warn'
          )
          dragState.toastShown = true // Debounce
        }
      }

      // Check for nested drop targets
      if (newDropTarget && newDropTarget.id() !== currentParentNode?.id()) {
        dragState.potentialDropTarget = newDropTarget
        newDropTarget.addClass('cdnd-drop-target')
      } else {
        dragState.potentialDropTarget = null
      }
    }
  }

  const endDrag = (node: NodeSingular) => {
    if (!dragState.isDragging || dragState.draggedNode?.id() !== node.id()) return

    node.removeClass('cdnd-grabbed-node')
    if (dragState.potentialDropTarget) {
      dragState.potentialDropTarget.removeClass('cdnd-drop-target')
    }

    // Removing the ghost node triggers the plate to resize to its natural state
    if (dragState.ghostNode) {
      cy.remove(dragState.ghostNode)
      dragState.ghostNode = null
    }

    const currentParentNode = node.parent().length > 0 ? node.parent()[0] : null
    const newParent = dragState.potentialDropTarget
    let dropPerformed = false

    if (dragState.detachedOnGrab) {
      if (newParent) {
        if (ur) {
          ur.do('move', { eles: node, location: { parent: newParent.id() } })
        } else {
          node.move({ parent: newParent.id() })
        }
        cy.trigger('compound-drop', [{ node, newParent, oldParent: dragState.originalParent }])
      }
      dropPerformed = true
    } else {
      if (newParent && newParent.id() !== currentParentNode?.id()) {
        if (ur) {
          ur.do('move', { eles: node, location: { parent: newParent.id() } })
        } else {
          node.move({ parent: newParent.id() })
        }
        cy.trigger('compound-drop', [{ node, newParent, oldParent: currentParentNode }])
        dropPerformed = true
      }
    }

    // Reset State
    Object.assign(dragState, {
      isDragging: false,
      draggedNode: null,
      originalParent: null,
      originalParentBounds: null,
      originalPosition: null,
      potentialDropTarget: null,
      detachedOnGrab: false,
      ghostNode: null,
      toastShown: false,
    })
    dragState.platePositions.clear()

    cy.trigger('compound-drag-end', [{ node, dropPerformed }])
  }

  // Bind Listeners
  cy.on('grab', 'node', (event: EventObject) => startDrag(event))

  cy.on('drag', 'node', (event: EventObject) => {
    const node = event.target as NodeSingular
    if (dragState.isDragging && dragState.draggedNode?.id() === node.id()) {
      // Pass the full event object to access modifier keys (altKey)
      updateDrag(node, node.position(), event)
    }
  })

  cy.on('free', 'node', (event: EventObject) => endDrag(event.target as NodeSingular))

  const destroy = () => {
    cy.off('grab', 'node')
    cy.off('drag', 'node')
    cy.off('free', 'node')
  }

  return {
    destroy,
    getDragState: () => ({ ...dragState }),
  }
}



================================================
FILE: src/composables/useGraphElements.ts
================================================
import { computed } from 'vue'
import { storeToRefs } from 'pinia'
import { useGraphStore } from '../stores/graphStore'
import type { GraphElement } from '../types'

export function useGraphElements(graphId?: string) {
  const graphStore = useGraphStore()

  const targetGraphId = computed(() => graphId || graphStore.currentGraphId)

  // Use the shared selectedElement from the store
  const { selectedElement } = storeToRefs(graphStore)

  const elements = computed<GraphElement[]>({
    get: () => {
      const id = targetGraphId.value
      if (id && graphStore.graphContents.has(id)) {
        return graphStore.graphContents.get(id)!.elements
      }
      return []
    },
    set: (newElements) => {
      const id = targetGraphId.value
      if (id) {
        graphStore.updateGraphElements(id, newElements)
      }
    },
  })

  const addElement = (newElement: GraphElement) => {
    elements.value = [...elements.value, newElement]
    selectedElement.value = newElement
  }

  const updateElement = (updatedElement: GraphElement) => {
    elements.value = elements.value.map((el) => (el.id === updatedElement.id ? updatedElement : el))
    if (selectedElement.value?.id === updatedElement.id) {
      selectedElement.value = updatedElement
    }
  }

  const deleteElement = (elementId: string) => {
    const elementToDelete = elements.value.find((el) => el.id === elementId)
    if (!elementToDelete) return

    const allIdsToDelete = new Set<string>([elementId])

    // Recursively find all descendant nodes when deleting a plate.
    if (elementToDelete.type === 'node' && elementToDelete.nodeType === 'plate') {
      const findDescendants = (currentParentId: string) => {
        elements.value.forEach((el) => {
          if (el.type === 'node' && el.parent === currentParentId) {
            allIdsToDelete.add(el.id)
            if (el.nodeType === 'plate') {
              findDescendants(el.id)
            }
          }
        })
      }
      findDescendants(elementId)
    }

    const nodesBeingDeleted = new Set<string>()
    allIdsToDelete.forEach((id) => {
      const el = elements.value.find((e) => e.id === id)
      if (el?.type === 'node') {
        nodesBeingDeleted.add(id)
      }
    })

    // Delete edges connected to the nodes being removed.
    elements.value.forEach((el) => {
      if (
        el.type === 'edge' &&
        (nodesBeingDeleted.has(el.source) || nodesBeingDeleted.has(el.target))
      ) {
        allIdsToDelete.add(el.id)
      }
    })

    elements.value = elements.value.filter((el) => !allIdsToDelete.has(el.id))

    if (selectedElement.value && allIdsToDelete.has(selectedElement.value.id)) {
      selectedElement.value = null
    }
  }

  return {
    elements,
    selectedElement,
    addElement,
    updateElement,
    deleteElement,
  }
}



================================================
FILE: src/composables/useGraphInstance.ts
================================================
import cytoscape from 'cytoscape'
import type { Core, ElementDefinition, NodeSingular, EdgeSingular } from 'cytoscape'
// NOTE: gridGuide and contextMenus extensions are DISABLED for iOS/iPad/WebKit compatibility
// They block touch events and prevent node/edge creation on mobile devices
// import gridGuide from 'cytoscape-grid-guide';
// import contextMenus from 'cytoscape-context-menus';
import dagre from 'cytoscape-dagre'
import fcose from 'cytoscape-fcose'
import cola from 'cytoscape-cola'
import klay from 'cytoscape-klay'
import undoRedo from 'cytoscape-undo-redo'
import { useCompoundDragDrop } from './useCompoundDragDrop'
import svg from 'cytoscape-svg'
import { useUiStore } from '../stores/uiStore'

// NOTE: Do NOT register gridGuide or contextMenus - they break iPad/mobile touch events
cytoscape.use(dagre)
cytoscape.use(fcose)
cytoscape.use(cola)
cytoscape.use(klay)
cytoscape.use(svg)
cytoscape.use(undoRedo)

// eslint-disable-next-line @typescript-eslint/no-explicit-any
type UndoRedoInstance = any

// Define specific types for Cytoscape styles to avoid 'any'
type CyLineStyle = 'solid' | 'dotted' | 'dashed' | 'double'
type CyNodeShape =
  | 'ellipse'
  | 'rectangle'
  | 'round-rectangle'
  | 'triangle'
  | 'pentagon'
  | 'hexagon'
  | 'star'
  | 'diamond'
  | 'vee'
  | 'rhomboid'
  | 'polygon'
  | 'tag'
  | 'barrel'
  | 'cut-rectangle'
  | 'bottom-round-rectangle'
  | 'concave-hexagon'
type CyTextBackgroundShape = 'rectangle' | 'roundrectangle'

const instances = new Map<string, { cy: Core; ur: UndoRedoInstance }>()

export function useGraphInstance() {
  const uiStore = useUiStore()

  const initCytoscape = (
    container: HTMLElement,
    initialElements: ElementDefinition[],
    graphId: string,
    onToast?: (message: string, severity?: 'info' | 'warn' | 'error' | 'success') => void
  ): Core => {
    if (instances.has(graphId)) {
      const instance = instances.get(graphId)!
      instance.cy.destroy()
      instances.delete(graphId)
    }

    const options: cytoscape.CytoscapeOptions = {
      container: container,
      elements: initialElements,
      style: [
        {
          selector: 'node',
          style: {
            // Core shape and size logic: Use global preference from uiStore
            'background-color': (ele: NodeSingular) =>
              uiStore.nodeStyles[ele.data('nodeType')]?.backgroundColor || '#999',
            'background-opacity': (ele: NodeSingular) =>
              uiStore.nodeStyles[ele.data('nodeType')]?.backgroundOpacity ?? 1,
            'border-color': (ele: NodeSingular) =>
              uiStore.nodeStyles[ele.data('nodeType')]?.borderColor || '#555',
            'border-width': (ele: NodeSingular) =>
              uiStore.nodeStyles[ele.data('nodeType')]?.borderWidth || 2,
            'border-style': (ele: NodeSingular) =>
              (uiStore.nodeStyles[ele.data('nodeType')]?.borderStyle || 'solid') as CyLineStyle,
            shape: (ele: NodeSingular) =>
              (uiStore.nodeStyles[ele.data('nodeType')]?.shape || 'ellipse') as CyNodeShape,
            width: (ele: NodeSingular) => uiStore.nodeStyles[ele.data('nodeType')]?.width || 60,
            height: (ele: NodeSingular) => uiStore.nodeStyles[ele.data('nodeType')]?.height || 60,

            label: (ele: NodeSingular) => {
              const name = ele.data('name') as string
              const indices = ele.data('indices') as string | undefined
              return indices ? `${name}[${indices}]` : name
            },
            color: (ele: NodeSingular) =>
              uiStore.nodeStyles[ele.data('nodeType')]?.labelColor || '#000000',

            'font-size': (ele: NodeSingular) =>
              uiStore.nodeStyles[ele.data('nodeType')]?.labelFontSize || 10,

            'text-valign': 'center',
            'text-halign': 'center',
            padding: '10px',
            'text-wrap': 'wrap',
            'text-max-width': '80px',
            'line-height': 1.2,
            'z-index': 10,
          },
        },
        {
          selector: 'node[nodeType="plate"]',
          style: {
            // Plate specific overrides - label handling primarily
            label: (ele: NodeSingular) =>
              `for(${ele.data('loopVariable')} in ${ele.data('loopRange')})`,
          },
        },
        {
          selector: ':parent',
          style: { 'text-valign': 'top', 'text-halign': 'center', padding: '15px', 'z-index': 5 },
        },
        {
          selector: 'node[?hasError]',
          style: { 'border-color': '#ffc107', 'border-width': 3, 'border-style': 'double' },
        },
        {
          selector: 'edge',
          style: {
            width: 3,
            'line-color': '#a0a0a0',
            'target-arrow-color': '#a0a0a0',
            'target-arrow-shape': 'triangle',
            'curve-style': 'bezier',
            'z-index': 1,
          },
        },
        {
          selector: 'edge[name]',
          style: {
            label: 'data(name)',
            'font-size': (ele: EdgeSingular) =>
              uiStore.edgeStyles[ele.data('relationshipType') as 'stochastic' | 'deterministic']
                ?.labelFontSize || 8,
            color: (ele: EdgeSingular) =>
              uiStore.edgeStyles[ele.data('relationshipType') as 'stochastic' | 'deterministic']
                ?.labelColor || '#000000',

            'text-rotation': 'autorotate',
            'text-background-opacity': (ele: EdgeSingular) =>
              uiStore.edgeStyles[ele.data('relationshipType') as 'stochastic' | 'deterministic']
                ?.labelBackgroundOpacity ?? 1,
            'text-background-color': (ele: EdgeSingular) =>
              uiStore.edgeStyles[ele.data('relationshipType') as 'stochastic' | 'deterministic']
                ?.labelBackgroundColor || '#ffffff',
            'text-background-padding': '3px',
            'text-background-shape': (ele: EdgeSingular) =>
              (uiStore.edgeStyles[ele.data('relationshipType') as 'stochastic' | 'deterministic']
                ?.labelBackgroundShape || 'rectangle') as CyTextBackgroundShape,

            'text-border-width': (ele: EdgeSingular) =>
              uiStore.edgeStyles[ele.data('relationshipType') as 'stochastic' | 'deterministic']
                ?.labelBorderWidth ?? 1,
            'text-border-color': (ele: EdgeSingular) =>
              uiStore.edgeStyles[ele.data('relationshipType') as 'stochastic' | 'deterministic']
                ?.labelBorderColor || '#ccc',
            'text-border-opacity': (ele: EdgeSingular) =>
              uiStore.edgeStyles[ele.data('relationshipType') as 'stochastic' | 'deterministic']
                ?.labelBackgroundOpacity ?? 1,
          },
        },
        {
          selector: 'edge[relationshipType="stochastic"]',
          style: {
            'line-color': () => uiStore.edgeStyles.stochastic.color,
            'target-arrow-color': () => uiStore.edgeStyles.stochastic.color,
            width: () => uiStore.edgeStyles.stochastic.width,
            // eslint-disable-next-line @typescript-eslint/no-explicit-any
            'line-style': () => uiStore.edgeStyles.stochastic.lineStyle as any,
          },
        },
        {
          selector: 'edge[relationshipType="deterministic"]',
          style: {
            'line-color': () => uiStore.edgeStyles.deterministic.color,
            'target-arrow-color': () => uiStore.edgeStyles.deterministic.color,
            width: () => uiStore.edgeStyles.deterministic.width,
            // eslint-disable-next-line @typescript-eslint/no-explicit-any
            'line-style': () => uiStore.edgeStyles.deterministic.lineStyle as any,
          },
        },
        {
          selector: '.cy-selected',
          style: {
            'border-width': 3,
            'border-color': '#007acc',
            'overlay-color': '#007acc',
            'overlay-opacity': 0.2,
          },
        },
        {
          selector: '.cdnd-grabbed-node',
          style: { 'background-color': '#f1c40f', opacity: 0.7 },
        },
        {
          selector: '.cdnd-drop-target',
          style: { 'border-color': '#f1c40f', 'border-style': 'solid' },
        },
        {
          selector: '.cdnd-drag-out',
          style: {
            'border-color': '#e74c3c',
            'border-style': 'dashed',
            'border-width': 2,
            'overlay-color': '#e74c3c',
            'overlay-opacity': 0.3,
            'overlay-padding': 5,
          },
        },
        {
          selector: '.cdnd-grabbed-node.cdnd-drag-out',
          style: {
            'border-color': '#e74c3c',
            'border-style': 'dashed',
            'border-width': 2,
            'background-color': '#f1c40f',
            opacity: 0.7,
            'overlay-color': '#e74c3c',
            'overlay-opacity': 0.3,
            'overlay-padding': 5,
          },
        },
      ],
      layout: { name: 'preset' },
      minZoom: 0.1,
      maxZoom: 7,
      boxSelectionEnabled: true,
      autounselectify: false,
    }

    const cyInstance = cytoscape(options)

    // Initialize undo-redo
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    const urInstance = (cyInstance as any).undoRedo({
      isDebug: false,
      undoableDrag: true,
      stackSizeLimit: 50,
    })

    urInstance.action(
      'move',
      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      function (args: any) {
        const eles = typeof args.eles === 'string' ? cyInstance!.$(args.eles) : args.eles
        const nodes = eles.nodes()
        const edges = eles.edges()

        const oldNodesParents: (string | null)[] = []
        const oldEdgesSources: string[] = []
        const oldEdgesTargets: string[] = []

        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        nodes.forEach((node: any) => {
          oldNodesParents.push(node.parent().length > 0 ? node.parent().id() : null)
        })

        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        edges.forEach((edge: any) => {
          oldEdgesSources.push(edge.source().id())
          oldEdgesTargets.push(edge.target().id())
        })

        return {
          oldNodesParents: oldNodesParents,
          newNodes: nodes.move(args.location),
          oldEdgesSources: oldEdgesSources,
          oldEdgesTargets: oldEdgesTargets,
          newEdges: edges.move(args.location),
        }
      },
      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      function (eles: any) {
        let newEles = cyInstance!.collection()
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        const location: any = {}

        if (eles.newNodes.length > 0) {
          const parent = eles.newNodes[0].parent()
          location.parent = parent.length > 0 ? parent.id() : null

          for (let i = 0; i < eles.newNodes.length; i++) {
            const newNode = eles.newNodes[i].move({
              parent: eles.oldNodesParents[i],
            })
            newEles = newEles.union(newNode)
          }
        } else if (eles.newEdges.length > 0) {
          location.source = eles.newEdges[0].source().id()
          location.target = eles.newEdges[0].target().id()

          for (let i = 0; i < eles.newEdges.length; i++) {
            const newEdge = eles.newEdges[i].move({
              source: eles.oldEdgesSources[i],
              target: eles.oldEdgesTargets[i],
            })
            newEles = newEles.union(newEdge)
          }
        }
        return {
          eles: newEles,
          location: location,
        }
      }
    )

    // Initialize custom compound drag and drop
    useCompoundDragDrop(
      cyInstance,
      {
        grabbedNode: (node: NodeSingular) => node !== undefined, // Allow dragging all node types
        dropTarget: (node: NodeSingular) => node.data('nodeType') === 'plate',
        dropSibling: () => false,
        outThreshold: 30, // Threshold for drag out detection
        onToast: onToast, // Pass the toast callback
        shouldDetach: () => uiStore.isDetachModeActive,
      },
      urInstance
    )

    instances.set(graphId, { cy: cyInstance, ur: urInstance })

    return cyInstance
  }

  const destroyCytoscape = (graphId: string): void => {
    if (instances.has(graphId)) {
      const instance = instances.get(graphId)!
      instance.cy.destroy()
      instances.delete(graphId)
    }
  }

  const getCyInstance = (graphId: string): Core | null => {
    return instances.get(graphId)?.cy || null
  }

  const getUndoRedoInstance = (graphId: string): UndoRedoInstance => {
    return instances.get(graphId)?.ur || null
  }

  return { initCytoscape, destroyCytoscape, getCyInstance, getUndoRedoInstance }
}



================================================
FILE: src/composables/useGraphLayout.ts
================================================
import type { Core, LayoutOptions } from 'cytoscape'

export function useGraphLayout() {
  const smartFit = (cy: Core, animate: boolean = true) => {
    const eles = cy.elements()
    if (eles.length === 0) return

    const padding = 50
    const w = cy.width()
    const h = cy.height()
    const bb = eles.boundingBox()

    if (bb.w === 0 || bb.h === 0) return

    const zoomX = (w - 2 * padding) / bb.w
    const zoomY = (h - 2 * padding) / bb.h
    let targetZoom = Math.min(zoomX, zoomY)
    targetZoom = Math.min(targetZoom, 0.8)

    const targetPan = {
      x: (w - targetZoom * (bb.x1 + bb.x2)) / 2,
      y: (h - targetZoom * (bb.y1 + bb.y2)) / 2,
    }

    if (animate) {
      cy.animate({
        zoom: targetZoom,
        pan: targetPan,
        duration: 500,
        easing: 'ease-in-out-cubic',
      })
    } else {
      cy.viewport({ zoom: targetZoom, pan: targetPan })
    }
  }

  const getLayoutOptions = (layoutName: string): LayoutOptions => {
    const layoutOptionsMap: Record<string, LayoutOptions> = {
      dagre: {
        name: 'dagre',
        animate: true,
        animationDuration: 500,
        fit: false,
        padding: 50,
      } as unknown as LayoutOptions,
      fcose: {
        name: 'fcose',
        animate: true,
        animationDuration: 500,
        fit: false,
        padding: 50,
        randomize: false,
        quality: 'proof',
      } as unknown as LayoutOptions,
      cola: {
        name: 'cola',
        animate: true,
        fit: false,
        padding: 50,
        refresh: 1,
        avoidOverlap: true,
        infinite: false,
        centerGraph: true,
        flow: { axis: 'y', minSeparation: 30 },
        handleDisconnected: false,
        randomize: false,
      } as unknown as LayoutOptions,
      klay: {
        name: 'klay',
        animate: true,
        animationDuration: 500,
        fit: false,
        padding: 50,
        klay: { direction: 'RIGHT', edgeRouting: 'SPLINES', nodePlacement: 'LINEAR_SEGMENTS' },
      } as unknown as LayoutOptions,
      preset: { name: 'preset', fit: false, padding: 50 } as unknown as LayoutOptions,
    }

    return layoutOptionsMap[layoutName] || layoutOptionsMap.preset
  }

  const applyLayout = (cy: Core, layoutName: string, onComplete?: () => void) => {
    const options = getLayoutOptions(layoutName)

    if (onComplete) {
      cy.one('layoutstop', onComplete)
    }

    cy.layout(options).run()
  }

  const applyLayoutWithFit = (cy: Core, layoutName: string) => {
    applyLayout(cy, layoutName, () => smartFit(cy, true))
  }

  return {
    smartFit,
    getLayoutOptions,
    applyLayout,
    applyLayoutWithFit,
  }
}



================================================
FILE: src/composables/useGraphValidator.ts
================================================
import { ref, watch } from 'vue'
import type { Ref } from 'vue'
import type { GraphElement, GraphNode, GraphEdge, ValidationError, ModelData } from '../types'
import { getDistributionByName } from '../config/nodeDefinitions'

// A set of known BUGS functions to be ignored during validation of deterministic node equations.
const knownBugsFunctions = new Set([
  'sqrt',
  'log',
  'exp',
  'sin',
  'cos',
  'tan',
  'abs',
  'round',
  'trunc',
  'step',
  'mean',
  'sum',
  'prod',
  'sd',
  'var',
  'min',
  'max',
  'inverse',
  'logdet',
  'logit',
  'probit',
  'cloglog',
  'phi',
])

// Helper to compare error maps
const areErrorMapsEqual = (
  map1: Map<string, ValidationError[]>,
  map2: Map<string, ValidationError[]>
) => {
  if (map1.size !== map2.size) return false
  for (const [key, val1] of map1) {
    const val2 = map2.get(key)
    if (!val2) return false
    if (val1.length !== val2.length) return false
    for (let i = 0; i < val1.length; i++) {
      if (val1[i].field !== val2[i].field || val1[i].message !== val2[i].message) return false
    }
  }
  return true
}

/**
 * Composable for validating a BUGS graph model.
 * It produces a reactive map of errors without mutating the source elements.
 * @param elements - A ref containing the graph elements.
 * @param modelData - A ref containing the parsed model data and inits.
 */
export function useGraphValidator(elements: Ref<GraphElement[]>, modelData: Ref<ModelData>) {
  const validationErrors = ref<Map<string, ValidationError[]>>(new Map())

  const validateGraph = () => {
    const newErrors = new Map<string, ValidationError[]>()
    const nodes = elements.value.filter((el) => el.type === 'node') as GraphNode[]
    const edges = elements.value.filter((el) => el.type === 'edge') as GraphEdge[]

    // Performance Optimization: Map for O(1) lookups
    const nodeMap = new Map(nodes.map((n) => [n.id, n]))
    const dataKeys = new Set(Object.keys(modelData.value.data))
    const nodeNames = new Set(nodes.map((n) => n.name))

    nodes.forEach((node) => {
      const errors: ValidationError[] = []

      if (node.nodeType === 'stochastic' || node.nodeType === 'observed') {
        const dist = getDistributionByName(node.distribution || '')
        if (dist && dist.paramCount !== undefined) {
          const parentEdges = edges.filter((e) => e.target === node.id)
          let providedParams = parentEdges.length

          const literalParams = Object.keys(node)
            .filter(
              (key) =>
                key.startsWith('param') &&
                node[key as keyof GraphNode] &&
                String(node[key as keyof GraphNode]).trim() !== ''
            )
            .map((key) => String(node[key as keyof GraphNode]))

          const linkedParams = literalParams.filter((p) => nodeNames.has(p))
          const numericParams = literalParams.length - linkedParams.length

          providedParams += numericParams

          if (providedParams !== dist.paramCount) {
            errors.push({
              field: 'distribution',
              message: `Invalid number of inputs. ${dist.label} expects ${dist.paramCount}, but found ${providedParams}.`,
            })
          }
        }
      }

      if (node.nodeType === 'deterministic') {
        if (!node.equation?.trim()) {
          errors.push({
            field: 'equation',
            message: 'Deterministic node must have an equation.',
          })
        } else {
          const ancestorLoopVars = new Set<string>()
          let currentNode: GraphNode | undefined = node
          // Basic loop detection to prevent infinite recursion in parent traversal
          const visitedAncestors = new Set<string>([node.id])

          while (true) {
            if (!currentNode?.parent) break
            if (visitedAncestors.has(currentNode.parent)) break
            visitedAncestors.add(currentNode.parent)

            // Optimized lookup
            const parentNode = nodeMap.get(currentNode.parent)

            if (parentNode && parentNode.nodeType === 'plate' && parentNode.loopVariable) {
              ancestorLoopVars.add(parentNode.loopVariable)
            }
            currentNode = parentNode
          }

          const variablesInEquation = new Set<string>(
            node.equation.match(/[a-zA-Z_][a-zA-Z0-9_.]*/g) || []
          )
          // Optimized parent name lookup
          const parentNames = new Set<string>()
          edges.forEach((e) => {
            if (e.target === node.id) {
              const source = nodeMap.get(e.source)
              if (source) parentNames.add(source.name)
            }
          })

          variablesInEquation.forEach((variable) => {
            if (knownBugsFunctions.has(variable)) {
              return
            }
            const baseVariable = variable.split('[')[0]
            if (!parentNames.has(baseVariable) && !ancestorLoopVars.has(baseVariable)) {
              errors.push({
                field: 'equation',
                message: `Variable '${baseVariable}' in equation is not a parent or an available loop index.`,
              })
            }
          })
        }
      }

      if (node.observed && !dataKeys.has(node.name)) {
        errors.push({
          field: 'name',
          message: `Node is marked as observed, but no data found for '${node.name}'.`,
        })
      }

      const baseName = node.name.split('[')[0].trim()
      if (!/^[a-zA-Z][a-zA-Z0-9.]*$/.test(baseName)) {
        errors.push({
          field: 'name',
          message: `Base name '${baseName}' is not a valid BUGS variable name.`,
        })
      }

      if (errors.length > 0) {
        newErrors.set(node.id, errors)
      }
    })

    // Only update if content actually changed to prevent infinite loops
    if (!areErrorMapsEqual(validationErrors.value, newErrors)) {
      validationErrors.value = newErrors
    }
  }

  watch([elements, modelData], validateGraph, { deep: true, immediate: true })

  return {
    validateGraph,
    validationErrors,
  }
}



================================================
FILE: src/composables/useGridSnapping.ts
================================================
import { ref, computed, watch } from 'vue'
import type { Core } from 'cytoscape'

export function useGridSnapping(getCyInstance: () => Core | null) {
  const isGridEnabledRef = ref<boolean>(false)
  const gridSizeRef = ref<number>(20)

  const cssGridSize = computed<string>(() => `${gridSizeRef.value}px`)

  const updateGridBackground = () => {
    const cy = getCyInstance()
    if (cy) {
      const container = cy.container()
      if (container) {
        if (isGridEnabledRef.value && gridSizeRef.value > 0) {
          container.classList.add('grid-background')
          container.style.setProperty('--grid-size', cssGridSize.value)
        } else {
          container.classList.remove('grid-background')
          container.style.removeProperty('--grid-size')
        }
      }
    }
  }

  const enableGridSnapping = (): void => {
    isGridEnabledRef.value = true
    updateGridBackground()
  }

  const disableGridSnapping = (): void => {
    isGridEnabledRef.value = false
    updateGridBackground()
  }

  const setGridSize = (size: number): void => {
    gridSizeRef.value = size
    if (isGridEnabledRef.value) {
      updateGridBackground()
    }
  }

  watch([isGridEnabledRef, gridSizeRef], updateGridBackground)

  return {
    isGridEnabledRef,
    gridSizeRef,
    cssGridSize,
    enableGridSnapping,
    disableGridSnapping,
    setGridSize,
  }
}



================================================
FILE: src/composables/useImportExport.ts
================================================
import { ref } from 'vue'

export interface ImportedGraphData {
  name?: string
  elements: unknown[]
  dataContent?: string
  layout?: string
}

export function useImportExport() {
  const importedGraphData = ref<ImportedGraphData | null>(null)

  const processGraphFile = (file: File): Promise<ImportedGraphData> => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader()
      reader.onload = (e) => {
        try {
          const content = e.target?.result as string
          const data = JSON.parse(content)
          if (data.elements && Array.isArray(data.elements)) {
            importedGraphData.value = data
            resolve(data)
          } else {
            reject(new Error('Invalid graph JSON file.'))
          }
        } catch (err) {
          console.error(err)
          reject(new Error('Failed to parse file.'))
        }
      }
      reader.onerror = () => reject(new Error('Failed to read file.'))
      reader.readAsText(file)
    })
  }

  const clearImportedData = () => {
    importedGraphData.value = null
  }

  return {
    importedGraphData,
    processGraphFile,
    clearImportedData,
  }
}



================================================
FILE: src/composables/usePersistence.ts
================================================
export interface UIState {
  leftSidebar?: {
    open: boolean
    x: number
    y: number
  }
  rightSidebar?: {
    open: boolean
    x: number
    y: number
  }
  codePanel?: {
    open: boolean
    x: number
    y: number
    width: number
    height: number
  }
  dataPanel?: {
    open: boolean
    x: number
    y: number
    width: number
    height: number
  }
  currentGraphId?: string
  editMode?: boolean
}

export interface GraphData {
  elements: unknown[]
  dataContent?: string
}

export function usePersistence(storageKeyPrefix = 'doodlebugs') {
  const isSSR = typeof window === 'undefined'

  const loadUIState = (key: string): UIState | null => {
    if (isSSR) return null
    try {
      const saved = localStorage.getItem(key)
      return saved ? JSON.parse(saved) : null
    } catch (e) {
      console.error('Failed to load UI state:', e)
      return null
    }
  }

  const saveUIState = (key: string, state: UIState): void => {
    if (isSSR) return
    try {
      localStorage.setItem(key, JSON.stringify(state))
    } catch (e) {
      console.error('Failed to save UI state:', e)
    }
  }

  const loadGraphData = (graphId: string): GraphData | null => {
    if (isSSR) return null
    try {
      const storedGraph = localStorage.getItem(`${storageKeyPrefix}-graph-${graphId}`)
      if (!storedGraph) return null

      const parsed = JSON.parse(storedGraph)
      return {
        elements: parsed.elements || [],
        dataContent: undefined,
      }
    } catch (e) {
      console.error('Failed to load graph data:', e)
      return null
    }
  }

  const loadDataContent = (graphId: string): string => {
    if (isSSR) return '{}'
    try {
      const storedData = localStorage.getItem(`${storageKeyPrefix}-data-${graphId}`)
      if (!storedData) return '{}'

      const parsed = JSON.parse(storedData)
      return (
        parsed.content ||
        (parsed.jsonData
          ? JSON.stringify({
              data: parsed.jsonData.data || {},
              inits: parsed.jsonData.inits || {},
            })
          : '{}')
      )
    } catch (e) {
      console.error('Failed to load data content:', e)
      return '{}'
    }
  }

  const loadLastGraphId = (): string | null => {
    if (isSSR) return null
    try {
      return localStorage.getItem(`${storageKeyPrefix}-currentGraphId`)
    } catch (e) {
      console.error('Failed to load last graph ID:', e)
      return null
    }
  }

  const saveLastGraphId = (graphId: string): void => {
    if (isSSR) return
    try {
      localStorage.setItem(`${storageKeyPrefix}-currentGraphId`, graphId)
    } catch (e) {
      console.error('Failed to save last graph ID:', e)
    }
  }

  const getStoredGraphElements = (graphId: string): unknown[] => {
    const graphData = loadGraphData(graphId)
    return graphData?.elements || []
  }

  const getStoredDataContent = (graphId: string): string => {
    return loadDataContent(graphId)
  }

  return {
    loadUIState,
    saveUIState,
    loadGraphData,
    loadDataContent,
    loadLastGraphId,
    saveLastGraphId,
    getStoredGraphElements,
    getStoredDataContent,
  }
}



================================================
FILE: src/composables/useShareExport.ts
================================================
import { ref } from 'vue'
import type { GraphElement, GraphNode, NodeType } from '../types'

const keyMap: Record<string, string> = {
  id: 'i',
  name: 'n',
  type: 't',
  nodeType: 'nt',
  position: 'p',
  parent: 'pa',
  distribution: 'di',
  equation: 'eq',
  observed: 'ob',
  indices: 'id',
  loopVariable: 'lv',
  loopRange: 'lr',
  param1: 'p1',
  param2: 'p2',
  param3: 'p3',
  source: 's',
  target: 'tg',
  x: 'x',
  y: 'y',
}

const nodeTypeMap: Record<string, number> = {
  stochastic: 1,
  deterministic: 2,
  constant: 3,
  observed: 4,
  plate: 5,
}

const reverseNodeTypeMap: Record<number, string> = Object.fromEntries(
  Object.entries(nodeTypeMap).map(([k, v]) => [v, k])
)

export function useShareExport() {
  const shareUrl = ref('')

  const compressAndEncode = async (jsonStr: string): Promise<string> => {
    try {
      if (!window.CompressionStream) throw new Error('CompressionStream not supported')
      const stream = new Blob([jsonStr]).stream()
      const compressedStream = stream.pipeThrough(new CompressionStream('gzip'))
      const response = new Response(compressedStream)
      const blob = await response.blob()
      const buffer = await blob.arrayBuffer()
      const bytes = new Uint8Array(buffer)
      let binaryStr = ''
      for (let i = 0; i < bytes.byteLength; i++) {
        binaryStr += String.fromCharCode(bytes[i])
      }
      return 'gz_' + btoa(binaryStr)
    } catch {
      return btoa(unescape(encodeURIComponent(jsonStr)))
    }
  }

  const decodeAndDecompress = async (encoded: string): Promise<string> => {
    try {
      if (encoded.startsWith('gz_')) {
        if (!window.DecompressionStream) throw new Error('DecompressionStream not supported')
        const base64 = encoded.substring(3)
        const binaryStr = atob(base64)
        const len = binaryStr.length
        const bytes = new Uint8Array(len)
        for (let i = 0; i < len; i++) {
          bytes[i] = binaryStr.charCodeAt(i)
        }
        const stream = new Blob([bytes]).stream()
        const decompressedStream = stream.pipeThrough(new DecompressionStream('gzip'))
        const response = new Response(decompressedStream)
        return await response.text()
      }
      return decodeURIComponent(escape(atob(encoded)))
    } catch (e) {
      console.error('Decompression failed, trying legacy decode:', e)
      return decodeURIComponent(escape(atob(encoded)))
    }
  }

  const minifyGraph = (elems: GraphElement[]): Record<string, unknown>[] => {
    return elems.map((el) => {
      const min: Record<string, unknown> = {}
      if (el.type === 'node') {
        const node = el as GraphNode
        min[keyMap.id] = node.id.replace('node_', '')
        min[keyMap.name] = node.name
        min[keyMap.type] = 0
        min[keyMap.nodeType] = nodeTypeMap[node.nodeType]
        min[keyMap.position] = [Math.round(node.position.x), Math.round(node.position.y)]
        if (node.parent) min[keyMap.parent] = node.parent.replace('node_', '').replace('plate_', '')
        if (node.distribution) min[keyMap.distribution] = node.distribution
        if (node.equation) min[keyMap.equation] = node.equation
        if (node.observed) min[keyMap.observed] = 1
        if (node.indices) min[keyMap.indices] = node.indices
        if (node.loopVariable) min[keyMap.loopVariable] = node.loopVariable
        if (node.loopRange) min[keyMap.loopRange] = node.loopRange
        if (node.param1) min[keyMap.param1] = node.param1
        if (node.param2) min[keyMap.param2] = node.param2
        if (node.param3) min[keyMap.param3] = node.param3
      } else {
        min[keyMap.id] = el.id.replace('edge_', '')
        min[keyMap.type] = 1
        min[keyMap.source] = el.source.replace('node_', '').replace('plate_', '')
        min[keyMap.target] = el.target.replace('node_', '').replace('plate_', '')
      }
      return min
    })
  }

  const expandGraph = (minified: Record<string, unknown>[]): GraphElement[] => {
    return minified.map((min) => {
      if (min[keyMap.type] === 0) {
        const nodeTypeNum = min[keyMap.nodeType] as number
        const minId = min[keyMap.id] as string

        // Handle plate vs regular node IDs
        const id =
          minId.startsWith('node_') || minId.startsWith('plate_')
            ? minId
            : (nodeTypeNum === 5 ? 'plate_' : 'node_') + minId

        const node: Partial<GraphNode> = {
          type: 'node',
          id,
          name: min[keyMap.name] as string,
          nodeType: reverseNodeTypeMap[nodeTypeNum] as NodeType,
          position: {
            x:
              min[keyMap.position] && !isNaN((min[keyMap.position] as number[])[0])
                ? (min[keyMap.position] as number[])[0]
                : 0,
            y:
              min[keyMap.position] && !isNaN((min[keyMap.position] as number[])[1])
                ? (min[keyMap.position] as number[])[1]
                : 0,
          },
        }

        if (min[keyMap.parent]) {
          const pid = min[keyMap.parent] as string
          node.parent = pid.startsWith('plate_') || pid.startsWith('node_') ? pid : 'plate_' + pid
        }
        if (min[keyMap.distribution]) node.distribution = min[keyMap.distribution] as string
        if (min[keyMap.equation]) node.equation = min[keyMap.equation] as string
        if (min[keyMap.observed]) node.observed = true
        if (min[keyMap.indices]) node.indices = min[keyMap.indices] as string
        if (min[keyMap.loopVariable]) node.loopVariable = min[keyMap.loopVariable] as string
        if (min[keyMap.loopRange]) node.loopRange = min[keyMap.loopRange] as string
        if (min[keyMap.param1]) node.param1 = min[keyMap.param1] as string
        if (min[keyMap.param2]) node.param2 = min[keyMap.param2] as string
        if (min[keyMap.param3]) node.param3 = min[keyMap.param3] as string
        return node as GraphElement
      } else {
        const minId = min[keyMap.id] as string
        const minSource = min[keyMap.source] as string
        const minTarget = min[keyMap.target] as string

        const edge = {
          type: 'edge' as const,
          id: minId.startsWith('edge_') ? minId : 'edge_' + minId,
          source:
            minSource.startsWith('node_') || minSource.startsWith('plate_')
              ? minSource
              : 'node_' + minSource,
          target:
            minTarget.startsWith('node_') || minTarget.startsWith('plate_')
              ? minTarget
              : 'node_' + minTarget,
        }
        return edge as GraphElement
      }
    })
  }

  const generateShareLink = async (payload: object) => {
    try {
      const base64 = await compressAndEncode(JSON.stringify(payload))
      const baseUrl = window.location.origin + window.location.pathname
      shareUrl.value = `${baseUrl}?share=${encodeURIComponent(base64)}`
    } catch (e) {
      console.error('Failed to generate share link:', e)
    }
  }

  return {
    shareUrl,
    compressAndEncode,
    decodeAndDecompress,
    minifyGraph,
    expandGraph,
    generateShareLink,
  }
}



================================================
FILE: src/config/examples.ts
================================================
// Import local models directly to bundle them into the widget JS
// Note: Ensure these files exist and use the Unified JSON format
import ratsModel from '../../public/examples/rats/model.json'

export type ModelSourceType = 'local' | 'github' | 'url'

export interface ExampleModelConfig {
  id: string
  name: string
  type: ModelSourceType
  // For local bundled models, we pass the imported JSON object directly
  data?: unknown 
  // For remote models, we pass the URL
  url?: string
}

export const examples: ExampleModelConfig[] = [
  {
    id: 'rats',
    name: 'Rats Model',
    type: 'local',
    data: ratsModel, // Bundled directly
  },
  {
    id: 'rat-2',
    name: 'Rats (GitHub Demo)',
    type: 'github',
    // Example of a raw GitHub URL
    url: 'https://raw.githubusercontent.com/shravanngoswamii/experimental/refs/heads/main/model.json'
  }
]

// Helper to check if a string is a URL
export const isUrl = (str: string) => {
  try {
    new URL(str);
    return true;
  } catch {
    return false;
  }
}



================================================
FILE: src/config/nodeDefinitions.ts
================================================
import type { NodeType } from '../types'

export type NodePropertyType = 'select' | 'text' | 'number' | 'checkbox'

export interface SelectOption {
  value: string
  label: string
  paramCount?: number
  paramNames?: string[]
  helpText?: string
}

export interface NodeProperty {
  key: string
  label: string
  type: NodePropertyType
  placeholder?: string
  options?: SelectOption[]
  defaultValue: string | number | boolean | null | undefined
  helpText?: string
}

export interface NodeDefinition {
  nodeType: NodeType
  label: string
  icon: string
  description: string
  styleClass: string
  properties: NodeProperty[]
  parameters?: NodeProperty[] // Optional parameters for distributions
  defaultStyle: {
    backgroundColor: string
    borderColor: string
    borderWidth: number
    borderStyle: string
    backgroundOpacity: number
    shape: string
    width: number
    height: number
    labelFontSize: number
    labelColor: string
  }
}

export interface EdgeStyle {
  color: string
  width: number
  lineStyle: string // 'solid' | 'dashed' | 'dotted'
  labelFontSize: number
  labelColor: string
  // Label Background Styling
  labelBackgroundColor: string
  labelBackgroundOpacity: number
  labelBorderColor: string
  labelBorderWidth: number
  labelBackgroundShape: 'rectangle' | 'roundrectangle'
}

export const defaultEdgeStyles: Record<'stochastic' | 'deterministic', EdgeStyle> = {
  stochastic: {
    color: '#dc3545',
    width: 3,
    lineStyle: 'dashed',
    labelFontSize: 10,
    labelColor: '#000000',
    labelBackgroundColor: '#ffffff',
    labelBackgroundOpacity: 1,
    labelBorderColor: '#cccccc',
    labelBorderWidth: 1,
    labelBackgroundShape: 'rectangle',
  },
  deterministic: {
    color: '#28a745',
    width: 3,
    lineStyle: 'solid',
    labelFontSize: 10,
    labelColor: '#000000',
    labelBackgroundColor: '#ffffff',
    labelBackgroundOpacity: 1,
    labelBorderColor: '#cccccc',
    labelBorderWidth: 1,
    labelBackgroundShape: 'rectangle',
  },
}

const distributionOptions: SelectOption[] = [
  {
    value: 'dnorm',
    label: 'Normal (dnorm)',
    paramCount: 2,
    paramNames: ['mean', 'precision'],
    helpText:
      'Parameters: mean (expected value), precision (1/variance). Note: BUGS uses precision instead of standard deviation.',
  },
  {
    value: 'dgamma',
    label: 'Gamma (dgamma)',
    paramCount: 2,
    paramNames: ['shape', 'rate'],
    helpText: 'Parameters: shape (alpha), rate (1/beta).',
  },
  {
    value: 'dbeta',
    label: 'Beta (dbeta)',
    paramCount: 2,
    paramNames: ['shape1', 'shape2'],
    helpText: 'Parameters: shape1 (alpha), shape2 (beta).',
  },
  {
    value: 'dbin',
    label: 'Binomial (dbin)',
    paramCount: 2,
    paramNames: ['prob', 'size'],
    helpText: 'Parameters: prob (success probability), size (number of trials).',
  },
  {
    value: 'dpois',
    label: 'Poisson (dpois)',
    paramCount: 1,
    paramNames: ['lambda'],
    helpText: 'Parameter: lambda (expected number of occurrences).',
  },
  {
    value: 'dt',
    label: 'Student-t (dt)',
    paramCount: 3,
    paramNames: ['mu', 'tau', 'k'],
    helpText: 'Parameters: mu (mean), tau (precision), k (degrees of freedom).',
  },
  {
    value: 'dunif',
    label: 'Uniform (dunif)',
    paramCount: 2,
    paramNames: ['lower', 'upper'],
    helpText: 'Parameters: lower (minimum value), upper (maximum value).',
  },
]

export const nodeDefinitions: NodeDefinition[] = [
  {
    nodeType: 'stochastic',
    label: 'Stochastic',
    icon: '~',
    description: 'Random variable with a distribution',
    styleClass: 'stochastic',
    properties: [
      { key: 'name', label: 'Name', type: 'text', defaultValue: 'stochastic.node' },
      {
        key: 'distribution',
        label: 'Distribution (~)',
        type: 'select',
        defaultValue: 'dnorm',
        options: distributionOptions,
      },
      {
        key: 'observed',
        label: 'Observed',
        type: 'checkbox',
        defaultValue: false,
        helpText: "If checked, this node's value is provided in the data section.",
      },
      {
        key: 'indices',
        label: 'Indices',
        type: 'text',
        placeholder: 'e.g., i,j or 1:N',
        defaultValue: '',
      },
    ],
    parameters: [
      // These fields will be used to store literal values or parent node links
      { key: 'param1', label: 'Parameter 1', type: 'text', defaultValue: '' },
      { key: 'param2', label: 'Parameter 2', type: 'text', defaultValue: '' },
      { key: 'param3', label: 'Parameter 3', type: 'text', defaultValue: '' },
    ],
    defaultStyle: {
      backgroundColor: '#ffe0e0',
      borderColor: '#dc3545',
      borderWidth: 2,
      borderStyle: 'solid',
      backgroundOpacity: 1,
      shape: 'ellipse',
      width: 60,
      height: 60,
      labelFontSize: 10,
      labelColor: '#000000',
    },
  },
  {
    nodeType: 'deterministic',
    label: 'Deterministic',
    icon: '<-',
    description: 'Logical function of parents',
    styleClass: 'deterministic',
    properties: [
      { key: 'name', label: 'Name', type: 'text', defaultValue: 'logical.node' },
      {
        key: 'equation',
        label: 'Equation (<-)',
        type: 'text',
        placeholder: 'e.g., a + b * x',
        defaultValue: '',
      },
      {
        key: 'indices',
        label: 'Indices',
        type: 'text',
        placeholder: 'e.g., i,j',
        defaultValue: '',
      },
    ],
    defaultStyle: {
      backgroundColor: '#e0ffe0',
      borderColor: '#28a745',
      borderWidth: 2,
      borderStyle: 'solid',
      backgroundOpacity: 1,
      shape: 'triangle',
      width: 60,
      height: 60,
      labelFontSize: 10,
      labelColor: '#000000',
    },
  },
  {
    nodeType: 'constant',
    label: 'Constant',
    icon: 'C',
    description: 'A fixed value or data input',
    styleClass: 'constant',
    properties: [
      { key: 'name', label: 'Name', type: 'text', defaultValue: 'constant.node' },
      {
        key: 'indices',
        label: 'Indices',
        type: 'text',
        placeholder: 'e.g., i,j',
        defaultValue: '',
      },
    ],
    defaultStyle: {
      backgroundColor: '#e9ecef',
      borderColor: '#6c757d',
      borderWidth: 2,
      borderStyle: 'solid',
      backgroundOpacity: 1,
      shape: 'rectangle',
      width: 60,
      height: 60,
      labelFontSize: 10,
      labelColor: '#000000',
    },
  },
  {
    nodeType: 'observed',
    label: 'Observed',
    icon: 'O',
    description: 'A data node with a fixed value',
    styleClass: 'observed',
    properties: [
      { key: 'name', label: 'Name', type: 'text', defaultValue: 'observed.node' },
      {
        key: 'distribution',
        label: 'Distribution (~)',
        type: 'select',
        defaultValue: 'dnorm',
        options: distributionOptions,
      },
      { key: 'observed', label: 'Observed', type: 'checkbox', defaultValue: true },
      {
        key: 'indices',
        label: 'Indices',
        type: 'text',
        placeholder: 'e.g., i,j or 1:N',
        defaultValue: '',
      },
    ],
    parameters: [
      { key: 'param1', label: 'Parameter 1', type: 'text', defaultValue: '' },
      { key: 'param2', label: 'Parameter 2', type: 'text', defaultValue: '' },
      { key: 'param3', label: 'Parameter 3', type: 'text', defaultValue: '' },
    ],
    defaultStyle: {
      backgroundColor: '#e0f0ff',
      borderColor: '#007bff',
      borderWidth: 2,
      borderStyle: 'dashed',
      backgroundOpacity: 1,
      shape: 'ellipse',
      width: 60,
      height: 60,
      labelFontSize: 10,
      labelColor: '#000000',
    },
  },
  {
    nodeType: 'plate',
    label: 'Plate',
    icon: '[]',
    description: 'Represents a loop structure',
    styleClass: 'plate',
    properties: [
      { key: 'name', label: 'Name', type: 'text', defaultValue: 'Plate' },
      {
        key: 'loopVariable',
        label: 'Loop Variable',
        type: 'text',
        placeholder: 'e.g., i',
        defaultValue: 'i',
      },
      {
        key: 'loopRange',
        label: 'Loop Range',
        type: 'text',
        placeholder: 'e.g., 1:N',
        defaultValue: '1:N',
      },
    ],
    defaultStyle: {
      backgroundColor: '#f0f8ff',
      borderColor: '#4682b4',
      borderWidth: 2,
      borderStyle: 'dashed',
      backgroundOpacity: 0.2, // Semi-transparent for plates
      shape: 'round-rectangle',
      width: 0, // Dynamic
      height: 0, // Dynamic
      labelFontSize: 10,
      labelColor: '#000000',
    },
  },
]

export const connectionPaletteItems: {
  label: string
  type: 'add-edge'
  styleClass: string
  description: string
}[] = [
  {
    label: 'Add Edge',
    type: 'add-edge',
    styleClass: 'connection',
    description: 'Connect two nodes',
  },
]

export const exampleModels: { name: string; key: string }[] = [{ name: 'Rats Model', key: 'rats' }]

export const getNodeDefinition = (type: NodeType): NodeDefinition | undefined => {
  return nodeDefinitions.find((def) => def.nodeType === type)
}

export const getDistributionByName = (distName: string): SelectOption | undefined => {
  return distributionOptions.find((opt) => opt.value === distName)
}

export const getDefaultNodeData = (
  type: NodeType
): { [key: string]: string | number | boolean | null | undefined } => {
  const definition = getNodeDefinition(type)
  if (!definition) return {}

  const defaultData: { [key: string]: string | number | boolean | null | undefined } = {}
  definition.properties.forEach((prop) => {
    defaultData[prop.key] = prop.defaultValue
  })
  if (definition.parameters) {
    definition.parameters.forEach((param) => {
      defaultData[param.key] = param.defaultValue
    })
  }
  return defaultData
}



================================================
FILE: src/stores/dataStore.ts
================================================
import { defineStore } from 'pinia'
import { ref, computed } from 'vue'
import { useGraphStore } from './graphStore'
import type { ModelData } from '../types'

const defaultContent = JSON.stringify(
  {
    data: {},
    inits: {},
  },
  null,
  2
)

interface DataState {
  content: string
}

export const useDataStore = defineStore('data', () => {
  const graphStore = useGraphStore()
  const dataContents = ref<Map<string, DataState>>(new Map())

  const getGraphData = (graphId: string): DataState => {
    if (!dataContents.value.has(graphId)) {
      const storedData = localStorage.getItem(`doodlebugs-data-${graphId}`)
      if (storedData) {
        try {
          const loadedState = JSON.parse(storedData)
          if (loadedState.jsonData !== undefined) {
            const merged = {
              data: JSON.parse(loadedState.jsonData || '{}'),
              inits: JSON.parse(loadedState.jsonInits || '{}'),
            }
            dataContents.value.set(graphId, { content: JSON.stringify(merged, null, 2) })
          } else {
            dataContents.value.set(graphId, loadedState)
          }
        } catch (e) {
          console.error('Failed to parse stored data', e)
          dataContents.value.set(graphId, { content: defaultContent })
        }
      } else {
        dataContents.value.set(graphId, { content: defaultContent })
      }
    }
    return dataContents.value.get(graphId)!
  }

  const currentGraphState = computed(() => {
    const graphId = graphStore.currentGraphId
    return graphId ? getGraphData(graphId) : null
  })

  const dataContent = computed({
    get: () => {
      if (!currentGraphState.value) return defaultContent
      return currentGraphState.value.content
    },
    set: (newContent) => {
      if (currentGraphState.value) {
        currentGraphState.value.content = newContent
        updateGraphData(graphStore.currentGraphId!, currentGraphState.value)
      }
    },
  })

  const parsedGraphData = computed<ModelData>(() => {
    try {
      const parsed = JSON.parse(currentGraphState.value?.content || defaultContent)
      return {
        data: parsed.data || {},
        inits: parsed.inits || {},
      }
    } catch {
      return { data: {}, inits: {} }
    }
  })

  const updateGraphData = (graphId: string, newState: DataState) => {
    dataContents.value.set(graphId, newState)
    localStorage.setItem(`doodlebugs-data-${graphId}`, JSON.stringify(newState))
  }

  const createNewGraphData = (graphId: string) => {
    const newState: DataState = {
      content: defaultContent,
    }
    dataContents.value.set(graphId, newState)
    updateGraphData(graphId, newState)
  }

  const deleteGraphData = (graphId: string) => {
    dataContents.value.delete(graphId)
    localStorage.removeItem(`doodlebugs-data-${graphId}`)
  }

  return {
    dataContent,
    parsedGraphData,
    createNewGraphData,
    deleteGraphData,
    getGraphData,
    updateGraphData,
  }
})



================================================
FILE: src/stores/graphStore.ts
================================================
import { defineStore } from 'pinia'
import { ref, computed, watch } from 'vue'
import type { GraphElement } from '../types'
import { useDataStore } from './dataStore'

export interface GraphContent {
  graphId: string
  elements: GraphElement[]
  lastLayout?: string
  zoom?: number
  pan?: { x: number; y: number }
}

export const useGraphStore = defineStore('graph', () => {
  const dataStore = useDataStore()
  const graphContents = ref<Map<string, GraphContent>>(new Map())
  const currentGraphId = ref<string | null>(
    localStorage.getItem('doodlebugs-currentGraphId') || null
  )

  const selectedElement = ref<GraphElement | null>(null)

  watch(currentGraphId, (newId) => {
    if (newId) {
      localStorage.setItem('doodlebugs-currentGraphId', newId)
    } else {
      localStorage.removeItem('doodlebugs-currentGraphId')
    }
  })

  const currentGraphElements = computed<GraphElement[]>(() => {
    if (currentGraphId.value && graphContents.value.has(currentGraphId.value)) {
      return graphContents.value.get(currentGraphId.value)!.elements
    }
    return []
  })

  const selectGraph = (graphId: string | null) => {
    currentGraphId.value = graphId
    if (graphId && !graphContents.value.has(graphId)) {
      loadGraph(graphId)
    }
  }

  const setSelectedElement = (element: GraphElement | null) => {
    selectedElement.value = element
  }

  const createNewGraphContent = (graphId: string) => {
    const newContent: GraphContent = {
      graphId: graphId,
      elements: [],
      lastLayout: 'dagre',
    }
    // Ensure reactivity
    graphContents.value.set(graphId, newContent)
    saveGraph(graphId, newContent)
    dataStore.createNewGraphData(graphId)
  }

  const updateGraphElements = (graphId: string, newElements: GraphElement[]) => {
    if (graphContents.value.has(graphId)) {
      const content = graphContents.value.get(graphId)!
      // Create new object to trigger reactivity
      const newContent = { ...content, elements: newElements }
      graphContents.value.set(graphId, newContent)
      saveGraph(graphId, newContent)
    }
  }

  const updateGraphLayout = (graphId: string, layoutName: string) => {
    if (graphContents.value.has(graphId)) {
      const content = graphContents.value.get(graphId)!
      if (content.lastLayout !== layoutName) {
        const newContent = { ...content, lastLayout: layoutName }
        graphContents.value.set(graphId, newContent)
        saveGraph(graphId, newContent)
      }
    }
  }

  const updateGraphViewport = (graphId: string, zoom: number, pan: { x: number; y: number }) => {
    if (graphContents.value.has(graphId)) {
      const content = graphContents.value.get(graphId)!
      // Only update if changed to avoid loops, but ensure object reference changes
      const newContent = { ...content, zoom, pan }
      graphContents.value.set(graphId, newContent)
      saveGraph(graphId, newContent)
    }
  }

  const deleteGraphContent = (graphId: string) => {
    graphContents.value.delete(graphId)
    localStorage.removeItem(`doodlebugs-graph-${graphId}`)
    dataStore.deleteGraphData(graphId)
    if (currentGraphId.value === graphId) {
      selectGraph(null)
    }
  }

  const saveGraph = (graphId: string, content: GraphContent) => {
    localStorage.setItem(`doodlebugs-graph-${graphId}`, JSON.stringify(content))
  }

  const loadGraph = (graphId: string): GraphContent | null => {
    const storedContent = localStorage.getItem(`doodlebugs-graph-${graphId}`)
    if (storedContent) {
      try {
        const content: GraphContent = JSON.parse(storedContent)
        graphContents.value.set(graphId, content)
        return content
      } catch (e) {
        console.error('Failed to load graph', e)
        return null
      }
    }
    return null
  }

  return {
    graphContents,
    currentGraphId,
    currentGraphElements,
    selectedElement,
    setSelectedElement,
    selectGraph,
    createNewGraphContent,
    updateGraphElements,
    updateGraphLayout,
    updateGraphViewport,
    deleteGraphContent,
    saveGraph,
    loadGraph,
  }
})



================================================
FILE: src/stores/projectStore.ts
================================================
import { defineStore } from 'pinia'
import { ref, computed } from 'vue'
import { useGraphStore } from './graphStore'
import type { GridStyle } from './uiStore'

export interface GraphMeta {
  id: string
  name: string
  createdAt: number
  lastModified: number
  // Layout props
  x: number
  y: number
  width: number
  height: number
  // Code Panel Props
  showCodePanel?: boolean
  codePanelX?: number
  codePanelY?: number
  codePanelWidth?: number
  codePanelHeight?: number
  // Data Panel Props
  showDataPanel?: boolean
  dataPanelX?: number
  dataPanelY?: number
  dataPanelWidth?: number
  dataPanelHeight?: number
  // JSON Panel Props
  showJsonPanel?: boolean
  jsonPanelX?: number
  jsonPanelY?: number
  jsonPanelWidth?: number
  jsonPanelHeight?: number
  // Per-graph Grid Settings
  gridEnabled?: boolean
  gridSize?: number
  gridStyle?: GridStyle
}

export interface Project {
  id: string
  name: string
  createdAt: number
  lastModified: number
  graphs: GraphMeta[]
}

export const useProjectStore = defineStore('project', () => {
  const projects = ref<Project[]>([])
  const currentProjectId = ref<string | null>(
    localStorage.getItem('doodlebugs-currentProjectId') || null
  )

  const graphStore = useGraphStore()

  const exportState = () => {
    return {
      projects: JSON.parse(JSON.stringify(projects.value)),
      currentProjectId: currentProjectId.value,
    }
  }

  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  const importState = (state: any) => {
    if (!state) return

    if (state.project) {
      projects.value = state.project.projects || []
      currentProjectId.value = state.project.currentProjectId || null
    } else if (state.projects) {
      projects.value = state.projects
      currentProjectId.value = state.currentProjectId
    }

    if (!currentProjectId.value && projects.value.length > 0) {
      currentProjectId.value = projects.value[0].id
    }
  }

  const createProject = (name: string) => {
    const newProject: Project = {
      id: `project_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`,
      name: name,
      createdAt: Date.now(),
      lastModified: Date.now(),
      graphs: [],
    }
    projects.value.push(newProject)
    saveProjects()
    selectProject(newProject.id)
  }

  const renameProject = (projectId: string, newName: string) => {
    const project = projects.value.find((p) => p.id === projectId)
    if (project && newName.trim()) {
      project.name = newName.trim()
      project.lastModified = Date.now()
      saveProjects()
    }
  }

  const selectProject = (projectId: string | null) => {
    currentProjectId.value = projectId
    if (projectId) {
      localStorage.setItem('doodlebugs-currentProjectId', projectId)
    } else {
      localStorage.removeItem('doodlebugs-currentProjectId')
    }
  }

  const deleteProject = (projectId: string) => {
    const projectToDelete = projects.value.find((p) => p.id === projectId)
    if (projectToDelete) {
      projectToDelete.graphs.forEach((graphMeta) => {
        graphStore.deleteGraphContent(graphMeta.id)
      })
      projects.value = projects.value.filter((p) => p.id !== projectId)
      if (currentProjectId.value === projectId) {
        selectProject(null)
      }
      saveProjects()
    }
  }

  const currentProject = computed(() => {
    return projects.value.find((p) => p.id === currentProjectId.value) || null
  })

  const addGraphToProject = (projectId: string, graphName: string): GraphMeta | undefined => {
    const project = projects.value.find((p) => p.id === projectId)
    if (project) {
      const offset = project.graphs.length * 40

      const newGraphMeta: GraphMeta = {
        id: `graph_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`,
        name: graphName,
        createdAt: Date.now(),
        lastModified: Date.now(),
        x: 100 + offset,
        y: 100 + offset,
        width: 600,
        height: 400,
        showCodePanel: false,
        showDataPanel: false,
        showJsonPanel: false,
        codePanelWidth: 400,
        codePanelHeight: 300,
        dataPanelWidth: 400,
        dataPanelHeight: 300,
        jsonPanelWidth: 400,
        jsonPanelHeight: 300,
      }
      project.graphs.push(newGraphMeta)
      project.lastModified = Date.now()
      saveProjects()
      graphStore.createNewGraphContent(newGraphMeta.id)
      graphStore.selectGraph(newGraphMeta.id)
      return newGraphMeta
    }
    return undefined
  }

  const renameGraphInProject = (projectId: string, graphId: string, newName: string) => {
    const project = projects.value.find((p) => p.id === projectId)
    if (project && newName.trim()) {
      const graph = project.graphs.find((g) => g.id === graphId)
      if (graph) {
        graph.name = newName.trim()
        graph.lastModified = Date.now()
        project.lastModified = Date.now()
        saveProjects()
      }
    }
  }

  const updateGraphLayout = (
    projectId: string,
    graphId: string,
    layout: Partial<{
      x: number
      y: number
      width: number
      height: number
      showCodePanel: boolean
      codePanelX: number
      codePanelY: number
      codePanelWidth: number
      codePanelHeight: number
      showDataPanel: boolean
      dataPanelX: number
      dataPanelY: number
      dataPanelWidth: number
      dataPanelHeight: number
      showJsonPanel: boolean
      jsonPanelX: number
      jsonPanelY: number
      jsonPanelWidth: number
      jsonPanelHeight: number
      gridEnabled: boolean
      gridSize: number
      gridStyle: GridStyle
    }>,
    shouldSave: boolean = true
  ) => {
    const project = projects.value.find((p) => p.id === projectId)
    if (project) {
      const graph = project.graphs.find((g) => g.id === graphId)
      if (graph) {
        if (layout.x !== undefined) graph.x = layout.x
        if (layout.y !== undefined) graph.y = layout.y
        if (layout.width !== undefined) graph.width = layout.width
        if (layout.height !== undefined) graph.height = layout.height

        if (layout.showCodePanel !== undefined) graph.showCodePanel = layout.showCodePanel
        if (layout.codePanelX !== undefined) graph.codePanelX = layout.codePanelX
        if (layout.codePanelY !== undefined) graph.codePanelY = layout.codePanelY
        if (layout.codePanelWidth !== undefined) graph.codePanelWidth = layout.codePanelWidth
        if (layout.codePanelHeight !== undefined) graph.codePanelHeight = layout.codePanelHeight

        if (layout.showDataPanel !== undefined) graph.showDataPanel = layout.showDataPanel
        if (layout.dataPanelX !== undefined) graph.dataPanelX = layout.dataPanelX
        if (layout.dataPanelY !== undefined) graph.dataPanelY = layout.dataPanelY
        if (layout.dataPanelWidth !== undefined) graph.dataPanelWidth = layout.dataPanelWidth
        if (layout.dataPanelHeight !== undefined) graph.dataPanelHeight = layout.dataPanelHeight

        if (layout.showJsonPanel !== undefined) graph.showJsonPanel = layout.showJsonPanel
        if (layout.jsonPanelX !== undefined) graph.jsonPanelX = layout.jsonPanelX
        if (layout.jsonPanelY !== undefined) graph.jsonPanelY = layout.jsonPanelY
        if (layout.jsonPanelWidth !== undefined) graph.jsonPanelWidth = layout.jsonPanelWidth
        if (layout.jsonPanelHeight !== undefined) graph.jsonPanelHeight = layout.jsonPanelHeight

        if (layout.gridEnabled !== undefined) graph.gridEnabled = layout.gridEnabled
        if (layout.gridSize !== undefined) graph.gridSize = layout.gridSize
        if (layout.gridStyle !== undefined) graph.gridStyle = layout.gridStyle

        if (shouldSave) {
          saveProjects()
        }
      }
    }
  }

  const deleteGraphFromProject = (projectId: string, graphId: string) => {
    const project = projects.value.find((p) => p.id === projectId)
    if (project) {
      project.graphs = project.graphs.filter((g) => g.id !== graphId)
      project.lastModified = Date.now()
      saveProjects()
      graphStore.deleteGraphContent(graphId)
    }
  }

  const getGraphsForProject = (projectId: string): GraphMeta[] => {
    return projects.value.find((p) => p.id === projectId)?.graphs || []
  }

  const saveProjects = () => {
    localStorage.setItem('doodlebugs-projects', JSON.stringify(projects.value))
  }

  const loadProjects = () => {
    const storedProjects = localStorage.getItem('doodlebugs-projects')
    if (storedProjects) {
      const loaded = JSON.parse(storedProjects) as Project[]
      loaded.forEach((p) => {
        if (p.graphs) {
          p.graphs.forEach((g, index) => {
            if (g.x === undefined) g.x = 100 + index * 40
            if (g.y === undefined) g.y = 100 + index * 40
            if (g.width === undefined) g.width = 600
            if (g.height === undefined) g.height = 400
          })
        }
      })
      projects.value = loaded
    }
    if (currentProjectId.value && !projects.value.some((p) => p.id === currentProjectId.value)) {
      selectProject(null)
    }
  }

  return {
    projects,
    currentProjectId,
    currentProject,
    createProject,
    renameProject,
    selectProject,
    deleteProject,
    addGraphToProject,
    renameGraphInProject,
    updateGraphLayout,
    deleteGraphFromProject,
    getGraphsForProject,
    loadProjects,
    saveProjects,
    exportState,
    importState,
  }
})



================================================
FILE: src/stores/scriptStore.ts
================================================
import { defineStore } from 'pinia'
import { ref, watch } from 'vue'

export interface SamplerSettings {
  n_samples: number
  n_adapts: number
  n_chains: number
  seed?: number | null
}

export const useScriptStore = defineStore('script', () => {
  const LS_KEYS = {
    standaloneScript: 'doodlebugs-standaloneScript',
  } as const

  const standaloneScript = ref<string>(localStorage.getItem(LS_KEYS.standaloneScript) || '')

  const samplerSettings = ref<SamplerSettings>({
    n_samples: 1000,
    n_adapts: 1000,
    n_chains: 1,
    seed: null,
  })

  watch(standaloneScript, (v) => localStorage.setItem(LS_KEYS.standaloneScript, v))

  return {
    standaloneScript,
    samplerSettings,
  }
})



================================================
FILE: src/stores/uiStore.ts
================================================
import { defineStore } from 'pinia'
import { ref, watch } from 'vue'
import { nodeDefinitions, defaultEdgeStyles, type EdgeStyle } from '../config/nodeDefinitions'

export type RightSidebarTab = 'properties' | 'script' | 'export'
export type LeftSidebarTab =
  | 'project'
  | 'palette'
  | 'data'
  | 'settings'
  | 'view'
  | 'connect'
  | 'help'
  | 'devtools'
export type GridStyle = 'dots' | 'lines'

export interface NodeStyle {
  backgroundColor: string
  borderColor: string
  borderWidth: number
  borderStyle: string
  backgroundOpacity: number
  shape: string
  width: number
  height: number
  labelFontSize: number
  labelColor: string
}

export const useUiStore = defineStore('ui', () => {
  // Right Sidebar State
  const storedRight = localStorage.getItem('doodlebugs-activeRightTab') as string | null
  let initialRightTab: RightSidebarTab = 'properties'

  if (storedRight === 'properties' || storedRight === 'script' || storedRight === 'export') {
    initialRightTab = storedRight as RightSidebarTab
  } else if (storedRight === 'json') {
    initialRightTab = 'properties' // Fallback since json is moved
  }

  const activeRightTab = ref<RightSidebarTab>(initialRightTab)

  const isRightTabPinned = ref<boolean>(
    localStorage.getItem('doodlebugs-isRightTabPinned') === 'true'
  )

  // Default to closed (false) if not set or not 'true'
  const isRightSidebarOpen = ref<boolean>(
    localStorage.getItem('doodlebugs-isRightSidebarOpen') === 'true'
  )

  // Left Sidebar State
  const activeLeftTab = ref<LeftSidebarTab>(
    (localStorage.getItem('doodlebugs-activeLeftTab') as LeftSidebarTab) || 'project'
  )
  // Default to closed (false) if not set or not 'true'
  const isLeftSidebarOpen = ref<boolean>(
    localStorage.getItem('doodlebugs-isLeftSidebarOpen') === 'true'
  )

  // Persist Open Accordion Tabs
  const storedAccordion = localStorage.getItem('doodlebugs-activeLeftAccordionTabs')
  const activeLeftAccordionTabs = ref<string[]>(
    storedAccordion ? JSON.parse(storedAccordion) : ['project']
  )

  // Persistent UI Settings
  const isGridEnabled = ref<boolean>(localStorage.getItem('doodlebugs-isGridEnabled') !== 'false')
  const gridSize = ref<number>(parseInt(localStorage.getItem('doodlebugs-gridSize') || '30', 10))
  const showZoomControls = ref<boolean>(
    localStorage.getItem('doodlebugs-showZoomControls') !== 'false'
  )
  const showDebugPanel = ref<boolean>(localStorage.getItem('doodlebugs-showDebugPanel') === 'true')
  const showDetachModeControl = ref<boolean>(
    localStorage.getItem('doodlebugs-showDetachModeControl') === 'true'
  )

  // Interaction Modes
  const isDetachModeActive = ref<boolean>(false)

  // Grid Settings - Default to 'dots' now
  const canvasGridStyle = ref<GridStyle>(
    (localStorage.getItem('doodlebugs-canvasGridStyle') as GridStyle) || 'dots'
  )

  // Theme State
  const isDarkMode = ref<boolean>(localStorage.getItem('doodlebugs-darkMode') === 'true')

  // Node Styles
  const storedStyles = localStorage.getItem('doodlebugs-nodeStyles')
  const initialNodeStyles: Record<string, NodeStyle> = {}

  // Initialize from definitions first
  nodeDefinitions.forEach((def) => {
    initialNodeStyles[def.nodeType] = { ...def.defaultStyle }
  })

  // Override with stored
  if (storedStyles) {
    try {
      const parsed = JSON.parse(storedStyles)
      Object.keys(initialNodeStyles).forEach((key) => {
        if (parsed[key]) {
          initialNodeStyles[key] = { ...initialNodeStyles[key], ...parsed[key] }
        }
      })
    } catch (e) {
      console.error('Failed to load node styles', e)
    }
  }

  const nodeStyles = ref<Record<string, NodeStyle>>(initialNodeStyles)

  // Edge Styles
  const storedEdgeStyles = localStorage.getItem('doodlebugs-edgeStyles')
  let initialEdgeStyles = { ...defaultEdgeStyles }

  if (storedEdgeStyles) {
    try {
      initialEdgeStyles = { ...initialEdgeStyles, ...JSON.parse(storedEdgeStyles) }
    } catch (e) {
      console.error('Failed to load edge styles', e)
    }
  }

  const edgeStyles = ref<Record<'stochastic' | 'deterministic', EdgeStyle>>(initialEdgeStyles)

  // Watchers for Persistence
  watch(activeRightTab, (newTab) => {
    localStorage.setItem('doodlebugs-activeRightTab', newTab)
  })
  watch(isRightTabPinned, (isPinned) => {
    localStorage.setItem('doodlebugs-isRightTabPinned', isPinned.toString())
  })
  watch(isRightSidebarOpen, (isOpen) => {
    localStorage.setItem('doodlebugs-isRightSidebarOpen', isOpen.toString())
  })
  watch(activeLeftTab, (newTab) => {
    localStorage.setItem('doodlebugs-activeLeftTab', newTab)
  })
  watch(isLeftSidebarOpen, (isOpen) => {
    localStorage.setItem('doodlebugs-isLeftSidebarOpen', isOpen.toString())
  })
  watch(
    activeLeftAccordionTabs,
    (tabs) => {
      localStorage.setItem('doodlebugs-activeLeftAccordionTabs', JSON.stringify(tabs))
    },
    { deep: true }
  )
  watch(isGridEnabled, (val) => {
    localStorage.setItem('doodlebugs-isGridEnabled', String(val))
  })
  watch(gridSize, (val) => {
    localStorage.setItem('doodlebugs-gridSize', String(val))
  })
  watch(showZoomControls, (val) => {
    localStorage.setItem('doodlebugs-showZoomControls', String(val))
  })
  watch(showDebugPanel, (val) => {
    localStorage.setItem('doodlebugs-showDebugPanel', String(val))
  })
  watch(showDetachModeControl, (val) => {
    localStorage.setItem('doodlebugs-showDetachModeControl', String(val))
  })
  watch(canvasGridStyle, (style) => {
    localStorage.setItem('doodlebugs-canvasGridStyle', style)
  })
  watch(isDarkMode, (val) => {
    localStorage.setItem('doodlebugs-darkMode', String(val))
  })
  watch(
    nodeStyles,
    (styles) => {
      localStorage.setItem('doodlebugs-nodeStyles', JSON.stringify(styles))
    },
    { deep: true }
  )
  watch(
    edgeStyles,
    (styles) => {
      localStorage.setItem('doodlebugs-edgeStyles', JSON.stringify(styles))
    },
    { deep: true }
  )

  // Actions
  const setActiveRightTab = (tab: RightSidebarTab) => {
    activeRightTab.value = tab
    if (!isRightSidebarOpen.value) {
      isRightSidebarOpen.value = true
    }
  }

  const toggleRightTabPinned = () => {
    isRightTabPinned.value = !isRightTabPinned.value
  }

  const toggleRightSidebar = () => {
    isRightSidebarOpen.value = !isRightSidebarOpen.value
  }

  const handleLeftTabClick = (tab: LeftSidebarTab) => {
    if (activeLeftTab.value === tab && isLeftSidebarOpen.value) {
      isLeftSidebarOpen.value = false
    } else {
      isLeftSidebarOpen.value = true
      activeLeftTab.value = tab
    }
  }

  const toggleLeftSidebar = () => {
    isLeftSidebarOpen.value = !isLeftSidebarOpen.value
  }

  const toggleDarkMode = () => {
    isDarkMode.value = !isDarkMode.value
  }

  const toggleDetachMode = () => {
    isDetachModeActive.value = !isDetachModeActive.value
  }

  return {
    activeRightTab,
    isRightTabPinned,
    isRightSidebarOpen,
    setActiveRightTab,
    toggleRightTabPinned,
    toggleRightSidebar,
    activeLeftTab,
    isLeftSidebarOpen,
    handleLeftTabClick,
    toggleLeftSidebar,
    activeLeftAccordionTabs,
    canvasGridStyle,
    isDarkMode,
    toggleDarkMode,
    nodeStyles,
    edgeStyles,
    isGridEnabled,
    gridSize,
    showZoomControls,
    showDebugPanel,
    showDetachModeControl,
    isDetachModeActive,
    toggleDetachMode,
  }
})



================================================
FILE: src/types/cytoscape-extensions.d.ts
================================================
// NOTE: gridGuide and contextMenus are DISABLED for iOS/iPad/WebKit compatibility
// They block touch events and prevent node/edge creation on mobile devices
// declare module 'cytoscape-grid-guide';
// declare module 'cytoscape-context-menus';

declare module 'cytoscape-dagre'
declare module 'cytoscape-fcose'
declare module 'cytoscape-svg'
declare module 'cytoscape-cola'
declare module 'cytoscape-klay'
declare module 'cytoscape-undo-redo'



================================================
FILE: src/types/index.ts
================================================
export type NodeType = 'stochastic' | 'deterministic' | 'constant' | 'observed' | 'plate'

export type PaletteItemType = NodeType | 'add-edge'

export interface ValidationError {
  field: string
  message: string
}

// This interface is now a superset of all possible properties defined in nodeDefinitions.ts.
// All properties specific to a node type are optional.
export interface GraphNode {
  id: string
  name: string
  type: 'node'
  nodeType: NodeType
  position: { x: number; y: number }
  parent?: string

  // Properties from definitions
  distribution?: string
  equation?: string
  observed?: boolean
  indices?: string
  loopVariable?: string
  loopRange?: string

  // Distribution parameters
  param1?: string
  param2?: string
  param3?: string

  // Index signature to allow dynamic property access
  [key: string]: string | number | boolean | null | undefined | { x: number; y: number } | string[]
}

export interface GraphEdge {
  id: string
  name?: string
  type: 'edge'
  source: string
  target: string
  relationshipType?: 'stochastic' | 'deterministic'
}

export type GraphElement = GraphNode | GraphEdge

export interface UnifiedModelData {
  name: string
  elements?: GraphElement[]
  dataContent?: string
  // Legacy support fields
  graphJSON?: GraphElement[]
  data?: Record<string, unknown>
  inits?: Record<string, unknown>
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  layout?: any
}

export interface ExampleModel {
  name: string
  graphJSON: GraphElement[]
}

export interface ModelData {
  data: { [key: string]: string | number | boolean | null | undefined }
  inits: { [key: string]: string | number | boolean | null | undefined }
}

declare module 'cytoscape' {
  interface Core {
    /**
     * Export the graph as SVG.
     * Provided by cytoscape-svg extension.
     */
    svg(options?: {
      scale?: number
      full?: boolean
      bg?: string
      maxWidth?: number
      maxHeight?: number
      [key: string]: unknown
    }): string
  }
}


